<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dance Master - 竖屏全身版 (修复UI)</title>
  
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;900&display=swap');
    
    body { background: #0f172a; font-family: 'Exo 2', sans-serif; user-select: none; overflow: hidden; }
    
    /* --- 舞台布局 --- */
    #stage { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; background: #000;}
    
    /* 左侧：老师 */
    #teacher-view { 
        position: relative; height: 100%; aspect-ratio: 9 / 16; 
        background: #000; border-right: 2px solid #334155; overflow: hidden;
    }
    #refVideo { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; }
    #teacherCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }

    /* 右侧：学生 */
    #student-view { 
        position: relative; height: 100%; aspect-ratio: 9 / 16; 
        background: #1e293b; overflow: hidden; 
    }
    #camVideo { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0.6; }
    #studentCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

    /* --- UI 层 --- */
    #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 50; }

    .top-panel {
        position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
        display: flex; gap: 20px; align-items: start;
    }

    /* 进度条容器 */
    .progress-box {
        width: 400px; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.2); text-align: center;
    }
    .stage-title { font-size: 20px; font-weight: 900; color: #fff; margin-bottom: 5px; letter-spacing: 1px; }
    .bar-bg { width: 100%; height: 15px; background: #334155; border-radius: 10px; overflow: hidden; }
    .bar-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #fbbf24, #f59e0b); transition: width 0.3s; }
    
    /* 修复：补回了缺失的小圆点样式 */
    .level-indicators { display: flex; gap: 8px; justify-content: center; margin-top: 10px; }
    .lvl-dot { width: 10px; height: 10px; border-radius: 50%; background: #475569; transition: all 0.3s; }
    .lvl-dot.active { background: #fbbf24; box-shadow: 0 0 10px #fbbf24; transform: scale(1.3); }
    .lvl-dot.done { background: #10b981; }

    /* 侧面状态灯 */
    .side-status-box {
        background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; gap: 10px; height: 50px;
    }
    .led { width: 12px; height: 12px; border-radius: 50%; background: #475569; transition: all 0.3s; }
    .led.on { background: #2ecc71; box-shadow: 0 0 10px #2ecc71; }
    .led.error { background: #e74c3c; box-shadow: 0 0 10px #e74c3c; }
    .side-text { font-size: 14px; color: #cbd5e1; font-weight: bold; }

    /* 反馈文字 */
    #feedback {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        font-size: 4rem; font-weight: 900; text-shadow: 0 0 30px rgba(0,0,0,0.8);
        opacity: 0; transition: all 0.2s; text-align: center; width: 100%;
        white-space: nowrap;
    }
    .fb-good { color: #34d399; animation: pop 0.5s forwards; }
    .fb-warn { color: #e74c3c; font-size: 3rem !important; animation: shake 0.4s forwards; }

    /* 菜单 */
    #menu { position: absolute; inset: 0; background: rgba(15,23,42,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; pointer-events: auto; }
    .step-card { background: #1e293b; padding: 20px; border-radius: 15px; margin: 10px; width: 280px; text-align: center; border: 1px solid #334155; }
    .step-num { font-size: 40px; font-weight: 900; color: #64748b; }
    
    .btn { background: linear-gradient(to right, #3b82f6, #2563eb); padding: 15px 40px; border-radius: 30px; color: white; font-weight: bold; font-size: 20px; margin-top: 30px; transition: transform 0.1s; cursor: pointer;}
    .btn:active { transform: scale(0.95); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; background: #475569; }

    #qr-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 200; }
    .qr-box { background: white; padding: 30px; border-radius: 16px; text-align: center; color: black; }

    /* 辅机界面 */
    #screen-side { height: 100vh; background: #111; display: flex; flex-direction: column; align-items: center; padding-top: 40px; }
    #video-side { width: 60vw; height: 80vw; object-fit: cover; border-radius: 12px; border: 2px solid #3498db; transform: scaleX(-1); background: #000;}

    @keyframes pop { 0%{transform:translate(-50%,-50%) scale(0.5);opacity:0} 50%{transform:translate(-50%,-50%) scale(1.2);opacity:1} 100%{transform:translate(-50%,-50%) scale(1);opacity:0} }
    @keyframes shake { 0%,100%{transform:translate(-50%,-50%) translateX(0)} 25%{transform:translate(-50%,-50%) translateX(-10px)} 75%{transform:translate(-50%,-50%) translateX(10px)} }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="stage">
    <div id="teacher-view">
        <div class="absolute top-4 left-4 bg-black/50 text-white px-3 py-1 rounded font-mono">TEACHER</div>
        <video id="refVideo" playsinline></video>
        <canvas id="teacherCanvas"></canvas>
    </div>

    <div id="student-view">
        <div class="absolute top-4 left-4 bg-black/50 text-white px-3 py-1 rounded font-mono">YOU (1080P)</div>
        <video id="camVideo" autoplay muted playsinline></video>
        <canvas id="studentCanvas"></canvas>
    </div>

    <div id="ui-layer">
        <div class="top-panel">
            <div class="progress-box">
                <div class="stage-title" id="stageTitle">STAGE 1: 手部特训</div>
                <div class="bar-bg"><div class="bar-fill" id="masteryBar"></div></div>
                <div class="flex justify-between text-xs text-slate-400 mt-2">
                    <span>熟练度</span>
                    <span id="masteryText">0%</span>
                </div>
                
                <div class="level-indicators">
                    <div class="lvl-dot active" id="dot1"></div>
                    <div class="lvl-dot" id="dot2"></div>
                    <div class="lvl-dot" id="dot3"></div>
                </div>
            </div>
            
            <div class="side-status-box">
                <div id="side-led" class="led"></div>
                <span id="side-text" class="side-text">侧面未连接</span>
                <button onclick="showQrCode()" style="background:#334155; border:none; color:white; border-radius:50%; width:24px; height:24px; cursor:pointer;">+</button>
            </div>
        </div>

        <div id="feedback"></div>
    </div>

    <div id="qr-modal" class="hidden">
        <div class="qr-box">
            <h3 style="font-weight:bold; margin-bottom:10px;">连接侧面辅机</h3>
            <div id="qrcode"></div>
            <br><button onclick="document.getElementById('qr-modal').classList.add('hidden')" style="padding:5px 15px; border:1px solid #ccc; border-radius:5px;">关闭</button>
        </div>
    </div>
  </div>

  <div id="menu">
    <h1 class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-2">DANCE MASTER</h1>
    <p class="text-slate-400 mb-8 text-xl">竖屏高清版 · 智能拆解</p>

    <div id="role-select" class="flex gap-4 mb-8">
        <button onclick="selectRole('main')" class="btn" style="margin:0; background: #f59e0b;">我是主机 (电脑/iPad)</button>
        <button onclick="selectRole('side')" class="btn" style="margin:0; background: #3b82f6;">我是辅机 (手机)</button>
    </div>

    <div id="host-flow" class="flex gap-6 hidden">
        <div class="step-card">
            <div class="step-num">01</div>
            <h3 class="text-xl font-bold text-white mb-2">上传视频</h3>
            <p class="text-sm text-slate-400">推荐竖屏舞蹈视频</p>
            <button id="btnLoad" class="mt-4 bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm w-full">选择文件</button>
            <input type="file" id="fileInput" accept="video/*" class="hidden">
        </div>
        <div class="step-card">
            <div class="step-num">02</div>
            <h3 class="text-xl font-bold text-white mb-2">AI 拆解</h3>
            <p class="text-sm text-slate-400" id="aiStatus">初始化中...</p>
        </div>
        <div class="step-card">
            <div class="step-num">03</div>
            <h3 class="text-xl font-bold text-white mb-2">开始训练</h3>
            <button id="btnStart" class="mt-4 bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-sm w-full" disabled>开始</button>
        </div>
    </div>
  </div>

  <div id="screen-side" class="hidden">
    <h3 style="color:#3498db; margin-top:20px;">侧面监控运行中</h3>
    <div id="side-status" style="color:#aaa; margin-bottom:20px;">连接中...</div>
    <video id="video-side" playsinline muted autoplay></video>
    <div id="side-log" style="font-family:monospace; color:#2ecc71; margin-top:20px;">Ready</div>
  </div>

  <script type="module">
    import { FilesetResolver, PoseLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

    const BODY_PARTS = {
        upper: [11,12,13,14,15,16,23,24],
        lower: [23,24,25,26,27,28],
        full:  [11,12,13,14,15,16,23,24,25,26,27,28]
    };
    const STAGES = [
        { id: 'upper', name: 'STAGE 1: 上肢特训', color: '#3b82f6' },
        { id: 'lower', name: 'STAGE 2: 下肢步伐', color: '#eab308' },
        { id: 'full',  name: 'FINAL: 完整演出', color: '#10b981' }
    ];

    let currentStageIdx = 0;
    let masteryScore = 0;
    let isPlaying = false;
    let poseLandmarker;
    let refData = []; 
    
    let peer, conn;
    let sideData = { active: false, errors: [] };

    const els = {
        stage: document.getElementById('stage'),
        refVideo: document.getElementById('refVideo'),
        camVideo: document.getElementById('camVideo'),
        tCanvas: document.getElementById('teacherCanvas'),
        sCanvas: document.getElementById('studentCanvas'),
        btnLoad: document.getElementById('btnLoad'),
        fileInput: document.getElementById('fileInput'),
        btnStart: document.getElementById('btnStart'),
        aiStatus: document.getElementById('aiStatus'),
        menu: document.getElementById('menu'),
        hostFlow: document.getElementById('host-flow'),
        roleSelect: document.getElementById('role-select'),
        stageTitle: document.getElementById('stageTitle'),
        masteryBar: document.getElementById('masteryBar'),
        masteryText: document.getElementById('masteryText'),
        feedback: document.getElementById('feedback'),
        sideLed: document.getElementById('side-led'),
        sideText: document.getElementById('side-text')
    };
    const tCtx = els.tCanvas.getContext('2d');
    const sCtx = els.sCanvas.getContext('2d');

    window.selectRole = (role) => {
        els.roleSelect.classList.add('hidden');
        if(role === 'main') {
            els.hostFlow.classList.remove('hidden');
            initHost();
        } else {
            initSide();
        }
    };

    if(new URLSearchParams(window.location.search).get('role') === 'side') {
        els.menu.classList.add('hidden');
        initSide();
    }

    async function initHost() {
        els.aiStatus.textContent = "加载 AI...";
        const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
        poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
            baseOptions: {
                modelAssetPath: `https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task`,
                delegate: "GPU"
            },
            runningMode: "VIDEO",
            numPoses: 1
        });

        try {
            // 1080P 竖屏请求
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'user', width: { ideal: 1080 }, height: { ideal: 1920 } } 
            });
            els.camVideo.srcObject = stream;
            els.camVideo.play();
            els.aiStatus.textContent = "AI & 摄像头就绪";
        } catch(e) {
            els.aiStatus.textContent = "摄像头错误: " + e.message;
        }

        initPeerHost();
    }

    function generateRoomId() { return Math.floor(10000 + Math.random() * 90000).toString(); }
    window.showQrCode = () => document.getElementById('qr-modal').classList.remove('hidden');

    function initPeerHost() {
        const roomId = generateRoomId();
        const sideUrl = `${window.location.href.split('?')[0]}?role=side&room=${roomId}`;
        document.getElementById("qrcode").innerHTML = "";
        new QRCode(document.getElementById("qrcode"), { text: sideUrl, width: 180, height: 180 });

        peer = new Peer(`dance-host-${roomId}`);
        peer.on('connection', (c) => {
            conn = c;
            els.sideLed.classList.add('on');
            els.sideText.textContent = "侧面已连接";
            els.sideText.style.color = "#2ecc71";
            document.getElementById('qr-modal').classList.add('hidden');

            conn.on('data', (data) => {
                sideData = data;
                if(data.errors.length > 0) {
                    els.sideLed.className = 'led error';
                    els.sideText.textContent = data.errors[0];
                    els.sideText.style.color = '#e74c3c';
                } else {
                    els.sideLed.className = 'led on';
                    els.sideText.textContent = "侧面正常";
                    els.sideText.style.color = '#2ecc71';
                }
            });
        });
    }

    els.btnLoad.onclick = () => els.fileInput.click();
    els.fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if(file) {
            els.refVideo.src = URL.createObjectURL(file);
            els.btnLoad.textContent = "重新选择";
            els.btnStart.disabled = false;
            els.btnStart.classList.add('animate-pulse');
        }
    };

    els.btnStart.onclick = async () => {
        els.btnStart.disabled = true;
        els.btnStart.textContent = "拆解中...";
        if (els.refVideo.readyState < 1) {
            await new Promise(r => els.refVideo.onloadedmetadata = r);
        }
        await analyzeReference();
        els.menu.classList.add('hidden');
        startStage(0);
    };

    async function analyzeReference() {
        refData = [];
        els.refVideo.muted = true;
        els.refVideo.playbackRate = 1.0;
        
        return new Promise((resolve) => {
            els.refVideo.currentTime = 0;
            els.refVideo.onended = () => resolve(); 
            els.refVideo.play().catch(e => { alert("播放失败: " + e); resolve(); });

            let lastT = -1;
            const analyzeLoop = () => {
                if (els.refVideo.paused || els.refVideo.ended) return;
                const t = els.refVideo.currentTime;
                const dur = els.refVideo.duration || 1;
                const pct = Math.floor((t / dur) * 100);
                els.btnStart.textContent = `正在拆解... ${pct}%`;
                if (pct >= 99) { resolve(); return; } 

                if (t > lastT + 0.1) { 
                    const res = poseLandmarker.detectForVideo(els.refVideo, performance.now());
                    if (res.landmarks[0]) refData.push({ time: t, pose: res.landmarks[0] });
                    lastT = t;
                }
                requestAnimationFrame(analyzeLoop);
            };
            analyzeLoop();
        });
    }

    function startStage(idx) {
        currentStageIdx = idx;
        masteryScore = 0;
        updateUI();
        els.refVideo.currentTime = 0;
        els.refVideo.muted = false;
        els.refVideo.play();
        if(!isPlaying) { isPlaying = true; gameLoop(); }
    }

    function gameLoop() {
        if(!isPlaying) return;

        if (els.stage.clientWidth > 0) {
            tCtx.canvas.width = els.refVideo.clientWidth;
            tCtx.canvas.height = els.refVideo.clientHeight;
            sCtx.canvas.width = els.camVideo.clientWidth;
            sCtx.canvas.height = els.camVideo.clientHeight;
        }

        const currentTime = els.refVideo.currentTime;
        const refFrame = refData.find(f => Math.abs(f.time - currentTime) < 0.15);
        
        let studentRes = null;
        if (els.camVideo.readyState >= 2) {
             studentRes = poseLandmarker.detectForVideo(els.camVideo, performance.now());
        }
        
        tCtx.clearRect(0,0,tCtx.canvas.width, tCtx.canvas.height);
        sCtx.clearRect(0,0,sCtx.canvas.width, sCtx.canvas.height);

        if(refFrame && studentRes && studentRes.landmarks[0]) {
            const sPose = studentRes.landmarks[0];
            const rPose = refFrame.pose;
            const activeIndices = BODY_PARTS[STAGES[currentStageIdx].id];
            
            drawSelectivePose(tCtx, rPose, activeIndices, '#fbbf24', 4);
            drawSelectivePose(sCtx, sPose, activeIndices, '#fff', 2);

            const similarity = calculatePartSimilarity(sPose, rPose, activeIndices);
            updateGameLogic(similarity);
        }

        if(els.refVideo.ended) {
            els.refVideo.currentTime = 0;
            els.refVideo.play();
        }
        requestAnimationFrame(gameLoop);
    }

    function updateGameLogic(sim) {
        if (sideData.active && sideData.errors.length > 0) {
            showFeedback(sideData.errors[0], "fb-warn"); return; 
        }
        if(sim > 0.85) {
            masteryScore += 0.3; showFeedback("PERFECT", "fb-good");
        } else if(sim > 0.7) {
            masteryScore += 0.1;
        }
        masteryScore = Math.min(100, masteryScore);
        els.masteryBar.style.width = `${masteryScore}%`;
        els.masteryText.textContent = `${Math.floor(masteryScore)}%`;
        if(masteryScore >= 100) levelUp();
    }

    function levelUp() {
        if(currentStageIdx < STAGES.length - 1) {
            showFeedback("STAGE CLEAR!", "fb-good");
            masteryScore = 0;
            setTimeout(() => startStage(currentStageIdx + 1), 2000);
        } else {
            alert("恭喜通关！");
            location.reload();
        }
    }

    function calculatePartSimilarity(poseA, poseB, indices) {
        let totalDiff = 0;
        let count = 0;
        indices.forEach(idx => {
            const dx = poseA[idx].x - poseB[idx].x;
            const dy = poseA[idx].y - poseB[idx].y;
            totalDiff += Math.sqrt(dx*dx + dy*dy);
            count++;
        });
        return Math.max(0, 1 - (totalDiff / count / 0.15));
    }

    function drawSelectivePose(ctx, landmarks, activeIndices, color, width) {
        const w = ctx.canvas.width;
        const h = ctx.canvas.height;
        
        ctx.strokeStyle = "rgba(255,255,255,0.1)";
        ctx.lineWidth = 1;
        for(const conn of PoseLandmarker.POSE_CONNECTIONS) {
            const start = landmarks[conn.start];
            const end = landmarks[conn.end];
            ctx.beginPath();
            ctx.moveTo(start.x * w, start.y * h);
            ctx.lineTo(end.x * w, end.y * h);
            ctx.stroke();
        }

        ctx.strokeStyle = color;
        ctx.lineWidth = width;
        ctx.lineCap = "round";
        for(const conn of PoseLandmarker.POSE_CONNECTIONS) {
            if(activeIndices.includes(conn.start) && activeIndices.includes(conn.end)) {
                const start = landmarks[conn.start];
                const end = landmarks[conn.end];
                ctx.beginPath();
                ctx.moveTo(start.x * w, start.y * h);
                ctx.lineTo(end.x * w, end.y * h);
                ctx.stroke();
            }
        }
    }

    function showFeedback(text, cls) {
        const el = els.feedback;
        if(el.textContent) return;
        el.textContent = text;
        el.className = cls;
        setTimeout(() => { el.className = ""; el.textContent = ""; }, 800);
    }

    function updateUI() {
        const stage = STAGES[currentStageIdx];
        els.stageTitle.textContent = stage.name;
        els.stageTitle.style.color = stage.color;
        // 修复点：这里确保 dot 元素已经存在于 HTML 中
        [1,2,3].forEach((i, idx) => {
            const dot = document.getElementById(`dot${i}`);
            if(dot) {
                dot.className = 'lvl-dot';
                if(idx < currentStageIdx) dot.classList.add('done');
                if(idx === currentStageIdx) dot.classList.add('active');
            }
        });
    }

    function initSide() {
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        if(!roomId) return alert("请先在主机生成二维码并扫描");

        document.getElementById('screen-side').classList.remove('hidden');
        document.getElementById('menu').classList.add('hidden');

        const peer = new Peer();
        let poseSide;
        let lastSend = 0;

        peer.on('open', () => {
            const conn = peer.connect(`dance-host-${roomId}`);
            conn.on('open', () => {
                document.getElementById('side-status').innerText = "✅ 已连接主机";
                document.getElementById('side-status').style.color = "#2ecc71";
                
                navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user', width: 640, height: 480 }, audio: false 
                }).then(async (stream) => {
                    const video = document.getElementById('video-side');
                    video.srcObject = stream;
                    
                    const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
                    poseSide = await PoseLandmarker.createFromOptions(vision, {
                        baseOptions: {
                            modelAssetPath: `https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task`,
                            delegate: "GPU"
                        },
                        runningMode: "VIDEO",
                        numPoses: 1
                    });

                    const loop = () => {
                        if(video.readyState >= 2) {
                            const now = Date.now();
                            if (now - lastSend > 100) { 
                                const res = poseSide.detectForVideo(video, performance.now());
                                let errors = [];
                                if(res.landmarks[0]) {
                                    const lm = res.landmarks[0];
                                    let isLeft = lm[7].visibility > lm[8].visibility;
                                    let sh = isLeft ? lm[11] : lm[12];
                                    let hip = isLeft ? lm[23] : lm[24];
                                    let lean = sh.x - hip.x;
                                    
                                    if(Math.abs(lean) > 0.08) errors.push(lean > 0 ? "后仰" : "前倾");
                                    document.getElementById('side-log').innerText = errors.length ? `⚠ ${errors[0]}` : "体态正常";
                                }
                                conn.send({ active: true, errors: errors });
                                lastSend = now;
                            }
                        }
                        requestAnimationFrame(loop);
                    };
                    loop();
                });
            });
        });
    }
  </script>
</body>
</html>