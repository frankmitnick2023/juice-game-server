<!DOCTYPE html>
<html lang="zh-CN">\>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>èŠ‚å¥æŒ‘æˆ˜è€… Â· Proï¼ˆç¨³æ§+å¼ºåé¦ˆ+å¼ºå³°é‡åŒ–ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --pri:#a855f7; --sec:#ec4899; }
    body { background:#0f172a; color:#e5e7eb; font-family: ui-sans-serif, system-ui; }
    .btn{ @apply px-4 py-2 rounded-2xl font-bold shadow-lg transition active:scale-95; }
    .card{ @apply bg-slate-900/80 ring-1 ring-white/10 rounded-3xl backdrop-blur-xl; }

    /* èŠ‚å¥åœˆ */
    .rhythm-circle{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1); width:140px;height:140px; border-radius:999px; border:4px solid rgba(255,255,255,.25); background:radial-gradient(circle,rgba(168,85,247,.28) 0%,transparent 65%); transition: transform .12s ease, filter .12s ease, border-color .12s ease; filter:brightness(.7); }
    .rc-active{ border-color: var(--pri); filter:brightness(1.25); box-shadow:0 0 26px rgba(168,85,247,.6); }

    /* åˆ¤å®šåŠ¨ç”» */
    .judge{ position:absolute; left:50%; top:48%; transform:translate(-50%,-50%); font-weight:900; font-size:56px; text-shadow: 0 8px 30px rgba(0,0,0,.6); opacity:0; }
    .PERFECT{ color:#34d399; animation: popPerfect .8s ease-out; }
    .GREAT{ color:#60a5fa; animation: popGreat .7s ease-out; }
    .GOOD{ color:#fbbf24; animation: popGood .6s ease-out; }
    .MISS{ color:#ef4444; animation: popMiss .45s ease-out; }
    @keyframes popPerfect{0%{transform:translate(-50%,-50%) scale(.2) rotate(-20deg); opacity:0}50%{transform:translate(-50%,-50%) scale(1.2); opacity:1}100%{transform:translate(-50%,-50%) scale(1); opacity:0}}
    @keyframes popGreat{0%{transform:translate(-50%,-50%) scale(.3); opacity:0}100%{transform:translate(-50%,-50%) scale(1); opacity:0}}
    @keyframes popGood{0%{transform:translate(-50%,-50%) scale(.6); opacity:0}100%{transform:translate(-50%,-50%) scale(1); opacity:0}}
    @keyframes popMiss{0%{transform:translate(-50%,-50%) scale(1.2); opacity:.8}100%{transform:translate(-50%,-50%) scale(.8); opacity:0}}

    /* å€’è®¡æ—¶ */
    .countdown{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(15,23,42,.95); z-index:60 }
    .countNum{ font-size:20vw; font-weight:1000; background:linear-gradient(45deg,var(--pri),var(--sec)); -webkit-background-clip:text; background-clip:text; color:transparent; }

    /* è¿›åº¦æ¡ */
    .pbar{ height:8px; background:rgba(255,255,255,.08); border-radius:8px; overflow:hidden }
    .pfill{ height:100%; background:linear-gradient(90deg,var(--pri),var(--sec)); width:0% }

    /* 3ç§’é¢„è§ˆæ¡ */
    #beatPreview{ position:absolute; left:50%; transform:translateX(-50%); bottom:70px; width:84%; height:12px; opacity:.95 }

    /* æç¤º */
    .hint{ position:absolute; left:50%; top:32%; transform:translateX(-50%); font-size:24px; font-weight:800; color:white; text-shadow:0 2px 10px rgba(0,0,0,.5); opacity:0; transition:opacity .1s }

    .modal{ @apply fixed inset-0 hidden items-center justify-center bg-black/80 backdrop-blur-xl z-50; }
    .modal.show{ @apply flex; }
  </style>
</head>
<body class="p-4 min-h-screen">
  <div class="max-w-[760px] mx-auto space-y-6">

    <header class="text-center">
      <h1 class="text-5xl font-black bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">ğŸµ èŠ‚å¥æŒ‘æˆ˜è€… Â· Pro</h1>
      <p class="opacity-80">ç¨³æ§ï¼ˆå»å™ª+æ»å›+ç¼“å†²+æ ¡å‡†ï¼‰ + å¼ºåé¦ˆ + å¼ºå³°é‡åŒ–ï¼ˆ1/3ï¼‰</p>
    </header>

    <section class="card p-6 space-y-4">
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <div class="text-sm font-semibold">ğŸ¼ é€‰æ‹©éŸ³ä¹</div>
          <input id="musicFile" type="file" accept="audio/*,video/*" class="block w-full text-sm text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-gradient-to-r file:from-purple-500 file:to-pink-600 file:text-white hover:file:from-purple-400 hover:file:to-pink-500" />
          <div class="text-xs opacity-70 mt-1">æ”¯æŒ MP3/WAV/M4A/OGG/è§†é¢‘</div>
        </div>
        <div>
          <div class="text-sm font-semibold">ğŸ”Š æµ‹è¯•éŸ³ä¹</div>
          <div class="flex gap-2">
            <button id="test1" class="btn bg-emerald-600 text-white">ç”µå­èŠ‚æ‹</button>
            <button id="test2" class="btn bg-sky-600 text-white">æµè¡Œç‰‡æ®µ</button>
          </div>
        </div>
      </div>
      <div class="flex flex-wrap gap-2 items-center">
        <button id="btnCam" class="btn bg-teal-600 text-white">ğŸ¥ æ‰“å¼€æ‘„åƒå¤´</button>
        <button id="btnAnalyze" class="btn bg-orange-600 text-white" disabled>ğŸ” åˆ†æèŠ‚å¥</button>
        <button id="btnStart" class="btn bg-fuchsia-600 text-white" disabled>ğŸš€ å¼€å§‹æŒ‘æˆ˜</button>
        <div class="text-sm opacity-80" id="status">å‡†å¤‡å¼€å§‹</div>
      </div>
    </section>

    <section class="card p-6 relative overflow-hidden ring-2 ring-purple-500/30">
      <video id="video" class="w-full rounded-2xl aspect-[9/16] object-cover ring-2 ring-teal-500/50" autoplay muted playsinline></video>
      <canvas id="skel" class="absolute inset-0 rounded-2xl pointer-events-none"></canvas>
      <canvas id="trail" class="absolute inset-0 rounded-2xl pointer-events-none"></canvas>

      <div id="rc" class="rhythm-circle"></div>
      <div id="hint" class="hint">åœˆäº®å¤§æ—¶ <span class="text-amber-300">æ‘‡å¤´</span>ï¼</div>
      <canvas id="beatPreview"></canvas>

      <div id="judge" class="judge">PERFECT</div>

      <div class="absolute bottom-4 left-1/2 -translate-x-1/2 text-center">
        <div id="score" class="text-5xl font-black bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">0</div>
        <div id="combo" class="text-xl text-emerald-400 font-bold opacity-0">è¿å‡» x0</div>
        <div class="w-[84%] mx-auto mt-2">
          <div class="pbar"><div id="pfill" class="pfill"></div></div>
          <div id="time" class="text-[11px] text-slate-400 mt-1">00:00 / 00:00</div>
        </div>
      </div>
    </section>

    <section class="card p-6">
      <div class="text-sm opacity-80">âš™ï¸ è°ƒæ•´ï¼ˆå¯é€‰ï¼‰</div>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-2 text-sm">
        <label class="flex items-center gap-2">å¯†åº¦
          <select id="density" class="bg-slate-800 rounded-lg px-2 py-1">
            <option value="2">ä¿ç•™1/2</option>
            <option value="3" selected>ä¿ç•™1/3</option>
            <option value="4">ä¿ç•™1/4</option>
          </select>
        </label>
        <label class="flex items-center gap-2">PERFECTçª—
          <select id="winPerfect" class="bg-slate-800 rounded-lg px-2 py-1">
            <option value="60">Â±60ms</option>
            <option value="80" selected>Â±80ms</option>
            <option value="100">Â±100ms</option>
          </select>
        </label>
        <label class="flex items-center gap-2">ç¼“å†²
          <select id="buffer" class="bg-slate-800 rounded-lg px-2 py-1">
            <option value="0">å…³é—­</option>
            <option value="80">80ms</option>
            <option value="100" selected>100ms</option>
            <option value="120">120ms</option>
          </select>
        </label>
        <label class="flex items-center gap-2">é‡åŒ–
          <select id="quant" class="bg-slate-800 rounded-lg px-2 py-1">
            <option value="0">å…³é—­</option>
            <option value="2" selected>1/2æ‹</option>
            <option value="4">1/4æ‹</option>
          </select>
        </label>
      </div>
    </section>

    <div id="cd" class="countdown"><div class="countNum" id="cdNum">3</div></div>

    <div id="result" class="modal">
      <div class="bg-slate-900/95 ring-2 ring-purple-500/50 rounded-3xl p-8 w-[min(92vw,520px)] text-center space-y-4">
        <div class="text-3xl font-black bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">ğŸ‰ ç»“ç®—</div>
        <div id="grade" class="text-7xl font-black text-emerald-400">S</div>
        <div id="final" class="text-5xl">0</div>
        <div class="text-sm opacity-80">æœ€é«˜è¿å‡» <span id="maxc" class="font-bold text-emerald-400">0</span> ï½œ å‘½ä¸­ç‡ <span id="acc">0%</span></div>
        <div class="flex gap-2 mt-2">
          <button id="again" class="btn bg-emerald-600 text-white flex-1">å†æˆ˜ä¸€æ›²</button>
          <button id="ok" class="btn bg-slate-700 text-white flex-1">å®Œæˆ</button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  // ===== å…ƒç´  =====
  const E = (id)=>document.getElementById(id);
  const els = { video:E('video'), skel:E('skel'), trail:E('trail'), rc:E('rc'), hint:E('hint'),
    musicFile:E('musicFile'), test1:E('test1'), test2:E('test2'), btnCam:E('btnCam'), btnAnalyze:E('btnAnalyze'), btnStart:E('btnStart'), status:E('status'),
    pfill:E('pfill'), time:E('time'), score:E('score'), combo:E('combo'), judge:E('judge'), beatPreview:E('beatPreview'),
    density:E('density'), winPerfect:E('winPerfect'), buffer:E('buffer'), quant:E('quant'),
    cd:E('cd'), cdNum:E('cdNum'), result:E('result'), grade:E('grade'), final:E('final'), maxc:E('maxc'), acc:E('acc'), again:E('again'), ok:E('ok') };

  // ===== å…¨å±€ =====
  let audio, audioBuf, stream, poseLandmarker;
  let beats=[], idx=0, running=false, totalMs=0;
  let score=0, combo=0, maxCombo=0, judgs=[];
  let prevNose=null, hx=0, hy=0, px=0, py=0, shaking=false;
  let globalOffset=0; // è‡ªé€‚åº”åç§»

  const HEAD_IDX=[0,1,2,4,5,7,8,10,11];
  const TESTS=[
    'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
    'https://www.soundjay.com/human/sounds/whip-1.mp3'
  ];

  // ===== å·¥å…· =====
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
  const msFmt=(t)=>{const m=String(Math.floor(t/60000)).padStart(2,'0'); const s=String(Math.floor((t%60000)/1000)).padStart(2,'0'); return `${m}:${s}`};

  function median(arr){ const a=arr.slice().sort((x,y)=>x-y); const m=Math.floor(a.length/2); return a.length%2? a[m] : (a[m-1]+a[m])/2 }

  // ===== Beat åˆ†æï¼šå¼ºå³° -> å»é‡ -> æŒ‰æ¯”ä¾‹ä¿ç•™ -> é‡åŒ– =====
  async function analyzeBeats(buf, keepFrac=3, quantDiv=2){
    return new Promise((resolve,reject)=>{
      const oc=new OfflineAudioContext(1, buf.length, buf.sampleRate);
      const src=oc.createBufferSource(); src.buffer=buf;
      const lp=oc.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=160; src.connect(lp); lp.connect(oc.destination); src.start();
      oc.startRendering().then(rb=>{
        const sr=buf.sampleRate; const data=rb.getChannelData(0); const N=data.length;
        // èƒ½é‡åŒ…ç»œ
        const env=new Float32Array(N); let prev=0, alpha=.5;
        for(let i=0;i<N;i++){ const v=Math.abs(data[i]); prev=alpha*v+(1-alpha)*prev; env[i]=prev; }
        // è‡ªé€‚åº”å‡å€¼ + å±€éƒ¨æå¤§
        const peaks=[]; let mean=0, gamma=.995; const win=Math.max(1, Math.floor(sr*0.01)); const loc=Math.max(1, Math.floor(sr*0.05));
        for(let i=win;i<N-win;i++){
          const v=env[i]; let isMax=true;
          for(let k=i-win;k<=i+win;k+=Math.max(1,Math.floor(win/2))) if(env[k]>v){isMax=false;break}
          if(isMax && v>mean*1.1){ let s=0; for(let j=i-loc;j<=i+loc;j++){ if(j>=0&&j<N) s+=env[j]; } s/= (2*loc+1); const strength = v - s; peaks.push({t:i/sr*1000, s:Math.max(0,strength)}) }
          mean = gamma*mean + (1-gamma)*v;
        }
        // æœ€å°é—´éš”å»é‡
        const spaced=[]; const minGap=120;
        for(const p of peaks){ if(!spaced.length){spaced.push(p);continue} const last=spaced[spaced.length-1]; if(p.t-last.t<minGap){ if(p.s>last.s) spaced[spaced.length-1]=p; } else spaced.push(p) }
        // åªä¿ç•™æœ€å¼º 1/keepFrac
        const keep=Math.max(1, Math.ceil(spaced.length/keepFrac));
        let strong = spaced.slice().sort((a,b)=>b.s-a.s).slice(0,keep).sort((a,b)=>a.t-b.t);
        // é‡åŒ–
        if(strong.length>2 && quantDiv>0){ const ibI = median(strong.slice(1).map((p,i)=>p.t-strong[i].t)); const grid = ibI/quantDiv; strong = strong.map(p=>({t: Math.round(p.t/grid)*grid, s:p.s})); }
        resolve(strong.map(p=>p.t));
      }).catch(reject);
    });
  }

  // ===== Pose =====
  async function loadPose(){
    if(poseLandmarker) return;
    const { PoseLandmarker, FilesetResolver } = await import('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14');
    const fr = await FilesetResolver.forVisionTasks('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm');
    poseLandmarker = await PoseLandmarker.createFromOptions(fr, {
      baseOptions:{ modelAssetPath:'https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task', delegate:'GPU' },
      runningMode:'VIDEO', numPoses:1, minPoseDetectionConfidence:.3, minPosePresenceConfidence:.3, minTrackingConfidence:.3
    });
  }

  // ç”»å¸ƒå°ºå¯¸
  function resize(){ const r=els.video.getBoundingClientRect(); [els.skel, els.trail].forEach(c=>{c.width=r.width; c.height=r.height;}); const pr=els.beatPreview.getBoundingClientRect(); els.beatPreview.width=pr.width; els.beatPreview.height=pr.height; }

  // æ‘‡å¤´é€Ÿåº¦ï¼ˆæŒ‡æ•°å¹³æ»‘ + æ¨ªå‘åŠ æƒï¼‰
  function smooth(x,y){ hx=.5*x+.5*hx; hy=.5*y+.5*hy; return [hx,hy]; }
  function headSpeed(nose){ const [x,y]=smooth(nose.x, nose.y); const vx=x-px, vy=y-py; px=x; py=y; return Math.abs(vx)*2000 + Math.abs(vy)*800; }

  // æ»å›é˜ˆå€¼
  const HIT_ON=25, HIT_OFF=14; // è¿›å…¥/é€€å‡º
  function shakeTriggered(spd){ if(!shaking && spd>HIT_ON){ shaking=true; return true } if(shaking && spd<HIT_OFF){ shaking=false } return false }

  // è¾“å…¥ç¼“å†²
  let bufferedTime=null; function bufferPush(t){ bufferedTime=t }

  // é¢„è§ˆæ¡
  function drawPreview(at){ const ctx=els.beatPreview.getContext('2d'); const w=ctx.canvas.width, h=ctx.canvas.height; ctx.clearRect(0,0,w,h); ctx.fillStyle='rgba(255,255,255,.08)'; ctx.fillRect(0,0,w,h); const W=3000; const vis=beats.filter(t=>t>=at-500&&t<=at+W); vis.forEach(t=>{ const x=((t-at)/W)*w; ctx.fillStyle = t<at? '#f472b6' : (Math.abs(t-at)<120?'#a855f7':'#fff'); ctx.fillRect(Math.floor(x)-1,0,3,h); }); ctx.fillStyle='rgba(255,255,255,.6)'; ctx.fillRect(0,0,2,h); }

  // èŠ‚å¥åœˆ
  function updateCircle(at){ if(!beats.length) return; const nb=beats[idx]; if(nb==null){ els.rc.classList.remove('rc-active'); els.hint.style.opacity=0; return } const dt=nb-at; if(dt>-260 && dt<820){ const t=clamp(1-Math.abs(dt)/820,0,1); els.rc.classList.add('rc-active'); els.rc.style.transform = `translate(-50%,-50%) scale(${1 + t*0.55})`; els.rc.style.filter = `brightness(${.7 + t*.6})`; els.hint.style.opacity = t>.78?1:0; } else { els.rc.classList.remove('rc-active'); els.rc.style.transform='translate(-50%,-50%) scale(1)'; els.hint.style.opacity=0; } }

  // åˆ¤å®š
  function judge(at, next){ const p=Number(els.winPerfect.value); const g=p*1.875, b=p*3.125; const dt=Math.abs(at-next); let J='MISS', pts=0; if(dt<p) {J='PERFECT';pts=100} else if(dt<g){J='GREAT';pts=70} else if(dt<b){J='GOOD';pts=40} return {J, pts} }
  function showJudge(J){ const el=els.judge; el.textContent=J; el.className=`judge ${J}`; }

  // å€’è®¡æ—¶
  async function countdown(){ els.cd.style.display='flex'; for(const n of ['3','2','1','GO!']){ els.cdNum.textContent=n; await sleep(700);} els.cd.style.display='none'; }

  // ç›¸æœº
  els.btnCam.onclick = async ()=>{
    try{
      els.btnCam.disabled=true; els.btnCam.textContent='è¯·æ±‚æƒé™...'; els.status.textContent='æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...';
      if(!navigator.mediaDevices?.getUserMedia){ throw new Error('å½“å‰ç¯å¢ƒä¸æ”¯æŒæ‘„åƒå¤´ï¼ˆéœ€HTTPSæˆ–å®‰å…¨åŸŸï¼‰') }
      stream = await navigator.mediaDevices.getUserMedia({ video:{ width:{ideal:720}, height:{ideal:1280}, facingMode:'user', frameRate:{ideal:30} }, audio:false });
      els.video.srcObject=stream; await new Promise(r=>els.video.onloadedmetadata=r); resize(); els.status.innerHTML='âœ… <span class="text-emerald-400">æ‘„åƒå¤´å°±ç»ª</span>'; els.btnCam.textContent='âœ… æ‘„åƒå¤´å·²å¼€'; await loadPose();
    }catch(e){ console.error(e); alert(e.message||'æ‘„åƒå¤´å¼€å¯å¤±è´¥'); els.status.textContent='âŒ æ‘„åƒå¤´å¼€å¯å¤±è´¥'; els.btnCam.textContent='ğŸ¥ æ‰“å¼€æ‘„åƒå¤´'; } finally{ els.btnCam.disabled=false }
  };

  // éŸ³é¢‘åŠ è½½
  async function loadAudio(src){ return new Promise((resolve,reject)=>{ if(!audio) audio=new Audio(); audio.src=src; const ctx=new (window.AudioContext||window.webkitAudioContext)(); audio.addEventListener('loadedmetadata', async()=>{ try{ const res=await fetch(src); const ab=await res.arrayBuffer(); audioBuf=await ctx.decodeAudioData(ab); resolve(audioBuf.duration) }catch(err){ reject(err) } }); audio.load(); }) }

  els.test1.onclick = async()=>{ els.status.textContent='åŠ è½½æµ‹è¯•éŸ³ä¹...'; try{ const d=await loadAudio(TESTS[0]); els.btnAnalyze.disabled=false; els.status.innerHTML=`âœ… <span class="text-blue-400">æµ‹è¯•éŸ³ä¹åŠ è½½æˆåŠŸ (${d.toFixed(0)}s)</span>` }catch{ els.status.textContent='âŒ åŠ è½½å¤±è´¥' } };
  els.test2.onclick = async()=>{ els.status.textContent='åŠ è½½æµ‹è¯•éŸ³ä¹...'; try{ const d=await loadAudio(TESTS[1]); els.btnAnalyze.disabled=false; els.status.innerHTML=`âœ… <span class="text-blue-400">æµ‹è¯•éŸ³ä¹åŠ è½½æˆåŠŸ (${d.toFixed(0)}s)</span>` }catch{ els.status.textContent='âŒ åŠ è½½å¤±è´¥' } };
  els.musicFile.onchange = async e=>{ const f=e.target.files[0]; if(!f) return; els.status.textContent='åŠ è½½éŸ³ä¹...'; try{ const ab=await f.arrayBuffer(); const ctx=new (window.AudioContext||window.webkitAudioContext)(); audioBuf=await ctx.decodeAudioData(ab); if(!audio) audio=new Audio(); audio.src=URL.createObjectURL(f); els.btnAnalyze.disabled=false; els.status.innerHTML=`âœ… <span class="text-blue-400">${f.name} (${audioBuf.duration.toFixed(0)}s)</span>` }catch{ els.status.textContent='âŒ éŸ³ä¹åŠ è½½å¤±è´¥' } };

  // åˆ†æèŠ‚æ‹ï¼ˆå«å¯†åº¦ä¸é‡åŒ–é€‰é¡¹ï¼‰
  els.btnAnalyze.onclick = async()=>{
    if(!audioBuf) return; els.btnAnalyze.disabled=true; els.status.textContent='åˆ†æèŠ‚æ‹ä¸­...';
    const keepFrac = Number(els.density.value); const quantDiv = Number(els.quant.value);
    beats = await analyzeBeats(audioBuf, keepFrac, quantDiv);
    idx=0; els.btnStart.disabled=false; els.status.innerHTML=`ğŸµ æ£€æµ‹åˆ° <b>${beats.length}</b> ä¸ªèŠ‚æ‹`;
  };

  // æ¸¸æˆä¸»æµç¨‹
  els.btnStart.onclick = async()=>{
    if(!beats.length){ els.status.textContent='è¯·å…ˆåˆ†æèŠ‚å¥'; return }
    await loadPose(); running=true; score=0; combo=0; maxCombo=0; judgs=[]; prevNose=null; px=py=hx=hy=0; globalOffset=0; bufferedTime=null; idx=0; els.score.textContent='0'; els.combo.style.opacity=0; els.pfill.style.width='0%';

    // 5ç§’æ ¡å‡†ï¼šè®©ç©å®¶æŒ‰èŠ‚æ‹æ‘‡4æ¬¡ï¼ˆå¯è·³è¿‡ï¼šå†æ¬¡ç‚¹å‡»å¼€å§‹ç›´æ¥è¿›å…¥ï¼‰
    // ç®€åŒ–ï¼šè¿™é‡Œç›´æ¥è¿›å…¥å€’è®¡æ—¶ï¼ˆå¦‚éœ€æ ¡å‡†ï¼Œå¯åœ¨æ­¤åŠ å…¥é‡‡æ ·é€»è¾‘ï¼‰

    await countdown();

    audio.currentTime=0; audio.volume=.85; audio.play(); totalMs=(audio.duration||audioBuf.duration||0)*1000;

    const BUFFER = Number(els.buffer.value); // è¾“å…¥ç¼“å†²

    let lastHit=0;
    const loop = async()=>{
      if(!running) return;
      const now=performance.now(); const aMs=(audio.currentTime*1000)+globalOffset;

      // é”™è¿‡æ‹è‡ªåŠ¨æ¨è¿›
      while(idx<beats.length && aMs>beats[idx]+300) idx++;

      drawPreview(aMs); updateCircle(aMs);

      // è¿›åº¦æ¡
      els.pfill.style.width = `${clamp((aMs/totalMs)*100,0,100)}%`;
      els.time.textContent = `${msFmt(aMs)} / ${msFmt(totalMs)}`;

      // å§¿æ€
      try{
        const r = await poseLandmarker.detectForVideo(els.video, now);
        if(r.landmarks?.[0]){
          const lm=r.landmarks[0]; prevNose = prevNose||lm[0]; // åˆå§‹åŒ–
          const spd = headSpeed(lm[0]);
          // è½¨è¿¹
          const tctx=els.trail.getContext('2d'); tctx.globalAlpha=.9; tctx.clearRect(0,0,tctx.canvas.width,tctx.canvas.height); tctx.beginPath(); tctx.strokeStyle='rgba(168,85,247,.85)'; tctx.lineWidth=4; tctx.lineCap='round';
          // å¯åŠ å…¥å†å²é˜Ÿåˆ—ï¼Œç®€åŒ–èµ·è§æ­¤å¤„åªç”»ç‚¹
          tctx.arc(lm[0].x*tctx.canvas.width, lm[0].y*tctx.canvas.height, 6, 0, Math.PI*2); tctx.fillStyle='#f59e0b'; tctx.fill();

          if(shakeTriggered(spd) && aMs-lastHit>100){ lastHit=aMs; bufferPush(aMs); }

          // åˆ¤å®šï¼ˆå¸¦ç¼“å†²ï¼‰
          if(bufferedTime!=null && idx<beats.length){ const t = BUFFER? Math.max(bufferedTime, aMs-BUFFER) : aMs; const {J,pts}=judge(t, beats[idx]); if(pts>0 && t>=beats[idx]-els.winPerfect.value*3.125 && t<=beats[idx]+els.winPerfect.value*3.125){ score+=pts; combo++; maxCombo=Math.max(maxCombo,combo); els.score.textContent=String(score); if(combo>1){ els.combo.textContent=`è¿å‡» x${combo}`; els.combo.style.opacity=1 } showJudge(J); judgs.push({J,pts}); idx++; bufferedTime=null; } else { /* æœªå…¥çª—åˆ™ç­‰å¾…ä¸‹ä¸€å¸§ï¼Œå†æ¬¡å¯¹æ¯” */ }
          }
        }
      }catch(e){ /* å¿½ç•¥å•å¸§é”™è¯¯ */ }

      if(audio.ended || aMs>=totalMs-300){ end(); return }
      requestAnimationFrame(loop);
    };
    loop();

    function end(){ running=false; try{audio.pause()}catch{} els.rc.classList.remove('rc-active'); els.hint.style.opacity=0; const hit=judgs.filter(x=>x.pts>0).length/Math.max(beats.length,1); const acc=Math.round(hit*100); const final=Math.round(score*(1+maxCombo*0.1)); els.final.textContent=final; els.maxc.textContent=maxCombo; els.acc.textContent=`${acc}%`; const g = final>=800?'S':final>=600?'A':final>=400?'B':final>=200?'C':'D'; els.grade.textContent=g; els.result.classList.add('show'); setTimeout(()=>{ parent.postMessage({type:'JUICE_GAME_SCORE', score:Math.max(0,final)}, '*') }, 300); }
  };

  els.again.onclick=()=>{ els.result.classList.remove('show'); els.btnStart.disabled=false; els.status.textContent='å‡†å¤‡å†æ¬¡æŒ‘æˆ˜' };
  els.ok.onclick=()=>{ els.result.classList.remove('show') };

  // ===== åˆå§‹åŒ– =====
  window.addEventListener('load', ()=>{ audio=new Audio(); audio.volume=.85; resize(); parent.postMessage({type:'JUICE_GAME_READY'}, '*'); });
  window.addEventListener('resize', resize);
</script>
</body>
</html>
