<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>èŠ‚å¥æŒ‘æˆ˜è€… Â· æ•™å­¦ç‰ˆï¼ˆæ‘‡å¤´/ç‚¹å¤´ + èŠ‚æ‹ç½‘æ ¼ + TapTempoï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --pri:#a855f7; --sec:#ec4899; --ok:#10b981; --warn:#f59e0b; --err:#ef4444 }
    body { background:#0f172a; color:#e5e7eb; font-family: ui-sans-serif,system-ui }
    .card{ @apply bg-slate-900/80 ring-1 ring-white/10 rounded-3xl backdrop-blur-xl }
    .btn{ @apply px-4 py-2 rounded-2xl font-bold shadow-lg transition active:scale-95 }
    .rhythm-circle{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1); width:150px;height:150px; border-radius:999px; border:5px solid rgba(255,255,255,.25); background:radial-gradient(circle,rgba(168,85,247,.28) 0%,transparent 65%); transition: transform .12s ease, filter .12s ease, border-color .12s ease }
    .rc-active{ border-color: var(--pri); filter:brightness(1.25); box-shadow:0 0 26px rgba(168,85,247,.6) }
    .rc-downbeat{ border-color:#22d3ee; box-shadow:0 0 28px rgba(34,211,238,.75) }
    .judge{ position:absolute; left:50%; top:48%; transform:translate(-50%,-50%); font-weight:900; font-size:56px; text-shadow:0 8px 30px rgba(0,0,0,.6); opacity:0 }
    .PERFECT{ color:#34d399; animation: popPerfect .8s ease-out }
    .GREAT{ color:#60a5fa; animation: popGreat .7s ease-out }
    .GOOD{ color:#fbbf24; animation: popGood .6s ease-out }
    .MISS{ color:#ef4444; animation: popMiss .45s ease-out }
    @keyframes popPerfect{0%{transform:translate(-50%,-50%) scale(.2) rotate(-20deg); opacity:0}50%{transform:translate(-50%,-50%) scale(1.2); opacity:1}100%{transform:translate(-50%,-50%) scale(1); opacity:0}}
    @keyframes popGreat{0%{transform:translate(-50%,-50%) scale(.3); opacity:0}100%{transform:translate(-50%,-50%) scale(1); opacity:0}}
    @keyframes popGood{0%{transform:translate(-50%,-50%) scale(.6); opacity:0}100%{transform:translate(-50%,-50%) scale(1); opacity:0}}
    @keyframes popMiss{0%{transform:translate(-50%,-50%) scale(1.2); opacity:.8}100%{transform:translate(-50%,-50%) scale(.8); opacity:0}}
    .pbar{ height:8px; background:rgba(255,255,255,.08); border-radius:8px; overflow:hidden }
    .pfill{ height:100%; background:linear-gradient(90deg,var(--pri),var(--sec)); width:0% }
    #beatPreview{ position:absolute; left:50%; transform:translateX(-50%); bottom:70px; width:86%; height:14px; opacity:.95 }
    .hint{ position:absolute; left:50%; top:32%; transform:translateX(-50%); font-size:22px; font-weight:800; color:white; text-shadow:0 2px 10px rgba(0,0,0,.5); opacity:0; transition:opacity .1s }
    .countdown{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(15,23,42,.95); z-index:60 }
    .countNum{ font-size:20vw; font-weight:1000; background:linear-gradient(45deg,var(--pri),var(--sec)); -webkit-background-clip:text; background-clip:text; color:transparent }
    .modal{ @apply fixed inset-0 hidden items-center justify-center bg-black/80 backdrop-blur-xl z-50 }
    .modal.show{ @apply flex }
  </style>
</head>
<body class="p-4 min-h-screen">
  <div class="max-w-[820px] mx-auto space-y-6">
    <header class="text-center space-y-1">
      <h1 class="text-5xl font-black bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">ğŸµ èŠ‚å¥æŒ‘æˆ˜è€… Â· æ•™å­¦ç‰ˆ</h1>
      <p class="opacity-80">æ‘‡å¤´ / ç‚¹å¤´ ä»»é€‰ï¼›èŠ‚æ‹ç½‘æ ¼ï¼ˆå°èŠ‚/å¼ºæ‹ï¼‰ï¼›Tap Tempoï¼›å¯å‡é€Ÿï¼›é€‚åˆè®­ç»ƒèŠ‚å¥æ„Ÿ</p>
    </header>

    <!-- æ§åˆ¶åŒº -->
    <section class="card p-6 space-y-4">
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <div class="text-sm font-semibold">ğŸ¼ é€‰æ‹©éŸ³ä¹</div>
          <input id="musicFile" type="file" accept="audio/*,video/*" class="block w-full text-sm text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-gradient-to-r file:from-purple-500 file:to-pink-600 file:text-white hover:file:from-purple-400 hover:file:to-pink-500" />
          <div class="text-xs opacity-70 mt-1">æ”¯æŒ MP3/WAV/M4A/OGG/è§†é¢‘</div>
        </div>
        <div>
          <div class="text-sm font-semibold">ğŸ”Š æµ‹è¯•éŸ³ä¹</div>
          <div class="flex gap-2">
            <button id="test1" class="btn bg-emerald-600 text-white">ç”µå­èŠ‚æ‹</button>
            <button id="test2" class="btn bg-sky-600 text-white">æµè¡Œç‰‡æ®µ</button>
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-4">
        <div class="space-y-1">
          <div class="text-sm font-semibold">ğŸ® åŠ¨ä½œé€‰æ‹©</div>
          <select id="gesture" class="w-full bg-slate-800 rounded-xl px-3 py-2">
            <option value="shake" selected>æ‘‡å¤´ï¼ˆå·¦å³ï¼‰</option>
            <option value="nod">ç‚¹å¤´ï¼ˆä¸Šä¸‹ï¼‰</option>
            <option value="either">ä»»ä¸€ï¼ˆå·¦å³æˆ–ä¸Šä¸‹ï¼‰</option>
          </select>
        </div>
        <div class="space-y-1">
          <div class="text-sm font-semibold">â±ï¸ èŠ‚æ‹æ¥æº</div>
          <select id="tempoMode" class="w-full bg-slate-800 rounded-xl px-3 py-2">
            <option value="auto" selected>è‡ªåŠ¨æ£€æµ‹</option>
            <option value="tap">Tap Tempoï¼ˆæ‰‹åŠ¨æ•²æ‹ï¼‰</option>
            <option value="fixed">å›ºå®š BPM</option>
          </select>
        </div>
        <div class="space-y-1">
          <div class="text-sm font-semibold">ğŸšï¸ è®­ç»ƒéš¾åº¦</div>
          <select id="gridMode" class="w-full bg-slate-800 rounded-xl px-3 py-2">
            <option value="downbeat" selected>åªæ‰“å¼ºæ‹ï¼ˆæ¯å°èŠ‚ç¬¬1æ‹ï¼‰</option>
            <option value="onbeat">åªæ‰“æ­£æ‹ï¼ˆ1/2 æ‹ï¼‰</option>
            <option value="all">å››åˆ†éŸ³ç¬¦ï¼ˆ1/1 æ‹ï¼‰</option>
          </select>
        </div>
      </div>

      <div class="grid md:grid-cols-4 gap-4 items-end">
        <div class="space-y-1">
          <div class="text-sm font-semibold">ğŸ¼ å›ºå®š BPM / æ£€æµ‹ç»“æœ</div>
          <input id="bpmInput" type="number" min="20" max="240" step="1" value="100" class="w-full bg-slate-800 rounded-xl px-3 py-2" />
          <div class="text-xs opacity-70">è‡ªåŠ¨æ£€æµ‹ä¼šè¦†ç›–è¿™é‡Œ</div>
        </div>
        <div class="space-y-1">
          <div class="text-sm font-semibold">ğŸ¢ è®­ç»ƒå‡é€Ÿ</div>
          <select id="tempoScale" class="w-full bg-slate-800 rounded-xl px-3 py-2">
            <option value="1">1.0xï¼ˆåŸé€Ÿï¼‰</option>
            <option value="0.75" selected>0.75xï¼ˆæ›´æ…¢ï¼‰</option>
            <option value="0.5">0.5xï¼ˆåŠé€Ÿï¼‰</option>
          </select>
        </div>
        <div class="space-y-1">
          <div class="text-sm font-semibold">ğŸ¯ PERFECT çª—</div>
          <select id="winPerfect" class="w-full bg-slate-800 rounded-xl px-3 py-2">
            <option value="60">Â±60ms</option>
            <option value="80" selected>Â±80ms</option>
            <option value="100">Â±100ms</option>
          </select>
        </div>
        <div class="space-y-1">
          <div class="text-sm font-semibold">ğŸ«° Tap æŒ‰é’®</div>
          <button id="tapBtn" class="btn w-full bg-amber-600 text-white">TAPï¼ˆTï¼‰</button>
          <div class="text-xs opacity-70" id="tapHint">æ•² 4~8 ä¸‹è‡ªåŠ¨ä¼°ç®— BPM</div>
        </div>
      </div>

      <div class="flex flex-wrap gap-2 items-center">
        <button id="btnCam" class="btn bg-teal-600 text-white">ğŸ¥ æ‰“å¼€æ‘„åƒå¤´</button>
        <button id="btnAnalyze" class="btn bg-orange-600 text-white" disabled>ğŸ” æ„å»ºèŠ‚æ‹ç½‘æ ¼</button>
        <button id="btnStart" class="btn bg-fuchsia-600 text-white" disabled>ğŸš€ å¼€å§‹è®­ç»ƒ</button>
        <div id="status" class="text-sm opacity-80">å‡†å¤‡å¼€å§‹</div>
      </div>
    </section>

    <!-- ç”»é¢åŒº -->
    <section class="card p-6 relative overflow-hidden ring-2 ring-purple-500/30">
      <video id="video" class="w-full rounded-2xl aspect-[9/16] object-cover ring-2 ring-teal-500/50" autoplay muted playsinline></video>
      <canvas id="skel" class="absolute inset-0 rounded-2xl pointer-events-none"></canvas>
      <canvas id="trail" class="absolute inset-0 rounded-2xl pointer-events-none"></canvas>

      <div id="rc" class="rhythm-circle"></div>
      <div id="hint" class="hint">åœˆäº®å¤§æ—¶ <span class="text-amber-300">è·Ÿæ‹</span>ï¼</div>
      <canvas id="beatPreview"></canvas>
      <div id="judge" class="judge">PERFECT</div>

      <div class="absolute bottom-4 left-1/2 -translate-x-1/2 text-center">
        <div id="score" class="text-5xl font-black bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">0</div>
        <div id="combo" class="text-xl text-emerald-400 font-bold opacity-0">è¿å‡» x0</div>
        <div class="w-[86%] mx-auto mt-2">
          <div class="pbar"><div id="pfill" class="pfill"></div></div>
          <div id="time" class="text-[11px] text-slate-400 mt-1">00:00 / 00:00</div>
        </div>
      </div>
    </section>

    <!-- å€’è®¡æ—¶ -->
    <div id="cd" class="countdown"><div class="countNum" id="cdNum">3</div></div>

    <!-- ç»“ç®— -->
    <div id="result" class="modal">
      <div class="bg-slate-900/95 ring-2 ring-purple-500/50 rounded-3xl p-8 w-[min(92vw,520px)] text-center space-y-4">
        <div class="text-3xl font-black bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">ğŸ‰ è®­ç»ƒç»“æœ</div>
        <div id="grade" class="text-7xl font-black text-emerald-400">S</div>
        <div id="final" class="text-5xl">0</div>
        <div class="text-sm opacity-80">æœ€é«˜è¿å‡» <span id="maxc" class="font-bold text-emerald-400">0</span> ï½œ å‘½ä¸­ç‡ <span id="acc">0%</span></div>
        <div class="flex gap-2 mt-2">
          <button id="again" class="btn bg-emerald-600 text-white flex-1">å†æ¥ä¸€è½®</button>
          <button id="ok" class="btn bg-slate-700 text-white flex-1">å®Œæˆ</button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  // ---------- å…ƒç´  & å…¨å±€ ----------
  const E = (id)=>document.getElementById(id);
  const els = { video:E('video'), skel:E('skel'), trail:E('trail'), rc:E('rc'), hint:E('hint'), beatPreview:E('beatPreview'),
    musicFile:E('musicFile'), test1:E('test1'), test2:E('test2'), btnCam:E('btnCam'), btnAnalyze:E('btnAnalyze'), btnStart:E('btnStart'), status:E('status'),
    gesture:E('gesture'), tempoMode:E('tempoMode'), gridMode:E('gridMode'), bpmInput:E('bpmInput'), tempoScale:E('tempoScale'), winPerfect:E('winPerfect'), tapBtn:E('tapBtn'), tapHint:E('tapHint'),
    pfill:E('pfill'), time:E('time'), score:E('score'), combo:E('combo'), judge:E('judge'),
    cd:E('cd'), cdNum:E('cdNum'), result:E('result'), grade:E('grade'), final:E('final'), maxc:E('maxc'), acc:E('acc'), again:E('again'), ok:E('ok') };

  let audio, audioBuf, stream, pose;
  let beats=[], gridBeats=[], idx=0, running=false, totalMs=0;
  let score=0, combo=0, maxCombo=0, judgs=[];
  let prevNose=null, sx=0, sy=0, px=0, py=0, shaking=false, nodding=false;
  let taps=[]; // tap tempo buffer

  // ---------- å·¥å…· ----------
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
  const msFmt=(t)=>{const m=String(Math.floor(t/60000)).padStart(2,'0'); const s=String(Math.floor((t%60000)/1000)).padStart(2,'0'); return `${m}:${s}`};
  const median=(arr)=>{ const a=arr.slice().sort((x,y)=>x-y); const m=Math.floor(a.length/2); return a.length%2? a[m] : (a[m-1]+a[m])/2 };

  // ---------- æ‘„åƒå¤´ ----------
  async function openCam(){
    if(!navigator.mediaDevices?.getUserMedia) throw new Error('éœ€è¦ HTTPS/å®‰å…¨åŸŸæ‰èƒ½ä½¿ç”¨æ‘„åƒå¤´');
    stream = await navigator.mediaDevices.getUserMedia({ video:{width:{ideal:720},height:{ideal:1280},facingMode:'user',frameRate:{ideal:30}}, audio:false });
    els.video.srcObject=stream; await new Promise(r=>els.video.onloadedmetadata=r); resize();
  }

  // ---------- MediaPipe Pose ----------
  async function loadPose(){
    if(pose) return pose;
    const { PoseLandmarker, FilesetResolver } = await import('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14');
    const fr = await FilesetResolver.forVisionTasks('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm');
    pose = await PoseLandmarker.createFromOptions(fr, {
      baseOptions:{ modelAssetPath:'https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task', delegate:'GPU' },
      runningMode:'VIDEO', numPoses:1, minPoseDetectionConfidence:.3, minPosePresenceConfidence:.3, minTrackingConfidence:.3
    });
    return pose;
  }

  function resize(){ const r=els.video.getBoundingClientRect(); [els.skel,els.trail].forEach(c=>{c.width=r.width; c.height=r.height}); const pr=els.beatPreview.getBoundingClientRect(); els.beatPreview.width=pr.width; els.beatPreview.height=pr.height; }
  window.addEventListener('resize', resize);

  // ---------- ä½é¢‘æ»¤æ³¢ + èŠ‚æ‹å³°æŠ“å– ----------
  async function analyzeBeats(buffer){
    return new Promise((resolve,reject)=>{
      const oc=new OfflineAudioContext(1,buffer.length,buffer.sampleRate);
      const src=oc.createBufferSource(); src.buffer=buffer;
      const lp=oc.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=160; src.connect(lp); lp.connect(oc.destination); src.start();
      oc.startRendering().then(rb=>{
        const sr=buffer.sampleRate; const data=rb.getChannelData(0); const N=data.length;
        const env=new Float32Array(N); let prev=0, alpha=.5; for(let i=0;i<N;i++){ const v=Math.abs(data[i]); prev=alpha*v+(1-alpha)*prev; env[i]=prev }
        const peaks=[]; let mean=0,gamma=.995; const win=Math.max(1,Math.floor(sr*.01)), loc=Math.max(1,Math.floor(sr*.05));
        for(let i=win;i<N-win;i++){
          const v=env[i]; let isMax=true; for(let k=i-win;k<=i+win;k+=Math.max(1,Math.floor(win/2))) if(env[k]>v){isMax=false;break}
          if(isMax && v>mean*1.1){ let s=0; for(let j=i-loc;j<=i+loc;j++){ if(j>=0&&j<N) s+=env[j] } s/= (2*loc+1); peaks.push({t:i/sr*1000, s:Math.max(0,v-s)}) }
          mean = gamma*mean + (1-gamma)*v;
        }
        // å»é‡ 120ms
        const spaced=[]; for(const p of peaks){ if(!spaced.length){spaced.push(p);continue} const last=spaced[spaced.length-1]; if(p.t-last.t<120){ if(p.s>last.s) spaced[spaced.length-1]=p } else spaced.push(p) }
        // ä»…ä¿ç•™æœ€å¼º 1/3
        const keep=Math.max(1,Math.ceil(spaced.length/3));
        const strong=spaced.slice().sort((a,b)=>b.s-a.s).slice(0,keep).sort((a,b)=>a.t-b.t);
        resolve(strong.map(p=>p.t));
      }).catch(reject)
    })
  }

  // ---------- ç”ŸæˆèŠ‚æ‹ç½‘æ ¼ï¼ˆå°èŠ‚/å¼ºæ‹/æ­£æ‹ï¼‰ ----------
  function buildBeatGrid(baseBeats, mode='downbeat', bpmHint=null, scale=1){
    // ä¼° BPMï¼šç”¨ç›¸é‚»é—´éš”ä¸­ä½æ•°
    let ibi = baseBeats.length>1 ? median(baseBeats.slice(1).map((t,i)=>t-baseBeats[i])) : 600;
    let bpm = Math.round(60000/ibi);
    if (bpmHint) { bpm = bpmHint; ibi = 60000/bpm }

    // é‡åŒ–åˆ° 1/2 æ‹ç½‘æ ¼ï¼Œç¨³å®šç›¸ä½
    const grid = ibi/2; const quantized = baseBeats.map(t=>Math.round(t/grid)*grid);
    const start = quantized[0] || 0;

    // ä»¥ 4/4 å°èŠ‚ç”Ÿæˆå…¨æ›²ç½‘æ ¼
    const beatsOut=[]; const total = totalMs || (audio?.duration||0)*1000 || 60000;
    const step = ibi * (mode==='all' ? 1 : (mode==='onbeat' ? 2 : 4)); // all=å››åˆ†ã€onbeat=äºŒåˆ†ã€downbeat=æ•´å°èŠ‚
    for(let t=start; t<=total+1000; t+=step){ beatsOut.push(t) }

    // è®­ç»ƒå‡é€Ÿï¼šåªæ”¹å˜ç›®æ ‡èŠ‚æ‹å¯†åº¦ï¼Œä¸æ”¹éŸ³é¢‘é€Ÿåº¦ï¼ˆå¯¹å­©å­æ›´å‹å¥½ï¼‰
    const scaled = beatsOut.map(t => start + (t-start)/scale);

    return { bpm: Math.round(bpm), grid: scaled, downbeatEvery: (step/ibi) };
  }

  // ---------- é¢„è§ˆæ¡ ----------
  function drawPreview(at){ const ctx=els.beatPreview.getContext('2d'); const w=ctx.canvas.width, h=ctx.canvas.height; ctx.clearRect(0,0,w,h); ctx.fillStyle='rgba(255,255,255,.08)'; ctx.fillRect(0,0,w,h); const W=3000; const vis=gridBeats.filter(t=>t>=at-500&&t<=at+W); vis.forEach((t,i)=>{ const x=((t-at)/W)*w; const isNow=Math.abs(t-at) < 120; ctx.fillStyle = t<at? '#f472b6' : (isNow?'#a855f7':'#fff'); ctx.fillRect(Math.floor(x)-1,0,3,h); }); ctx.fillStyle='rgba(255,255,255,.6)'; ctx.fillRect(0,0,2,h); }

  // ---------- èŠ‚å¥åœˆ ----------
  function updateCircle(at){ if(!gridBeats.length) return; const nb=gridBeats[idx]; if(nb==null){ els.rc.classList.remove('rc-active'); els.hint.style.opacity=0; return } const dt=nb-at; const inWin=(dt>-260 && dt<820); const t=clamp(1-Math.abs(dt)/820,0,1); if(inWin){ els.rc.classList.add('rc-active'); els.rc.style.transform=`translate(-50%,-50%) scale(${1+t*.55})`; els.rc.style.filter=`brightness(${.7+t*.6})`; els.hint.style.opacity=t>.78?1:0; } else { els.rc.classList.remove('rc-active'); els.rc.style.transform='translate(-50%,-50%) scale(1)'; els.hint.style.opacity=0 } }

  // ---------- æ‰‹åŠ¿æ£€æµ‹ï¼šæ‘‡å¤´/ç‚¹å¤´ ----------
  function smooth(x,y){ sx=.5*x+.5*sx; sy=.5*y+.5*sy; return [sx,sy] }
  const TH_ON=25, TH_OFF=14; // æ»å›
  function headSpeedXY(nose){ const [x,y]=smooth(nose.x,nose.y); const vx=(x-px), vy=(y-py); px=x; py=y; return { vx, vy, spx:Math.abs(vx)*2000, spy:Math.abs(vy)*2000 } }
  function triggerGesture(gMode, spx, spy){
    if(gMode==='shake'){ // æ¨ªå‘
      if(!shaking && spx>TH_ON){ shaking=true; return true } if(shaking && spx<TH_OFF) shaking=false; return false
    } else if(gMode==='nod'){ // çºµå‘
      if(!nodding && spy>TH_ON){ nodding=true; return true } if(nodding && spy<TH_OFF) nodding=false; return false
    } else { // ä»»ä¸€
      let fire=false; if(!shaking && spx>TH_ON){ shaking=true; fire=true } if(shaking && spx<TH_OFF) shaking=false; if(!nodding && spy>TH_ON){ nodding=true; fire=true } if(nodding && spy<TH_OFF) nodding=false; return fire
    }
  }

  // ---------- åˆ¤å®š & åé¦ˆ ----------
  function showJudge(J){ els.judge.textContent=J; els.judge.className=`judge ${J}` }
  function judge(at, beat){ const p=Number(els.winPerfect.value); const g=p*1.875, b=p*3.125; const dt=Math.abs(at-beat); if(dt<p) return {J:'PERFECT',pts:100}; if(dt<g) return {J:'GREAT',pts:70}; if(dt<b) return {J:'GOOD',pts:40}; return {J:'MISS',pts:0} }

  // ---------- Tap Tempo ----------
  function tap(){ const t=performance.now(); taps.push(t); if(taps.length>8) taps.shift(); if(taps.length>=4){ const iv=taps.slice(1).map((x,i)=>x-taps[i]); const bpm=Math.round(60000/median(iv)); els.bpmInput.value=bpm; els.tapHint.textContent=`ä¼°ç®— BPM: ${bpm}` } }
  els.tapBtn.addEventListener('click', tap);
  window.addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='t') tap() });

  // ---------- å€’è®¡æ—¶ ----------
  async function countdown(){ els.cd.style.display='flex'; for(const n of ['3','2','1','GO!']){ els.cdNum.textContent=n; await sleep(700) } els.cd.style.display='none' }

  // ---------- éŸ³é¢‘åŠ è½½ ----------
  async function loadAudio(src){ return new Promise((resolve,reject)=>{ if(!audio) audio=new Audio(); audio.src=src; const ctx=new (window.AudioContext||window.webkitAudioContext)(); audio.addEventListener('loadedmetadata', async()=>{ try{ const res=await fetch(src); const ab=await res.arrayBuffer(); audioBuf=await ctx.decodeAudioData(ab); resolve(audioBuf.duration) }catch(e){ reject(e) } }); audio.load() }) }

  // ---------- UI ç»‘å®š ----------
  els.btnCam.onclick = async()=>{ try{ els.btnCam.disabled=true; els.status.textContent='è¯·æ±‚æ‘„åƒå¤´æƒé™...'; await openCam(); els.status.innerHTML='âœ… <span class="text-emerald-400">æ‘„åƒå¤´å°±ç»ª</span>'; await loadPose(); els.btnCam.textContent='âœ… æ‘„åƒå¤´å·²å¼€' } catch(e){ alert(e.message||'æ‘„åƒå¤´å¤±è´¥'); els.status.textContent='âŒ æ‘„åƒå¤´å¤±è´¥' } finally{ els.btnCam.disabled=false } };

  const TESTS=['https://www.soundjay.com/misc/sounds/bell-ringing-05.wav','https://www.soundjay.com/human/sounds/whip-1.mp3'];
  els.test1.onclick = async()=>{ els.status.textContent='åŠ è½½æµ‹è¯•éŸ³ä¹...'; try{ const d=await loadAudio(TESTS[0]); els.btnAnalyze.disabled=false; els.status.innerHTML=`âœ… æµ‹è¯•éŸ³ä¹1åŠ è½½æˆåŠŸ (${d.toFixed(0)}s)` }catch{ els.status.textContent='âŒ åŠ è½½å¤±è´¥' } };
  els.test2.onclick = async()=>{ els.status.textContent='åŠ è½½æµ‹è¯•éŸ³ä¹...'; try{ const d=await loadAudio(TESTS[1]); els.btnAnalyze.disabled=false; els.status.innerHTML=`âœ… æµ‹è¯•éŸ³ä¹2åŠ è½½æˆåŠŸ (${d.toFixed(0)}s)` }catch{ els.status.textContent='âŒ åŠ è½½å¤±è´¥' } };
  els.musicFile.onchange = async e=>{ const f=e.target.files[0]; if(!f) return; els.status.textContent='åŠ è½½éŸ³ä¹...'; try{ const ab=await f.arrayBuffer(); const ctx=new (window.AudioContext||window.webkitAudioContext)(); audioBuf=await ctx.decodeAudioData(ab); if(!audio) audio=new Audio(); audio.src=URL.createObjectURL(f); els.btnAnalyze.disabled=false; els.status.innerHTML=`âœ… ${f.name} (${audioBuf.duration.toFixed(0)}s)` }catch{ els.status.textContent='âŒ éŸ³ä¹åŠ è½½å¤±è´¥' } };

  els.btnAnalyze.onclick = async()=>{
    if(!audioBuf && els.tempoMode.value==='auto'){ els.status.textContent='è¯·å…ˆåŠ è½½éŸ³ä¹'; return }
    els.btnAnalyze.disabled=true; els.status.textContent='æ„å»ºèŠ‚æ‹ç½‘æ ¼...';

    if(els.tempoMode.value==='auto'){
      beats = await analyzeBeats(audioBuf);
      totalMs = (audio?.duration||audioBuf?.duration||0)*1000;
      const {bpm, grid} = buildBeatGrid(beats, els.gridMode.value, null, Number(els.tempoScale.value));
      els.bpmInput.value = bpm; gridBeats = grid;
    } else if(els.tempoMode.value==='tap'){
      const bpm = clamp(Number(els.bpmInput.value)||100, 20, 240);
      totalMs = (audio?.duration||audioBuf?.duration||0)*1000 || 60000;
      const start = 0; const ibi=60000/bpm; const step = ibi * (els.gridMode.value==='all'?1:(els.gridMode.value==='onbeat'?2:4));
      gridBeats=[]; for(let t=start; t<=totalMs+1000; t+=step) gridBeats.push(t/Number(els.tempoScale.value));
    } else { // fixed
      const bpm = clamp(Number(els.bpmInput.value)||100, 20, 240);
      totalMs = (audio?.duration||audioBuf?.duration||0)*1000 || 60000;
      const start = 0; const ibi=60000/bpm; const step = ibi * (els.gridMode.value==='all'?1:(els.gridMode.value==='onbeat'?2:4));
      gridBeats=[]; for(let t=start; t<=totalMs+1000; t+=step) gridBeats.push(t/Number(els.tempoScale.value));
    }

    idx=0; els.btnStart.disabled=false; els.status.innerHTML=`ğŸµ å·²ç”Ÿæˆ <b>${gridBeats.length}</b> ä¸ªè®­ç»ƒæ‹ç‚¹ï¼ˆ${els.bpmInput.value} BPMï¼Œæ¨¡å¼ï¼š${els.gridMode.value}ï¼‰`;
    els.btnAnalyze.disabled=false;
  };

  els.btnStart.onclick = async()=>{
    if(!gridBeats.length){ els.status.textContent='è¯·å…ˆæ„å»ºèŠ‚æ‹ç½‘æ ¼'; return }
    await loadPose(); running=true; score=0; combo=0; maxCombo=0; judgs=[]; prevNose=null; px=py=sx=sy=0; idx=0; taps=[];
    els.score.textContent='0'; els.combo.style.opacity=0; els.pfill.style.width='0%';

    await countdown();
    audio.currentTime=0; audio.volume=.85; audio.play(); totalMs=(audio.duration||audioBuf?.duration||0)*1000;

    let lastInput=0;
    const loop = async()=>{
      if(!running) return; const now=performance.now(); const aMs=audio.currentTime*1000;
      while(idx<gridBeats.length && aMs>gridBeats[idx]+300) idx++;
      drawPreview(aMs); updateCircle(aMs);
      els.pfill.style.width = `${clamp((aMs/totalMs)*100,0,100)}%`; els.time.textContent = `${msFmt(aMs)} / ${msFmt(totalMs)}`;
      try{
        const r = await pose.detectForVideo(els.video, now);
        if(r.landmarks?.[0]){
          const nose=r.landmarks[0][0];
          const {spx, spy} = headSpeedXY(nose);
          const mode=els.gesture.value;
          if(triggerGesture(mode, spx, spy) && aMs-lastInput>100){ lastInput=aMs; // åˆ¤å®š
            if(idx<gridBeats.length){ const next=gridBeats[idx]; const res=judge(aMs,next); if(res.pts>0){ score+=res.pts; combo++; maxCombo=Math.max(maxCombo,combo); els.score.textContent=String(score); if(combo>1){ els.combo.textContent=`è¿å‡» x${combo}`; els.combo.style.opacity=1 } showJudge(res.J); judgs.push(res); idx++ } else { showJudge('MISS'); combo=0; els.combo.style.opacity=0 } }
          }
        }
      }catch(e){ /* ignore */ }
      if(audio.ended || aMs>=totalMs-300){ finish(); return }
      requestAnimationFrame(loop);
    };
    loop();
  };

  function finish(){ running=false; try{audio.pause()}catch{} els.rc.classList.remove('rc-active'); els.hint.style.opacity=0; const hit=judgs.filter(x=>x.pts>0).length/Math.max(gridBeats.length,1); const acc=Math.round(hit*100); const final=Math.round(score*(1+maxCombo*0.1)); els.final.textContent=final; els.maxc.textContent=maxCombo; els.acc.textContent=`${acc}%`; const g=final>=800?'S':final>=600?'A':final>=400?'B':final>=200?'C':'D'; els.grade.textContent=g; els.result.classList.add('show'); setTimeout(()=>{ parent.postMessage({type:'JUICE_GAME_SCORE', score:Math.max(0,final)}, '*') }, 300) }

  els.again.onclick=()=>{ els.result.classList.remove('show'); els.btnStart.disabled=false; els.status.textContent='å‡†å¤‡å†æ¬¡è®­ç»ƒ' };
  els.ok.onclick=()=>{ els.result.classList.remove('show') };

  // åˆå§‹åŒ–
  window.addEventListener('load', ()=>{ audio=new Audio(); audio.volume=.85; resize(); parent.postMessage({type:'JUICE_GAME_READY'}, '*'); });
</script>
</body>
</html>