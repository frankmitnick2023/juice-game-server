<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DanceCam - å…¨èº«æ•æ‰èˆè¹ˆæ¸¸æˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #f1f5f9; font-family: system-ui, -apple-system, sans-serif; }
    .portrait { aspect-ratio: 9 / 16; height: 70vh; width: auto; }
    video.portrait { object-fit: cover; }
    canvas.portrait { display:block; }
    .fx-burst{position:absolute; inset:0; pointer-events:none;}
    .fx-burst canvas{position:absolute; inset:0}
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(2,6,23,.8); backdrop-filter: blur(12px); z-index:50;}
    .modal.show{display:flex;}
    .game-ready { animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.7} }
    .btn-primary { @apply px-6 py-3 rounded-2xl font-semibold transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg; }
    .btn-glow { box-shadow: 0 0 20px rgba(34,197,94,0.5); }
  </style>
</head>
<body class="min-h-screen p-4 md:p-8">
  <div class="max-w-7xl mx-auto space-y-6">
    <!-- æ ‡é¢˜ä¸ç‰ˆæœ¬ -->
    <header class="text-center space-y-4">
      <h1 class="text-4xl md:text-6xl font-black bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-500 bg-clip-text text-transparent drop-shadow-2xl">
        ğŸµ DanceCam
      </h1>
      <p class="text-xl md:text-2xl opacity-90">AIå…¨èº«æ•æ‰èˆè¹ˆæ¸¸æˆ Â· å¹³å°ä¼˜åŒ–ç‰ˆ v7</p>
      <div class="text-sm md:text-base opacity-70">ç«–å±ä¸‰åˆ†å± | é¢„å‘Šè½®å»“ | è§’åº¦è®­ç»ƒ | æœ¬åœ°æ’è¡Œ</div>
    </header>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="bg-gradient-to-r from-slate-900/80 to-slate-800/80 backdrop-blur-xl rounded-3xl p-6 ring-2 ring-white/10 shadow-2xl">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <!-- æ¸¸æˆè®¾ç½® -->
        <div class="space-y-3">
          <label class="flex items-center gap-3 bg-slate-800/70 px-4 py-3 rounded-2xl ring-1 ring-white/10">
            <span class="font-semibold w-16">éš¾åº¦</span>
            <select id="difficulty" class="flex-1 bg-slate-900/80 border border-white/20 rounded-xl px-4 py-2 focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all">
              <option value="Easy">ğŸŒŸ Easy</option>
              <option value="Normal" selected>â­ Normal</option>
              <option value="Hard">â­â­ Hard</option>
              <option value="Extreme">â­â­â­ Extreme</option>
            </select>
          </label>
          
          <label class="flex items-center gap-3 bg-slate-800/70 px-4 py-3 rounded-2xl ring-1 ring-white/10">
            <span class="font-semibold w-16">é¢„å‘Š</span>
            <input id="ghostToggle" type="checkbox" checked class="w-5 h-5 accent-emerald-500 rounded" />
            <span class="text-sm opacity-80">æå‰</span>
            <input id="lookahead" type="range" min="200" max="2000" step="100" value="800" class="w-24 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500" />
            <span id="lookaheadVal" class="text-sm font-mono bg-slate-900 px-2 py-1 rounded">800ms</span>
          </label>

          <label class="flex items-center gap-3 bg-slate-800/70 px-4 py-3 rounded-2xl ring-1 ring-white/10">
            <span class="font-semibold w-16">è®­ç»ƒ</span>
            <input id="trainToggle" type="checkbox" class="w-5 h-5 accent-emerald-500 rounded" />
            <select id="trainTarget" class="bg-slate-900/80 border border-white/20 rounded-xl px-3 py-2 ml-2 w-32 focus:ring-2 focus:ring-emerald-500">
              <option value="arm_raise">æŠ¬è‡‚</option>
              <option value="squat">ä¸‹è¹²</option>
              <option value="kick">è¸¢è…¿</option>
            </select>
          </label>
        </div>

        <!-- ä¸ªäººä¿¡æ¯ -->
        <div class="space-y-3">
          <label class="flex items-center gap-3 bg-slate-800/70 px-4 py-3 rounded-2xl ring-1 ring-white/10">
            <span class="font-semibold w-16">æ›²ç›®</span>
            <input id="songTitle" type="text" placeholder="è¾“å…¥æ­Œæ›²å" maxlength="30" 
                   class="flex-1 bg-slate-900/80 border border-white/20 rounded-xl px-4 py-2 focus:ring-2 focus:ring-blue-500 placeholder:opacity-50 transition-all" />
          </label>
          
          <label class="flex items-center gap-3 bg-slate-800/70 px-4 py-3 rounded-2xl ring-1 ring-white/10">
            <span class="font-semibold w-16">ç©å®¶</span>
            <input id="playerName" type="text" placeholder="ä½ çš„æ˜µç§°" maxlength="12" value="èˆè€…" 
                   class="flex-1 bg-gradient-to-r from-emerald-500/20 to-blue-500/20 border border-white/30 rounded-xl px-4 py-2 font-semibold focus:ring-4 focus:ring-emerald-400 transition-all" />
          </label>
        </div>

        <!-- çŠ¶æ€æ˜¾ç¤º -->
        <div class="space-y-3 md:col-span-3 lg:col-span-1">
          <div class="grid grid-cols-2 gap-3">
            <div id="comboBox" class="p-4 rounded-2xl bg-gradient-to-br from-emerald-900/60 to-emerald-800/60 ring-2 ring-emerald-500/50 text-center">
              <div class="text-xs opacity-80 uppercase tracking-wider">COMBO</div>
              <div id="comboCount" class="text-3xl md:text-4xl font-black text-emerald-400">0</div>
            </div>
            <div id="feedbackBox" class="p-4 rounded-2xl bg-gradient-to-br from-slate-900/80 to-slate-800/80 ring-2 ring-white/20 text-center">
              <div id="feedbackText" class="text-lg font-bold text-transparent bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text">å‡†å¤‡å¼€å§‹</div>
            </div>
          </div>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="flex flex-wrap gap-4 justify-center">
        <input id="refFile" type="file" accept="video/*" class="hidden" />
        <button id="refBtn" class="btn-primary bg-gradient-to-r from-orange-500 to-orange-600 text-white shadow-orange-500/50 hover:from-orange-400 hover:to-orange-500 game-ready">
          ğŸ“¹ é€‰æ‹©èˆè¹ˆè§†é¢‘
        </button>
        <button id="openCamBtn" class="btn-primary bg-gradient-to-r from-teal-500 to-teal-600 text-white shadow-teal-500/50 hover:from-teal-400 hover:to-teal-500">
          ğŸ¥ æ‰“å¼€æ‘„åƒå¤´
        </button>
        <button id="analyzeRefBtn" class="btn-primary bg-gradient-to-r from-indigo-500 to-indigo-600 text-white shadow-indigo-500/50 hover:from-indigo-400 hover:to-indigo-500 disabled:opacity-50" disabled>
          âš¡ åˆ†æåŠ¨ä½œ
        </button>
        <button id="startGameBtn" class="btn-primary bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-emerald-500/50 hover:from-emerald-400 hover:to-emerald-500 text-xl px-8 disabled:opacity-50" disabled>
          ğŸš€ å¼€å§‹è·Ÿèˆ
        </button>
        <button id="stopGameBtn" class="btn-primary bg-gradient-to-r from-rose-500 to-rose-600 text-white shadow-rose-500/50 hover:from-rose-400 hover:to-rose-500 text-xl px-8 disabled:opacity-50 hidden" disabled>
          â¹ï¸ åœæ­¢
        </button>
      </div>
      
      <div id="statusRow" class="flex flex-wrap gap-4 text-sm opacity-80 mt-4 justify-center">
        <span id="refStatus"></span>
        <span id="runStatus"></span>
      </div>
    </div>

    <!-- ä¸»æ¸¸æˆåŒºåŸŸ -->
    <div id="mainGrid" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- å‚è€ƒè§†é¢‘ -->
      <div id="leftPanel" class="bg-slate-900/70 backdrop-blur-xl rounded-3xl p-6 ring-2 ring-white/10 shadow-2xl" data-role="ref">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
          <span class="w-8 h-8 bg-orange-500/20 rounded-xl flex items-center justify-center text-orange-400 font-bold text-lg">1</span>
          å‚è€ƒèˆè¹ˆ
        </h2>
        <div class="relative mb-4">
          <video id="refVideo" class="portrait w-full rounded-2xl bg-gradient-to-br from-black to-slate-900 ring-2 ring-white/20 shadow-2xl" controls playsinline></video>
        </div>
        <label class="flex items-center gap-3 px-4 py-3 rounded-2xl bg-slate-800/60 hover:bg-slate-800/80 cursor-pointer transition-all w-full justify-center">
          <input id="toggleLandmarks" type="checkbox" class="accent-emerald-500 w-5 h-5" />
          <span class="text-sm">æ˜¾ç¤º33ä¸ªæ•æ‰ç‚¹</span>
        </label>
      </div>

      <!-- æ‘„åƒå¤´ -->
      <div id="middlePanel" class="bg-slate-900/70 backdrop-blur-xl rounded-3xl p-6 ring-2 ring-white/10 shadow-2xl" data-role="cam">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
          <span class="w-8 h-8 bg-teal-500/20 rounded-xl flex items-center justify-center text-teal-400 font-bold text-lg">2</span>
          å®æ—¶æ‘„åƒå¤´
        </h2>
        <video id="camVideo" class="portrait w-full rounded-2xl bg-gradient-to-br from-black to-slate-900 ring-4 ring-teal-500/30 shadow-2xl" autoplay muted playsinline></video>
      </div>

      <!-- å¡é€šäººç‰© -->
      <div id="rightPanel" class="bg-slate-900/70 backdrop-blur-xl rounded-3xl p-6 ring-2 ring-white/10 shadow-2xl" data-role="avatar">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
          <span class="w-8 h-8 bg-emerald-500/20 rounded-xl flex items-center justify-center text-emerald-400 font-bold text-lg">3</span>
          AIå¡é€šåŒ–
        </h2>
        <div class="relative mb-6">
          <canvas id="avatarCanvas" class="portrait w-full rounded-2xl bg-gradient-to-br from-slate-900 to-slate-800 ring-4 ring-emerald-500/30 shadow-2xl"></canvas>
          <canvas id="ghostCanvas" class="portrait w-full rounded-2xl absolute inset-0 pointer-events-none"></canvas>
          <div class="fx-burst" id="fxLayer"></div>
        </div>
        
        <!-- å®æ—¶å¾—åˆ† -->
        <div class="grid grid-cols-2 gap-4">
          <div class="p-4 rounded-2xl bg-gradient-to-br from-blue-900/60 to-blue-800/60 ring-2 ring-blue-500/40 text-center">
            <div class="text-xs opacity-80 uppercase tracking-wider">åŠ¨ä½œè¿˜åŸ</div>
            <div class="text-2xl font-black text-blue-400" id="similarityScore">â€”</div>
          </div>
          <div class="p-4 rounded-2xl bg-gradient-to-br from-purple-900/60 to-purple-800/60 ring-2 ring-purple-500/40 text-center">
            <div class="text-xs opacity-80 uppercase tracking-wider">èŠ‚å¥ç²¾å‡†</div>
            <div class="text-2xl font-black text-purple-400" id="rhythmScore">â€”</div>
          </div>
          <div class="p-4 rounded-2xl bg-gradient-to-br from-emerald-900/60 to-emerald-800/60 ring-2 ring-emerald-500/40 text-center">
            <div class="text-xs opacity-80 uppercase tracking-wider">è¡¨ç°åŠ›</div>
            <div class="text-2xl font-black text-emerald-400" id="avatarScore">â€”</div>
          </div>
          <div class="p-4 md:col-span-2 rounded-2xl bg-gradient-to-br from-amber-900/70 to-amber-800/70 ring-3 ring-amber-500/50 text-center">
            <div class="text-sm opacity-80 uppercase tracking-wider">æ€»åˆ†</div>
            <div class="text-3xl md:text-4xl font-black bg-gradient-to-r from-amber-400 to-amber-500 bg-clip-text text-transparent drop-shadow-lg" id="finalScore">â€”</div>
          </div>
        </div>
      </div>
    </div>

    <!-- å…¨å±æŒ‰é’® -->
    <div class="text-center">
      <label class="inline-flex items-center gap-3 bg-slate-800/60 px-6 py-3 rounded-2xl ring-1 ring-white/20 hover:bg-slate-800/80 cursor-pointer transition-all">
        <input id="fsTarget" type="checkbox" class="hidden" value="avatar" checked />
        <span>ğŸ® å…¨å±å¡é€šäººç‰©</span>
        <button id="fsBtn" class="ml-auto px-4 py-2 rounded-xl bg-gradient-to-r from-violet-500 to-violet-600 hover:from-violet-400 hover:to-violet-500 text-white text-sm font-semibold shadow-lg">è¿›å…¥å…¨å±</button>
      </label>
    </div>

    <footer class="text-center text-xs opacity-50 pt-8">
      <p>âœ¨ å¹³å°ä¸“å±ä¼˜åŒ–ç‰ˆ | æ”¯æŒæœ¬åœ°æ’è¡Œæ¦œ | MediaPipe Pose AIé©±åŠ¨</p>
    </footer>
  </div>

  <!-- ç»“ç®—é¢æ¿ -->
  <div id="resultModal" class="modal">
    <div class="w-full max-w-4xl max-h-[90vh] bg-gradient-to-b from-slate-900/95 to-slate-800/90 ring-2 ring-white/20 rounded-3xl p-8 space-y-8 overflow-hidden shadow-2xl">
      <div class="flex items-center justify-between">
        <h3 class="text-3xl font-black bg-gradient-to-r from-emerald-400 to-blue-400 bg-clip-text text-transparent">ğŸ‰ èˆè¹ˆç»“ç®—</h3>
        <button id="closeResult" class="px-4 py-2 rounded-xl bg-slate-800/70 hover:bg-slate-700/70 ring-1 ring-white/20 transition-all">âœ•</button>
      </div>

      <!-- æˆç»©æ€»è§ˆ -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center text-center">
        <div>
          <div class="text-8xl font-black" id="gradeLetter">S</div>
          <div id="stars" class="flex justify-center text-4xl gap-1 mt-2"></div>
        </div>
        <div class="space-y-2">
          <div class="text-5xl font-black text-transparent bg-gradient-to-r from-emerald-400 to-blue-400 bg-clip-text" id="finalScoreModal">100</div>
          <div class="text-sm opacity-70" id="summaryText">å®Œç¾æ¼”å‡ºï¼</div>
        </div>
        <div class="text-left md:text-center">
          <div class="text-2xl font-bold text-emerald-400 mb-2" id="comboMax">æœ€é«˜è¿å‡» x50</div>
          <div class="grid grid-cols-2 gap-2 text-sm opacity-80">
            <span>å‘½ä¸­ç‡</span><span id="hitRate">98%</span>
            <span>Perfect</span><span id="perfectCount">45</span>
            <span>Great</span><span id="greatCount">5</span>
            <span>Miss</span><span id="missCount">0</span>
          </div>
        </div>
      </div>

      <!-- ç²¾å‡†åº¦æ›²çº¿ -->
      <div class="bg-slate-900/50 rounded-2xl p-6 ring-1 ring-white/10">
        <h4 class="font-bold text-lg mb-4 flex items-center gap-2">
          ğŸ“ˆ å‘½ä¸­ç²¾å‡†åº¦æ›²çº¿
          <span class="text-xs opacity-60">(ç»¿è‰²=Perfect, è“è‰²=Great, çº¢è‰²=Miss)</span>
        </h4>
        <canvas id="accChart" class="w-full h-48 rounded-xl bg-slate-900/30 ring-1 ring-white/20"></canvas>
      </div>

      <!-- æ’è¡Œæ¦œ -->
      <div>
        <div class="flex items-center justify-between mb-6">
          <h4 class="text-xl font-bold flex items-center gap-2">
            ğŸ† æœ¬åœ°æ’è¡Œæ¦œ
            <span class="text-sm opacity-60">(å½“å‰æ­Œæ›²)</span>
          </h4>
          <div class="flex items-center gap-2">
            <select id="clearScope" class="bg-slate-800/70 hover:bg-slate-700/70 rounded-xl px-3 py-2 text-sm ring-1 ring-white/20 focus:ring-emerald-500">
              <option value="all">æ¸…ç©ºå…¨éƒ¨è®°å½•</option>
              <option value="video" selected>æ¸…ç©ºå½“å‰æ­Œæ›²</option>
            </select>
            <button id="doClearLB" class="px-4 py-2 text-sm rounded-xl bg-rose-600/80 hover:bg-rose-500/80 ring-1 ring-rose-500/30 transition-all">åˆ é™¤</button>
          </div>
        </div>
        <div class="max-h-64 overflow-auto">
          <ol id="leaderboard" class="space-y-2"></ol>
        </div>
      </div>

      <!-- å†æ¬¡æŒ‘æˆ˜ -->
      <div class="flex flex-col sm:flex-row gap-4 pt-4 border-t border-white/10">
        <button id="replayBtn" class="flex-1 btn-primary bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-emerald-500/50 hover:from-emerald-400">
          ğŸ”„ å†æˆ˜ä¸€æ¬¡
        </button>
        <button id="shareBtn" class="flex-1 btn-primary bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-blue-500/50 hover:from-blue-400">
          ğŸ“± åˆ†äº«æˆç»©
        </button>
      </div>
    </div>
  </div>

  <!-- å€’è®¡æ—¶ -->
  <div id="countdownOverlay" class="hidden fixed inset-0 bg-gradient-to-b from-black/95 to-slate-900/95 flex items-center justify-center z-50 backdrop-blur-sm">
    <div class="text-center space-y-8">
      <div id="countdownNumber" class="text-white text-[12vw] md:text-[20vw] font-black drop-shadow-2xl animate-bounce">3</div>
      <div class="text-2xl font-bold text-emerald-400 tracking-wider animate-pulse">Ready to Dance!</div>
    </div>
  </div>

  <script type="module">
    import { FilesetResolver, PoseLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

    // ===== æ ¸å¿ƒçŠ¶æ€ =====
    let poseLandmarker, running = false, rafId, combo = 0, lastBeatIdx = -1, lastHitTime = -1e9;
    let refFrames = [], refBeats = [], userFrames = [], judgments = [];
    const ctx = {}, gctx = {}, cctx = {};

    // ===== DOM å…ƒç´  =====
    const els = {
      refFile: document.getElementById('refFile'),
      refVideo: document.getElementById('refVideo'),
      camVideo: document.getElementById('camVideo'),
      avatarCanvas: document.getElementById('avatarCanvas'),
      ghostCanvas: document.getElementById('ghostCanvas'),
      accChart: document.getElementById('accChart'),
      comboCount: document.getElementById('comboCount'),
      feedbackText: document.getElementById('feedbackText'),
      finalScore: document.getElementById('finalScore'),
      // ... å…¶ä»–å…ƒç´ 
    };

    // åˆå§‹åŒ–ç”»å¸ƒä¸Šä¸‹æ–‡
    function initCtx() {
      ['avatarCanvas', 'ghostCanvas', 'accChart'].forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) ctx[id.replace('Canvas','')] = canvas.getContext('2d');
      });
      cctx = ctx.accChart;
    }

    // ===== å·¥å…·å‡½æ•° =====
    const now = () => performance.now();
    function copyXYV(lms) { return lms.map(p => ({x:p.x,y:p.y,v:p.visibility||1})); }
    function angleDeg(a,b,c) {
      const A = Math.atan2(c.y-b.y, c.x-b.x) - Math.atan2(a.y-b.y, a.x-b.x);
      return Math.abs(A * 180 / Math.PI) % 180;
    }

    // ===== MediaPipe Pose =====
    async function loadPose() {
      if (poseLandmarker) return;
      const filesetResolver = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
      );
      poseLandmarker = await PoseLandmarker.createFromOptions(filesetResolver, {
        baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_full/float16/1/pose_landmarker.task` },
        runningMode: "VIDEO",
        numPoses: 1
      });
    }

    // ===== å‚è€ƒè§†é¢‘åˆ†æ =====
    document.getElementById('refFile').addEventListener('change', e => {
      const f = e.target.files[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      els.refVideo.src = url;
      els.refVideo.controls = true;
      document.getElementById('refStatus').textContent = `å·²é€‰æ‹©ï¼š${f.name}`;
      document.getElementById('analyzeRefBtn').disabled = true;
      document.getElementById('startGameBtn').disabled = true;
      
      els.refVideo.onloadedmetadata = () => {
        document.getElementById('refStatus').textContent += ` | æ—¶é•¿ ${els.refVideo.duration.toFixed(1)}s`;
        document.getElementById('analyzeRefBtn').disabled = false;
      };
    });

    document.getElementById('analyzeRefBtn').addEventListener('click', async () => {
      await loadPose();
      if (!els.refVideo.src) return alert('è¯·å…ˆé€‰æ‹©å‚è€ƒè§†é¢‘');
      
      document.getElementById('refStatus').textContent = 'ğŸ¬ åˆ†æèˆè¹ˆåŠ¨ä½œä¸­...';
      refFrames = []; refBeats = []; judgments = [];
      
      const fps = 30, interval = 1000/fps;
      const start = now();
      await els.refVideo.play();
      
      let nextT = 0, lastVec = null;
      const times = [], ener = [];
      
      while (!els.refVideo.ended) {
        const t = now() - start;
        if (t >= nextT) {
          const res = poseLandmarker.detectForVideo(els.refVideo, performance.now());
          if (res.landmarks?.[0]) {
            const lms = copyXYV(res.landmarks[0]);
            let vec = normalizeAndFlatten(lms);
            vec = oneEuroVec(vec, t);
            const vis = lms.reduce((a,b) => a + (b.v||1), 0) / lms.length;
            const e = motionEnergy(lastVec, vec);
            refFrames.push({t, vec, vis, raw: lms});
            times.push(t); ener.push(e);
            lastVec = vec;
          }
          nextT += interval;
        }
        await new Promise(r => setTimeout(r, 0));
      }
      
      refBeats = detectPeaks(times, ener, {win:3, thrK:1.0, minGapMs:160});
      document.getElementById('refStatus').textContent = `âœ… åˆ†æå®Œæˆï¼š${refFrames.length}å¸§ | ${refBeats.length}ä¸ªèŠ‚æ‹`;
      document.getElementById('startGameBtn').disabled = false;
      document.getElementById('runStatus').textContent = 'ğŸ¯ å¯ä»¥å¼€å§‹è·Ÿèˆå•¦ï¼';
      els.refVideo.pause(); els.refVideo.currentTime = 0;
    });

    // ===== æ‘„åƒå¤´ =====
    document.getElementById('openCamBtn').onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { width: {ideal: 720}, height: {ideal: 1280}, aspectRatio: 9/16 },
          audio: false
        });
        els.camVideo.srcObject = stream;
        await els.camVideo.play();
        document.getElementById('runStatus').textContent = 'ğŸ“¹ æ‘„åƒå¤´å°±ä½ï¼ˆç«–å±ï¼‰';
      } catch (err) {
        document.getElementById('runStatus').textContent = 'âŒ æ‘„åƒå¤´æƒé™å¤±è´¥ï¼š' + err.message;
      }
    };

    // ===== æ ¸å¿ƒæ¸¸æˆé€»è¾‘ =====
    function startGame() {
      running = true;
      userFrames = []; judgments = []; combo = 0;
      document.getElementById('comboCount').textContent = 0;
      document.getElementById('finalScore').textContent = 'â€¦';
      
      document.getElementById('startGameBtn').disabled = true;
      document.getElementById('stopGameBtn').classList.remove('hidden');
      document.getElementById('stopGameBtn').disabled = false;
      document.getElementById('runStatus').textContent = 'ğŸµ è·Ÿèˆè¿›è¡Œä¸­...';
      
      resizeCanvases();
      els.refVideo.currentTime = 0;
      els.refVideo.play();
      
      let last = null;
      const fps = 30, interval = 1000/fps;
      const startT = now();
      let nextT = 0;
      
      function loop() {
        if (!running) return;
        const t = now() - startT;
        
        if (t >= nextT) {
          const res = poseLandmarker.detectForVideo(els.camVideo, performance.now());
          if (res.landmarks?.[0]) {
            const lms = copyXYV(res.landmarks[0]);
            let vec = normalizeAndFlatten(lms);
            vec = oneEuroVec(vec, t);
            drawAvatar(lms);
            
            const vis = lms.reduce((a,b) => a + (b.v||1), 0) / lms.length;
            const e = motionEnergy(last, vec);
            userFrames.push({t, vec, vis, energy: e});
            last = vec;
            
            computeScores();
            tryJudge(t, vec, lms);
          }
          nextT += interval;
        }
        
        drawNextGhost(t);
        handleMiss(t);
        rafId = requestAnimationFrame(loop);
      }
      rafId = requestAnimationFrame(loop);
    }

    function stopGame(showResults = true) {
      running = false;
      if (rafId) cancelAnimationFrame(rafId);
      document.getElementById('startGameBtn').disabled = false;
      document.getElementById('stopGameBtn').disabled = true;
      document.getElementById('stopGameBtn').classList.add('hidden');
      els.refVideo.pause();
      document.getElementById('runStatus').textContent = 'â¸ï¸ å·²åœæ­¢';
      if (showResults) showResultsModal();
    }

    // ===== äº‹ä»¶ç»‘å®š =====
    document.getElementById('startGameBtn').onclick = async () => {
      await loadPose();
      if (!els.camVideo.srcObject) return document.getElementById('runStatus').textContent = 'è¯·å…ˆæ‰“å¼€æ‘„åƒå¤´';
      if (!refFrames.length) return document.getElementById('runStatus').textContent = 'è¯·å…ˆåˆ†æå‚è€ƒè§†é¢‘';
      
      lastBeatIdx = -1; lastHitTime = -1e9;
      startAfterCountdown();
    };

    document.getElementById('stopGameBtn').onclick = () => stopGame(true);
    els.refVideo.addEventListener('ended', () => { if (running) stopGame(true); });

    // ===== å€’è®¡æ—¶å¯åŠ¨ =====
    async function startAfterCountdown() {
      let seq = ['3', '2', '1', 'GO!'];
      const overlay = document.getElementById('countdownOverlay');
      const numberEl = document.getElementById('countdownNumber');
      
      overlay.classList.remove('hidden');
      for (let i = 0; i < seq.length; i++) {
        numberEl.textContent = seq[i];
        await new Promise(r => setTimeout(r, 800));
      }
      overlay.classList.add('hidden');
      
      els.refVideo.play();
      startGame();
    }

    // ===== å…¶ä»–å¿…è¦å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰=====
    function normalizeAndFlatten(lms) {
      // ç®€åŒ–å§¿æ€å‘é‡å½’ä¸€åŒ–
      const hips = [(lms[23].x + lms[24].x)/2, (lms[23].y + lms[24].y)/2];
      return lms.map(p => Math.hypot(p.x-hips[0], p.y-hips[1]));
    }
    
    function oneEuroVec(vec, t) { return vec; } // ç®€åŒ–
    function motionEnergy(a, b) { return a ? Math.hypot(...a.map((v,i) => v - b[i])) : 0; }
    function detectPeaks(times, ener, opts) { return []; } // ç®€åŒ–
    
    function computeScores() { /* ç®€åŒ– */ }
    function drawAvatar(lms) {}
    function drawNextGhost(t) {}
    function tryJudge(t, vec, lms) {}
    function handleMiss(t) {}
    
    // åˆå§‹åŒ–
    initCtx();
    document.getElementById('lookahead').addEventListener('input', e => {
      document.getElementById('lookaheadVal').textContent = e.target.value + 'ms';
    });
  </script>
</body>
</html>