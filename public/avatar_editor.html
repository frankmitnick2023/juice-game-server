<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Avatar Salon</title>
  <style>
    /* ... CSS ä¿æŒä¸å˜ ... */
    body { background: #1a1a2e; margin: 0; font-family: sans-serif; color: white; height: 100vh; display: flex; flex-direction: column; }
    .preview-area { flex: 1; background: radial-gradient(circle at center, #2a2a4a, #1a1a2e); display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden; }
    .spotlight { position: absolute; top: -20%; left: 50%; transform: translateX(-50%); width: 60%; height: 80%; background: linear-gradient(to bottom, rgba(255,255,255,0.1), transparent); filter: blur(30px); pointer-events: none; }
    .avatar-img { height: 75vh; width: auto; max-width: 90%; object-fit: contain; transition: all 0.3s; filter: drop-shadow(0 20px 30px rgba(0,0,0,0.6)); z-index: 10; }
    .controls { background: rgba(22, 33, 62, 0.95); padding: 20px; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); backdrop-filter: blur(10px); z-index: 20; }
    .c-title { font-size: 0.9rem; color: #aaa; margin-bottom: 10px; display: flex; justify-content: space-between; }
    .outfit-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
    .outfit-btn { flex-shrink: 0; width: 70px; height: 70px; background: #222; border: 2px solid #444; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
    .outfit-btn span { font-size: 0.7rem; color: #ccc; }
    .outfit-btn.selected { border-color: #e94560; background: #2a1a2a; box-shadow: 0 0 15px rgba(233, 69, 96, 0.4); }
    .outfit-btn.selected span { color: #e94560; font-weight: bold; }
    .slider-container { margin-top: 15px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; }
    input[type=range] { width: 100%; accent-color: #e94560; cursor: pointer; }
    .btn-save { width: 100%; background: linear-gradient(90deg, #ff9966, #ff5e62); color: white; border: none; padding: 15px; border-radius: 12px; font-size: 1.1rem; font-weight: bold; margin-top: 15px; box-shadow: 0 5px 15px rgba(255, 94, 98, 0.4); cursor: pointer; }
    .btn-back { position: absolute; top: 20px; left: 20px; color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.9rem; z-index: 50; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 15px; }
  </style>
</head>
<body>
<a href="/games.html" class="btn-back">â—€ Back (è¿”å›)</a>
<div class="preview-area">
    <div class="spotlight"></div>
    <img id="avatarDisplay" class="avatar-img" src="" alt="Avatar">
</div>
<div class="controls">
    <div class="c-title"><span>ğŸ‘” Outfit (è£…æ‰®)</span><span id="genderLabel" style="font-size:0.8rem; color:#4facfe">...</span></div>
    <div class="outfit-scroll">
        <div class="outfit-btn selected" onclick="setOutfit('uniform', this)"><span style="font-size:24px">ğŸ‘•</span><span>Uniform</span></div>
        <div class="outfit-btn" onclick="setOutfit('ballet', this)"><span style="font-size:24px">ğŸ©°</span><span>Ballet</span></div>
        <div class="outfit-btn" onclick="setOutfit('jazz', this)"><span style="font-size:24px">ğŸ©</span><span>Jazz</span></div>
        <div class="outfit-btn" onclick="setOutfit('hiphop', this)"><span style="font-size:24px">ğŸ§¢</span><span>HipHop</span></div>
        <div class="outfit-btn" onclick="setOutfit('kpop', this)"><span style="font-size:24px">ğŸ¤</span><span>K-POP</span></div>
    </div>
    <div class="slider-container">
        <div class="c-title">ğŸ“ Body Shape (èº«æ)</div>
        <input type="range" id="bodySlider" min="0.85" max="1.15" step="0.01" value="1">
    </div>
    <button class="btn-save" onclick="saveAvatar()">âœ¨ Save (ä¿å­˜)</button>
</div>
<script>
    let currentConfig = { outfit: 'uniform', bodyScale: 1.0, gender: 'girl', ageGroup: 'junior' };
    async function init() {
        try {
            const res = await fetch('/api/me');
            const user = await res.json();
            if(!user.id) return location.href='/';
            const name = (user.student_name || "").toLowerCase();
            if (/[aeiy]$/.test(name) || ['yolanda','cindy'].some(n=>name.includes(n))) { currentConfig.gender = 'girl'; document.getElementById('genderLabel').textContent = "â™€ Girl"; } 
            else { currentConfig.gender = 'boy'; document.getElementById('genderLabel').textContent = "â™‚ Boy"; }
            let age = 7; if (user.dob) age = new Date().getFullYear() - new Date(user.dob).getFullYear();
            currentConfig.ageGroup = age >= 10 ? 'senior' : 'junior';
            if (user.avatar_config) {
                if(user.avatar_config.outfit) currentConfig.outfit = user.avatar_config.outfit;
                if(user.avatar_config.bodyScale) currentConfig.bodyScale = user.avatar_config.bodyScale;
                document.getElementById('bodySlider').value = currentConfig.bodyScale;
            }
            updateImage();
        } catch(e) {}
    }
    window.setOutfit = function(type, btn) {
        currentConfig.outfit = type;
        document.querySelectorAll('.outfit-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        updateImage();
    }
    document.getElementById('bodySlider').oninput = function() { currentConfig.bodyScale = this.value; const img = document.getElementById('avatarDisplay'); img.style.transform = `scaleX(${this.value})`; };
    function updateImage() {
        const img = document.getElementById('avatarDisplay');
        const filename = `${currentConfig.gender}_${currentConfig.ageGroup}_${currentConfig.outfit}.png`;
        const fullPath = `/avatars/${filename}`;
        img.src = fullPath;
        img.style.transform = `scaleX(${currentConfig.bodyScale})`;
        img.onerror = () => { img.src = `https://api.dicebear.com/7.x/adventurer/svg?seed=${currentConfig.gender}&backgroundColor=transparent`; };
    }
    window.saveAvatar = async function() {
        try { await fetch('/api/save-avatar', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ config: currentConfig }) }); alert('âœ¨ Saved!'); location.href = '/games.html'; } catch(e) { alert('Error'); }
    }
    init();
</script>
</body>
</html>