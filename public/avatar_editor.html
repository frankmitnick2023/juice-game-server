<script>
    let currentConfig = { outfit: 'uniform', bodyScale: 1.0, gender: 'girl', ageGroup: 'junior', useAiAvatar: false, aiAvatarUrl: null };

    async function init() {
        try {
            const res = await fetch('/api/me');
            const user = await res.json();
            if(!user.id) return location.href='/';

            const name = (user.student_name || "").toLowerCase();
            if (/[aeiy]$/.test(name) || ['yolanda','cindy'].some(n=>name.includes(n))) { currentConfig.gender = 'girl'; document.getElementById('genderLabel').textContent = "♀ Girl"; } 
            else { currentConfig.gender = 'boy'; document.getElementById('genderLabel').textContent = "♂ Boy"; }
            let age = 7; if (user.dob) age = new Date().getFullYear() - new Date(user.dob).getFullYear();
            currentConfig.ageGroup = age >= 10 ? 'senior' : 'junior';

            if (user.avatar_config) {
                Object.assign(currentConfig, user.avatar_config);
                // 恢复滑块状态
                if(currentConfig.bodyScale) document.getElementById('bodySlider').value = currentConfig.bodyScale;
                // 恢复衣服按钮状态
                if(currentConfig.outfit) {
                    document.querySelectorAll('.outfit-btn').forEach(btn => {
                        btn.classList.remove('selected');
                        if(btn.innerText.toLowerCase().includes(translateOutfit(currentConfig.outfit))) {
                            btn.classList.add('selected');
                        }
                    });
                }
            }
            updateImage();
        } catch(e) { console.error(e); }
    }

    function translateOutfit(code) {
        const map = {'uniform':'校服', 'ballet':'芭蕾', 'jazz':'爵士', 'hiphop':'街舞', 'kpop':'k-pop'};
        return map[code] || '校服';
    }

    window.setOutfit = function(type, btn) {
        currentConfig.outfit = type;
        currentConfig.useAiAvatar = false; // 切换衣服时退出 AI 模式
        document.querySelectorAll('.outfit-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        updateImage();
    }

    document.getElementById('bodySlider').oninput = function() {
        currentConfig.bodyScale = this.value;
        const img = document.getElementById('avatarDisplay');
        img.style.transform = `scaleX(${this.value})`;
    };

    async function generateAI() {
        const input = document.getElementById('aiInput');
        if(input.files.length === 0) return;

        document.getElementById('loader').style.display = 'flex';
        const formData = new FormData();
        formData.append('faceImage', input.files[0]);

        try {
            const res = await fetch('/api/generate-avatar', { method:'POST', body:formData });
            const data = await res.json();
            
            if(data.success) {
                currentConfig.useAiAvatar = true;
                currentConfig.aiAvatarUrl = data.url;
                alert(data.mode === 'Mock' ? '⚠️ 模拟模式：生成了随机卡通形象 (因为没有API Key)' : '✅ AI 生成成功！');
                updateImage();
            } else {
                // 显示详细错误
                alert('生成失败: ' + (data.detail || data.error));
            }
        } catch(e) { 
            alert('请求出错: ' + e.message); 
        }
        finally { document.getElementById('loader').style.display = 'none'; }
    }

    function updateImage() {
        const img = document.getElementById('avatarDisplay');
        
        if (currentConfig.useAiAvatar && currentConfig.aiAvatarUrl) {
            img.src = currentConfig.aiAvatarUrl;
            img.style.transform = 'scaleX(1)'; // AI 图不缩放
        } else {
            const filename = `${currentConfig.gender}_${currentConfig.ageGroup}_${currentConfig.outfit}.png`;
            const fullPath = `/avatars/${filename}`;
            img.src = fullPath;
            img.style.transform = `scaleX(${currentConfig.bodyScale})`;
            img.onerror = () => { img.src = `https://api.dicebear.com/7.x/adventurer/svg?seed=${currentConfig.gender}&backgroundColor=transparent`; };
        }
    }

    window.saveAvatar = async function() {
        const btn = document.querySelector('.btn-save');
        btn.textContent = '保存中...';
        try { 
            const res = await fetch('/api/save-avatar', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ config: currentConfig }) 
            }); 
            const data = await res.json();
            if (res.ok) {
                alert('✨ 形象已保存！');
                location.href = '/games.html';
            } else {
                alert('保存失败: ' + (data.error || data.detail));
            }
        } catch(e) { alert('网络错误: ' + e.message); }
        btn.textContent = '✨ 保存我的形象';
    }

    init();
</script>