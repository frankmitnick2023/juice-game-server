<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Avatar Salon</title>
  <style>
    /* ... ä¿æŒåŸæœ‰ CSS ... */
    body { background: #1a1a2e; margin: 0; font-family: sans-serif; color: white; height: 100vh; display: flex; flex-direction: column; }
    .preview-area { flex: 1; background: radial-gradient(circle at center, #2a2a4a, #1a1a2e); display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden; }
    .spotlight { position: absolute; top: -20%; left: 50%; transform: translateX(-50%); width: 60%; height: 80%; background: linear-gradient(to bottom, rgba(255,255,255,0.1), transparent); filter: blur(30px); pointer-events: none; }
    .avatar-img { height: 70vh; width: auto; max-width: 90%; object-fit: contain; transition: all 0.3s; filter: drop-shadow(0 20px 30px rgba(0,0,0,0.6)); z-index: 10; }
    .controls { background: rgba(22, 33, 62, 0.95); padding: 15px; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); backdrop-filter: blur(10px); z-index: 20; }
    .c-title { font-size: 0.9rem; color: #aaa; margin-bottom: 10px; display: flex; justify-content: space-between; }
    
    /* AI ä¸“å±æ ·å¼ */
    .ai-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border-radius: 12px; margin-bottom: 15px; text-align: center; }
    .ai-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
    
    .outfit-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
    .outfit-btn { flex-shrink: 0; width: 60px; height: 60px; background: #222; border: 2px solid #444; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
    .outfit-btn span { font-size: 0.7rem; color: #ccc; }
    .outfit-btn.selected { border-color: #e94560; background: #2a1a2a; }
    
    .btn-save { width: 100%; background: linear-gradient(90deg, #ff9966, #ff5e62); color: white; border: none; padding: 15px; border-radius: 12px; font-size: 1.1rem; font-weight: bold; margin-top: 10px; }
    .btn-back { position: absolute; top: 20px; left: 20px; color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.9rem; z-index: 50; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 15px; }
    
    .loader { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 100; display: none; flex-direction: column; justify-content: center; align-items: center; }
  </style>
</head>
<body>

<a href="/games.html" class="btn-back">â—€ Back</a>

<div class="preview-area">
    <div class="spotlight"></div>
    <img id="avatarDisplay" class="avatar-img" src="" alt="Avatar">
</div>

<div class="controls">
    <div class="ai-section">
        <div style="font-size:0.9rem; margin-bottom:5px">âœ¨ Magic: Generate from Photo</div>
        <label class="ai-btn">
            ğŸ“· Upload Selfie (ä¸Šä¼ è‡ªæ‹)
            <input type="file" id="aiInput" accept="image/*" style="display:none" onchange="generateAI()">
        </label>
        <div style="font-size:0.7rem; opacity:0.8; margin-top:5px">Turn your photo into a cute cartoon!</div>
    </div>

    <div class="c-title">
        <span>ğŸ‘” Or Select Outfit (æˆ–æ‰‹åŠ¨æ¢è£…)</span>
        <span id="genderLabel" style="font-size:0.8rem; color:#4facfe">...</span>
    </div>
    
    <div class="outfit-scroll">
        <div class="outfit-btn selected" onclick="setOutfit('uniform', this)"><span style="font-size:24px">ğŸ‘•</span><span>Uniform</span></div>
        <div class="outfit-btn" onclick="setOutfit('ballet', this)"><span style="font-size:24px">ğŸ©°</span><span>Ballet</span></div>
        <div class="outfit-btn" onclick="setOutfit('jazz', this)"><span style="font-size:24px">ğŸ©</span><span>Jazz</span></div>
        <div class="outfit-btn" onclick="setOutfit('hiphop', this)"><span style="font-size:24px">ğŸ§¢</span><span>HipHop</span></div>
        <div class="outfit-btn" onclick="setOutfit('kpop', this)"><span style="font-size:24px">ğŸ¤</span><span>K-POP</span></div>
    </div>

    <button class="btn-save" onclick="saveAvatar()">âœ¨ Save Avatar</button>
</div>

<div class="loader" id="loader">
    <div style="font-size:3rem">ğŸª„</div>
    <div style="margin-top:10px">AI Generating... Please wait (ç”Ÿæˆä¸­)</div>
</div>

<script>
    let currentConfig = { outfit: 'uniform', bodyScale: 1.0, gender: 'girl', ageGroup: 'junior', useAiAvatar: false, aiAvatarUrl: null };

    async function init() {
        try {
            const res = await fetch('/api/me');
            const user = await res.json();
            if(!user.id) return location.href='/';

            // æ€§åˆ«/å¹´é¾„é€»è¾‘
            const name = (user.student_name || "").toLowerCase();
            if (/[aeiy]$/.test(name) || ['yolanda','cindy'].some(n=>name.includes(n))) { currentConfig.gender = 'girl'; document.getElementById('genderLabel').textContent = "â™€ Girl"; } 
            else { currentConfig.gender = 'boy'; document.getElementById('genderLabel').textContent = "â™‚ Boy"; }
            let age = 7; if (user.dob) age = new Date().getFullYear() - new Date(user.dob).getFullYear();
            currentConfig.ageGroup = age >= 10 ? 'senior' : 'junior';

            // åŠ è½½å·²æœ‰é…ç½®
            if (user.avatar_config) {
                // åˆå¹¶é…ç½®
                Object.assign(currentConfig, user.avatar_config);
            }
            updateImage();
        } catch(e) {}
    }

    window.setOutfit = function(type, btn) {
        currentConfig.outfit = type;
        currentConfig.useAiAvatar = false; // åªè¦ç‚¹äº†è¡£æœï¼Œå°±åˆ‡å›æ™®é€šæ¨¡å¼
        document.querySelectorAll('.outfit-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        updateImage();
    }

    async function generateAI() {
        const input = document.getElementById('aiInput');
        if(input.files.length === 0) return;

        document.getElementById('loader').style.display = 'flex';
        const formData = new FormData();
        formData.append('faceImage', input.files[0]); // è¿™é‡Œå¤ç”¨ä¸Šä¼ ç»„ä»¶ï¼Œä½†åœ¨åç«¯æ˜¯å‘ç»™ AI

        try {
            // è°ƒç”¨åç«¯ç”Ÿæˆæ¥å£
            const res = await fetch('/api/generate-avatar', { method:'POST', body:formData });
            const data = await res.json();
            
            if(data.success) {
                currentConfig.useAiAvatar = true;
                currentConfig.aiAvatarUrl = data.url; // è¿™æ˜¯ä¸€ä¸ª URL
                updateImage();
            } else {
                alert('AI Generation Failed (ç”Ÿæˆå¤±è´¥)');
            }
        } catch(e) { alert('Error'); }
        finally { document.getElementById('loader').style.display = 'none'; }
    }

    function updateImage() {
        const img = document.getElementById('avatarDisplay');
        
        if (currentConfig.useAiAvatar && currentConfig.aiAvatarUrl) {
            // æ˜¾ç¤º AI ç”Ÿæˆçš„å›¾
            img.src = currentConfig.aiAvatarUrl;
        } else {
            // æ˜¾ç¤ºæ‹¼å›¾
            const filename = `${currentConfig.gender}_${currentConfig.ageGroup}_${currentConfig.outfit}.png`;
            const fullPath = `/avatars/${filename}`;
            img.src = fullPath;
            img.onerror = () => { img.src = `https://api.dicebear.com/7.x/adventurer/svg?seed=${currentConfig.gender}&backgroundColor=transparent`; };
        }
    }

    window.saveAvatar = async function() {
        try { await fetch('/api/save-avatar', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ config: currentConfig }) }); alert('âœ¨ Saved!'); location.href = '/games.html'; } catch(e) { alert('Error'); }
    }

    init();
</script>
</body>
</html>