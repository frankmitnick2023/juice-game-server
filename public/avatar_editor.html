<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>ÂΩ¢Ë±°Ê≤ôÈæô</title>
  <style>
    body { background: #1a1a2e; margin: 0; font-family: sans-serif; color: white; height: 100vh; display: flex; flex-direction: column; }
    
    .preview-area { 
        flex: 1; 
        background: radial-gradient(circle at center, #2a2a4a, #1a1a2e); 
        display: flex; justify-content: center; align-items: center; 
        position: relative; 
        overflow: hidden;
    }
    
    .spotlight {
        position: absolute; top: -20%; left: 50%; transform: translateX(-50%);
        width: 60%; height: 80%;
        background: linear-gradient(to bottom, rgba(255,255,255,0.1), transparent);
        filter: blur(30px); pointer-events: none;
    }

    .avatar-img { 
        height: 75vh; 
        width: auto; 
        max-width: 90%;
        object-fit: contain; 
        transition: opacity 0.3s ease; /* Removed transform transition */
        filter: drop-shadow(0 20px 30px rgba(0,0,0,0.6)); 
        z-index: 10;
    }
    
    .controls { 
        background: rgba(22, 33, 62, 0.95); 
        padding: 20px; 
        border-radius: 20px 20px 0 0; 
        box-shadow: 0 -5px 20px rgba(0,0,0,0.5); 
        backdrop-filter: blur(10px);
        z-index: 20;
    }
    
    .c-title { font-size: 0.9rem; color: #aaa; margin-bottom: 10px; display: flex; justify-content: space-between; }
    
    .outfit-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
    .outfit-btn { 
        flex-shrink: 0; width: 70px; height: 70px; 
        background: #222; border: 2px solid #444; border-radius: 12px; 
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        cursor: pointer; transition: 0.2s;
    }
    .outfit-btn img { width: 30px; height: 30px; margin-bottom: 5px; }
    .outfit-btn span { font-size: 0.7rem; color: #ccc; }
    
    .outfit-btn.selected { border-color: #e94560; background: #2a1a2a; box-shadow: 0 0 15px rgba(233, 69, 96, 0.4); }
    .outfit-btn.selected span { color: #e94560; font-weight: bold; }

    /* Slider styles removed */

    .btn-save { 
        width: 100%; background: linear-gradient(90deg, #ff9966, #ff5e62); 
        color: white; border: none; padding: 15px; border-radius: 12px; 
        font-size: 1.1rem; font-weight: bold; margin-top: 15px; 
        box-shadow: 0 5px 15px rgba(255, 94, 98, 0.4);
        cursor: pointer;
    }
    .btn-save:active { transform: scale(0.98); }

    .btn-back { position: absolute; top: 20px; left: 20px; color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.9rem; z-index: 50; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 15px; }
    
    /* AI Âå∫Âüü */
    .ai-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border-radius: 12px; margin-bottom: 15px; text-align: center; }
    .ai-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; font-size: 0.9rem; }
    
    .loader { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 100; display: none; flex-direction: column; justify-content: center; align-items: center; }
  </style>
</head>
<body>

<a href="/games.html" class="btn-back">‚óÄ Back</a>

<div class="preview-area">
    <div class="spotlight"></div>
    <img id="avatarDisplay" class="avatar-img" src="" alt="Avatar">
</div>

<div class="controls">
    <div class="ai-section">
        <div style="font-size:0.9rem; margin-bottom:5px; font-weight:bold;">‚ú® AI Magic: Create Your Avatar</div>
        <label class="ai-btn">
            üì∑ Upload Selfie (‰∏ä‰º†Ëá™Êãç)
            <input type="file" id="aiInput" accept="image/*" style="display:none" onchange="generateAI()">
        </label>
    </div>

    <div class="c-title">
        <span>üëî Outfit (Ë£ÖÊâÆ)</span>
        <span id="genderLabel" style="font-size:0.8rem; color:#4facfe">Loading...</span>
    </div>
    
    <div class="outfit-scroll">
        <div class="outfit-btn selected" onclick="setOutfit('uniform', this)">
            <span style="font-size:24px">üëï</span>
            <span>Uniform</span>
        </div>
        <div class="outfit-btn" onclick="setOutfit('ballet', this)">
            <span style="font-size:24px">ü©∞</span>
            <span>Ballet</span>
        </div>
        <div class="outfit-btn" onclick="setOutfit('jazz', this)">
            <span style="font-size:24px">üé©</span>
            <span>Jazz</span>
        </div>
        <div class="outfit-btn" onclick="setOutfit('hiphop', this)">
            <span style="font-size:24px">üß¢</span>
            <span>HipHop</span>
        </div>
        <div class="outfit-btn" onclick="setOutfit('kpop', this)">
            <span style="font-size:24px">üé§</span>
            <span>K-POP</span>
        </div>
    </div>

    <button class="btn-save" onclick="saveAvatar()">‚ú® Save Avatar</button>
</div>

<div class="loader" id="loader">
    <div style="font-size:3rem">ü™Ñ</div>
    <div style="margin-top:10px">AI Generating... (ÁîüÊàê‰∏≠)</div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Âà†Èô§‰∫Ü bodyScale Â≠óÊÆµ
        let currentConfig = { outfit: 'uniform', gender: 'girl', ageGroup: 'junior', useAiAvatar: false, aiAvatarUrl: null };
        
        // ÂàùÂßãÂåñ
        init();

        async function init() {
            try {
                const res = await fetch('/api/me');
                const user = await res.json();
                if(!user.id) return location.href='/';

                // 1. ÊÄßÂà´Âà§Êñ≠ (‰øùÊåÅ‰∏çÂèò)
                const name = (user.student_name || "").toLowerCase();
                if (/[aeiy]$/.test(name) || ['yolanda','cindy','alice'].some(n=>name.includes(n))) { 
                    currentConfig.gender = 'girl'; 
                    document.getElementById('genderLabel').textContent = "‚ôÄ Girl"; 
                    document.getElementById('genderLabel').style.color = "#ff69b4";
                } else { 
                    currentConfig.gender = 'boy'; 
                    document.getElementById('genderLabel').textContent = "‚ôÇ Boy"; 
                    document.getElementById('genderLabel').style.color = "#4facfe";
                }

                // 2. ‚òÖ‚òÖ‚òÖ Ê†∏ÂøÉ‰øÆÂ§çÔºöÂº∫Âà∂ËÆ°ÁÆóÂπ¥ÈæÑÁªÑ ‚òÖ‚òÖ‚òÖ
                let age = 7; 
                if (user.dob) {
                    // Á≤æÁ°ÆËÆ°ÁÆóÂπ¥ÈæÑ
                    const dob = new Date(user.dob);
                    const diff = Date.now() - dob.getTime();
                    const ageDate = new Date(diff); 
                    age = Math.abs(ageDate.getUTCFullYear() - 1970);
                }
                
                // ËÆ°ÁÆóÂá∫ÁöÑÊ≠£Á°ÆÁªÑÂà´
                let correctAgeGroup = 'junior';
                if (age >= 12) correctAgeGroup = 'senior';
                else if (age >= 8) correctAgeGroup = 'middle'; // 9Â≤Å‰ºöËøõËøôÈáå
                else correctAgeGroup = 'junior';

                // 3. ËØªÂèñÂ∑≤‰øùÂ≠òÁöÑËÆæÁΩÆ (Ë°£ÊúçÁ≠â)
                if (user.avatar_config) {
                    Object.assign(currentConfig, user.avatar_config);
                }

                // ‚òÖ‚òÖ‚òÖ ÂÖ≥ÈîÆ‰∏ÄÊ≠•ÔºöÂº∫Âà∂Êää AgeGroup ÊîπÂõûÁÆóÂá∫Êù•ÁöÑÊ≠£Á°ÆÂÄº ‚òÖ‚òÖ‚òÖ
                // Âì™ÊÄïÊï∞ÊçÆÂ∫ìÈáåÂ≠òÁöÑÊòØ SeniorÔºåËøôÈáå‰πü‰ºöÂº∫Âà∂ÊîπÊàê Middle
                currentConfig.ageGroup = correctAgeGroup; 

                // 4. ÊÅ¢Â§çÊåâÈíÆÈÄâ‰∏≠ÊÄÅ
                if(currentConfig.outfit && !currentConfig.useAiAvatar) {
                     updateButtonState(currentConfig.outfit);
                }

                updateImage();
            } catch(e) { console.error(e); }
        }
        function updateButtonState(outfitCode) {
            const map = {'uniform':'Uniform', 'ballet':'Ballet', 'jazz':'Jazz', 'hiphop':'HipHop', 'kpop':'K-POP'};
            const text = map[outfitCode] || 'Uniform';
            document.querySelectorAll('.outfit-btn').forEach(btn => {
                btn.classList.remove('selected');
                if(btn.innerText.includes(text)) btn.classList.add('selected');
            });
        }

        window.setOutfit = function(type, btn) {
            currentConfig.outfit = type;
            currentConfig.useAiAvatar = false;
            document.querySelectorAll('.outfit-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            updateImage();
        }

        window.generateAI = async function() {
            const input = document.getElementById('aiInput');
            if(input.files.length === 0) return;

            document.getElementById('loader').style.display = 'flex';
            const formData = new FormData();
            formData.append('faceImage', input.files[0]);

            try {
                const res = await fetch('/api/generate-avatar', { method:'POST', body:formData });
                const data = await res.json();
                
                if(data.success) {
                    currentConfig.useAiAvatar = true;
                    currentConfig.aiAvatarUrl = data.url;
                    alert(data.mode === 'Mock' ? '‚ö†Ô∏è Mock Mode - Random Avatar' : '‚úÖ AI Avatar Generated!');
                    updateImage();
                } else {
                    alert('Failed: ' + (data.detail || data.error));
                }
            } catch(e) { alert('Error: ' + e.message); }
            finally { document.getElementById('loader').style.display = 'none'; input.value = ''; }
        }

        function updateImage() {
            const img = document.getElementById('avatarDisplay');
            if (!img) return;

            if (currentConfig.useAiAvatar && currentConfig.aiAvatarUrl) {
                img.src = currentConfig.aiAvatarUrl;
                // Removed scaleX logic
            } else {
                const filename = `${currentConfig.gender}_${currentConfig.ageGroup}_${currentConfig.outfit}.png`;
                const fullPath = `/avatars/${filename}`;
                
                img.src = fullPath;
                // Removed scaleX logic
                
                img.onerror = () => {
                    console.warn("Missing:", fullPath);
                    const seed = currentConfig.gender + currentConfig.outfit;
                    img.src = `https://api.dicebear.com/7.x/adventurer/svg?seed=${seed}&backgroundColor=transparent`;
                };
            }
        }

        window.saveAvatar = async function() {
            const btn = document.querySelector('.btn-save');
            btn.textContent = 'Saving...';
            try { 
                await fetch('/api/save-avatar', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ config: currentConfig }) 
                }); 
                alert('‚ú® Saved!'); 
                location.href = '/games.html'; 
            } catch(e) { alert('Error'); }
            btn.textContent = '‚ú® Save Avatar';
        }
    });
</script>
</body>
</html>
