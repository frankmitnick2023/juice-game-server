<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>å½¢è±¡æ²™é¾™</title>
  <style>
    body { background: #1a1a2e; margin: 0; font-family: sans-serif; color: white; height: 100vh; display: flex; flex-direction: column; }
    
    /* === 1. å±•å°åŒº === */
    .preview-area { 
        flex: 1; 
        background: radial-gradient(circle at center, #2a2a4a, #1a1a2e); 
        display: flex; justify-content: center; align-items: center; 
        position: relative; 
        overflow: hidden;
    }
    
    /* èšå…‰ç¯ */
    .spotlight {
        position: absolute; top: -20%; left: 50%; transform: translateX(-50%);
        width: 60%; height: 80%;
        background: linear-gradient(to bottom, rgba(255,255,255,0.1), transparent);
        filter: blur(30px); pointer-events: none;
    }

    /* æ ¸å¿ƒäººç‰©å›¾ */
    .avatar-img { 
        height: 75vh; /* å æ®å±å¹•é«˜åº¦çš„75% */
        width: auto; 
        max-width: 90%;
        object-fit: contain; 
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* å¼¹æ€§åŠ¨ç”» */
        filter: drop-shadow(0 20px 30px rgba(0,0,0,0.6)); 
        z-index: 10;
    }
    
    /* === 2. æ§åˆ¶é¢æ¿ === */
    .controls { 
        background: rgba(22, 33, 62, 0.95); 
        padding: 20px; 
        border-radius: 20px 20px 0 0; 
        box-shadow: 0 -5px 20px rgba(0,0,0,0.5); 
        backdrop-filter: blur(10px);
        z-index: 20;
    }
    
    .c-title { font-size: 0.9rem; color: #aaa; margin-bottom: 10px; display: flex; justify-content: space-between; }
    
    /* è¡£æœé€‰æ‹©å™¨ */
    .outfit-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
    .outfit-btn { 
        flex-shrink: 0; width: 70px; height: 70px; 
        background: #222; border: 2px solid #444; border-radius: 12px; 
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        cursor: pointer; transition: 0.2s;
    }
    .outfit-btn img { width: 30px; height: 30px; margin-bottom: 5px; }
    .outfit-btn span { font-size: 0.7rem; color: #ccc; }
    
    .outfit-btn.selected { border-color: #e94560; background: #2a1a2a; box-shadow: 0 0 15px rgba(233, 69, 96, 0.4); }
    .outfit-btn.selected span { color: #e94560; font-weight: bold; }

    /* èº«ææ»‘å— */
    .slider-container { margin-top: 15px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; }
    input[type=range] { width: 100%; accent-color: #e94560; cursor: pointer; }

    .btn-save { 
        width: 100%; background: linear-gradient(90deg, #ff9966, #ff5e62); 
        color: white; border: none; padding: 15px; border-radius: 12px; 
        font-size: 1.1rem; font-weight: bold; margin-top: 15px; 
        box-shadow: 0 5px 15px rgba(255, 94, 98, 0.4);
        cursor: pointer;
    }
    .btn-save:active { transform: scale(0.98); }

    .btn-back { position: absolute; top: 20px; left: 20px; color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.9rem; z-index: 50; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 15px; }

    /* Loading */
    .loading-mask { position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100;}
  </style>
</head>
<body>

<a href="/games.html" class="btn-back">â—€ è¿”å›å¤§å…</a>

<div class="preview-area">
    <div class="spotlight"></div>
    
    <img id="avatarDisplay" class="avatar-img" src="" alt="Avatar">
    
    <div id="imgLoader" class="loading-mask"><span>åŠ è½½ç´ æ...</span></div>
</div>

<div class="controls">
    
    <div class="c-title">
        <span>ğŸ‘” é€‰æ‹©è£…æ‰® (Outfit)</span>
        <span id="genderLabel" style="font-size:0.8rem; color:#4facfe">è¯†åˆ«ä¸­...</span>
    </div>
    
    <div class="outfit-scroll">
        <div class="outfit-btn selected" onclick="setOutfit('uniform', this)">
            <span style="font-size:24px">ğŸ‘•</span>
            <span>æ ¡æœ</span>
        </div>
        <div class="outfit-btn" onclick="setOutfit('ballet', this)">
            <span style="font-size:24px">ğŸ©°</span>
            <span>èŠ­è•¾</span>
        </div>
        <div class="outfit-btn" onclick="setOutfit('jazz', this)">
            <span style="font-size:24px">ğŸ©</span>
            <span>çˆµå£«</span>
        </div>
        <div class="outfit-btn" onclick="setOutfit('hiphop', this)">
            <span style="font-size:24px">ğŸ§¢</span>
            <span>è¡—èˆ</span>
        </div>
        <div class="outfit-btn" onclick="setOutfit('kpop', this)">
            <span style="font-size:24px">ğŸ¤</span>
            <span>K-POP</span>
        </div>
    </div>

    <div class="slider-container">
        <div class="c-title">ğŸ“ èº«æå¾®è°ƒ (Body Shape)</div>
        <input type="range" id="bodySlider" min="0.85" max="1.15" step="0.01" value="1">
    </div>

    <button class="btn-save" onclick="saveAvatar()">âœ¨ ä¿å­˜æˆ‘çš„å½¢è±¡</button>
</div>

<script>
    // é»˜è®¤é…ç½®
    let currentConfig = {
        outfit: 'uniform',
        bodyScale: 1.0,
        gender: 'girl', // è‡ªåŠ¨ä»æ•°æ®åº“è·å–
        ageGroup: 'junior' // è‡ªåŠ¨ä»æ•°æ®åº“è·å–
    };

    // 1. åˆå§‹åŒ–ï¼šè·å–ç”¨æˆ·èµ„æ–™ï¼Œå†³å®š Gender å’Œ AgeGroup
    async function init() {
        try {
            const res = await fetch('/api/me');
            const user = await res.json();
            if(!user.id) return location.href='/';

            // --- è‡ªåŠ¨åˆ¤å®šæ€§åˆ« ---
            // ç®€å•é€»è¾‘ï¼šåå­—ç»“å°¾ a/e/i/y æˆ–å¸¸è§å¥³å -> Girlï¼Œå¦åˆ™ Boy
            const name = (user.student_name || "").toLowerCase();
            if (/[aeiy]$/.test(name) || ['yolanda','cindy','alice'].some(n=>name.includes(n))) {
                currentConfig.gender = 'girl';
                document.getElementById('genderLabel').textContent = "â™€ å¥³å­©æ¨¡ç‰ˆ";
                document.getElementById('genderLabel').style.color = "#ff69b4";
            } else {
                currentConfig.gender = 'boy';
                document.getElementById('genderLabel').textContent = "â™‚ ç”·å­©æ¨¡ç‰ˆ";
                document.getElementById('genderLabel').style.color = "#4facfe";
            }

            // --- è‡ªåŠ¨åˆ¤å®šå¹´é¾„ç»„ ---
            let age = 7;
            if (user.dob) age = new Date().getFullYear() - new Date(user.dob).getFullYear();
            
            if (age <= 9) currentConfig.ageGroup = 'junior';
            else currentConfig.ageGroup = 'senior'; // ç®€åŒ–ä¸ºä¸¤æ¡£ï¼Œæ–¹ä¾¿ä½ å‡†å¤‡ç´ æ

            // å¦‚æœä»¥å‰ä¿å­˜è¿‡é…ç½®ï¼Œè¦†ç›–é»˜è®¤å€¼
            if (user.avatar_config) {
                // åªéœ€è¦ outfit å’Œ scaleï¼Œgender/ageGroup å§‹ç»ˆé‡æ–°è®¡ç®—ä»¥ä¿æŒæœ€æ–°
                if(user.avatar_config.outfit) currentConfig.outfit = user.avatar_config.outfit;
                if(user.avatar_config.bodyScale) currentConfig.bodyScale = user.avatar_config.bodyScale;
                
                // æ¢å¤æ»‘å—å’ŒæŒ‰é’®çŠ¶æ€
                document.getElementById('bodySlider').value = currentConfig.bodyScale;
                document.querySelectorAll('.outfit-btn').forEach(btn => {
                    btn.classList.remove('selected');
                    if(btn.innerText.toLowerCase().includes(translateOutfit(currentConfig.outfit))) {
                        btn.classList.add('selected');
                    }
                });
            }

            updateImage();

        } catch(e) { console.error(e); }
    }

    // è¾…åŠ©ï¼šç¿»è¯‘è‹±æ–‡ä»£å·ç”¨äºåŒ¹é…æŒ‰é’®
    function translateOutfit(code) {
        const map = {'uniform':'æ ¡æœ', 'ballet':'èŠ­è•¾', 'jazz':'çˆµå£«', 'hiphop':'è¡—èˆ', 'kpop':'k-pop'};
        return map[code] || 'æ ¡æœ';
    }

    // 2. åˆ‡æ¢è¡£æœ
    window.setOutfit = function(type, btn) {
        currentConfig.outfit = type;
        document.querySelectorAll('.outfit-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        updateImage();
    }

    // 3. è°ƒæ•´èº«æ
    document.getElementById('bodySlider').oninput = function() {
        currentConfig.bodyScale = this.value;
        const img = document.getElementById('avatarDisplay');
        img.style.transform = `scaleX(${this.value})`;
    };

    // 4. æ ¸å¿ƒï¼šæ„å»ºå›¾ç‰‡è·¯å¾„å¹¶åŠ è½½
    function updateImage() {
        const img = document.getElementById('avatarDisplay');
        const loader = document.getElementById('imgLoader');
        
        // è·¯å¾„è§„åˆ™ï¼š/assets/avatars/girl_junior_ballet.png
        // ç¡®ä¿ä½ ä¸Šä¼ çš„æ–‡ä»¶å¤¹å« assets/avatars æˆ–è€… uploads/avatarsï¼Œå¹¶åœ¨ server.js å¼€æ”¾äº†è®¿é—®
        // è¿™é‡Œå‡è®¾æ”¾åœ¨ public/games/avatars ä¸‹æ–¹ä¾¿ç®¡ç†ï¼Œæˆ–è€… uploads/avatars
        // å’±ä»¬ç»Ÿä¸€ç”¨: /uploads/avatars/
        
        const filename = `${currentConfig.gender}_${currentConfig.ageGroup}_${currentConfig.outfit}.png`;
        const fullPath = `/uploads/avatars/${filename}`;

        console.log("Loading:", fullPath);
        
        // é¢„åŠ è½½
        const tempImg = new Image();
        tempImg.onload = () => {
            img.src = fullPath;
            img.style.transform = `scaleX(${currentConfig.bodyScale})`; // ä¿æŒèº«æ
        };
        tempImg.onerror = () => {
            // å¦‚æœå›¾ç‰‡ä¸å­˜åœ¨ï¼ŒåŠ è½½ä¸€ä¸ªå…œåº•å›¾ (æ¯”å¦‚ DiceBear)
            console.warn("Missing image:", filename);
            const seed = currentConfig.gender + currentConfig.outfit;
            img.src = `https://api.dicebear.com/7.x/adventurer/svg?seed=${seed}&backgroundColor=transparent`;
        };
        tempImg.src = fullPath;
    }

    // 5. ä¿å­˜é…ç½®åˆ°æ•°æ®åº“
    window.saveAvatar = async function() {
        const btn = document.querySelector('.btn-save');
        btn.textContent = 'æ­£åœ¨ä¿å­˜...';
        
        try {
            const res = await fetch('/api/save-avatar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ config: currentConfig })
            });
            if (res.ok) {
                alert('âœ¨ å½¢è±¡å·²æ›´æ–°ï¼');
                location.href = '/games.html';
            }
        } catch(e) { alert('ä¿å­˜å¤±è´¥'); }
        btn.textContent = 'âœ¨ ä¿å­˜æˆ‘çš„å½¢è±¡';
    }

    init();
</script>
</body>
</html>