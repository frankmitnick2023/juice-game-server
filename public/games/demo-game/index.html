<!DOCTYPE html>
<html>
<head>
  <title>小舞者教练</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:Arial;background:#f0f8ff;color:#333;margin:0;padding:0}
    .container{max-width:900px;margin:auto;padding:10px;text-align:center}
    video{width:100%;max-width:400px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .actions{display:flex;justify-content:center;gap:20px;flex-wrap:wrap;margin:20px 0}
    .action-btn{padding:15px 30px;font-size:18px;border:none;border-radius:50px;background:#4CAF50;color:white;cursor:pointer;box-shadow:0 5px 15px rgba(0,0,0,.2);transition:.2s}
    .action-btn:active{transform:scale(0.95)}
    .demo{border:4px solid #ff6b6b;border-radius:20px;padding:10px;background:#ffe0e0}
    .feedback{font-size:60px;font-weight:bold;margin:20px;min-height:80px}
    .success{color:#4CAF50;animation:pop 0.6s}
    .fail{color:#f44336;animation:shake 0.5s}
    @keyframes pop{0%{transform:scale(0)}50%{transform:scale(1.3)}100%{transform:scale(1)}}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-10px)}75%{transform:translateX(10px)}}
  </style>
</head>
<body>
  <div class="container">
    <h1>小舞者教练</h1>
    <p>跟老师一起跳，AI 会告诉你做得好不好！</p>

    <video id="demoVideo" class="demo" controls loop></video>
    <video id="camVideo" autoplay playsinline></video>

    <div class="actions">
      <button class="action-btn" onclick="startAction('raise')">举手</button>
      <button class="action-btn" onclick="startAction('clap')">拍手</button>
      <button class="action-btn" onclick="startAction('turn')">转身</button>
      <button class="action-btn" onclick="startAction('jump')">跳跃</button>
    </div>

    <div id="feedback">准备好了吗？</div>
    <div id="score">得分: <span id="points">0</span></div>
  </div>

  <script type="module">
    import { PoseLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14";

    let pose, stream;
    const video = document.getElementById('camVideo');
    const feedback = document.getElementById('feedback');
    const pointsEl = document.getElementById('points');
    let score = 0;
    let currentAction = null;

    // 动作定义（关键点 + 阈值）
    const ACTIONS = {
      raise: {
        name: "举手",
        demo: "raise.mp4", // 你准备的示范视频
        check: (landmarks) => {
          const wrist = landmarks[15], shoulder = landmarks[11];
          return wrist.y < shoulder.y - 0.2 && wrist.visibility > 0.5;
        }
      },
      clap: {
        name: "拍手",
        demo: "clap.mp4",
        check: (landmarks) => {
          const left = landmarks[15], right = landmarks[16];
          const dist = Math.abs(left.x - right.x);
          return dist < 0.08 && left.y > 0.3 && right.y > 0.3;
        }
      },
      turn: {
        name: "转身",
        demo: "turn.mp4",
        check: (landmarks) => {
          const leftHip = landmarks[23], rightHip = landmarks[24];
          const nose = landmarks[0];
          return Math.abs(nose.x - (leftHip.x + rightHip.x)/2) > 0.2;
        }
      },
      jump: {
        name: "跳跃",
        demo: "jump.mp4",
        check: (landmarks) => {
          const ankle = landmarks[27].y;
          return ankle < 0.6; // 脚离地
        }
      }
    };

    // 初始化
    async function init() {
      const fileset = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm");
      pose = await PoseLandmarker.createFromOptions(fileset, {
        baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task" },
        runningMode: "VIDEO"
      });
      startCamera();
    }

    async function startCamera() {
      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
    }

    // 开始一个动作
    window.startAction = async function(type) {
      if (!pose) await init();
      currentAction = ACTIONS[type];
      document.getElementById('demoVideo').src = currentAction.demo;
      document.getElementById('demoVideo').play();
      feedback.textContent = `跟老师做：${currentAction.name}！`;
      feedback.className = '';
      setTimeout(() => checkAction(type), 3000); // 给3秒模仿时间
    };

    // 检查动作
    async function checkAction(type) {
      const start = performance.now();
      let success = false;
      while (performance.now() - start < 3000) {
        const results = await pose.detectForVideo(video, performance.now());
        if (results.landmarks?.[0]) {
          if (currentAction.check(results.landmarks[0])) {
            success = true;
            break;
          }
        }
        await new Promise(r => requestAnimationFrame(r));
      }

      if (success) {
        feedback.textContent = "太棒了！";
        feedback.className = 'success';
        score += 10;
      } else {
        feedback.textContent = "再试一次哦~";
        feedback.className = 'fail';
      }
      pointsEl.textContent = score;
      currentAction = null;
    };

    init();
  </script>
</body>
</html>