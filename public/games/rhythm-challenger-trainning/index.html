<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>èŠ‚å¥æŒ‘æˆ˜è€… Â· æ•™å­¦ç‰ˆ + Juiceï¼ˆå‡»ä¸­è½¨é“ + å¤¸å¼ åé¦ˆï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --pri:#a855f7; --sec:#ec4899; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --cyan:#22d3ee }
    body { background:#0f172a; color:#e5e7eb; font-family: ui-sans-serif,system-ui }
    .card{ @apply bg-slate-900/80 ring-1 ring-white/10 rounded-3xl backdrop-blur-xl }
    .btn{ @apply px-4 py-2 rounded-2xl font-bold shadow-lg transition active:scale-95 }

    /* èŠ‚å¥åœˆ */
    .rhythm-circle{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1); width:150px;height:150px; border-radius:999px; border:5px solid rgba(255,255,255,.25); background:radial-gradient(circle,rgba(168,85,247,.28) 0%,transparent 65%); transition: transform .12s ease, filter .12s ease, border-color .12s ease }
    .rc-active{ border-color: var(--pri); filter:brightness(1.25); box-shadow:0 0 26px rgba(168,85,247,.6) }

    /* å¼ºæ‹æ—¶ç»™ä¸€ä¸ªé’è‰²é«˜äº®è¾¹ */
    .rc-downbeat{ border-color: var(--cyan); box-shadow:0 0 30px rgba(34,211,238,.8) }

    /* åˆ¤å®šåŠ¨ç”»å­—æ · */
    .judge{ position:absolute; left:50%; top:48%; transform:translate(-50%,-50%); font-weight:900; font-size:56px; text-shadow: 0 8px 30px rgba(0,0,0,.6); opacity:0 }
    .PERFECT{ color:#34d399; animation: popPerfect .8s ease-out }
    .GREAT{ color:#60a5fa; animation: popGreat .7s ease-out }
    .GOOD{ color:#fbbf24; animation: popGood .6s ease-out }
    .MISS{ color:#ef4444; animation: popMiss .45s ease-out }
    @keyframes popPerfect{0%{transform:translate(-50%,-50%) scale(.2) rotate(-20deg); opacity:0}50%{transform:translate(-50%,-50%) scale(1.25); opacity:1}100%{transform:translate(-50%,-50%) scale(1) rotate(0); opacity:0}}
    @keyframes popGreat{0%{transform:translate(-50%,-50%) scale(.3); opacity:0}100%{transform:translate(-50%,-50%) scale(1); opacity:0}}
    @keyframes popGood{0%{transform:translate(-50%,-50%) scale(.6); opacity:0}100%{transform:translate(-50%,-50%) scale(1); opacity:0}}
    @keyframes popMiss{0%{transform:translate(-50%,-50%) scale(1.2); opacity:.8}100%{transform:translate(-50%,-50%) scale(.8); opacity:0}}

    /* å€’è®¡æ—¶ */
    .countdown{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(15,23,42,.95); z-index:60 }
    .countNum{ font-size:20vw; font-weight:1000; background:linear-gradient(45deg,var(--pri),var(--sec)); -webkit-background-clip:text; background-clip:text; color:transparent }

    /* è¿›åº¦æ¡ */
    .pbar{ height:8px; background:rgba(255,255,255,.08); border-radius:8px; overflow:hidden }
    .pfill{ height:100%; background:linear-gradient(90deg,var(--pri),var(--sec)); width:0% }

    /* é¢„è§ˆæ¡ */
    #beatPreview{ position:absolute; left:50%; transform:translateX(-50%); bottom:76px; width:86%; height:14px; opacity:.95 }

    .hint{ position:absolute; left:50%; top:32%; transform:translateX(-50%); font-size:22px; font-weight:800; color:white; text-shadow:0 2px 10px rgba(0,0,0,.5); opacity:0; transition:opacity .1s }

    /* å‡»ä¸­â€œè½¨é“â€ç”»å¸ƒåœ¨æœ€ä¸Šå±‚ */
    #fx { position:absolute; inset:0; pointer-events:none }

    /* å‘½ä¸­æ—¶å±å¹•æŠ–åŠ¨ */
    .shake { animation: shake .18s cubic-bezier(.36,.07,.19,.97) both }
    @keyframes shake { 10%,90%{transform:translate3d(-1px,0,0)} 20%,80%{transform:translate3d(2px,0,0)} 30%,50%,70%{transform:translate3d(-4px,0,0)} 40%,60%{transform:translate3d(4px,0,0)} }
  </style>
</head>
<body class="p-4 min-h-screen">
  <div class="max-w-[860px] mx-auto space-y-6">
    <header class="text-center space-y-1">
      <h1 class="text-5xl font-black bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">ğŸµ èŠ‚å¥æŒ‘æˆ˜è€… Â· æ•™å­¦ç‰ˆ + Juice</h1>
      <p class="opacity-80">åŠ å…¥ï¼šå‡»ä¸­â€œè½¨é“â€ + å¤¸å¼ ç²’å­/é—ªç™½/å±æŠ– + æ›´å“äº®å‘½ä¸­éŸ³æ•ˆ + éŸ³ä¹ç¬æ—¶ducking</p>
    </header>

    <!-- æ§åˆ¶åŒºï¼ˆä¿æŒæ•™å­¦ç‰ˆç»“æ„ï¼‰ -->
    <section class="card p-6 space-y-4">
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <div class="text-sm font-semibold">ğŸ¼ é€‰æ‹©éŸ³ä¹</div>
          <input id="musicFile" type="file" accept="audio/*,video/*" class="block w-full text-sm text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-gradient-to-r file:from-purple-500 file:to-pink-600 file:text-white hover:file:from-purple-400 hover:file:to-pink-500" />
          <div class="text-xs opacity-70 mt-1">æ”¯æŒ MP3/WAV/M4A/OGG/è§†é¢‘</div>
        </div>
        <div>
          <div class="text-sm font-semibold">ğŸ”Š æµ‹è¯•éŸ³ä¹</div>
          <div class="flex gap-2">
            <button id="test1" class="btn bg-emerald-600 text-white">ç”µå­èŠ‚æ‹</button>
            <button id="test2" class="btn bg-sky-600 text-white">æµè¡Œç‰‡æ®µ</button>
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-4">
        <div class="space-y-1">
          <div class="text-sm font-semibold">ğŸ® åŠ¨ä½œé€‰æ‹©</div>
          <select id="gesture" class="w-full bg-slate-800 rounded-xl px-3 py-2">
            <option value="shake" selected>æ‘‡å¤´ï¼ˆå·¦å³ï¼‰</option>
            <option value="nod">ç‚¹å¤´ï¼ˆä¸Šä¸‹ï¼‰</option>
            <option value="either">ä»»ä¸€ï¼ˆå·¦å³æˆ–ä¸Šä¸‹ï¼‰</option>
          </select>
        </div>
        <div class="space-y-1">
          <div class="text-sm font-semibold">â±ï¸ èŠ‚æ‹æ¥æº</div>
          <select id="tempoMode" class="w-full bg-slate-800 rounded-xl px-3 py-2">
            <option value="auto" selected>è‡ªåŠ¨æ£€æµ‹</option>
            <option value="tap">Tap Tempoï¼ˆæ‰‹åŠ¨æ•²æ‹ï¼‰</option>
            <option value="fixed">å›ºå®š BPM</option>
          </select>
        </div>
        <div class="space-y-1">
          <div class="text-sm font-semibold">ğŸšï¸ è®­ç»ƒéš¾åº¦</div>
          <select id="gridMode" class="w-full bg-slate-800 rounded-xl px-3 py-2">
            <option value="downbeat" selected>åªæ‰“å¼ºæ‹ï¼ˆæ¯å°èŠ‚ç¬¬1æ‹ï¼‰</option>
            <option value="onbeat">åªæ‰“æ­£æ‹ï¼ˆ1/2 æ‹ï¼‰</option>
            <option value="all">å››åˆ†éŸ³ç¬¦ï¼ˆ1/1 æ‹ï¼‰</option>
          </select>
        </div>
      </div>

      <div class="grid md:grid-cols-4 gap-4 items-end">
        <div class="space-y-1">
          <div class="text-sm font-semibold">ğŸ¼ å›ºå®š BPM / æ£€æµ‹ç»“æœ</div>
          <input id="bpmInput" type="number" min="20" max="240" step="1" value="100" class="w-full bg-slate-800 rounded-xl px-3 py-2" />
          <div class="text-xs opacity-70">è‡ªåŠ¨æ£€æµ‹ä¼šè¦†ç›–è¿™é‡Œ</div>
        </div>
        <div class="space-y-1">
          <div class="text-sm font-semibold">ğŸ¢ è®­ç»ƒå‡é€Ÿ</div>
          <select id="tempoScale" class="w-full bg-slate-800 rounded-xl px-3 py-2">
            <option value="1">1.0xï¼ˆåŸé€Ÿï¼‰</option>
            <option value="0.75" selected>0.75xï¼ˆæ›´æ…¢ï¼‰</option>
            <option value="0.5">0.5xï¼ˆåŠé€Ÿï¼‰</option>
          </select>
        </div>
        <div class="space-y-1">
          <div class="text-sm font-semibold">ğŸ¯ PERFECT çª—</div>
          <select id="winPerfect" class="w-full bg-slate-800 rounded-xl px-3 py-2">
            <option value="60">Â±60ms</option>
            <option value="80" selected>Â±80ms</option>
            <option value="100">Â±100ms</option>
          </select>
        </div>
        <div class="space-y-1">
          <div class="text-sm font-semibold">ğŸ«° Tap æŒ‰é’®</div>
          <button id="tapBtn" class="btn w-full bg-amber-600 text-white">TAPï¼ˆTï¼‰</button>
          <div class="text-xs opacity-70" id="tapHint">æ•² 4~8 ä¸‹è‡ªåŠ¨ä¼°ç®— BPM</div>
        </div>
      </div>

      <div class="flex flex-wrap gap-2 items-center">
        <button id="btnCam" class="btn bg-teal-600 text-white">ğŸ¥ æ‰“å¼€æ‘„åƒå¤´</button>
        <button id="btnAnalyze" class="btn bg-orange-600 text-white" disabled>ğŸ” æ„å»ºèŠ‚æ‹ç½‘æ ¼</button>
        <button id="btnStart" class="btn bg-fuchsia-600 text-white" disabled>ğŸš€ å¼€å§‹è®­ç»ƒ</button>
        <div id="status" class="text-sm opacity-80">å‡†å¤‡å¼€å§‹</div>
      </div>
    </section>

    <!-- ç”»é¢åŒº -->
    <section id="stage" class="card p-6 relative overflow-hidden ring-2 ring-purple-500/30">
      <video id="video" class="w-full rounded-2xl aspect-[9/16] object-cover ring-2 ring-teal-500/50" autoplay muted playsinline></video>
      <canvas id="skel" class="absolute inset-0 rounded-2xl pointer-events-none"></canvas>
      <canvas id="trail" class="absolute inset-0 rounded-2xl pointer-events-none"></canvas>
      <!-- æ–°å¢ï¼šFX ç”»å¸ƒï¼ˆç²’å­/é—ªç™½/å‡»ä¸­è½¨é“ï¼‰ -->
      <canvas id="fx" class="absolute inset-0 rounded-2xl pointer-events-none"></canvas>

      <div id="rc" class="rhythm-circle"></div>
      <div id="hint" class="hint">åœˆäº®å¤§æ—¶ <span class="text-amber-300">è·Ÿæ‹</span>ï¼</div>
      <canvas id="beatPreview"></canvas>
      <div id="judge" class="judge">PERFECT</div>

      <div class="absolute bottom-4 left-1/2 -translate-x-1/2 text-center">
        <div id="score" class="text-5xl font-black bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">0</div>
        <div id="combo" class="text-xl text-emerald-400 font-bold opacity-0">è¿å‡» x0</div>
        <div class="w-[86%] mx-auto mt-2">
          <div class="pbar"><div id="pfill" class="pfill"></div></div>
          <div id="time" class="text-[11px] text-slate-400 mt-1">00:00 / 00:00</div>
        </div>
      </div>
    </section>

    <!-- å€’è®¡æ—¶ -->
    <div id="cd" class="countdown"><div class="countNum" id="cdNum">3</div></div>

    <!-- ç»“ç®— -->
    <div id="result" class="modal">
      <div class="bg-slate-900/95 ring-2 ring-purple-500/50 rounded-3xl p-8 w-[min(92vw,520px)] text-center space-y-4">
        <div class="text-3xl font-black bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">ğŸ‰ è®­ç»ƒç»“æœ</div>
        <div id="grade" class="text-7xl font-black text-emerald-400">S</div>
        <div id="final" class="text-5xl">0</div>
        <div class="text-sm opacity-80">æœ€é«˜è¿å‡» <span id="maxc" class="font-bold text-emerald-400">0</span> ï½œ å‘½ä¸­ç‡ <span id="acc">0%</span></div>
        <div class="flex gap-2 mt-2">
          <button id="again" class="btn bg-emerald-600 text-white flex-1">å†æ¥ä¸€è½®</button>
          <button id="ok" class="btn bg-slate-700 text-white flex-1">å®Œæˆ</button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  // ========== å…ƒç´  & å…¨å±€ ==========
  const E = (id)=>document.getElementById(id);
  const els = { video:E('video'), skel:E('skel'), trail:E('trail'), fx:E('fx'), rc:E('rc'), hint:E('hint'), beatPreview:E('beatPreview'), stage:E('stage'),
    musicFile:E('musicFile'), test1:E('test1'), test2:E('test2'), btnCam:E('btnCam'), btnAnalyze:E('btnAnalyze'), btnStart:E('btnStart'), status:E('status'),
    gesture:E('gesture'), tempoMode:E('tempoMode'), gridMode:E('gridMode'), bpmInput:E('bpmInput'), tempoScale:E('tempoScale'), winPerfect:E('winPerfect'), tapBtn:E('tapBtn'), tapHint:E('tapHint'),
    pfill:E('pfill'), time:E('time'), score:E('score'), combo:E('combo'), judge:E('judge'),
    cd:E('cd'), cdNum:E('cdNum'), result:E('result'), grade:E('grade'), final:E('final'), maxc:E('maxc'), acc:E('acc'), again:E('again'), ok:E('ok') };

  let audio, audioBuf, stream, pose;
  let beats=[], gridBeats=[], idx=0, running=false, totalMs=0;
  let score=0, combo=0, maxCombo=0, judgs=[];
  let sx=0, sy=0, px=0, py=0, shaking=false, nodding=false;
  let taps=[];
  let downbeatEvery=4; // 4/4 é»˜è®¤

  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
  const msFmt=(t)=>{const m=String(Math.floor(t/60000)).padStart(2,'0'); const s=String(Math.floor((t%60000)/1000)).padStart(2,'0'); return `${m}:${s}`};
  const median=(arr)=>{ const a=arr.slice().sort((x,y)=>x-y); const m=Math.floor(a.length/2); return a.length%2? a[m] : (a[m-1]+a[m])/2 };

  // ===== ç”»å¸ƒå°ºå¯¸ =====
  function resize(){ const r=els.video.getBoundingClientRect(); [els.skel,els.trail,els.fx].forEach(c=>{c.width=r.width; c.height=r.height}); const pr=els.beatPreview.getBoundingClientRect(); els.beatPreview.width=pr.width; els.beatPreview.height=pr.height; }
  window.addEventListener('resize', resize);

  // ===== æ‘„åƒå¤´ & Pose =====
  async function openCam(){ if(!navigator.mediaDevices?.getUserMedia) throw new Error('éœ€è¦ HTTPS/å®‰å…¨åŸŸæ‰èƒ½ä½¿ç”¨æ‘„åƒå¤´'); stream = await navigator.mediaDevices.getUserMedia({ video:{width:{ideal:720},height:{ideal:1280},facingMode:'user',frameRate:{ideal:30}}, audio:false }); els.video.srcObject=stream; await new Promise(r=>els.video.onloadedmetadata=r); resize(); }
  async function loadPose(){ if(pose) return pose; const { PoseLandmarker, FilesetResolver } = await import('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14'); const fr = await FilesetResolver.forVisionTasks('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm'); pose = await PoseLandmarker.createFromOptions(fr, { baseOptions:{ modelAssetPath:'https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task', delegate:'GPU' }, runningMode:'VIDEO', numPoses:1, minPoseDetectionConfidence:.3, minPosePresenceConfidence:.3, minTrackingConfidence:.3 }); return pose }

  // ===== æ‰“ç‚¹åˆ†æï¼ˆå¼ºå³°1/3ï¼‰ =====
  async function analyzeBeats(buffer){ return new Promise((resolve,reject)=>{ const oc=new OfflineAudioContext(1,buffer.length,buffer.sampleRate); const src=oc.createBufferSource(); src.buffer=buffer; const lp=oc.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=160; src.connect(lp); lp.connect(oc.destination); src.start(); oc.startRendering().then(rb=>{ const sr=buffer.sampleRate; const data=rb.getChannelData(0); const N=data.length; const env=new Float32Array(N); let prev=0, alpha=.5; for(let i=0;i<N;i++){ const v=Math.abs(data[i]); prev=alpha*v+(1-alpha)*prev; env[i]=prev } const peaks=[]; let mean=0,gamma=.995; const win=Math.max(1,Math.floor(sr*.01)), loc=Math.max(1,Math.floor(sr*.05)); for(let i=win;i<N-win;i++){ const v=env[i]; let isMax=true; for(let k=i-win;k<=i+win;k+=Math.max(1,Math.floor(win/2))) if(env[k]>v){isMax=false;break} if(isMax && v>mean*1.1){ let s=0; for(let j=i-loc;j<=i+loc;j++){ if(j>=0&&j<N) s+=env[j] } s/= (2*loc+1); peaks.push({t:i/sr*1000, s:Math.max(0,v-s)}) } mean = gamma*mean + (1-gamma)*v } const spaced=[]; for(const p of peaks){ if(!spaced.length){spaced.push(p);continue} const last=spaced[spaced.length-1]; if(p.t-last.t<120){ if(p.s>last.s) spaced[spaced.length-1]=p } else spaced.push(p) } const keep=Math.max(1,Math.ceil(spaced.length/3)); const strong=spaced.slice().sort((a,b)=>b.s-a.s).slice(0,keep).sort((a,b)=>a.t-b.t); resolve(strong.map(p=>p.t)); }).catch(reject) }) }

  // ===== ç”ŸæˆèŠ‚æ‹ç½‘æ ¼ =====
  function buildBeatGrid(baseBeats, mode='downbeat', bpmHint=null, scale=1){ let ibi = baseBeats.length>1 ? median(baseBeats.slice(1).map((t,i)=>t-baseBeats[i])) : 600; let bpm = Math.round(60000/ibi); if (bpmHint) { bpm = bpmHint; ibi = 60000/bpm } const grid = ibi/2; const quantized = baseBeats.map(t=>Math.round(t/grid)*grid); const start = quantized[0] || 0; const total = totalMs || (audio?.duration||0)*1000 || 60000; const step = ibi * (mode==='all' ? 1 : (mode==='onbeat' ? 2 : 4)); downbeatEvery = step/ibi; const out=[]; for(let t=start; t<=total+1000; t+=step) out.push(t); const scaled = out.map(t => start + (t-start)/scale); return { bpm: Math.round(bpm), grid: scaled } }

  // ===== é¢„è§ˆæ¡ =====
  function drawPreview(at){ const ctx=els.beatPreview.getContext('2d'); const w=ctx.canvas.width, h=ctx.canvas.height; ctx.clearRect(0,0,w,h); ctx.fillStyle='rgba(255,255,255,.08)'; ctx.fillRect(0,0,w,h); const W=3000; const vis=gridBeats.filter(t=>t>=at-500&&t<=at+W); vis.forEach((t,i)=>{ const x=((t-at)/W)*w; const isNow=Math.abs(t-at) < 120; ctx.fillStyle = t<at? '#f472b6' : (isNow?'#a855f7':'#fff'); ctx.fillRect(Math.floor(x)-1,0,3,h); }); ctx.fillStyle='rgba(255,255,255,.6)'; ctx.fillRect(0,0,2,h); }

  // ===== èŠ‚å¥åœˆï¼ˆå¼ºæ‹é«˜äº®ï¼‰ =====
  function updateCircle(at){ if(!gridBeats.length) return; const nb=gridBeats[idx]; if(nb==null){ els.rc.classList.remove('rc-active','rc-downbeat'); els.hint.style.opacity=0; return } const dt=nb-at; const inWin=(dt>-260 && dt<820); const t=clamp(1-Math.abs(dt)/820,0,1); if(inWin){ els.rc.classList.add('rc-active'); els.rc.style.transform=`translate(-50%,-50%) scale(${1+t*.55})`; els.rc.style.filter=`brightness(${.7+t*.6})`; els.hint.style.opacity=t>.78?1:0; const isDownbeat = (idx % downbeatEvery)===0; els.rc.classList.toggle('rc-downbeat', isDownbeat); } else { els.rc.classList.remove('rc-active','rc-downbeat'); els.rc.style.transform='translate(-50%,-50%) scale(1)'; els.hint.style.opacity=0 } }

  // ===== æ‰‹åŠ¿æ£€æµ‹ï¼šæ‘‡å¤´/ç‚¹å¤´ï¼ˆå¸¦æ»å›ï¼‰ =====
  function smooth(x,y){ sx=.5*x+.5*sx; sy=.5*y+.5*sy; return [sx,sy] }
  const TH_ON=25, TH_OFF=14; 
  function headSpeedXY(nose){ const [x,y]=smooth(nose.x,nose.y); const vx=(x-px), vy=(y-py); px=x; py=y; return { spx:Math.abs(vx)*2000, spy:Math.abs(vy)*2000 } }
  function triggerGesture(mode, spx, spy){ if(mode==='shake'){ if(!shaking && spx>TH_ON){ shaking=true; return true } if(shaking && spx<TH_OFF) shaking=false; return false } else if(mode==='nod'){ if(!nodding && spy>TH_ON){ nodding=true; return true } if(nodding && spy<TH_OFF) nodding=false; return false } else { let fire=false; if(!shaking && spx>TH_ON){ shaking=true; fire=true } if(shaking && spx<TH_OFF) shaking=false; if(!nodding && spy>TH_ON){ nodding=true; fire=true } if(nodding && spy<TH_OFF) nodding=false; return fire } }

  // ===== å¤¸å¼ åé¦ˆï¼šéŸ³æ•ˆ + ç²’å­ + è½¨é“è„‰å†² + å±æŠ– + é—ªç™½ + éŸ³ä¹ducking =====
  const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  function playSfx(type='GOOD'){ // åˆæˆçŸ­ä¿ƒæ‰“å‡»
    const now = audioCtx.currentTime;
    const g = audioCtx.createGain(); g.connect(audioCtx.destination);
    const o = audioCtx.createOscillator(); o.connect(g);
    const n = audioCtx.createBufferSource(); // å™ªå£° burst
    const buf = audioCtx.createBuffer(1, audioCtx.sampleRate*0.08, audioCtx.sampleRate);
    const data = buf.getChannelData(0); for(let i=0;i<data.length;i++){ data[i] = (Math.random()*2-1) * (1 - i/data.length); }
    n.buffer = buf; const ng = audioCtx.createGain(); n.connect(ng); ng.connect(audioCtx.destination);

    let base= type==='PERFECT'? 880 : type==='GREAT'? 660 : type==='GOOD'? 440 : 220;
    let vol = type==='PERFECT'? 0.9 : type==='GREAT'? 0.75 : type==='GOOD'? 0.6 : 0.4;

    o.frequency.setValueAtTime(base, now);
    o.frequency.exponentialRampToValueAtTime(base/2, now+0.08);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(vol, now+0.004);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.12);

    ng.gain.setValueAtTime(vol*0.6, now);
    ng.gain.exponentialRampToValueAtTime(0.0001, now+0.08);

    o.start(now); o.stop(now+0.12);
    n.start(now); n.stop(now+0.09);
  }

  // å±å¹•æŠ–åŠ¨ + é—ªç™½
  function screenPunch(){ els.stage.classList.add('shake'); const ctx=els.fx.getContext('2d'); const {width:w,height:h}=els.fx; ctx.fillStyle='rgba(255,255,255,0.22)'; ctx.fillRect(0,0,w,h); setTimeout(()=>{ ctx.clearRect(0,0,w,h); els.stage.classList.remove('shake') }, 120) }

  // å‡»ä¸­è½¨é“ï¼šå±…ä¸­ç«–ç›´â€œå‘½ä¸­çº¿â€è„‰å†²
  let railPulse=0; // 0~1
  function drawRail(at){ const ctx=els.fx.getContext('2d'); const w=ctx.canvas.width, h=ctx.canvas.height; const cx=w/2; ctx.clearRect(0,0,w,h); // å…ˆæ¸… FXï¼ˆç²’å­å¦è¡Œç»˜åˆ¶åœ¨åŒä¸€å±‚ï¼‰
    // èƒŒæ™¯æ·¡è½¨
    ctx.fillStyle='rgba(255,255,255,0.06)'; ctx.fillRect(cx-3, h*0.15, 6, h*0.7);
    // è„‰å†²äº®åº¦
    if(railPulse>0){ const alpha = railPulse; ctx.save(); const grad = ctx.createLinearGradient(cx, h*0.15, cx, h*0.85); grad.addColorStop(0, `rgba(168,85,247,${0.1+alpha*0.2})`); grad.addColorStop(0.5, `rgba(236,72,153,${0.15+alpha*0.35})`); grad.addColorStop(1, `rgba(168,85,247,${0.1+alpha*0.2})`); ctx.fillStyle=grad; ctx.fillRect(cx-5, h*0.15, 10, h*0.7); ctx.restore(); railPulse = Math.max(0, railPulse-0.08); }
  }

  // ç²’å­ç³»ç»Ÿ
  const particles=[];
  function spawnParticles(x,y,color='#ffffff',count=48){ const ctx=els.fx.getContext('2d'); const w=ctx.canvas.width, h=ctx.canvas.height; for(let i=0;i<count;i++){ const a=Math.random()*Math.PI*2; const sp= 3+ Math.random()*5; particles.push({x, y, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp, life: 0.6+Math.random()*0.4, t:0, color}) } }
  function tickParticles(dt){ const ctx=els.fx.getContext('2d'); ctx.globalCompositeOperation='lighter'; for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.t+=dt; p.x+=p.vx; p.y+=p.vy; const k=1-p.t/p.life; if(k<=0){ particles.splice(i,1); continue } ctx.beginPath(); ctx.arc(p.x, p.y, 2+3*(1-k), 0, Math.PI*2); ctx.fillStyle=`rgba(${p.color},${k})`; ctx.fill(); } ctx.globalCompositeOperation='source-over' }

  // å‘½ä¸­æ—¶è§¦å‘æ‰€æœ‰æ•ˆæœ + éŸ³ä¹ ducking
  function hitFX(judg){ // è½¨é“è„‰å†²
    railPulse = 1;
    // ç²’å­åœ¨å±ä¸­é—´ä½ç½®çˆ†ç‚¸ï¼ˆå¯æ ¹æ®å¤´éƒ¨å®é™…ä½ç½®æ‰©å±•ï¼‰
    const ctx=els.fx.getContext('2d'); const w=ctx.canvas.width, h=ctx.canvas.height; const cx=w/2, cy=h*0.55;
    const colorMap={ PERFECT:'52,211,153', GREAT:'96,165,250', GOOD:'251,191,36', MISS:'239,68,68' };
    spawnParticles(cx, cy, colorMap[judg]||'168,85,247', judg==='PERFECT'?72:48);
    screenPunch();
    playSfx(judg);
    // éŸ³ä¹ä¾§é“¾å‹ä½
    const base = _musicVol.base; const target = base*0.7; setMusicVol(target); setTimeout(()=>setMusicVol(base), 140);
  }

  // éŸ³ä¹éŸ³é‡ç®¡ç†ï¼ˆå« ducking æ¢å¤ï¼‰
  const _musicVol = { base: 0.85 };
  function setMusicVol(v){ if(audio) audio.volume = clamp(v,0,1) }

  // ===== åˆ¤å®š & å­—æ · =====
  function showJudge(J){ els.judge.textContent=J; els.judge.className=`judge ${J}` }
  function judge(at, beat){ const p=Number(els.winPerfect.value); const g=p*1.875, b=p*3.125; const dt=Math.abs(at-beat); if(dt<p) return {J:'PERFECT',pts:120}; if(dt<g) return {J:'GREAT',pts:80}; if(dt<b) return {J:'GOOD',pts:50}; return {J:'MISS',pts:0} }

  // ===== Tap Tempo =====
  function tap(){ const t=performance.now(); taps.push(t); if(taps.length>8) taps.shift(); if(taps.length>=4){ const iv=taps.slice(1).map((x,i)=>x-taps[i]); const bpm=Math.round(60000/median(iv)); els.bpmInput.value=bpm; els.tapHint.textContent=`ä¼°ç®— BPM: ${bpm}` } }
  els.tapBtn.addEventListener('click', tap); window.addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='t') tap() });

  // ===== å€’è®¡æ—¶ =====
  async function countdown(){ els.cd.style.display='flex'; for(const n of ['3','2','1','GO!']){ els.cdNum.textContent=n; await sleep(700) } els.cd.style.display='none' }

  // ===== éŸ³é¢‘åŠ è½½ =====
  async function loadAudio(src){ return new Promise((resolve,reject)=>{ if(!audio) audio=new Audio(); audio.src=src; const ctx=new (window.AudioContext||window.webkitAudioContext)(); audio.addEventListener('loadedmetadata', async()=>{ try{ const res=await fetch(src); const ab=await res.arrayBuffer(); audioBuf=await ctx.decodeAudioData(ab); resolve(audioBuf.duration) }catch(e){ reject(e) } }); audio.load() }) }

  // ===== UI ç»‘å®š =====
  els.btnCam.onclick = async()=>{ try{ els.btnCam.disabled=true; els.status.textContent='è¯·æ±‚æ‘„åƒå¤´æƒé™...'; await openCam(); els.status.innerHTML='âœ… <span class="text-emerald-400">æ‘„åƒå¤´å°±ç»ª</span>'; await loadPose(); els.btnCam.textContent='âœ… æ‘„åƒå¤´å·²å¼€' } catch(e){ alert(e.message||'æ‘„åƒå¤´å¤±è´¥'); els.status.textContent='âŒ æ‘„åƒå¤´å¤±è´¥' } finally{ els.btnCam.disabled=false } };
  const TESTS=['https://www.soundjay.com/misc/sounds/bell-ringing-05.wav','https://www.soundjay.com/human/sounds/whip-1.mp3'];
  els.test1.onclick = async()=>{ els.status.textContent='åŠ è½½æµ‹è¯•éŸ³ä¹...'; try{ const d=await loadAudio(TESTS[0]); els.btnAnalyze.disabled=false; els.status.innerHTML=`âœ… æµ‹è¯•éŸ³ä¹1åŠ è½½æˆåŠŸ (${d.toFixed(0)}s)` }catch{ els.status.textContent='âŒ åŠ è½½å¤±è´¥' } };
  els.test2.onclick = async()=>{ els.status.textContent='åŠ è½½æµ‹è¯•éŸ³ä¹...'; try{ const d=await loadAudio(TESTS[1]); els.btnAnalyze.disabled=false; els.status.innerHTML=`âœ… æµ‹è¯•éŸ³ä¹2åŠ è½½æˆåŠŸ (${d.toFixed(0)}s)` }catch{ els.status.textContent='âŒ åŠ è½½å¤±è´¥' } };
  els.musicFile.onchange = async e=>{ const f=e.target.files[0]; if(!f) return; els.status.textContent='åŠ è½½éŸ³ä¹...'; try{ const ab=await f.arrayBuffer(); const ctx=new (window.AudioContext||window.webkitAudioContext)(); audioBuf=await ctx.decodeAudioData(ab); if(!audio) audio=new Audio(); audio.src=URL.createObjectURL(f); els.btnAnalyze.disabled=false; els.status.innerHTML=`âœ… ${f.name} (${audioBuf.duration.toFixed(0)}s)` }catch{ els.status.textContent='âŒ éŸ³ä¹åŠ è½½å¤±è´¥' } };

  els.btnAnalyze.onclick = async()=>{ if(!audioBuf && els.tempoMode.value==='auto'){ els.status.textContent='è¯·å…ˆåŠ è½½éŸ³ä¹'; return } els.btnAnalyze.disabled=true; els.status.textContent='æ„å»ºèŠ‚æ‹ç½‘æ ¼...'; if(els.tempoMode.value==='auto'){ beats = await analyzeBeats(audioBuf); totalMs = (audio?.duration||audioBuf?.duration||0)*1000; const {bpm, grid} = buildBeatGrid(beats, els.gridMode.value, null, Number(els.tempoScale.value)); els.bpmInput.value = bpm; gridBeats = grid; } else { const bpm = clamp(Number(els.bpmInput.value)||100, 20, 240); totalMs = (audio?.duration||audioBuf?.duration||0)*1000 || 60000; const ibi=60000/bpm; const step = ibi * (els.gridMode.value==='all'?1:(els.gridMode.value==='onbeat'?2:4)); gridBeats=[]; for(let t=0; t<=totalMs+1000; t+=step) gridBeats.push(t/Number(els.tempoScale.value)); } idx=0; els.btnStart.disabled=false; els.status.innerHTML=`ğŸµ å·²ç”Ÿæˆ <b>${gridBeats.length}</b> ä¸ªè®­ç»ƒæ‹ç‚¹ï¼ˆ${els.bpmInput.value} BPMï¼Œæ¨¡å¼ï¼š${els.gridMode.value}ï¼‰`; els.btnAnalyze.disabled=false };

  // ========== æ¸¸æˆä¸»å¾ªç¯ ==========
  els.btnStart.onclick = async()=>{
    if(!gridBeats.length){ els.status.textContent='è¯·å…ˆæ„å»ºèŠ‚æ‹ç½‘æ ¼'; return }
    await loadPose();
    running=true; score=0; combo=0; maxCombo=0; judgs=[]; px=py=sx=sy=0; idx=0; taps=[];
    els.score.textContent='0'; els.combo.style.opacity=0; els.pfill.style.width='0%';

    await countdown();
    audio.currentTime=0; setMusicVol(_musicVol.base); audio.play(); totalMs=(audio.duration||audioBuf?.duration||0)*1000;

    let lastInput=0; let lastTime=performance.now();
    const loop = async()=>{
      if(!running) return; const now=performance.now(); const dt=(now-lastTime)/1000; lastTime=now; const aMs=audio.currentTime*1000;
      while(idx<gridBeats.length && aMs>gridBeats[idx]+300) idx++;
      drawPreview(aMs); updateCircle(aMs); drawRail(aMs); tickParticles(dt);
      els.pfill.style.width = `${clamp((aMs/totalMs)*100,0,100)}%`; els.time.textContent = `${msFmt(aMs)} / ${msFmt(totalMs)}`;
      try{ const r = await pose.detectForVideo(els.video, now); if(r.landmarks?.[0]){ const nose=r.landmarks[0][0]; const {spx, spy}=headSpeedXY(nose); const mode=els.gesture.value; if(triggerGesture(mode, spx, spy) && aMs-lastInput>100){ lastInput=aMs; if(idx<gridBeats.length){ const next=gridBeats[idx]; const res=judge(aMs,next); if(res.pts>0){ score+=res.pts + combo*2; combo++; maxCombo=Math.max(maxCombo,combo); els.score.textContent=String(score); if(combo>1){ els.combo.textContent=`è¿å‡» x${combo}`; els.combo.style.opacity=1 } showJudge(res.J); hitFX(res.J); judgs.push(res); idx++ } else { showJudge('MISS'); hitFX('MISS'); combo=0; els.combo.style.opacity=0 } } } } }catch(e){}
      if(audio.ended || aMs>=totalMs-300){ finish(); return }
      requestAnimationFrame(loop);
    };
    loop();
  };

  function finish(){ running=false; try{audio.pause()}catch{} els.rc.classList.remove('rc-active','rc-downbeat'); els.hint.style.opacity=0; const hit=judgs.filter(x=>x.pts>0).length/Math.max(gridBeats.length,1); const acc=Math.round(hit*100); const final=Math.round(score*(1+maxCombo*0.1)); els.final.textContent=final; els.maxc.textContent=maxCombo; els.acc.textContent=`${acc}%`; const g=final>=800?'S':final>=600?'A':final>=400?'B':final>=200?'C':'D'; els.grade.textContent=g; els.result.classList.add('show'); setTimeout(()=>{ parent.postMessage({type:'JUICE_GAME_SCORE', score:Math.max(0,final)}, '*') }, 300) }

  els.again.onclick=()=>{ els.result.classList.remove('show'); els.btnStart.disabled=false; els.status.textContent='å‡†å¤‡å†æ¬¡è®­ç»ƒ' };
  els.ok.onclick=()=>{ els.result.classList.remove('show') };

  // ===== åˆå§‹åŒ– =====
  window.addEventListener('load', ()=>{ audio=new Audio(); setMusicVol(_musicVol.base); resize(); parent.postMessage({type:'JUICE_GAME_READY'}, '*'); });
</script>
</body>
</html>
