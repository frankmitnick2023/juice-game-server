<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Studio Hire</title>
  <style>
    /* ... æ ·å¼ä¿æŒä¸å˜ ... */
    body{font-family:'Segoe UI', sans-serif;margin:0;background:#f2f4f8;padding-bottom:5rem}
    .header{background:#2c3e50;color:white;padding:1rem;text-align:center;position:sticky;top:0;z-index:100}
    
    /* é¡¶éƒ¨æ§åˆ¶æ  */
    .controls {background:white;padding:12px;display:flex;overflow-x:auto;gap:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05); white-space:nowrap;}
    .day-selector {padding:8px 16px;background:#f0f0f0;border-radius:20px;font-size:0.9rem;cursor:pointer;font-weight:bold;color:#666;transition:0.2s}
    .day-selector.active {background:#2c3e50;color:white;box-shadow:0 2px 5px rgba(0,0,0,0.2)}
    
    /* è¡¨æ ¼å®¹å™¨ */
    .table-wrapper {overflow-x:auto; margin-top:15px; background:white; padding-bottom:20px; border-top:1px solid #ddd}
    .room-table {border-collapse:separate; border-spacing:0; width:100%; min-width:800px}
    .room-table th {background:#fff; color:#333; font-size:0.85rem; padding:10px; border-bottom:2px solid #e94560; border-right:1px solid #eee; position:sticky; top:0; z-index:10; min-width:90px}
    .room-table th:first-child {position:sticky; left:0; z-index:20; border-right:2px solid #ddd; background:#fff; color:#e94560}
    .room-table td {border-right:1px solid #eee; border-bottom:1px solid #eee; height:45px; text-align:center; font-size:0.8rem; cursor:pointer; position:relative; transition:0.1s}
    .room-table td:first-child {background:#f9f9f9; font-weight:bold; position:sticky; left:0; border-right:2px solid #ddd; z-index:5; color:#555}
    
    .cell-free {background:white}
    .cell-free:hover {background:#e3f2fd}
    .cell-booked {background:#ffcdd2; color:#b71c1c; cursor:not-allowed; font-size:0.7rem; font-weight:bold; background-image:repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,0.5) 5px, rgba(255,255,255,0.5) 10px);}
    
    .price-tag {font-size:0.7rem; color:#888; display:block; font-weight:normal; margin-top:2px}
    .price-val {color:#e94560; font-weight:bold}

    .modal-overlay {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:999;justify-content:center;align-items:end}
    .modal {background:white;width:100%;max-width:500px;border-radius:20px 20px 0 0;padding:25px;box-sizing:border-box;animation:slideUp 0.3s; box-shadow:0 -5px 20px rgba(0,0,0,0.2)}
    @keyframes slideUp {from{transform:translateY(100%)} to{transform:translateY(0)}}
    
    .btn-confirm {width:100%;padding:14px;background:#2c3e50;color:white;border:none;border-radius:10px;font-weight:bold;margin-top:15px;font-size:1.1rem}
    .btn-confirm:active {transform:scale(0.98)}

    .info-row {display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px dashed #eee}
    .info-label {color:#888}
    .info-val {font-weight:bold; color:#333}
    .input-row {display:flex; gap:10px; align-items:center; justify-content:flex-end; width:60%} /* Added for date/time input */

    .nav-bar{position:fixed;bottom:0;left:0;width:100%;background:white;border-top:1px solid #eee;display:flex;justify-content:space-around;padding:8px 0;z-index:99; padding-bottom: max(8px, env(safe-area-inset-bottom));}
    .nav-item{text-decoration:none;color:#999;font-size:0.75rem;text-align:center;display:flex;flex-direction:column;align-items:center;flex:1}
    .nav-icon{font-size:1.5rem;margin-bottom:2px}
    .nav-item.active{color:#2c3e50}
  </style>
</head>
<body>

<div class="header">
    <h3 style="margin:0">ğŸ”‘ Studio Hire (æ•™å®¤é¢„çº¦)</h3>
</div>

<div class="controls" id="dayControls"></div>

<div class="table-wrapper">
    <table class="room-table" id="roomTable"></table>
</div>

<div id="bookingModal" class="modal-overlay">
    <div class="modal">
        <h2 id="mRoomName" style="margin-top:0; color:#2c3e50">Studio Name</h2>
        
        <div style="margin:20px 0;">
            <div class="info-row">
                <span class="info-label">Start Time (å¼€å§‹æ—¶é—´)</span>
                <span class="info-val" id="mStartTime">--</span>
            </div>
            
            <div class="info-row">
                <span class="info-label">ğŸ“… Date (æ—¥æœŸ)</span>
                <div class="input-row">
                    <input type="date" id="dateInput" style="padding:5px; border:1px solid #ddd; border-radius:5px; width:100%" onchange="updateBookingDay()">
                </div>
            </div>
            
            <div class="info-row">
                <span class="info-label">â° Duration (æ—¶é•¿)</span>
                <div class="input-row">
                    <input type="number" id="durationInput" min="0.5" max="8" step="0.5" value="1" oninput="updateModalPrice()" style="padding:5px; border:1px solid #ddd; border-radius:5px; text-align:right"> 
                    <span style="color:#666; font-weight:bold">hrs</span>
                </div>
            </div>
            
            <div class="info-row" style="border:none">
                <span class="info-label">ğŸ’° Total Price (Inc. GST)</span>
                <span class="info-val" style="color:#e94560; font-size:1.2rem" id="mPrice">--</span>
            </div>
        </div>

        <div style="background:#f8f9fa;padding:12px;border-radius:8px;font-size:0.85rem;color:#666;line-height:1.4">
            âš ï¸ **Note on Availability:** The schedule grid only reflects **TERM 1 class times**. Booking beyond the current day/term or for custom hours assumes availability, but **requires external confirmation**.
        </div>
        
        <button class="btn-confirm" onclick="confirmHire()">Confirm & Book</button>
        <button onclick="document.getElementById('bookingModal').style.display='none'" style="width:100%;padding:12px;background:none;border:none;color:#999;margin-top:5px;font-weight:bold">Cancel</button>
    </div>
</div>

<div class="nav-bar">
    <a href="/games.html" class="nav-item"><span class="nav-icon">ğŸ®</span>Home</a>
    <a href="/my_schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>Schedule</a>
    <a href="/timetable.html" class="nav-item"><span class="nav-icon">ğŸ›’</span>Book</a>
    <a href="#" class="nav-item active"><span class="nav-icon">ğŸ”‘</span>Rooms</a>
</div>

<script>
    // ä»·æ ¼é…ç½®
    const ROOMS = [
        {id: 'Classroom 1', name: "Studio 1", price: 35},
        {id: 'Classroom 2', name: "Studio 2", price: 35},
        {id: 3, name: "Studio 3", price: 35},
        {id: 4, name: "Studio 4 (Large)", price: 50},
        {id: 5, name: "Studio 5", price: 35},
        {id: 6, name: "Studio 6", price: 35},
        {id: 7, name: "Studio 7 (Small)", price: 30},
        {id: 8, name: "Yoga Room", price: 35},
    ];
    
    const HOURS = [];
    for(let i=9; i<=21; i++) HOURS.push(`${i}:00`); 

    const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const SHORT_DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    let currentDayIndex = 0; 
    let allCourses = []; 
    let selectedSlot = null; 

    // R1 è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®æ˜ŸæœŸå‡ çš„ç´¢å¼•ï¼Œè®¡ç®—å‡ºæœ¬å‘¨å…·ä½“çš„æ—¥æœŸå¯¹è±¡
    function getSpecificDate(dayIndex) {
        const today = new Date();
        const todayDayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1; // 0=Mon, 6=Sun (JS getDay: 0=Sun, 1=Mon)
        const diff = (dayIndex - todayDayIndex + 7) % 7;
        const targetDate = new Date(today);
        targetDate.setDate(today.getDate() + diff);
        return targetDate;
    }

    async function init() {
        // ç”Ÿæˆæ˜ŸæœŸå¯¼èˆª
        const c = document.getElementById('dayControls');
        SHORT_DAYS.forEach((d, idx) => {
            const btn = document.createElement('div');
            btn.className = `day-selector ${idx===0 ? 'active' : ''}`;
            btn.textContent = d;
            btn.onclick = () => switchDay(idx, btn);
            c.appendChild(btn);
        });

        // ä»æœåŠ¡å™¨è·å–æ‰€æœ‰è¯¾ç¨‹
        try {
            const res = await fetch('/api/public-schedule');
            allCourses = await res.json();
        } catch(e) { console.error('Failed to load schedule'); }

        renderTable();
    }

    function switchDay(idx, btn) {
        currentDayIndex = idx;
        document.querySelectorAll('.day-selector').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderTable();
    }

    function renderTable() {
        const table = document.getElementById('roomTable');
        table.innerHTML = '';
        
        // ç¡®ä¿æˆ¿é—´ ID å§‹ç»ˆæ˜¯å­—ç¬¦ä¸²ï¼Œé¿å… JS æŸ¥æ‰¾é”™è¯¯
        const ROOM_IDS = ROOMS.map(r => r.id);

        // è¡¨å¤´
        const thead = document.createElement('tr');
        thead.innerHTML = '<th>Time</th>';
        ROOMS.forEach(r => {
            thead.innerHTML += `<th>${r.name}<br><span class="price-tag"><span class="price-val">$${r.price}</span>+G</span></th>`;
        });
        table.appendChild(thead);

        const todayName = DAYS[currentDayIndex];

        // è¡¨æ ¼å†…å®¹
        HOURS.forEach(time => {
            const row = document.createElement('tr');
            const timeCell = document.createElement('td');
            timeCell.textContent = time;
            row.appendChild(timeCell);

            const hourInt = parseInt(time.split(':')[0]);

            ROOMS.forEach(r => {
                const cell = document.createElement('td');
                
                const occupiedCourse = allCourses.find(c => {
                    if (c.day_of_week !== todayName) return false;
                    if (c.classroom !== r.id) return false; 

                    const start = parseInt(c.start_time.split(':')[0]);
                    const end = parseInt(c.end_time.split(':')[0]);
                    return hourInt >= start && hourInt < end;
                });
                
                if (occupiedCourse) {
                    cell.className = 'cell-booked';
                    cell.textContent = 'BUSY';
                    cell.title = occupiedCourse.name;
                } else {
                    cell.className = 'cell-free';
                    cell.innerHTML = '<span style="color:#ddd;font-size:1.2rem">+</span>';
                    cell.onclick = () => openBooking(r, time, hourInt);
                }
                row.appendChild(cell);
            });

            table.appendChild(row);
        });
    }

    // R2 & R3 ä»·æ ¼è”åŠ¨å‡½æ•°
    window.updateModalPrice = function() {
        if (!selectedSlot) return;
        // è¯»å–æ—¶é•¿è¾“å…¥æ¡†çš„å€¼
        const duration = parseFloat(document.getElementById('durationInput').value) || 0;
        
        // ä»·æ ¼è®¡ç®— (å•ä»· * æ—¶é•¿ * 1.15 GST)
        const totalPrice = (selectedSlot.room.price * duration * 1.15).toFixed(2);
        document.getElementById('mPrice').textContent = `$${totalPrice}`;
    }

    // R1 æ›´æ–°æ—¥æœŸæ˜¾ç¤º
    window.updateBookingDay = function() {
        // å½“ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹æ—¥æœŸæ—¶ï¼Œä»…æ›´æ–°æ—¥æœŸï¼Œä¸å½±å“è¡¨æ ¼æ˜¾ç¤º
        const dateInput = document.getElementById('dateInput');
        const specificDate = new Date(dateInput.value);
        const dayOfWeek = specificDate.toLocaleDateString('en-NZ', { weekday: 'long' });
        
        // å¯ä»¥åœ¨è¿™é‡Œç»™ç”¨æˆ·ä¸€ä¸ªæç¤ºï¼šå½“å‰æ˜¾ç¤ºçš„è¡¨æ ¼æ˜¯ [dayOfWeek] çš„å ç”¨æƒ…å†µ
        console.log(`User manually selected date: ${dateInput.value} (${dayOfWeek})`);
    }

    function openBooking(room, time, hourInt) {
        selectedSlot = {room, time, hourInt};
        
        // R1 ä¿®å¤ï¼šè®¾ç½®æ—¥æœŸé€‰æ‹©å™¨çš„é»˜è®¤å€¼ (æœ¬å‘¨çš„è¯¥å¤©)
        const specificDate = getSpecificDate(currentDayIndex);
        const isoDate = specificDate.toISOString().split('T')[0];
        
        document.getElementById('mRoomName').textContent = room.name;
        document.getElementById('mStartTime').textContent = time; // æ˜ç¡®å¼€å§‹æ—¶é—´
        document.getElementById('dateInput').value = isoDate; // è®¾ç½®æ—¥æœŸè¾“å…¥æ¡†çš„å€¼
        
        document.getElementById('durationInput').value = 1; // é»˜è®¤ 1 å°æ—¶
        updateModalPrice(); // è®¡ç®— 1 å°æ—¶çš„ä»·æ ¼
        
        document.getElementById('bookingModal').style.display = 'flex';
    }

    function confirmHire() {
        if(!selectedSlot) return;
        const duration = parseFloat(document.getElementById('durationInput').value) || 0;
        const bookingDate = document.getElementById('dateInput').value;
        const startTime = selectedSlot.time;

        if(duration <= 0) return alert('Duration must be greater than 0.');
        
        const totalPrice = document.getElementById('mPrice').textContent;

        if(!confirm(`Confirm ${duration} hours booking on ${bookingDate} starting at ${startTime}? Total: ${totalPrice}`)) return;
        
        alert(`âœ… Booking Request Sent!\nRoom: ${selectedSlot.room.name}\nDate: ${bookingDate}\nDuration: ${duration} hrs\nTotal: ${totalPrice}`);
        document.getElementById('bookingModal').style.display = 'none';
        
        // NOTE: Real system needs to send API request with bookingDate, startTime, and duration.
    }

    init();
</script>
</body>
</html>