<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Studio Hire</title>
  <style>
    /* ... Ê†∑Âºè‰øùÊåÅ‰∏çÂèò ... */
    body{font-family:'Segoe UI', sans-serif;margin:0;background:#f2f4f8;padding-bottom:5rem}
    .header{background:#2c3e50;color:white;padding:1rem;text-align:center;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,0.2)}
    .controls {background:white;padding:12px;display:flex;overflow-x:auto;gap:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05); white-space:nowrap;}
    .day-selector {padding:8px 16px;background:#f0f0f0;border-radius:20px;font-size:0.9rem;cursor:pointer;font-weight:bold;color:#666;transition:0.2s}
    .day-selector.active {background:#2c3e50;color:white;box-shadow:0 2px 5px rgba(0,0,0,0.2)}
    .table-wrapper {overflow-x:auto; margin-top:15px; background:white; padding-bottom:20px; border-top:1px solid #ddd}
    .room-table {border-collapse:separate; border-spacing:0; width:100%; min-width:800px}
    .room-table th {background:#fff; color:#333; font-size:0.85rem; padding:10px; border-bottom:2px solid #e94560; border-right:1px solid #eee; position:sticky; top:0; z-index:10; min-width:90px}
    .room-table th:first-child {position:sticky; left:0; z-index:20; border-right:2px solid #ddd; background:#fff; color:#e94560}
    .room-table td {border-right:1px solid #eee; border-bottom:1px solid #eee; height:45px; text-align:center; font-size:0.8rem; cursor:pointer; position:relative; transition:0.1s}
    .room-table td:first-child {background:#f9f9f9; font-weight:bold; position:sticky; left:0; border-right:2px solid #ddd; z-index:5; color:#555}
    
    /* Áä∂ÊÄÅÈ¢úËâ≤ */
    .cell-free {background:white}
    .cell-free:hover {background:#e3f2fd}
    .cell-booked {background:#ffcdd2; color:#b71c1c; cursor:not-allowed; font-size:0.7rem; font-weight:bold; background-image:repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,0.5) 5px, rgba(255,255,255,0.5) 10px);}
    
    .price-tag {font-size:0.7rem; color:#888; display:block; font-weight:normal; margin-top:2px}
    .price-val {color:#e94560; font-weight:bold}

    .modal-overlay {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:999;justify-content:center;align-items:end}
    .modal {background:white;width:100%;max-width:500px;border-radius:20px 20px 0 0;padding:25px;box-sizing:border-box;animation:slideUp 0.3s; box-shadow:0 -5px 20px rgba(0,0,0,0.2)}
    @keyframes slideUp {from{transform:translateY(100%)} to{transform:translateY(0)}}
    .btn-confirm {width:100%;padding:14px;background:#2c3e50;color:white;border:none;border-radius:10px;font-weight:bold;margin-top:15px;font-size:1.1rem}
    .info-row {display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #eee}
    .info-label {color:#888}
    .info-val {font-weight:bold; color:#333}

    .nav-bar{position:fixed;bottom:0;left:0;width:100%;background:white;border-top:1px solid #eee;display:flex;justify-content:space-around;padding:8px 0;z-index:99; padding-bottom: max(8px, env(safe-area-inset-bottom));}
    .nav-item{text-decoration:none;color:#999;font-size:0.75rem;text-align:center;display:flex;flex-direction:column;align-items:center;flex:1}
    .nav-icon{font-size:1.5rem;margin-bottom:2px}
    .nav-item.active{color:#2c3e50}
  </style>
</head>
<body>

<div class="header">
    <h3 style="margin:0">üîë Studio Hire (ÊïôÂÆ§È¢ÑÁ∫¶)</h3>
</div>

<div class="controls" id="dayControls"></div>

<div class="table-wrapper">
    <table class="room-table" id="roomTable"></table>
</div>

<div id="bookingModal" class="modal-overlay">
    <div class="modal">
        <h2 id="mRoomName" style="margin-top:0; color:#2c3e50">Studio Name</h2>
        <div style="margin:20px 0;">
            <div class="info-row"><span class="info-label">üìÖ Date</span><span class="info-val" id="mDate">--</span></div>
            <div class="info-row"><span class="info-label">‚è∞ Time</span><span class="info-val" id="mTime">--</span></div>
            <div class="info-row" style="border:none"><span class="info-label">üí∞ Price (+GST)</span><span class="info-val" style="color:#e94560; font-size:1.2rem" id="mPrice">--</span></div>
        </div>
        <div style="background:#f8f9fa;padding:12px;border-radius:8px;font-size:0.85rem;color:#666;line-height:1.4">
            üí° <strong>Note:</strong> Valid for personal practice or rehearsal only.
        </div>
        <button class="btn-confirm" onclick="confirmHire()">Confirm & Book</button>
        <button onclick="document.getElementById('bookingModal').style.display='none'" style="width:100%;padding:12px;background:none;border:none;color:#999;margin-top:5px;font-weight:bold">Cancel</button>
    </div>
</div>

<div class="nav-bar">
    <a href="/games.html" class="nav-item"><span class="nav-icon">üéÆ</span>Home</a>
    <a href="/my_schedule.html" class="nav-item"><span class="nav-icon">üìÖ</span>Schedule</a>
    <a href="/timetable.html" class="nav-item"><span class="nav-icon">üõí</span>Book</a>
    <a href="#" class="nav-item active"><span class="nav-icon">üîë</span>Rooms</a>
</div>

<script>
    // 1. ÊïôÂÆ§ÈÖçÁΩÆ
    const ROOMS = [
        {id: 'Classroom 1', name: "Studio 1", price: 35},
        {id: 'Classroom 2', name: "Studio 2", price: 35},
        {id: 'Classroom 3', name: "Studio 3", price: 35},
        {id: 'Classroom 4', name: "Studio 4 (Large)", price: 50},
        {id: 'Classroom 5', name: "Studio 5", price: 35},
        {id: 'Classroom 6', name: "Studio 6", price: 35},
        {id: 'Classroom 7', name: "Studio 7 (Small)", price: 30},
        {id: 'Yoga Room', name: "Yoga Room", price: 35},
    ];
    
    const HOURS = [];
    for(let i=9; i<=21; i++) HOURS.push(`${i}:00`); 

    const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const SHORT_DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    let currentDayIndex = 0; 
    
    // ‚òÖ‚òÖ‚òÖ Âä®ÊÄÅÊï∞ÊçÆÊ∫ê ‚òÖ‚òÖ‚òÖ
    let allCourses = []; 

    async function init() {
        // ÁîüÊàêÊòüÊúüÂØºËà™
        const c = document.getElementById('dayControls');
        SHORT_DAYS.forEach((d, idx) => {
            const btn = document.createElement('div');
            btn.className = `day-selector ${idx===0 ? 'active' : ''}`;
            btn.textContent = d;
            btn.onclick = () => switchDay(idx, btn);
            c.appendChild(btn);
        });

        // ‚òÖ‚òÖ‚òÖ Ê†∏ÂøÉÔºö‰ªéÊúçÂä°Âô®Ëé∑ÂèñÊâÄÊúâËØæÁ®ã ‚òÖ‚òÖ‚òÖ
        try {
            const res = await fetch('/api/public-schedule');
            allCourses = await res.json();
            console.log("Loaded courses:", allCourses.length);
        } catch(e) { console.error('Failed to load schedule'); }

        renderTable();
    }

    function switchDay(idx, btn) {
        currentDayIndex = idx;
        document.querySelectorAll('.day-selector').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderTable();
    }

    function renderTable() {
        const table = document.getElementById('roomTable');
        table.innerHTML = '';

        // Ë°®Â§¥
        const thead = document.createElement('tr');
        thead.innerHTML = '<th>Time</th>';
        ROOMS.forEach(r => {
            thead.innerHTML += `<th>${r.name}<br><span class="price-tag"><span class="price-val">$${r.price}</span>+GST</span></th>`;
        });
        table.appendChild(thead);

        const todayName = DAYS[currentDayIndex]; // e.g., "Monday"

        // Ë°®Ê†ºÂÜÖÂÆπ
        HOURS.forEach(time => {
            const row = document.createElement('tr');
            const timeCell = document.createElement('td');
            timeCell.textContent = time;
            row.appendChild(timeCell);

            const hourInt = parseInt(time.split(':')[0]);

            ROOMS.forEach(r => {
                const cell = document.createElement('td');
                
                // ‚òÖ‚òÖ‚òÖ Êô∫ËÉΩÂåπÈÖçÔºöÊ£ÄÊü•ËØ•Êó∂ÊÆµÊòØÂê¶ÊúâËØæ ‚òÖ‚òÖ‚òÖ
                const occupiedCourse = allCourses.find(c => {
                    if (c.day_of_week !== todayName) return false;
                    if (c.classroom !== r.id) return false;
                    
                    // Ê£ÄÊü•Êó∂Èó¥ÈáçÂè†
                    const start = parseInt(c.start_time.split(':')[0]);
                    // ÁÆÄÂçïÂà§Êñ≠ÔºöÂ¶ÇÊûúËØæÁ®ãÂú® 16:00 ÂºÄÂßãÔºåÈÇ£‰πà 16:00 Ëøô‰∏ÄÊ†ºË¢´Âç†Áî®
                    // Â¶ÇÊûúËØæÁ®ã 16:00-17:30ÔºåÈÇ£‰πà 16:00 Âíå 17:00 ÈÉΩË¢´Âç†
                    const end = parseInt(c.end_time.split(':')[0]);
                    return hourInt >= start && hourInt < end;
                });
                
                if (occupiedCourse) {
                    cell.className = 'cell-booked';
                    cell.textContent = 'BUSY'; // ÊòæÁ§∫ËØæÂêçÂ§™Êå§‰∫ÜÔºåÊòæÁ§∫BUSYÂç≥ÂèØ
                    cell.title = occupiedCourse.name; // Èº†Ê†áÊÇ¨ÂÅúÊòæÁ§∫ËØæÂêç
                } else {
                    cell.className = 'cell-free';
                    cell.innerHTML = '<span style="color:#ddd;font-size:1.2rem">+</span>';
                    cell.onclick = () => openBooking(r, time, hourInt);
                }
                row.appendChild(cell);
            });

            table.appendChild(row);
        });
    }

    let selectedSlot = null;

    function openBooking(room, time, hourInt) {
        selectedSlot = {room, time, hourInt};
        const gstPrice = (room.price * 1.15).toFixed(2); 
        document.getElementById('mRoomName').textContent = room.name;
        document.getElementById('mDate').textContent = `${DAYS[currentDayIndex]}`;
        document.getElementById('mTime').textContent = `${time} - ${hourInt+1}:00`;
        document.getElementById('mPrice').textContent = `$${gstPrice}`;
        document.getElementById('bookingModal').style.display = 'flex';
    }

    function confirmHire() {
        if(!selectedSlot) return;
        alert(`‚úÖ Booking Request Sent!\nRoom: ${selectedSlot.room.name}\nTime: ${selectedSlot.time}\n\n(Mock Payment Processed)`);
        document.getElementById('bookingModal').style.display = 'none';
    }

    init();
</script>
</body>
</html>