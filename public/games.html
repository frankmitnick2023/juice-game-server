<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>WE DANCE - Hero Hub</title>
  <style>
    /* CSS æ ·å¼ */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #1a1a2e; color: white; padding-bottom: 5rem; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
    .header { background: rgba(22, 33, 62, 0.95); padding: 0 1rem; height: 60px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
    .user-name { font-weight: bold; color: #e94560; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; }
    .logout { font-size: 0.8rem; color: #aaa; text-decoration: none; border: 1px solid #444; padding: 4px 12px; border-radius: 15px; transition: 0.2s; }
    
    .stage-container { 
        margin-top: 60px; height: 55vh; min-height: 400px; position: relative; 
        display: flex; justify-content: center; align-items: center; overflow: hidden;
        background: radial-gradient(circle at center, rgba(42, 42, 74, 0.9) 0%, rgba(26, 26, 46, 0.95) 70%), url('/images/logo_watermark.png') no-repeat center center;
        background-size: auto 180%; 
    }
    
    .spotlight { position: absolute; top: -10%; left: 50%; transform: translateX(-50%); width: 80%; height: 120%; background: linear-gradient(to bottom, rgba(255,255,255,0.08), transparent); filter: blur(40px); pointer-events: none; }
    .avatar-wrapper { position: relative; width: 85vw; height: 85vw; max-width: 600px; max-height: 600px; animation: float 3s ease-in-out infinite; z-index: 10; margin-top: 20px; }
    .avatar-img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 15px 30px rgba(0,0,0,0.7)); opacity: 0; transition: opacity 0.5s; }
    .age-tag { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.6); color: #e94560; border: 1px solid #e94560; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; z-index: 20; }
    
    .upload-btn { position: absolute; top: 15px; left: 15px; background: rgba(255,255,255,0.1); border: 1px dashed #888; color: #ccc; padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; cursor: pointer; z-index: 50; display: flex; align-items: center; gap: 5px; }
    .edit-btn { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: #e94560; color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; text-decoration: none; box-shadow: 0 5px 15px rgba(233,69,96,0.4); z-index: 50; }
    .trophy-pile { position: absolute; bottom: 20px; right: 10px; display: flex; align-items: flex-end; flex-wrap: wrap-reverse; max-width: 180px; justify-content: flex-end; z-index: 15; pointer-events: none; }
    .trophy-item { font-size: 2.2rem; margin-left: -8px; margin-bottom: -5px; filter: drop-shadow(2px 2px 5px rgba(0,0,0,0.6)); transition: transform 0.2s; cursor: pointer; pointer-events: auto; position: relative; }
    .t-gold { color: #ffd700; filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5)); }
    
    .portal-container { padding: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-width: 800px; margin: -40px auto 0; position: relative; z-index: 30; }
    .portal-card { background: #16213e; border-radius: 16px; padding: 1.5rem 1rem; text-align: center; border: 2px solid rgba(255,255,255,0.05); box-shadow: 0 10px 25px rgba(0,0,0,0.4); cursor: pointer; }
    .portal-battle { background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%); }
    .portal-train { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .p-icon { font-size: 2.5rem; display: block; margin-bottom: 8px; }
    .p-title { font-size: 1.2rem; font-weight: bold; }

    /* Game View */
    .content-section { display: none; padding: 1rem; max-width: 1000px; margin: 60px auto 0; animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    .back-bar { display: flex; align-items: center; gap: 5px; color: #ccc; font-size: 1rem; margin-bottom: 1.5rem; cursor: pointer; padding: 10px 0; }
    .game-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
    .game-card { background: #222244; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .game-thumb { height: 110px; background: #0f3460; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
    .game-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .game-info { padding: 12px; text-align: center; }
    .game-title { font-size: 0.95rem; font-weight: bold; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .btn-start { display: block; width: 100%; box-sizing: border-box; background: #e94560; color: white; padding: 8px; border-radius: 6px; text-decoration: none; font-size: 0.9rem; font-weight: bold; }

    /* Modals */
    .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
    .modal-box { background: #222; width: 100%; max-width: 400px; border-radius: 16px; padding: 20px; position: relative; border: 1px solid #444; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .close-modal { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #888; }
    .upload-section { margin-bottom: 15px; border: 1px dashed #555; padding: 15px; border-radius: 8px; text-align: center; background: rgba(255,255,255,0.02); }
    .file-preview { margin-top: 10px; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
    .preview-thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #444; }
    .btn-submit { width: 100%; background: #e94560; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px; }
    
    /* Trophy Detail */
    .detail-img-box { width: 100%; height: 200px; background: #000; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
    .detail-img { max-width: 100%; max-height: 100%; }
    .detail-title { font-size: 1.2rem; font-weight: bold; color: #ffd700; margin-bottom: 5px; text-align: center; }
    .detail-meta { text-align: center; color: #888; font-size: 0.9rem; margin-bottom: 15px; }
    .detail-desc { background: #333; padding: 10px; border-radius: 8px; font-size: 0.9rem; color: #ccc; line-height: 1.4; }
    .loader-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 300; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; }

    /* Nav */
    .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #16213e; border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 8px 0; z-index: 99; padding-bottom: max(8px, env(safe-area-inset-bottom)); }
    .nav-item { text-decoration: none; color: #888; font-size: 0.75rem; text-align: center; display: flex; flex-direction: column; align-items: center; flex: 1; }
    .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }
    .nav-item.active { color: #e94560; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <div class="header">
    <div id="userInfo" class="user-name">LOADING...</div>
    <a href="#" id="logout" class="logout">é€€å‡º</a>
  </div>

  <div id="lobbyView">
      <div class="stage-container">
        <div class="spotlight"></div>
        <div id="ageTag" class="age-tag">Hero</div>
        <div class="upload-btn" onclick="openUploadModal()"><span>ğŸ“· Upload Award</span></div>
        <a href="/avatar_editor.html" class="edit-btn">âœï¸ Customize</a>
        <div class="avatar-wrapper"><img id="heroImg" class="avatar-img" src="" alt="Hero"></div>
        <div id="trophyArea" class="trophy-pile"></div>
      </div>

      <div class="portal-container">
        <div class="portal-card portal-battle" onclick="switchMode('battle')">
          <span class="p-icon">âš”ï¸</span><div class="p-title">Battle Mode</div>
        </div>
        <div class="portal-card portal-train" onclick="location.href='/timetable.html'">
          <span class="p-icon">ğŸ›¡ï¸</span><div class="p-title">Training Mode</div>
        </div>
      </div>
  </div>

 <div id="gameView" class="content-section" style="display:none;">
    <div class="back-bar" onclick="switchMode('home')"><span>â—€ Back</span></div>
    <div style="font-size:1.2rem;font-weight:bold;color:#e94560;margin-bottom:15px;border-left:4px solid #e94560;padding-left:10px">Available Games</div>
    
    <div id="gameGrid" class="game-grid"></div>
  </div>
	
  <div id="virtualWorld" style="display:none; width:100%; height:100vh; background: #000; position:fixed; top:0; left:0; z-index:200;">
      <div style="position:absolute; top:80px; left:20px; z-index:300;">
          <button onclick="exitVirtualWorld()" style="background:rgba(255,69,96, 0.8); color:white; border:none; padding:10px 20px; border-radius:30px; font-weight:bold; box-shadow: 0 4px 10px rgba(0,0,0,0.5);">
              â—€ Exit World
          </button>
      </div>
      
      <div id="canvas-container" style="width:100%; height:100%;"></div>
  </div>
	
    <div id="phaser-game" style="width:100%; height:100%;"></div>
    
    <div id="interactionTip" style="display:none; position:absolute; bottom:100px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:20px; border:2px solid #e94560; font-weight:bold; font-size:1.2rem; animation: float 2s infinite;">
        Press SPACE to enter
    </div>
  </div>

  <div id="uploadModal" class="modal-overlay">
      <div class="modal-box">
          <span class="close-modal" onclick="closeModal('uploadModal')">&times;</span>
          <h3 style="margin-top:0; text-align:center">Upload Achievement</h3>
          <div class="upload-section"><label class="upload-label">1. Certificate (Main)</label><input type="file" id="mainCertInput" accept="image/*" onchange="previewFiles(this, 'previewMain')"><div id="previewMain" class="file-preview"></div></div>
          <div class="upload-section"><label class="upload-label">2. Photos (Optional)</label><input type="file" id="extraPhotosInput" accept="image/*" multiple onchange="previewFiles(this, 'previewExtra')"><div id="previewExtra" class="file-preview"></div></div>
          <button class="btn-submit" onclick="submitAwardUpload()">Submit</button>
      </div>
  </div>

  <div id="trophyDetailModal" class="modal-overlay">
      <div class="modal-box">
          <span class="close-modal" onclick="closeModal('trophyDetailModal')">&times;</span>
          <div class="detail-img-box"><img id="dImg" src="" class="detail-img"></div>
          <div id="dTitle" class="detail-title"></div>
          <div id="dMeta" class="detail-meta"></div>
          <div id="dDesc" class="detail-desc"></div>
      </div>
  </div>

  <div class="loader-overlay" id="loader"><div style="font-size:3rem">ğŸ“¤</div></div>

  <div class="nav-bar">
    <a href="#" class="nav-item active"><span class="nav-icon">ğŸ®</span>Home</a>
    <a href="/my_schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>Schedule</a>
    <a href="/timetable.html" class="nav-item"><span class="nav-icon">ğŸ›’</span>Book</a>
    <a href="/growth.html" class="nav-item"><span class="nav-icon">ğŸ“Š</span>Growth</a>
    <a href="/rooms.html" class="nav-item"><span class="nav-icon">ğŸ”‘</span>Rooms</a>
  </div>

  <script>
	  // åœ¨ games.html çš„ script æ ‡ç­¾å†…

async function submitAwardUpload() {
    // 1. è·å– input é‡Œçš„æ–‡ä»¶
    const mainInput = document.getElementById('mainCertInput');
    const extraInput = document.getElementById('extraPhotosInput');
    
    // éªŒè¯ï¼šå¿…é¡»ä¸Šä¼ ä¸»è¯ä¹¦
    if (!mainInput.files || mainInput.files.length === 0) {
        alert('Please upload the Main Certificate (è¯·ä¸Šä¼ è¯ä¹¦å›¾ç‰‡)!');
        return;
    }

    // 2. ç•Œé¢åé¦ˆï¼šæ˜¾ç¤º Loadingï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
    const btn = document.querySelector('.btn-submit');
    const originalText = btn.textContent;
    btn.textContent = 'Uploading... 0%'; // å¯ä»¥ç®€å•æç¤ºæ­£åœ¨ä¸Šä¼ 
    btn.disabled = true;
    document.getElementById('loader').style.display = 'flex'; // æ˜¾ç¤ºä½ åšå¥½çš„ loader é®ç½©

    // 3. æ„å»º FormData æ•°æ®åŒ…
    const formData = new FormData();
    // æ³¨æ„ï¼šè¿™é‡Œçš„åå­— 'mainCert' å¿…é¡»å’Œåç«¯ upload.fields é‡Œçš„åå­—ä¸€è‡´
    formData.append('mainCert', mainInput.files[0]); 
    
    // æŠŠå¤šå¼ é¢å¤–ç…§ç‰‡åŠ è¿›å»
    for (let i = 0; i < extraInput.files.length; i++) {
        formData.append('extraPhotos', extraInput.files[i]);
    }

    try {
        // 4. å‘é€è¯·æ±‚
        const res = await fetch('/api/upload-trophy', {
            method: 'POST',
            body: formData // ä¸éœ€è¦è®¾ç½® Content-Typeï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å¤„ç†
        });
        
        const data = await res.json();
        
        if (res.ok && data.success) {
            alert('âœ… Upload Successful! Waiting for teacher approval.');
            closeModal('uploadModal'); // å…³é—­å¼¹çª—
            
            // æ¸…ç©ºè¾“å…¥æ¡†ï¼Œæ–¹ä¾¿ä¸‹æ¬¡ä¸Šä¼ 
            mainInput.value = '';
            extraInput.value = '';
            document.getElementById('previewMain').innerHTML = '';
            document.getElementById('previewExtra').innerHTML = '';

            // åˆ·æ–°åˆ—è¡¨ï¼ˆå¦‚æœä½ æœ‰ loadTrophies å‡½æ•°çš„è¯ï¼‰
            if (typeof loadTrophies === 'function') loadTrophies();
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    } catch (e) {
        console.error(e);
        alert('âŒ Upload Failed: ' + e.message);
    } finally {
        // 5. æ¢å¤ç•Œé¢çŠ¶æ€
        btn.textContent = originalText;
        btn.disabled = false;
        document.getElementById('loader').style.display = 'none';
    }
}
	    
    async function init() {
        try {
            const res = await fetch('/api/me');
            const user = await res.json();
            if (!user.id) return location.href = '/';
            document.getElementById('userInfo').textContent = user.student_name || "Hero";
            loadAvatar(user);
            loadTrophies();
        } catch (e) {}
    }

    // -------------------------------------------------------------
    // 1. å¤´åƒåŠ è½½é€»è¾‘ (ä¿æŒä¸å˜)
    // -------------------------------------------------------------
    function loadAvatar(user) {
        const imgEl = document.getElementById('heroImg');
        let age = 7; 
        if (user.dob) age = Math.abs(new Date(Date.now() - new Date(user.dob).getTime()).getUTCFullYear() - 1970);
        
        let ageGroup = 'junior'; 
        if (age >= 12) ageGroup = 'senior'; 
        else if (age >= 8) ageGroup = 'middle';
        
        const gender = (/[aeiy]$/.test(user.student_name || "") || ['cindy','yolanda'].includes((user.student_name||"").toLowerCase())) ? 'girl' : 'boy';
        const outfit = user.avatar_config?.outfit || 'uniform';
        
        const ageTag = document.getElementById('ageTag');
        if(ageTag) ageTag.textContent = `${ageGroup.toUpperCase()} ${gender==='girl'?'Heroine':'Hero'}`;
        
        if (imgEl) {
            if (user.avatar_config?.useAiAvatar && user.avatar_config?.aiAvatarUrl) { 
                imgEl.src = user.avatar_config.aiAvatarUrl; 
            } else { 
                imgEl.src = `/avatars/${gender}_${ageGroup}_${outfit}.png`; 
            }
            imgEl.style.opacity = 1;
        }
    }

    // -------------------------------------------------------------
    // 2. æ¨¡å¼åˆ‡æ¢ä¸è™šæ‹Ÿæ ¡å›­é€»è¾‘ (æ ¸å¿ƒä¿®æ”¹)
    // -------------------------------------------------------------
    let gameInstance = null; // å…¨å±€å˜é‡å­˜å‚¨æ¸¸æˆå®ä¾‹

    function switchMode(mode) {
        // è·å–ä¸‰ä¸ªä¸»è¦å®¹å™¨
        const lobby = document.getElementById('lobbyView');      // ä¸ªäººä¸»é¡µ/å¤§å…
        const gameView = document.getElementById('gameView');    // æ™®é€š2Dæ¸¸æˆåˆ—è¡¨
        const virtualWorld = document.getElementById('virtualWorld'); // 3Dè™šæ‹Ÿå¤§å…å®¹å™¨

        if (mode === 'battle') { 
            // === è¿›å…¥ Battle Mode (è™šæ‹Ÿæ ¡å›­) ===
            
            // 1. éšè—æ™®é€šç•Œé¢
            if(lobby) lobby.style.display = 'none';
            if(gameView) gameView.style.display = 'none'; // æ—¢ç„¶è¿›3Dï¼Œå°±å…ˆéšè—2Dåˆ—è¡¨
            
            // 2. æ˜¾ç¤ºè™šæ‹Ÿå¤§å…å®¹å™¨
            if(virtualWorld) {
                virtualWorld.style.display = 'block';
            } else {
                console.error("Error: æ‰¾ä¸åˆ° ID ä¸º 'virtualWorld' çš„ divï¼Œè¯·æ£€æŸ¥ HTML");
                return;
            }

            // 3. å¯åŠ¨ 3D åœºæ™¯
            if (!gameInstance) {
                // å»¶è¿Ÿä¸€ç‚¹ç‚¹ç¡®ä¿å®¹å™¨å·²æ¸²æŸ“
                setTimeout(() => {
                    initVirtualCampus(); 
                }, 100);
            }

        } else { 
            // === è¿”å› Home (ä¸ªäººä¸»é¡µ) ===
            
            // 1. éšè—è™šæ‹Ÿå¤§å…å’Œæ¸¸æˆåˆ—è¡¨
            if(virtualWorld) virtualWorld.style.display = 'none';
            if(gameView) gameView.style.display = 'none';
            
            // 2. æ˜¾ç¤ºä¸ªäººä¸»é¡µ
            if(lobby) lobby.style.display = 'block';
            
            // 3. é”€æ¯æ¸¸æˆå®ä¾‹ï¼Œé‡Šæ”¾å†…å­˜ (é˜²æ­¢å¡é¡¿)
            if (gameInstance) {
                // å¦‚æœæ˜¯ Phaser æ¸¸æˆï¼Œè°ƒç”¨ destroy
                if(typeof gameInstance.destroy === 'function') {
                    gameInstance.destroy(true);
                }
                gameInstance = null;
                console.log("è™šæ‹Ÿæ ¡å›­å·²å…³é—­");
            }
        }
    }

    // â˜…â˜…â˜… æ–°å¢ï¼šå®šä¹‰å¯åŠ¨è™šæ‹Ÿæ ¡å›­çš„å‡½æ•° (é˜²æ­¢ is not defined æŠ¥é”™) â˜…â˜…â˜…
    function initVirtualCampus() {
        console.log("ğŸš€ å¯åŠ¨è™šæ‹Ÿæ ¡å›­...");
        const container = document.getElementById('canvas-container'); // ä½ çš„3Då®¹å™¨ID
        if(!container) return;

        // åœ¨è¿™é‡Œåˆå§‹åŒ–ä½ çš„ 3D å¼•æ“ (Phaser æˆ– Three.js)
        // ç¤ºä¾‹ï¼šæš‚æ—¶åªæ˜¾ç¤ºä¸€ä¸ªæ–‡æœ¬ï¼Œä»£è¡¨å·²å¯åŠ¨
        container.innerHTML = '<h2 style="color:white; margin-top:20%">ğŸŒ Virtual World Loaded</h2><p style="color:#ccc">Game Instance Active</p>';
        
        // æ¨¡æ‹Ÿåˆ›å»ºä¸€ä¸ªæ¸¸æˆå®ä¾‹å¯¹è±¡ (é˜²æ­¢ switchMode é‡ŒæŠ¥é”™)
        gameInstance = {
            active: true,
            destroy: function() {
                console.log("Cleaning up resources...");
                container.innerHTML = ''; // æ¸…ç©ºç”»é¢
            }
        };
        
        // å¦‚æœä½ ä»¥åæ¥å…¥äº†çœŸå®çš„ Phaserï¼Œä»£ç å¤§æ¦‚æ˜¯è¿™æ ·ï¼š
        // gameInstance = new Phaser.Game(config);
    }

    // -------------------------------------------------------------
    // 3. åŠ è½½ 2D æ¸¸æˆåˆ—è¡¨ (å¢åŠ ç©ºå€¼æ£€æŸ¥)
    // -------------------------------------------------------------
    function loadGames() {
        const grid = document.getElementById('gameGrid');
        
        // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœå½“å‰é¡µé¢æ²¡æœ‰ gameGrid (æ¯”å¦‚åœ¨çº¯3Dæ¨¡å¼ä¸‹)ï¼Œå°±ä¸æ‰§è¡Œï¼Œé˜²æ­¢æŠ¥é”™
        if (!grid) return; 

        grid.innerHTML = '<div style="text-align:center;color:#888">Loading...</div>';
        
        fetch('/api/games')
            .then(r => r.json())
            .then(games => {
                grid.innerHTML = '';
                if(games.length === 0) { 
                    grid.innerHTML = 'No games found'; 
                    return; 
                }
                games.forEach(g => {
                    const thumb = g.thumbnail ? `/games/${g.path}/${g.thumbnail}` : null;
                    grid.innerHTML += `
                        <div class="game-card">
                            <div class="game-thumb">${thumb ? `<img src="${thumb}">` : 'ğŸ‘¾'}</div>
                            <div class="game-info">
                                <div class="game-title">${g.title}</div>
                                <a href="/play/${g.id}" class="btn-start">START</a>
                            </div>
                        </div>`;
                });
            })
            .catch(e => {
                console.error(e);
                grid.innerHTML = 'Error loading games';
            });
    }
    
   // 1. åŠ è½½å¥–æ¯æ•°æ®çš„å‡½æ•°
async function loadTrophies() {
        const container = document.getElementById('trophyArea');
        container.innerHTML = ''; 

        try {
            // æ·»åŠ ä¸€ä¸ªéšæœºæ•°é˜²æ­¢æ¥å£ç¼“å­˜ (?t=...)
            const res = await fetch('/api/my-trophies?t=' + new Date().getTime()); 
            const trophies = await res.json();

            if (!trophies || trophies.length === 0) return;

            trophies.forEach(t => {
                const status = (t.status || '').toUpperCase();
                if (status !== 'APPROVED') return; 

                // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šç²¾å‡†åŒ¹é…æ•°æ®åº“æˆªå›¾ä¸­çš„å­—æ®µå â˜…â˜…â˜…
                // ä¼˜å…ˆè¯»å– trophy_type (æ•°æ®åº“åŸå)ï¼Œå…¶æ¬¡å°è¯• camelCaseï¼Œæœ€åå°è¯• type
                const dbType = t.trophy_type; 
                const rawType = dbType || t.trophyType || t.type || ''; 
                
                // è½¬å°å†™å¤„ç†
                const safeType = String(rawType).toLowerCase().trim();

                const div = document.createElement('div');
                div.className = 'trophy-item';
                
                // --- å›¾æ ‡åŒ¹é… ---
                let icon = 'ğŸ–ï¸'; // é»˜è®¤ï¼šBadge

                if (safeType.includes('gold') && !safeType.includes('medal')) { 
                    icon = 'ğŸ†'; div.classList.add('t-gold'); 
                }
                else if (safeType.includes('silver')) icon = 'ğŸ¥ˆ';
                else if (safeType.includes('bronze')) icon = 'ğŸ¥‰';
                else if (safeType.includes('medal')) icon = 'ğŸ¥‡';
                
                // åªè¦åŒ…å« 'cert' (å¯¹åº” certificate) å°±æ˜¾ç¤ºå·è½´
                else if (safeType.includes('cert')) icon = 'ğŸ“œ';
                
                else if (safeType.includes('badge')) icon = 'ğŸ…';

                div.textContent = icon;
                div.onclick = () => showTrophyDetail(t);
                
                // â˜…â˜…â˜… ä¸´æ—¶è¯Šæ–­ä»£ç  (è°ƒè¯•å®Œå¯åˆ é™¤) â˜…â˜…â˜…
                // è¿™è¡Œä»£ç ä¼šåœ¨å›¾æ ‡æ—è¾¹ç›´æ¥æ˜¾ç¤ºå®ƒè¯»åˆ°çš„ç±»å‹ï¼Œä¾‹å¦‚ "Type: certificate"
                // å¦‚æœæ˜¾ç¤º "Type: undefined"ï¼Œè¯´æ˜åç«¯å‹æ ¹æ²¡æŠŠè¿™ä¸ªå­—æ®µå‘è¿‡æ¥ï¼
                const debugLabel = document.createElement('span');
                debugLabel.style.fontSize = '10px';
                debugLabel.style.color = 'white';
                debugLabel.style.background = 'rgba(0,0,0,0.5)';
                debugLabel.textContent = ` ${safeType || 'NULL'} `; 
                div.appendChild(debugLabel); 
                // â˜…â˜…â˜… è¯Šæ–­ä»£ç ç»“æŸ â˜…â˜…â˜…

                container.appendChild(div);
            });
        } catch (e) {
            console.error("åŠ è½½å¥–æ¯å¤±è´¥:", e);
        }
    }

    // 2. æ˜¾ç¤ºå¥–æ¯è¯¦æƒ…å¼¹çª—çš„å‡½æ•°
    function showTrophyDetail(t) {
        const modal = document.getElementById('trophyDetailModal');
        const img = document.getElementById('dImg');
        const title = document.getElementById('dTitle');
        const meta = document.getElementById('dMeta');
        const desc = document.getElementById('dDesc');

        // å¡«å……æ•°æ®
        // æ³¨æ„ï¼šè¿™é‡Œå­—æ®µå (image_path, source_name) éœ€å¯¹åº”æ‚¨æ•°æ®åº“è¿”å›çš„å­—æ®µ
        img.src = t.image_path || ''; 
        title.textContent = t.source_name || 'Award';
        
        const dateStr = t.created_at ? new Date(t.created_at).toLocaleDateString() : '';
        meta.textContent = `${dateStr} â€¢ ${t.type ? t.type.toUpperCase() : 'AWARD'}`;
        
       // ä¿®å¤åçš„é€»è¾‘ï¼šæ€»æ˜¯æ˜¾ç¤º
		// å¦‚æœæœ‰æ•°æ®åº“é‡Œçš„è¯„è¯­ï¼Œå°±ç”¨æ•°æ®åº“çš„ï¼›å¦‚æœæ²¡æœ‰ï¼Œå°±ç”¨é»˜è®¤çš„é¼“åŠ±è¯­
		desc.textContent = t.description || 'Great job! Keep dancing! (æ­¤è£èª‰æš‚æ— è¯¦ç»†è¯„è¯­)';
		desc.style.display = 'block'; // å¼ºåˆ¶æ˜¾ç¤º

        // æ˜¾ç¤ºå¼¹çª—
        modal.style.display = 'flex';
    }
    
    function openUploadModal() { document.getElementById('uploadModal').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function previewFiles(input, conId) { /* ... */ }
    async function submitAwardUpload() {
    const mainInput = document.getElementById('mainCertInput');
    const extraInput = document.getElementById('extraPhotosInput');
    
    // 1. éªŒè¯ï¼šå¿…é¡»ä¸Šä¼ ä¸»è¯ä¹¦
    if (!mainInput.files || mainInput.files.length === 0) {
        alert('Please upload the Main Certificate (è¯·ä¸Šä¼ è¯ä¹¦å›¾ç‰‡)!');
        return;
    }

    // 2. ç•Œé¢åé¦ˆï¼šæŒ‰é’®å˜è‰²ï¼Œé˜²æ­¢é‡å¤ç‚¹
    const btn = document.querySelector('.btn-submit');
    const originalText = btn.textContent;
    btn.textContent = 'Uploading... (Wait)';
    btn.disabled = true;
    
    // æ˜¾ç¤ºåŠ è½½åœˆ (å¦‚æœæœ‰è¿™ä¸ªå…ƒç´ çš„è¯)
    const loader = document.getElementById('loader');
    if(loader) loader.style.display = 'flex';

    // 3. æ‰“åŒ…æ•°æ®
    const formData = new FormData();
    formData.append('mainCert', mainInput.files[0]); 
    
    // æŠŠå¤šå¼ é¢å¤–ç…§ç‰‡åŠ è¿›å»
    if (extraInput.files) {
        for (let i = 0; i < extraInput.files.length; i++) {
            formData.append('extraPhotos', extraInput.files[i]);
        }
    }

    try {
        // 4. å‘é€ç»™æœåŠ¡å™¨
        const res = await fetch('/api/upload-trophy', {
            method: 'POST',
            body: formData
        });
        
        // å°è¯•è§£æè¿”å›ç»“æœ
        const data = await res.json();
        
        if (res.ok && data.success) {
            alert('âœ… Upload Successful! Waiting for teacher approval.');
            closeModal('uploadModal'); // å…³é—­å¼¹çª—
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            mainInput.value = '';
            extraInput.value = '';
            document.getElementById('previewMain').innerHTML = '';
            document.getElementById('previewExtra').innerHTML = '';
            
            // åˆ·æ–°åˆ—è¡¨ï¼ˆå¦‚æœé¡µé¢æœ‰è¿™ä¸ªå‡½æ•°ï¼‰
            if(typeof loadTrophies === 'function') loadTrophies();
        } else {
            throw new Error(data.error || 'Upload failed');
        }
    } catch (e) {
        console.error(e);
        alert('âŒ Error: ' + e.message);
    } finally {
        // 5. æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.textContent = originalText;
        btn.disabled = false;
        if(loader) loader.style.display = 'none';
    }
}
    document.getElementById('logout').onclick = () => fetch('/api/logout', {method:'POST'}).then(()=>location.href='/');
	src="/js/virtual_campus.js"> 
    init();
  </script>
</body>
</html>