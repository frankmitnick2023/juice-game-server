<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>WE DANCE - Hero Hub</title>
  <style>
    /* CSS æ ·å¼ */
	  
/* 1. å®šä¹‰å‘¼å¸åŠ¨ç”»å…³é”®å¸§ */
    /* è®©å›¾ç‰‡åœ¨ Y è½´è½»å¾®æ‹‰ä¼¸ï¼ŒX è½´è½»å¾®å‹ç¼©ï¼Œæ¨¡æ‹Ÿå‘¼å¸ */
    @keyframes breathe {
        0%, 100% { transform: scale(1, 1); }
        50% { transform: scale(1.02, 0.98); } /* æ•°å€¼è¶Šå°åŠ¨ä½œè¶Šä¸æ˜æ˜¾ï¼Œ1.02 è¡¨ç¤ºæ‹‰ä¼¸ 2% */
    }

    /* åŸæœ‰çš„å¤–éƒ¨å®¹å™¨åŠ¨ç”» (ä¿æŒä¸å˜ï¼Œè´Ÿè´£æ•´ä½“ä¸Šä¸‹æµ®åŠ¨) */
    .avatar-wrapper { position: relative; width: 85vw; height: 85vw; max-width: 600px; max-height: 600px; animation: float 3s ease-in-out infinite; z-index: 10; margin-top: 20px; }

    /* 2. ä¿®æ”¹å†…éƒ¨å›¾ç‰‡æ ·å¼ï¼Œåº”ç”¨å‘¼å¸åŠ¨ç”» */
    .avatar-img { 
        width: 100%; 
        height: 100%; 
        object-fit: contain; 
        filter: drop-shadow(0 15px 30px rgba(0,0,0,0.7)); 
        opacity: 0; 
        transition: opacity 0.5s;
        
        /* â˜…â˜…â˜… æ–°å¢éƒ¨åˆ† â˜…â˜…â˜… */
        /* åº”ç”¨å‘¼å¸åŠ¨ç”»ï¼Œæ—¶é—´è®¾ä¸º 2.5sï¼Œå’Œå¤–å±‚çš„ float 3s é”™å¼€ä¸€ç‚¹èŠ‚å¥æ„Ÿæ›´å¥½ */
        animation: breathe 2.5s ease-in-out infinite;
        /* è®¾ç½®å˜å½¢åŸºç‚¹åœ¨åº•éƒ¨ä¸­å¿ƒï¼Œè¿™æ ·çœ‹èµ·æ¥æ˜¯èº«ä½“åœ¨åŠ¨ï¼Œè„šä¸åŠ¨ */
        transform-origin: bottom center;
    }	  
	  
	/* ğŸ® è™šæ‹Ÿæ–¹å‘é”®æ ·å¼ */
.d-pad-container {
    position: fixed;
    bottom: 140px; /* ä½äºåº•éƒ¨å¯¼èˆªæ ä¸Šæ–¹ */
    left: 20px;
    width: 150px;
    height: 150px;
    z-index: 600; /* ç¡®ä¿åœ¨åœ°å›¾ä¹‹ä¸Š */
    display: none; /* é»˜è®¤éšè—ï¼Œè¿›å…¥åœ°å›¾æ¨¡å¼æ‰æ˜¾ç¤º */
    pointer-events: none; /* è®©å®¹å™¨æœ¬èº«ä¸é˜»æŒ¡ç‚¹å‡»ï¼Œåªæœ‰æŒ‰é’®é˜»æŒ¡ */
}

/* åå­—é”®å¸ƒå±€ */
.d-pad-btn {
    position: absolute;
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.25);
    border: 2px solid rgba(255, 255, 255, 0.5);
    border-radius: 50%;
    color: white;
    font-size: 24px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    pointer-events: auto; /* æŒ‰é’®å¯ä»¥ç‚¹å‡» */
    backdrop-filter: blur(4px);
    user-select: none;
    -webkit-user-select: none;
    transition: background 0.1s;
}

.d-pad-btn:active, .d-pad-btn.active {
    background: rgba(233, 69, 96, 0.8); /* æŒ‰ä¸‹å˜çº¢ */
    transform: scale(0.95);
}

/* æ–¹å‘å®šä½ */
.d-up { top: 0; left: 50px; }
.d-down { bottom: 0; left: 50px; }
.d-left { top: 50px; left: 0; }
.d-right { top: 50px; right: 0; }  
	  
	  
	  /* å…¨å±€ç¦æ­¢å›¾ç‰‡æ‹–æ‹½ï¼Œé˜²æ­¢å°æœ‹å‹æ‰‹æ»‘æ‹–å‡ºæ–°æ ‡ç­¾é¡µ */
    img {
    -webkit-user-drag: none;
    user-select: none;
    -moz-user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
    }
	  
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #1a1a2e; color: white; padding-bottom: 5rem; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
    .header { background: rgba(22, 33, 62, 0.95); padding: 0 1rem; height: 60px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
    .user-name { font-weight: bold; color: #e94560; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; }
    .logout { font-size: 0.8rem; color: #aaa; text-decoration: none; border: 1px solid #444; padding: 4px 12px; border-radius: 15px; transition: 0.2s; }
    
    .stage-container { 
        margin-top: 60px; height: 55vh; min-height: 400px; position: relative; 
        display: flex; justify-content: center; align-items: center; overflow: hidden;
        background: radial-gradient(circle at center, rgba(42, 42, 74, 0.9) 0%, rgba(26, 26, 46, 0.95) 70%), url('/images/logo_watermark.png') no-repeat center center;
        background-size: auto 180%; 
    }
    
    .spotlight { position: absolute; top: -10%; left: 50%; transform: translateX(-50%); width: 80%; height: 120%; background: linear-gradient(to bottom, rgba(255,255,255,0.08), transparent); filter: blur(40px); pointer-events: none; }
   .avatar-wrapper { position: relative; width: 85vw; height: 85vw; max-width: 600px; max-height: 600px; animation: float 3s ease-in-out infinite; z-index: 10; margin-top: 20px; }
   .avatar-img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 15px 30px rgba(0,0,0,0.7)); opacity: 0; transition: opacity 0.5s; }
    .age-tag { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.6); color: #e94560; border: 1px solid #e94560; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; z-index: 20; }
    
    .upload-btn { position: absolute; top: 15px; left: 15px; background: rgba(255,255,255,0.1); border: 1px dashed #888; color: #ccc; padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; cursor: pointer; z-index: 50; display: flex; align-items: center; gap: 5px; }
    .edit-btn { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: #e94560; color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; text-decoration: none; box-shadow: 0 5px 15px rgba(233,69,96,0.4); z-index: 50; }
    .trophy-pile { position: absolute; bottom: 20px; right: 10px; display: flex; align-items: flex-end; flex-wrap: wrap-reverse; max-width: 180px; justify-content: flex-end; z-index: 15; pointer-events: none; }
    .trophy-item { font-size: 2.2rem; margin-left: -8px; margin-bottom: -5px; filter: drop-shadow(2px 2px 5px rgba(0,0,0,0.6)); transition: transform 0.2s; cursor: pointer; pointer-events: auto; position: relative; }
    .t-gold { color: #ffd700; filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5)); }
    
    .portal-container { padding: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-width: 800px; margin: -40px auto 0; position: relative; z-index: 30; }
    .portal-card { background: #16213e; border-radius: 16px; padding: 1.5rem 1rem; text-align: center; border: 2px solid rgba(255,255,255,0.05); box-shadow: 0 10px 25px rgba(0,0,0,0.4); cursor: pointer; }
    .portal-battle { background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%); }
    .portal-train { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .p-icon { font-size: 2.5rem; display: block; margin-bottom: 8px; }
    .p-title { font-size: 1.2rem; font-weight: bold; }

    /* Game View */
    .content-section { display: none; padding: 1rem; max-width: 1000px; margin: 60px auto 0; animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    .back-bar { display: flex; align-items: center; gap: 5px; color: #ccc; font-size: 1rem; margin-bottom: 1.5rem; cursor: pointer; padding: 10px 0; }
    .game-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
    .game-card { background: #222244; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .game-thumb { height: 110px; background: #0f3460; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
    .game-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .game-info { padding: 12px; text-align: center; }
    .game-title { font-size: 0.95rem; font-weight: bold; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .btn-start { display: block; width: 100%; box-sizing: border-box; background: #e94560; color: white; padding: 8px; border-radius: 6px; text-decoration: none; font-size: 0.9rem; font-weight: bold; }

    /* Modals */
    .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
    .modal-box { background: #222; width: 100%; max-width: 400px; border-radius: 16px; padding: 20px; position: relative; border: 1px solid #444; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .close-modal { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #888; }
    .upload-section { margin-bottom: 15px; border: 1px dashed #555; padding: 15px; border-radius: 8px; text-align: center; background: rgba(255,255,255,0.02); }
    .file-preview { margin-top: 10px; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
    .preview-thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #444; }
    .btn-submit { width: 100%; background: #e94560; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px; }
    
    /* Trophy Detail */
    .detail-img-box { width: 100%; height: 200px; background: #000; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
    .detail-img { max-width: 100%; max-height: 100%; }
    .detail-title { font-size: 1.2rem; font-weight: bold; color: #ffd700; margin-bottom: 5px; text-align: center; }
    .detail-meta { text-align: center; color: #888; font-size: 0.9rem; margin-bottom: 15px; }
    .detail-desc { background: #333; padding: 10px; border-radius: 8px; font-size: 0.9rem; color: #ccc; line-height: 1.4; }
    .loader-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 300; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; }

	  /* åœ°å›¾æ¨¡å¼ä¸‹çš„ç©å®¶ä½ç½®æŒ‡ç¤ºå™¨ï¼ˆå‘¼å¸å…‰åœˆï¼‰ */
    /* â˜…â˜…â˜… æ–°å¢ï¼šåœ°å›¾æ¨¡å¼ä¸‹çš„é—ªçƒå…‰åœˆ â˜…â˜…â˜… */
    @keyframes indicator-pulse {
        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0.8; box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
        70% { transform: translate(-50%, -50%) scale(2.0); opacity: 0; box-shadow: 0 0 0 40px rgba(255, 215, 0, 0); }
        100% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    }

    .map-indicator {
        position: absolute;
        top: 50%; left: 50%;
        width: 100px; height: 100px; /* å¤§å° */
        border: 4px solid #ffd700;   /* é‡‘è‰²è¾¹æ¡† */
        border-radius: 50%;
        background: rgba(255, 215, 0, 0.3);
        z-index: 240;
        pointer-events: none;
        display: none; /* é»˜è®¤éšè— */
        transform: translate(-50%, -50%);
    }
    
    /* æ¿€æ´»æ—¶å¼€å¯åŠ¨ç”» */
    .map-indicator.active {
        display: block;
        animation: indicator-pulse 1.2s infinite ease-out;
    }
	
	  .connection-status {
    position: fixed; top: 90px; left: 140px; z-index: 600;
    width: 10px; height: 10px; border-radius: 50%;
    background: red; /* é»˜è®¤çº¢è‰²ï¼Œä»£è¡¨æ–­å¼€ */
    box-shadow: 0 0 5px black;
}
.connection-status.online { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
	  
	  
    /* Nav */
    .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #16213e; border-top: 1px solid #333; display: flex; justify-content: space-around; padding: 8px 0; z-index: 99; padding-bottom: max(8px, env(safe-area-inset-bottom)); }
    .nav-item { text-decoration: none; color: #888; font-size: 0.75rem; text-align: center; display: flex; flex-direction: column; align-items: center; flex: 1; }
    .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }
    .nav-item.active { color: #e94560; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/virtual_campus.js?v=2"></script>
</head>
<body>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <div class="header">
    <div id="userInfo" class="user-name">LOADING...</div>
    
    <div style="display:flex; gap:10px; align-items:center;">
        <button id="musicBtn" onclick="toggleMusic()" style="background:none; border:1px solid #444; color:#fff; border-radius:15px; padding:4px 10px; cursor:pointer;">
            ğŸ”‡ Music Off
        </button>
        <a href="#" id="logout" class="logout">é€€å‡º</a>
    </div>
  </div>

  <audio id="bgmPlayer" loop>
      <source src="/audio/bgm.mp3" type="audio/mpeg">
  </audio>

  <div id="lobbyView">
      <div class="stage-container">
        <div class="spotlight"></div>
        <div id="ageTag" class="age-tag">Hero</div>
        <div class="upload-btn" onclick="openUploadModal()"><span>ğŸ“· Upload Award</span></div>
        <a href="/avatar_editor.html" class="edit-btn">âœï¸ Customize</a>
        <div class="avatar-wrapper"><img id="heroImg" class="avatar-img" src="" alt="Hero"></div>
        <div id="trophyArea" class="trophy-pile"></div>
      </div>

      <div class="portal-container">
        <div class="portal-card portal-battle" onclick="switchMode('battle')">
          <span class="p-icon">âš”ï¸</span><div class="p-title">Battle Mode</div>
        </div>
        <div class="portal-card portal-train" onclick="location.href='/timetable.html'">
          <span class="p-icon">ğŸ›¡ï¸</span><div class="p-title">Training Mode</div>
        </div>
      </div>
  </div>

 <div id="gameView" class="content-section" style="display:none;">
    <div class="back-bar" onclick="switchMode('home')"><span>â—€ Back</span></div>
    <div style="font-size:1.2rem;font-weight:bold;color:#e94560;margin-bottom:15px;border-left:4px solid #e94560;padding-left:10px">Available Games</div>
    
    <div id="gameGrid" class="game-grid"></div>
  </div>
	
<div id="virtualWorld" style="display:none; width:100%; height:100vh; position:fixed; top:0; left:0; z-index:200; overflow:hidden; background:#111;">
      
      <div style="position:fixed; top:80px; left:20px; z-index:500; display:flex; gap:10px;">
          <button onclick="window.exitVirtualWorld()" style="background:rgba(0,0,0, 0.7); color:white; border:2px solid #e94560; padding:8px 15px; border-radius:30px; font-weight:bold; cursor:pointer;">
              â—€ Exit
          </button>
          
          <button onclick="window.toggleMapMode()" id="btn-map-mode" style="background:rgba(0,0,0, 0.7); color:#4facfe; border:2px solid #4facfe; padding:8px 15px; border-radius:30px; font-weight:bold; cursor:pointer;">
              ğŸ—ºï¸ Map View
          </button>
      </div>
      <div id="net-status" class="connection-status" title="Connection Status"></div>
	
      <div id="world-map" style="position:absolute; top:0; left:0; transform-origin: 0 0; transition: transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);">
          
          <img id="scene-bg" src="/images/studio_map.png" 
     style="width:2500px; height:auto; display:block; pointer-events: none; user-select: none; -webkit-user-drag: none;" 
     onload="window.initCollisionMap(this)">

          <div id="my-player" style="position:absolute; top:1200px; left:1200px; z-index:250; text-align:center; transition: top 0.6s linear, left 0.6s linear;">
              
              <div id="player-radar" class="map-indicator"></div>

              <div style="background:rgba(0,0,0,0.6); color:#fff; padding:2px 6px; border-radius:4px; font-size:10px; white-space:nowrap; position:absolute; top:-20px; left:50%; transform:translateX(-50%);">
                  My Hero
              </div>
              <img id="player-img" src="" style="width:50px; height:auto; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));">
          </div>
          
          <div id="block-marker" style="position:absolute; color:red; font-weight:bold; font-size:24px; display:none; transform:translate(-50%, -50%); z-index:600; text-shadow:2px 2px 0 #fff;">ğŸš«</div>
          
          <div id="click-marker" style="position:absolute; width:20px; height:20px; border:2px solid #e94560; border-radius:50%; display:none; transform:translate(-50%, -50%); pointer-events:none;"></div>
      </div>

      <canvas id="collision-canvas" style="display:none;"></canvas>

      <div id="game-tip" style="position:fixed; bottom:100px; width:100%; text-align:center; z-index:500; pointer-events:none;">
          <span style="background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:15px; color:white;">
              Tap to walk
          </span>
      </div>
	
	<div id="d-pad" class="d-pad-container">
    <div class="d-pad-btn d-up"    onpointerdown="startMove(0, -1)" onpointerup="stopMove()" onpointerleave="stopMove()">â¬†ï¸</div>
    <div class="d-pad-btn d-left"  onpointerdown="startMove(-1, 0)" onpointerup="stopMove()" onpointerleave="stopMove()">â¬…ï¸</div>
    <div class="d-pad-btn d-right" onpointerdown="startMove(1, 0)"  onpointerup="stopMove()" onpointerleave="stopMove()">â¡ï¸</div>
    <div class="d-pad-btn d-down"  onpointerdown="startMove(0, 1)"  onpointerup="stopMove()" onpointerleave="stopMove()">â¬‡ï¸</div>
      </div>
	
  </div>
	
    <div id="phaser-game" style="width:100%; height:100%;"></div>
    
    <div id="interactionTip" style="display:none; position:absolute; bottom:100px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:20px; border:2px solid #e94560; font-weight:bold; font-size:1.2rem; animation: float 2s infinite;">
        Press SPACE to enter
    </div>
  </div>

  <div id="uploadModal" class="modal-overlay">
      <div class="modal-box">
          <span class="close-modal" onclick="closeModal('uploadModal')">&times;</span>
          <h3 style="margin-top:0; text-align:center">Upload Achievement</h3>
          <div class="upload-section"><label class="upload-label">1. Certificate (Main)</label><input type="file" id="mainCertInput" accept="image/*" onchange="previewFiles(this, 'previewMain')"><div id="previewMain" class="file-preview"></div></div>
          <div class="upload-section"><label class="upload-label">2. Photos (Optional)</label><input type="file" id="extraPhotosInput" accept="image/*" multiple onchange="previewFiles(this, 'previewExtra')"><div id="previewExtra" class="file-preview"></div></div>
          <button class="btn-submit" onclick="submitAwardUpload()">Submit</button>
      </div>
  </div>

  <div id="trophyDetailModal" class="modal-overlay">
      <div class="modal-box">
          <span class="close-modal" onclick="closeModal('trophyDetailModal')">&times;</span>
          <div class="detail-img-box"><img id="dImg" src="" class="detail-img"></div>
          <div id="dTitle" class="detail-title"></div>
          <div id="dMeta" class="detail-meta"></div>
          <div id="dDesc" class="detail-desc"></div>
      </div>
  </div>

  <div class="loader-overlay" id="loader"><div style="font-size:3rem">ğŸ“¤</div></div>

  <div class="nav-bar">
    <a href="#" class="nav-item active"><span class="nav-icon">ğŸ®</span>Home</a>
    <a href="/my_schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>Schedule</a>
    <a href="/timetable.html" class="nav-item"><span class="nav-icon">ğŸ›’</span>Book</a>
    <a href="/growth.html" class="nav-item"><span class="nav-icon">ğŸ“Š</span>Growth</a>
    <a href="/rooms.html" class="nav-item"><span class="nav-icon">ğŸ”‘</span>Rooms</a>
  </div>

<script>
    // å¼•å…¥ Socket.io å®¢æˆ·ç«¯åº“ (ç¡®ä¿è¿™ä¸€è¡Œåœ¨ head æˆ– body éƒ½æœ‰)
    // <script src="/socket.io/socket.io.js"><\/script> 
    // <script src="/js/virtual_campus.js"><\/script>

    // ==========================================
    // 1. åˆå§‹åŒ–é€»è¾‘ (è·å–ç”¨æˆ·ä¿¡æ¯)
    // ==========================================
    async function init() {
        try {
            const res = await fetch('/api/me');
            const user = await res.json();
            if (!user.id) return location.href = '/';
            
            const nameEl = document.getElementById('userInfo');
            if(nameEl) nameEl.textContent = user.student_name || "Hero";
            
            loadAvatar(user);
            loadTrophies();
        } catch (e) { console.error(e); }
    }
	
	// ================= ğŸµ éŸ³ä¹æ§åˆ¶é€»è¾‘ =================

    const bgm = document.getElementById('bgmPlayer');
    const musicBtn = document.getElementById('musicBtn');
    let isMusicPlaying = false;

    // 1. å¼€å…³éŸ³ä¹å‡½æ•°
    function toggleMusic() {
        if (bgm.paused) {
            bgm.play().then(() => {
                updateMusicIcon(true);
            }).catch(e => console.log("æ’­æ”¾å¤±è´¥:", e));
        } else {
            bgm.pause();
            updateMusicIcon(false);
        }
    }

    // 2. æ›´æ–°æŒ‰é’®å›¾æ ‡
    function updateMusicIcon(playing) {
        isMusicPlaying = playing;
        if (playing) {
            musicBtn.textContent = "ğŸµ Music On";
            musicBtn.style.color = "#00ff00"; // äº®ç»¿è‰²
            musicBtn.style.borderColor = "#00ff00";
        } else {
            musicBtn.textContent = "ğŸ”‡ Music Off";
            musicBtn.style.color = "#fff";
            musicBtn.style.borderColor = "#444";
        }
    }

    // 3. â˜…â˜…â˜… è‡ªåŠ¨æ’­æ”¾é»‘ç§‘æŠ€ â˜…â˜…â˜…
    // æµè§ˆå™¨ä¸è®¸è‡ªåŠ¨æ’­æ”¾ï¼Œä½†å…è®¸ç”¨æˆ·â€œç¬¬ä¸€æ¬¡ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®â€åæ’­æ”¾
    // æ‰€ä»¥æˆ‘ä»¬ç›‘å¬ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶ï¼Œå¸®ç”¨æˆ·è‡ªåŠ¨æ‰“å¼€éŸ³ä¹
    function autoPlayOnFirstClick() {
        if(isMusicPlaying) return; // å·²ç»åœ¨è¿™ä¸ªè®¾å¤‡æ’­æ”¾äº†å°±ä¸ç®¡
        
        bgm.play().then(() => {
            updateMusicIcon(true);
            // æˆåŠŸæ’­æ”¾åï¼Œç§»é™¤ç›‘å¬ï¼Œä¸å†æ‰“æ‰°
            document.removeEventListener('click', autoPlayOnFirstClick);
            document.removeEventListener('touchstart', autoPlayOnFirstClick);
        }).catch(() => {
            // å¦‚æœå¤±è´¥ï¼ˆæ¯”å¦‚ç”¨æˆ·åªæ˜¯ç‚¹äº†ä¸ªç©ºç™½ï¼‰ï¼Œç»§ç»­ç­‰å¾…ä¸‹ä¸€æ¬¡ç‚¹å‡»
        });
    }

    // ç›‘å¬å…¨å±ç‚¹å‡»
    document.addEventListener('click', autoPlayOnFirstClick);
    document.addEventListener('touchstart', autoPlayOnFirstClick);

    // ==========================================
    // 2. ç•Œé¢åˆ‡æ¢ (å¤§å… vs æˆ˜æ–—æ¨¡å¼)
    // ==========================================
    function switchMode(mode) {
        const lobby = document.getElementById('lobbyView');
        const gameView = document.getElementById('gameView');
        const virtualWorld = document.getElementById('virtualWorld'); // â˜…â˜…â˜… è·å–è™šæ‹Ÿå¤§å…å…ƒç´ 
		const dpad = document.getElementById('d-pad'); // â˜… è·å–æ–¹å‘é”®å…ƒç´ 
        
        if (mode === 'battle') { 
            // è¿›å…¥æˆ˜æ–—/åœ°å›¾æ¨¡å¼
            if (typeof window.initVirtualCampus === 'function') {
                if(lobby) lobby.style.display = 'none'; 
                if(gameView) gameView.style.display = 'none'; 
                
                // â˜…â˜…â˜… å…³é”®ä¿®å¤ï¼šå¿…é¡»æŠŠè¿™ä¸€è¡ŒåŠ å›å»ï¼æ˜¾ç¤ºè™šæ‹Ÿå¤§å… â˜…â˜…â˜…
                if(virtualWorld) virtualWorld.style.display = 'block'; 
				if(dpad) dpad.style.display = 'block'; // â˜… æ˜¾ç¤ºæ–¹å‘é”®

                window.initVirtualCampus();      // å¯åŠ¨é€»è¾‘
            } else {
                console.error("virtual_campus.js æœªåŠ è½½ï¼");
                alert("æ­£åœ¨åŠ è½½èµ„æºï¼Œè¯·ç¨åå†è¯•...");
            }
        } else { 
            // å›åˆ°ä¸»é¡µ
            if(gameView) gameView.style.display = 'none';
            if(virtualWorld) virtualWorld.style.display = 'none'; // â˜…â˜…â˜… è®°å¾—è¿™é‡Œä¹Ÿè¦éšè—
			if(dpad) dpad.style.display = 'none'; // â˜… éšè—æ–¹å‘é”®
            if(lobby) lobby.style.display = 'block';
        }
    }

    // ==========================================
    // 3. è¾…åŠ©åŠŸèƒ½ (å¤´åƒã€å¥–æ¯ã€ä¸Šä¼ )
    // ==========================================
    function loadAvatar(user) {
        const imgEl = document.getElementById('heroImg');
        if(!imgEl) return;

        let age = 7; 
        if (user.dob) age = Math.abs(new Date(Date.now() - new Date(user.dob).getTime()).getUTCFullYear() - 1970);
        
        let ageGroup = 'junior'; 
        if (age >= 12) ageGroup = 'senior'; 
        else if (age >= 8) ageGroup = 'middle';
        
        const gender = (/[aeiy]$/.test(user.student_name || "") || ['cindy','yolanda'].includes((user.student_name||"").toLowerCase())) ? 'girl' : 'boy';
        const outfit = user.avatar_config?.outfit || 'uniform';
        
        const ageTag = document.getElementById('ageTag');
        if(ageTag) ageTag.textContent = `${ageGroup.toUpperCase()} ${gender==='girl'?'Heroine':'Hero'}`;
        
        if (user.avatar_config?.useAiAvatar && user.avatar_config?.aiAvatarUrl) { 
            imgEl.src = user.avatar_config.aiAvatarUrl; 
        } else { 
            imgEl.src = `/avatars/${gender}_${ageGroup}_${outfit}.png`; 
        }
        imgEl.style.opacity = 1;
    }

    function loadGames() {
        const grid = document.getElementById('gameGrid');
        if(!grid) return;
        grid.innerHTML = '<div style="text-align:center;color:#888">Loading...</div>';
        fetch('/api/games').then(r=>r.json()).then(games => {
            grid.innerHTML = '';
            if(games.length === 0) { grid.innerHTML = 'No games found'; return; }
            games.forEach(g => {
                const thumb = g.thumbnail ? `/games/${g.path}/${g.thumbnail}` : null;
                grid.innerHTML += `
                    <div class="game-card">
                        <div class="game-thumb">${thumb ? `<img src="${thumb}">` : 'ğŸ‘¾'}</div>
                        <div class="game-info">
                            <div class="game-title">${g.title}</div>
                            <a href="/play/${g.id}" class="btn-start">START</a>
                        </div>
                    </div>`;
            });
        });
    }
    
    // å¥–æ¯é€»è¾‘
    // è·å–å¹¶å±•ç¤ºå¥–æ¯åˆ—è¡¨
	
	// æ˜¾ç¤ºå¥–æ¯/è¯ä¹¦è¯¦æƒ…å¼¹çª—
    function showTrophyDetail(t) {
        const modal = document.getElementById('trophyDetailModal');
        if(!modal) return;
        
        // 1. è®¾ç½®å¤§å›¾
        const img = document.getElementById('dImg');
        if(img) img.src = t.image_path || '';

        // 2. è®¾ç½®æ ‡é¢˜
        const title = document.getElementById('dTitle');
        if(title) title.textContent = t.source_name || 'Achievement';

        // 3. è®¾ç½®æ—¶é—´/å…ƒæ•°æ®
        const meta = document.getElementById('dMeta');
        if(meta) {
            const dateStr = t.created_at ? new Date(t.created_at).toLocaleDateString() : '';
            const status = t.status === 'PENDING' ? '(Audit Pending)' : '';
            meta.textContent = `${dateStr} ${status}`;
        }

        // 4. è®¾ç½®æè¿° (è€å¸ˆè¯„è¯­ç­‰)
        const desc = document.getElementById('dDesc');
        if(desc) {
            desc.textContent = t.description || 'Keep dancing! (No comments yet)';
        }

        // 5. æ˜¾ç¤ºå¼¹çª—
        modal.style.display = 'flex';
    }
	
    async function loadTrophies() {
        const area = document.getElementById('trophyArea');
        if(!area) return;
        
        try {
            const res = await fetch('/api/my-trophies'); // ç¡®ä¿åç«¯æœ‰è¿™ä¸ª GET æ¥å£
            const data = await res.json();
            
            area.innerHTML = ''; // æ¸…ç©ºç°æœ‰åˆ—è¡¨
            
            if (!data || data.length === 0) return;

            data.forEach(t => {
                const el = document.createElement('div');
                el.className = 'trophy-item';
				
				if (t.status !== 'APPROVED') return;
                
                // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šæ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡ â˜…â˜…â˜…
                let icon = 'ğŸ†'; // é»˜è®¤
                let colorClass = 't-gold'; // é»˜è®¤æ ·å¼ç±»

                // æ•°æ®åº“é‡Œçš„ type å¯èƒ½æ˜¯: gold, silver, bronze, certificate, medal_gold...
                const type = (t.trophy_type || '').toLowerCase();

                if (type.includes('certificate')) {
                    icon = 'ğŸ“œ'; // è¯ä¹¦å·è½´
                    colorClass = ''; // è¯ä¹¦ä¸éœ€è¦é‡‘å…‰ç‰¹æ•ˆ
                } else if (type.includes('silver')) {
                    icon = 'ğŸ¥ˆ';
                    colorClass = ''; 
                } else if (type.includes('bronze')) {
                    icon = 'ğŸ¥‰';
                    colorClass = '';
                } else if (type.includes('medal')) {
                    icon = 'ğŸ¥‡';
                }

                el.textContent = icon;
                
                // å¦‚æœéœ€è¦åŠ ç‰¹æ•ˆç±» (CSSé‡Œå®šä¹‰çš„ t-gold ç­‰)
                if(colorClass) el.classList.add(colorClass);

                // ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…å¤§å›¾
                el.onclick = () => showTrophyDetail(t);
                
                area.appendChild(el);
            });
        } catch(e) { 
            console.error("åŠ è½½å¥–æ¯å¤±è´¥:", e); 
        }
    }
    // ä¸Šä¼ å¼¹çª—é€»è¾‘
    function openUploadModal() { document.getElementById('uploadModal').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    // æ–‡ä»¶é¢„è§ˆ
    function previewFiles(input, conId) {
        const con = document.getElementById(conId);
        con.innerHTML = '';
        if(input.files) {
            Array.from(input.files).forEach(file => {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'preview-thumb';
                con.appendChild(img);
            });
        }
    }

    // æäº¤ä¸Šä¼  (ä¿®å¤ç‰ˆ)
    async function submitAwardUpload() {
        const mainInput = document.getElementById('mainCertInput');
        const extraInput = document.getElementById('extraPhotosInput');
        
        if (!mainInput.files || mainInput.files.length === 0) {
            alert('Please upload the Main Certificate!');
            return;
        }

        const btn = document.querySelector('.btn-submit');
        const originalText = btn.textContent;
        btn.textContent = 'Uploading...';
        btn.disabled = true;
        
        const loader = document.getElementById('loader');
        if(loader) loader.style.display = 'flex';

        const formData = new FormData();
        formData.append('mainCert', mainInput.files[0]); 
        if (extraInput.files) {
            for (let i = 0; i < extraInput.files.length; i++) {
                formData.append('extraPhotos', extraInput.files[i]);
            }
        }

        try {
            const res = await fetch('/api/upload-trophy', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            if (res.ok && data.success) {
                alert('âœ… Upload Successful!');
                closeModal('uploadModal');
                mainInput.value = '';
                extraInput.value = '';
                document.getElementById('previewMain').innerHTML = '';
                document.getElementById('previewExtra').innerHTML = '';
            } else {
                throw new Error(data.error || 'Upload failed');
            }
        } catch (e) {
            alert('âŒ Error: ' + e.message);
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
            if(loader) loader.style.display = 'none';
        }
    }

    document.getElementById('logout').onclick = () => fetch('/api/logout', {method:'POST'}).then(()=>location.href='/');
    
    // å¯åŠ¨ï¼
    init();
</script>
</body>
</html>