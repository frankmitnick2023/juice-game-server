<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>2026 Timetable (é€‰è¯¾)</title>
  <style>
    body{font-family:'Segoe UI', sans-serif;margin:0;background:#f9f9f9;padding-bottom:5rem}
    .header{background:#ff6b35;color:white;padding:1rem;text-align:center;position:sticky;top:0;z-index:90}
    .day-tabs {display:flex;overflow-x:auto;background:white;padding:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05);position:sticky;top:60px;z-index:80}
    .day-tab {flex:0 0 auto;padding:8px 16px;margin-right:10px;border-radius:20px;background:#f0f0f0;color:#666;font-weight:bold;cursor:pointer;font-size:0.9rem}
    .day-tab.active {background:#ff6b35;color:white}
    .container{max-width:800px;margin:1rem auto;padding:0 1rem}
    
    .course-card{background:white;border-radius:12px;padding:1.2rem;margin-bottom:1rem;box-shadow:0 2px 8px rgba(0,0,0,0.05);display:flex;justify-content:space-between;align-items:center; transition:0.2s}
    .course-card.disabled {opacity: 0.6; background: #eee; cursor: not-allowed;}
    
    .c-main h3{margin:0 0 5px 0;color:#333}
    .c-detail{font-size:0.9rem;color:#666;margin:2px 0}
    .tag{font-size:0.8rem;background:#fff0e6;color:#ff6b35;padding:2px 5px;border-radius:4px;margin-right:5px}
    
    .btn-book{background:#ff6b35;color:white;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:bold}
    .btn-book:disabled {background:#ccc; cursor: not-allowed;}

    .modal-overlay {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999;justify-content:center;align-items:end}
    .modal {background:white;width:100%;max-width:600px;border-radius:20px 20px 0 0;padding:20px;box-sizing:border-box;animation:slideUp 0.3s}
    @keyframes slideUp {from{transform:translateY(100%)} to{transform:translateY(0)}}
    
    .option-box {border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:10px;cursor:pointer; display:flex; justify-content:space-between; align-items:center}
    .option-box.selected {border-color:#ff6b35;background:#fff0e6}
    .option-box.disabled {opacity:0.5; cursor:not-allowed; background:#eee; border-color:#ccc}
    
    .date-grid {display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px;display:none; padding:10px; background:#f9f9f9; border-radius:8px;}
    .date-item {background:white; border:1px solid #ddd; padding:8px; text-align:center;border-radius:4px;font-size:0.8rem;cursor:pointer}
    .date-item.active {background:#ff6b35;color:white; border-color:#ff6b35}
    .date-item.booked {background:#e0e0e0;color:#999;cursor:not-allowed;text-decoration:line-through; border-color:#ccc}

    .btn-confirm {width:100%; padding:15px; background:#ff6b35; color:white; border:none; border-radius:8px; font-weight:bold; font-size:1.1rem; margin-top:15px; cursor:pointer}
    
    .nav-bar{position:fixed;bottom:0;left:0;width:100%;background:white;border-top:1px solid #eee;display:flex;justify-content:space-around;padding:8px 0;z-index:99; padding-bottom: max(8px, env(safe-area-inset-bottom));}
    .nav-item{text-decoration:none;color:#888;font-size:0.75rem;text-align:center;display:flex;flex-direction:column;align-items:center;flex:1}
    .nav-icon{font-size:1.4rem;margin-bottom:2px}
    .nav-item.active{color:#ff6b35}
  </style>
</head>
<body>

<div class="header"><h3>2026 TERM 1 Timetable</h3></div>
<div class="day-tabs" id="dayTabs"></div>
<div class="container">
  <div id="ageTip" style="text-align:center;color:#666;margin:10px">Loading...</div>
  <div id="courseList"></div>
</div>

<div id="bookModal" class="modal-overlay">
    <div class="modal">
        <h2 id="mTitle" style="margin-top:0">Course Name</h2>
        <div style="margin-bottom:15px; color:#666" id="mInfo"></div>
        
        <div class="option-box selected" id="optTerm" onclick="selectMode('term')">
            <div>
                <div style="font-weight:bold">Full Term (10 Weeks)</div>
                <div style="font-size:0.85rem;color:#666">Best Value â€¢ Guaranteed Spot</div>
            </div>
            <div style="font-weight:bold;color:#ff6b35" id="priceTerm">$230</div>
        </div>

        <div class="option-box" id="optCasual" onclick="selectMode('casual')">
             <div>
                <div style="font-weight:bold">Casual / Make-up</div>
                <div style="font-size:0.85rem;color:#666">Select specific dates</div>
            </div>
            <div style="font-weight:bold;color:#ff6b35">$25/class</div>
        </div>

        <div class="date-grid" id="dateGrid"></div>

        <div style="display:flex; justify-content:space-between; margin-top:15px; font-weight:bold">
            <span>Total:</span>
            <span id="totalDisplay" style="color:#ff6b35">$230</span>
        </div>

        <button class="btn-confirm" id="btnConfirm" onclick="confirmBooking()">Confirm Booking</button>
        <button onclick="closeModal()" style="width:100%;padding:12px;background:none;border:none;color:#999;margin-top:5px">Cancel</button>
    </div>
</div>

<div class="nav-bar">
    <a href="/games.html" class="nav-item"><span class="nav-icon">ğŸ®</span>Home<br>(å¤§å…)</a>
    <a href="/my_schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>Schedule<br>(è¯¾è¡¨)</a>
    <a href="#" class="nav-item active"><span class="nav-icon">ğŸ›’</span>Book<br>(é€‰è¯¾)</a>
    <a href="/growth.html" class="nav-item"><span class="nav-icon">ğŸ“Š</span>Growth<br>(æˆé•¿)</a> 
    <a href="/rooms.html" class="nav-item"><span class="nav-icon">ğŸ”‘</span>Rooms<br>(æ•™å®¤)</a>
</div>

<script>
  // å‡å®š 2026 Term 1 ä» 2æœˆ2æ—¥å¼€å§‹
  const TERM_START = new Date("2026-02-02"); 
  const WEEKS = 10; 
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  
  let allCourses = [];
  let myBookings = []; 
  let currentDay = 'Monday';
  let currentCourse = null;
  let selectedMode = 'term';
  let selectedDates = []; 
  
  function getCourseDates(dayStr) {
      const dayIndex = days.indexOf(dayStr);
      const result = [];
      for(let i=0; i<WEEKS; i++) {
          const d = new Date(TERM_START);
          d.setDate(d.getDate() + (i*7) + dayIndex);
          result.push(d.toISOString().split('T')[0]);
      }
      return result;
  }

// ==========================================
// è¯·å°†æ­¤å‡½æ•°æ›¿æ¢ timetable.html ä¸­åŸæœ‰çš„ loadCourses
// ==========================================

async function loadCourses() {
    const container = document.getElementById('course-list-container'); // è¯·ç¡®è®¤ä½ çš„å®¹å™¨ ID
    if (!container) return;
    
    container.innerHTML = '<div style="text-align:center; padding:20px;">Loading...</div>';

    try {
        // â˜…â˜…â˜… å…³é”®æ­¥éª¤ï¼šåŒæ—¶è·å–â€œæ‰€æœ‰è¯¾ç¨‹â€å’Œâ€œæˆ‘çš„é¢„å®šâ€ â˜…â˜…â˜…
        const [coursesRes, bookingsRes] = await Promise.all([
            fetch('/api/courses/recommended'), // æˆ–è€… /api/public-schedule
            fetch('/api/my-bookings')          // è·å–æˆ‘å·²ç»ä¹°äº†å•¥
        ]);

        const coursesData = await coursesRes.json();
        // ç¡®ä¿ bookings æ˜¯ä¸ªæ•°ç»„ï¼Œé˜²æ­¢æŠ¥é”™
        const myBookings = bookingsRes.ok ? await bookingsRes.json() : [];

        // æ¸…ç©ºå®¹å™¨
        container.innerHTML = '';
        const list = coursesData.courses || coursesData; // å…¼å®¹ä¸åŒæ¥å£è¿”å›æ ¼å¼

        if (list.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#888;">No courses available.</div>';
            return;
        }

        // å¼€å§‹æ¸²æŸ“æ¯ä¸€ä¸ªè¯¾ç¨‹å¡ç‰‡
        list.forEach(course => {
            
            // â˜…â˜…â˜… æ ¸å¿ƒé€»è¾‘ï¼šå»æˆ‘çš„è®¢å•é‡Œæ‰¾è¿™é—¨è¯¾ â˜…â˜…â˜…
            // è¿‡æ»¤æ‰å·²å–æ¶ˆçš„è®¢å•
            const booking = myBookings.find(b => b.course_id === course.id && b.status !== 'CANCELLED');
            
            let actionBtn = '';
            let statusBadge = '';

            // --- æƒ…å†µ 1: å®Œå…¨æ²¡ä¹°è¿‡ ---
            if (!booking) {
                // é»˜è®¤æ˜¾ç¤ºæ©™è‰² Book æŒ‰é’®
                actionBtn = `<button class="btn-book" onclick="openBookingModal(${course.id}, '${course.name}', '${course.day_of_week}', '${course.start_time}')">Book</button>`;
            } 
            
            // --- æƒ…å†µ 2: ä¹°è¿‡ï¼Œæ˜¯å…¨å­¦æœŸ (Term) ---
            else if (booking.type === 'term') {
                // æ˜¾ç¤ºç»¿è‰² Joined
                statusBadge = `<span style="color:#2ecc71; background:rgba(46,204,113,0.1); padding:2px 6px; border-radius:4px; font-size:12px; margin-left:5px;">âœ… Joined</span>`;
                actionBtn = `<button class="btn-joined" disabled style="background:#ddd; color:#888; cursor:default;">Joined</button>`;
            } 
            
            // --- æƒ…å†µ 3: ä¹°è¿‡ï¼Œæ˜¯æ•£è¯¾ (Casual) --> è¿™å°±æ˜¯ä½ è¦çš„ Partial ---
            else {
                // æ˜¾ç¤ºæ©™é»„è‰² Partial
                // è¿™é‡Œçš„é¢œè‰²ä½¿ç”¨äº† #f1c40f (é»„è‰²) æˆ– #e67e22 (æ©™è‰²) æ¥åŒºåˆ†
                statusBadge = `<span style="color:#e67e22; background:rgba(230,126,34,0.1); padding:2px 6px; border-radius:4px; font-size:12px; margin-left:5px;">âš ï¸ Partial</span>`;
                
                // æŒ‰é’®æ–‡å­—æ”¹æˆ "Add More" æˆ– "Edit"ï¼Œè®©ç”¨æˆ·çŸ¥é“è¿˜å¯ä»¥ç»§ç»­ä¹°
                actionBtn = `<button class="btn-partial" onclick="openBookingModal(${course.id}, '${course.name}', '${course.day_of_week}', '${course.start_time}')" style="background:#e67e22; color:white;">Add More</button>`;
            }

            // --- ç”Ÿæˆ HTML (è¯·æ ¹æ®ä½ åŸæœ¬çš„å¡ç‰‡æ ·å¼è°ƒæ•´ class) ---
            const card = document.createElement('div');
            card.className = 'course-card'; // ä¿æŒä½ åŸæœ‰çš„ CSS ç±»å
            card.innerHTML = `
                <div class="card-left">
                    <h3 class="c-title">${course.name} ${statusBadge}</h3>
                    <div class="c-time">â° ${course.day_of_week} ${course.start_time} - ${course.end_time}</div>
                    <div class="c-loc">ğŸ“ ${course.classroom || 'Studio 1'} &nbsp; ğŸ‘©â€ğŸ« ${course.teacher}</div>
                </div>
                <div class="card-right">
                    ${actionBtn}
                </div>
            `;
            container.appendChild(card);
        });

    } catch (e) {
        console.error(e);
        container.innerHTML = 'Error loading courses.';
    }
}
	
  async function init() {
    const tabContainer = document.getElementById('dayTabs');
    tabContainer.innerHTML = ''; // æ¸…ç©ºé˜²æ­¢é‡å¤
    days.forEach((d) => {
        const div = document.createElement('div');
        div.className = `day-tab ${d === 'Monday' ? 'active' : ''}`;
        div.textContent = d === 'Wednesday' ? 'Wed' : d.substring(0, 3);
        div.onclick = () => switchDay(d, div);
        tabContainer.appendChild(div);
    });

    try {
        const resBooks = await fetch('/api/my-bookings'); 
        myBookings = await resBooks.json();
    } catch(e) { myBookings = []; }

    try {
        const res = await fetch('/api/courses/recommended');
        const data = await res.json();
        document.getElementById('ageTip').textContent = `Age: ${data.age} (Recommended)`;
        allCourses = data.courses;
        renderList();
    } catch(e) {}
  }

  function switchDay(day, el) {
      currentDay = day;
      document.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      renderList();
  }

  function renderList() {
      const list = document.getElementById('courseList');
      list.innerHTML = '';
      const todayCourses = allCourses.filter(c => c.day_of_week === currentDay);
      
      if(todayCourses.length === 0) list.innerHTML = '<p style="text-align:center;color:#999;margin-top:20px">No classes today.</p>';

      todayCourses.forEach(c => {
          const termBooking = myBookings.find(b => b.course_id === c.id && b.type === 'term');
          const div = document.createElement('div');
          div.className = `course-card ${termBooking ? 'disabled' : ''}`;
          
          let btnHtml = '';
          if (termBooking) {
              btnHtml = `<button class="btn-book" disabled>âœ… Joined</button>`;
          } else {
              // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šåªä¼ é€’ IDï¼Œé¿å…å¼•å·åµŒå¥—å¯¼è‡´ç‚¹å‡»å¤±æ•ˆ â˜…â˜…â˜…
              btnHtml = `<button class="btn-book" onclick="openBookingModal(${c.id})">Book</button>`;
          }

          div.innerHTML = `
            <div class="c-main">
                <h3>${c.name}</h3>
                <div class="c-detail">â° ${c.start_time} - ${c.end_time}</div>
                <div class="c-detail">
                    <span class="tag">ğŸ“ ${c.classroom || 'Studio 1'}</span>
                    <span class="tag">ğŸ‘©â€ğŸ« ${c.teacher}</span>
                    <span class="tag">$${c.price} / Term</span>
                </div>
            </div>
            ${btnHtml}
          `;
          list.appendChild(div);
      });
  }

  // â˜…â˜…â˜… æ–°å¢çš„æ‰“å¼€å‡½æ•°ï¼šæ ¹æ® ID æ‰¾è¯¾ç¨‹ â˜…â˜…â˜…
  window.openBookingModal = function(courseId) {
      // åœ¨æ•°ç»„é‡Œæ‰¾åˆ°è¿™ä¸ªè¯¾ç¨‹å¯¹è±¡
      const course = allCourses.find(c => c.id === courseId);
      if (!course) return alert("Error: Course not found");

      currentCourse = course;
      const allDates = getCourseDates(course.day_of_week);
      
      const existingDates = new Set();
      const existing = myBookings.filter(b => b.course_id === course.id);
      existing.forEach(b => {
          if(b.type === 'term') allDates.forEach(d => existingDates.add(d));
          else if(b.dates) b.dates.forEach(d => existingDates.add(d));
      });

      document.getElementById('mTitle').textContent = course.name;
      document.getElementById('mInfo').textContent = `${course.day_of_week} ${course.start_time} @ ${course.classroom}`;
      document.getElementById('priceTerm').textContent = `$${course.price}`;

      const grid = document.getElementById('dateGrid');
      grid.innerHTML = '';
      allDates.forEach(dateStr => {
          const dObj = new Date(dateStr);
          const display = `${dObj.getDate()}/${dObj.getMonth()+1}`;
          const isBooked = existingDates.has(dateStr);
          
          const item = document.createElement('div');
          item.className = `date-item ${isBooked ? 'booked' : ''}`;
          item.textContent = display;
          if(!isBooked) {
              item.onclick = () => toggleDate(item, dateStr);
          }
          grid.appendChild(item);
      });

      selectMode('term'); 
      document.getElementById('bookModal').style.display = 'flex';
  }

  window.selectMode = function(mode) {
      selectedMode = mode;
      document.getElementById('optTerm').className = `option-box ${mode==='term'?'selected':''}`;
      document.getElementById('optCasual').className = `option-box ${mode==='casual'?'selected':''}`;
      
      const grid = document.getElementById('dateGrid');
      if(mode === 'term') {
          grid.style.display = 'none';
          updateTotal();
      } else {
          grid.style.display = 'grid';
          selectedDates = []; 
          document.querySelectorAll('.date-item').forEach(el => {
              if(!el.classList.contains('booked')) el.classList.remove('active');
          });
          updateTotal();
      }
  }

  window.toggleDate = function(el, dateStr) {
      if(selectedMode !== 'casual') return;
      if(selectedDates.includes(dateStr)) {
          selectedDates = selectedDates.filter(d => d !== dateStr);
          el.classList.remove('active');
      } else {
          selectedDates.push(dateStr);
          el.classList.add('active');
      }
      updateTotal();
  }

  function updateTotal() {
      const display = document.getElementById('totalDisplay');
      const btn = document.getElementById('btnConfirm');
      
      if(selectedMode === 'term') {
          display.textContent = `$${currentCourse.price}`;
          btn.textContent = `Confirm ($${currentCourse.price})`;
          btn.disabled = false;
      } else {
          const cost = selectedDates.length * 25; 
          display.textContent = `$${cost}`;
          if(selectedDates.length === 0) {
              btn.textContent = 'Select Dates';
              btn.disabled = true;
          } else {
              btn.textContent = `Confirm ($${cost})`;
              btn.disabled = false;
          }
      }
  }

  window.closeModal = function() {
      document.getElementById('bookModal').style.display = 'none';
  }

  window.confirmBooking = async function() {
      const btn = document.getElementById('btnConfirm');
      btn.textContent = 'Processing...';
      btn.disabled = true;

      const payload = {
          courseId: currentCourse.id,
          type: selectedMode,
          totalPrice: selectedMode === 'term' ? currentCourse.price : (selectedDates.length * 25),
          selectedDates: selectedMode === 'term' ? [] : selectedDates
      };

      try {
          const res = await fetch('/api/book-course', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(payload)
          });
          const data = await res.json();
          if(data.success) {
              alert('âœ… Booking Successful!');
              closeModal();
              init(); 
          } else {
              alert('Failed: ' + (data.message || 'Error'));
          }
      } catch(e) {
          alert('Network Error');
      }
      btn.disabled = false;
  }
  
  init();
</script>
</body>
</html>