<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>2026 Timetable (é€‰è¯¾)</title>
  <style>
    body{font-family:'Segoe UI', sans-serif;margin:0;background:#f9f9f9;padding-bottom:5rem}
    .header{background:#ff6b35;color:white;padding:1rem;text-align:center;position:sticky;top:0;z-index:90}
    /* Day Tabs æ ·å¼ä¿ç•™ä½†æš‚æ—¶ä¸ç”¨ï¼Œå› ä¸ºæ–°ç‰ˆæ˜¯åˆ—è¡¨å±•ç¤º */
    .day-tabs {display:none; overflow-x:auto;background:white;padding:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05);position:sticky;top:60px;z-index:80}
    .container{max-width:800px;margin:1rem auto;padding:0 1rem}
    
    .course-card{background:white;border-radius:12px;padding:1.2rem;margin-bottom:1rem;box-shadow:0 2px 8px rgba(0,0,0,0.05);display:flex;justify-content:space-between;align-items:center; transition:0.2s}
    
    .c-main h3{margin:0 0 5px 0;color:#333}
    .c-detail{font-size:0.9rem;color:#666;margin:2px 0}
    
    .btn-book{background:#ff6b35;color:white;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:bold}
    .btn-joined{background:#ddd;color:#888;cursor:default;border:none;padding:8px 16px;border-radius:20px;font-weight:bold}
    .btn-partial{background:#e67e22;color:white;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:bold}
    .btn-rebook{background:#3498db;color:white;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:bold}

    .modal-overlay {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999;justify-content:center;align-items:end}
    .modal {background:white;width:100%;max-width:600px;border-radius:20px 20px 0 0;padding:20px;box-sizing:border-box;animation:slideUp 0.3s}
    @keyframes slideUp {from{transform:translateY(100%)} to{transform:translateY(0)}}
    
    .option-box {border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:10px;cursor:pointer; display:flex; justify-content:space-between; align-items:center}
    .option-box.selected {border-color:#ff6b35;background:#fff0e6}
    
    .date-grid {display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px;display:none; padding:10px; background:#f9f9f9; border-radius:8px;}
    .date-item {background:white; border:1px solid #ddd; padding:8px; text-align:center;border-radius:4px;font-size:0.8rem;cursor:pointer}
    .date-item.active {background:#ff6b35;color:white; border-color:#ff6b35}
    .date-item.booked {background:#e0e0e0;color:#999;cursor:not-allowed;text-decoration:line-through; border-color:#ccc}

    .btn-confirm {width:100%; padding:15px; background:#ff6b35; color:white; border:none; border-radius:8px; font-weight:bold; font-size:1.1rem; margin-top:15px; cursor:pointer}
    
    .nav-bar{position:fixed;bottom:0;left:0;width:100%;background:white;border-top:1px solid #eee;display:flex;justify-content:space-around;padding:8px 0;z-index:99; padding-bottom: max(8px, env(safe-area-inset-bottom));}
    .nav-item{text-decoration:none;color:#888;font-size:0.75rem;text-align:center;display:flex;flex-direction:column;align-items:center;flex:1}
    .nav-icon{font-size:1.4rem;margin-bottom:2px}
    .nav-item.active{color:#ff6b35}
  </style>
</head>
<body>

<div class="header"><h3>2026 TERM 1 Timetable</h3></div>

<div class="container">
  <div id="course-list-container"></div>
</div>

<div id="bookModal" class="modal-overlay">
    <div class="modal">
        <h2 id="mTitle" style="margin-top:0">Course Name</h2>
        <div style="margin-bottom:15px; color:#666" id="mInfo"></div>
        
        <div class="option-box selected" id="optTerm" onclick="selectMode('term')">
            <div>
                <div style="font-weight:bold">Full Term (10 Weeks)</div>
                <div style="font-size:0.85rem;color:#666">Best Value â€¢ Guaranteed Spot</div>
            </div>
            <div style="font-weight:bold;color:#ff6b35" id="priceTerm">$230</div>
        </div>

        <div class="option-box" id="optCasual" onclick="selectMode('casual')">
             <div>
                <div style="font-weight:bold">Casual / Make-up</div>
                <div style="font-size:0.85rem;color:#666">Select specific dates</div>
            </div>
            <div style="font-weight:bold;color:#ff6b35">$25/class</div>
        </div>

        <div class="date-grid" id="dateGrid"></div>

        <div style="display:flex; justify-content:space-between; margin-top:15px; font-weight:bold">
            <span>Total:</span>
            <span id="totalDisplay" style="color:#ff6b35">$230</span>
        </div>

        <button class="btn-confirm" id="btnConfirm" onclick="confirmBooking()">Confirm Booking</button>
        <button onclick="closeModal()" style="width:100%;padding:12px;background:none;border:none;color:#999;margin-top:5px">Cancel</button>
    </div>
</div>

<div class="nav-bar">
    <a href="/games.html" class="nav-item"><span class="nav-icon">ğŸ®</span>Home</a>
    <a href="/my_schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>Schedule</a>
    <a href="#" class="nav-item active"><span class="nav-icon">ğŸ›’</span>Book</a>
    <a href="/growth.html" class="nav-item"><span class="nav-icon">ğŸ“Š</span>Growth</a> 
    <a href="/rooms.html" class="nav-item"><span class="nav-icon">ğŸ”‘</span>Rooms</a>
</div>

<script>
  // åŸºç¡€é…ç½®
  const TERM_START = new Date("2026-02-02"); 
  const WEEKS = 10; 
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  
  // â˜… å…¨å±€å˜é‡ï¼šå¿…é¡»å®šä¹‰ï¼Œå¦åˆ™å¼¹çª—æŠ¥é”™
  let allCourses = [];
  let myBookings = []; 
  let currentCourse = null;
  let selectedMode = 'term';
  let selectedDates = []; 
  
  function getCourseDates(dayStr) {
      const dayIndex = days.indexOf(dayStr);
      const result = [];
      for(let i=0; i<WEEKS; i++) {
          const d = new Date(TERM_START);
          d.setDate(d.getDate() + (i*7) + dayIndex);
          result.push(d.toISOString().split('T')[0]);
      }
      return result;
  }

  // â˜…â˜…â˜… æ ¸å¿ƒæ¸²æŸ“å‡½æ•°ï¼šloadCourses â˜…â˜…â˜…
  async function loadCourses() {
    let container = document.getElementById('course-list-container');
    if (!container) return;

    container.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">Loading courses...</div>';

    try {
        const [coursesRes, bookingsRes] = await Promise.all([
            fetch('/api/courses/recommended'), 
            fetch('/api/my-bookings')          
        ]);

        const coursesData = await coursesRes.json();
        const bookingsData = bookingsRes.ok ? await bookingsRes.json() : [];
        
        // â˜… å…³é”®ï¼šæ›´æ–°å…¨å±€å˜é‡ï¼Œå¦åˆ™å¼¹çª—æ‰“ä¸å¼€
        allCourses = coursesData.courses || coursesData;
        myBookings = bookingsData;

        container.innerHTML = ''; 

        if (allCourses.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#888;">No courses available.</div>';
            return;
        }

        allCourses.forEach(course => {
            const courseBookings = myBookings.filter(b => b.course_id == course.id);

            // åŒºåˆ†æœ‰æ•ˆè®¢å•å’Œå–æ¶ˆè®¢å•
            const activeBooking = courseBookings.find(b => b.status && b.status !== 'CANCELLED');
            const cancelledBooking = courseBookings.find(b => b.status === 'CANCELLED');
            
            let actionBtn = '';
            let statusBadge = '';

            // --- A: æœ‰æ•ˆ (Joined / Partial) ---
            if (activeBooking) {
                if (activeBooking.type === 'term') {
                    statusBadge = `<span style="color:#2ecc71; background:rgba(46,204,113,0.1); padding:2px 6px; border-radius:4px; font-size:12px; margin-left:5px;">âœ… Joined</span>`;
                    actionBtn = `<button class="btn-joined">Joined</button>`;
                } else {
                    statusBadge = `<span style="color:#e67e22; background:rgba(230,126,34,0.1); padding:2px 6px; border-radius:4px; font-size:12px; margin-left:5px;">âš ï¸ Partial</span>`;
                    actionBtn = `<button class="btn-partial" onclick="openBookingModal(${course.id})">Add More</button>`;
                }
            } 
            // --- B: å·²å–æ¶ˆ (Cancelled) ---
            else if (cancelledBooking) {
                statusBadge = `<span style="color:#e74c3c; background:rgba(231,76,60,0.1); padding:2px 6px; border-radius:4px; font-size:12px; margin-left:5px; text-decoration:line-through;">ğŸš« Cancelled</span>`;
                actionBtn = `<button class="btn-rebook" onclick="openBookingModal(${course.id})">ğŸ”„ Rebook</button>`;
            }
            // --- C: æœªè´­ä¹° (Book) ---
            else {
                actionBtn = `<button class="btn-book" onclick="openBookingModal(${course.id})">Book</button>`;
            }

            const card = document.createElement('div');
            card.className = 'course-card'; 
            card.innerHTML = `
                <div style="flex:1;">
                    <h3 style="margin:0 0 5px 0; font-size:1rem; color:#333;">${course.name} ${statusBadge}</h3>
                    <div style="font-size:0.85rem; color:#666;">â° ${course.day_of_week} ${course.start_time} - ${course.end_time}</div>
                    <div style="font-size:0.85rem; color:#999; margin-top:3px;">ğŸ“ ${course.classroom || 'Studio 1'} &nbsp; ğŸ‘©â€ğŸ« ${course.teacher}</div>
                </div>
                <div>${actionBtn}</div>
            `;
            container.appendChild(card);
        });

    } catch (e) {
        console.error(e);
        container.innerHTML = 'Error loading courses.';
    }
  }

  // --- å¼¹çª—ç›¸å…³é€»è¾‘ ---

  window.openBookingModal = function(courseId) {
      // å¿…é¡»ç¡®ä¿ allCourses å·²ç»è¢« loadCourses å¡«å……
      const course = allCourses.find(c => c.id == courseId);
      if (!course) return alert("Error: Course data not loaded.");

      currentCourse = course;
      const allDates = getCourseDates(course.day_of_week);
      
      const existingDates = new Set();
      // è¿‡æ»¤æ‰å·²å–æ¶ˆçš„è®¢å•æ—¥æœŸ
      const existing = myBookings.filter(b => b.course_id == course.id && b.status !== 'CANCELLED');
      existing.forEach(b => {
          if(b.type === 'term') allDates.forEach(d => existingDates.add(d));
          else if(b.dates) b.dates.forEach(d => existingDates.add(d));
      });

      document.getElementById('mTitle').textContent = course.name;
      document.getElementById('mInfo').textContent = `${course.day_of_week} ${course.start_time} @ ${course.classroom}`;
      document.getElementById('priceTerm').textContent = `$${course.price}`;

      const grid = document.getElementById('dateGrid');
      grid.innerHTML = '';
      allDates.forEach(dateStr => {
          const dObj = new Date(dateStr);
          const display = `${dObj.getDate()}/${dObj.getMonth()+1}`;
          const isBooked = existingDates.has(dateStr);
          
          const item = document.createElement('div');
          item.className = `date-item ${isBooked ? 'booked' : ''}`;
          item.textContent = display;
          if(!isBooked) {
              item.onclick = () => toggleDate(item, dateStr);
          }
          grid.appendChild(item);
      });

      selectMode('term'); 
      document.getElementById('bookModal').style.display = 'flex';
  }

  window.selectMode = function(mode) {
      selectedMode = mode;
      document.getElementById('optTerm').className = `option-box ${mode==='term'?'selected':''}`;
      document.getElementById('optCasual').className = `option-box ${mode==='casual'?'selected':''}`;
      
      const grid = document.getElementById('dateGrid');
      if(mode === 'term') {
          grid.style.display = 'none';
          updateTotal();
      } else {
          grid.style.display = 'grid';
          selectedDates = []; 
          document.querySelectorAll('.date-item').forEach(el => {
              if(!el.classList.contains('booked')) el.classList.remove('active');
          });
          updateTotal();
      }
  }

  window.toggleDate = function(el, dateStr) {
      if(selectedMode !== 'casual') return;
      if(selectedDates.includes(dateStr)) {
          selectedDates = selectedDates.filter(d => d !== dateStr);
          el.classList.remove('active');
      } else {
          selectedDates.push(dateStr);
          el.classList.add('active');
      }
      updateTotal();
  }

  function updateTotal() {
      const display = document.getElementById('totalDisplay');
      const btn = document.getElementById('btnConfirm');
      
      if(selectedMode === 'term') {
          display.textContent = `$${currentCourse.price}`;
          btn.textContent = `Confirm ($${currentCourse.price})`;
          btn.disabled = false;
      } else {
          const cost = selectedDates.length * 25; 
          display.textContent = `$${cost}`;
          if(selectedDates.length === 0) {
              btn.textContent = 'Select Dates';
              btn.disabled = true;
          } else {
              btn.textContent = `Confirm ($${cost})`;
              btn.disabled = false;
          }
      }
  }

  window.closeModal = function() {
      document.getElementById('bookModal').style.display = 'none';
  }

  window.confirmBooking = async function() {
      const btn = document.getElementById('btnConfirm');
      btn.textContent = 'Processing...';
      btn.disabled = true;

      const payload = {
          courseId: currentCourse.id,
          type: selectedMode,
          totalPrice: selectedMode === 'term' ? currentCourse.price : (selectedDates.length * 25),
          selectedDates: selectedMode === 'term' ? [] : selectedDates
      };

      try {
          const res = await fetch('/api/book-course', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(payload)
          });
          const data = await res.json();
          if(data.success) {
              alert('âœ… Booking Successful!');
              closeModal();
              loadCourses(); // åˆ·æ–°åˆ—è¡¨
          } else {
              alert('Failed: ' + (data.message || 'Error'));
          }
      } catch(e) {
          alert('Network Error');
      }
      btn.disabled = false;
  }
  
  // â˜… å”¯ä¸€å…¥å£ï¼šåªè°ƒç”¨ loadCourses
  loadCourses();
</script>
</body>
</html>