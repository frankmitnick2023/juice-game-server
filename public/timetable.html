<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>2026 Timetable (é€‰è¯¾)</title>
  <style>
    /* ... CSS ä¿æŒä¸å˜ ... */
    body{font-family:Arial;margin:0;background:#f9f9f9;padding-bottom:5rem}
    .header{background:#ff6b35;color:white;padding:1rem;text-align:center}
    .day-tabs {display:flex;overflow-x:auto;background:white;padding:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05);position:sticky;top:0;z-index:100}
    .day-tab {flex:0 0 auto;padding:8px 16px;margin-right:10px;border-radius:20px;background:#f0f0f0;color:#666;font-weight:bold;cursor:pointer;font-size:0.9rem}
    .day-tab.active {background:#ff6b35;color:white}
    .container{max-width:800px;margin:1rem auto;padding:0 1rem}
    .course-card{background:white;border-radius:12px;padding:1.2rem;margin-bottom:1rem;box-shadow:0 2px 8px rgba(0,0,0,0.05);display:flex;justify-content:space-between;align-items:center}
    .c-main h3{margin:0 0 5px 0;color:#333}
    .c-detail{font-size:0.9rem;color:#666;margin:2px 0}
    .tag{font-size:0.8rem;background:#fff0e6;color:#ff6b35;padding:2px 5px;border-radius:4px;margin-right:5px}
    .btn-book{background:#ff6b35;color:white;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:bold}
    .modal-overlay {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999;justify-content:center;align-items:end}
    .modal {background:white;width:100%;max-width:600px;border-radius:20px 20px 0 0;padding:20px;box-sizing:border-box;animation:slideUp 0.3s}
    @keyframes slideUp {from{transform:translateY(100%)} to{transform:translateY(0)}}
    .option-box {border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:10px;cursor:pointer}
    .option-box.selected {border-color:#ff6b35;background:#fff0e6}
    .makeup-box {border-color:#2196f3;background:#e3f2fd}
    .date-grid {display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px;display:none}
    .date-item {background:#f0f0f0;padding:8px;text-align:center;border-radius:4px;font-size:0.8rem;cursor:pointer}
    .date-item.active {background:#ff6b35;color:white}
    .nav-bar{position:fixed;bottom:0;left:0;width:100%;background:white;border-top:1px solid #eee;display:flex;justify-content:space-around;padding:8px 0;z-index:99; padding-bottom: max(8px, env(safe-area-inset-bottom));}
    .nav-item{text-decoration:none;color:#888;font-size:0.75rem;text-align:center;display:flex;flex-direction:column;align-items:center;flex:1}
    .nav-icon{font-size:1.4rem;margin-bottom:2px}
    .nav-item.active{color:#ff6b35}
  </style>
</head>
<body>

<div class="header"><h3>2026 TERM 1 Timetable (è¯¾è¡¨)</h3></div>
<div class="day-tabs" id="dayTabs"></div>
<div class="container">
  <div id="ageTip" style="text-align:center;color:#666;margin:10px">Loading...</div>
  <div id="courseList"></div>
</div>

<div id="bookModal" class="modal-overlay">
  <div class="modal">
    <h3 id="mTitle">Course Name</h3>
    <div id="userCredits" style="font-size:0.8rem;color:#2196f3;margin-bottom:10px"></div>
    
    <div class="option-box selected" onclick="selectMode('term')" id="optTerm">
      <div style="font-weight:bold">ğŸ“… Full Term (æ•´å­¦æœŸ)</div>
      <div style="color:#ff6b35;margin-top:5px" id="mTermPrice">$230</div>
    </div>

    <div class="option-box" onclick="selectMode('casual')" id="optCasual">
      <div style="font-weight:bold">ğŸ—“ Casual Dates (è‡ªé€‰æ—¥æœŸ)</div>
      <div style="color:#ff6b35;margin-top:5px" id="mCasualPrice">$25 / lesson</div>
      <div class="date-grid" id="dateGrid"></div>
    </div>

    <div class="option-box makeup-box" onclick="selectMode('makeup')" id="optMakeup" style="display:none">
      <div style="font-weight:bold">ğŸ”µ Use Makeup Credit (ä½¿ç”¨è¡¥è¯¾å¡)</div>
      <div style="color:#2196f3;margin-top:5px">Free (å…è´¹)</div>
      <div class="date-grid" id="makeupDateGrid"></div>
    </div>

    <div style="margin-top:20px;display:flex;gap:10px">
      <button onclick="closeModal()" style="flex:1;padding:12px;border:1px solid #ddd;background:white;border-radius:8px">Cancel</button>
      <button onclick="confirmBooking()" style="flex:2;padding:12px;background:#ff6b35;color:white;border:none;border-radius:8px;font-weight:bold">Confirm (ç¡®è®¤)</button>
    </div>
  </div>
</div>

<div class="nav-bar">
    <a href="/games.html" class="nav-item"><span class="nav-icon">ğŸ®</span>Home<br>(å¤§å…)</a>
    <a href="/my_schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>Schedule<br>(è¯¾è¡¨)</a>
    <a href="#" class="nav-item active"><span class="nav-icon">ğŸ›’</span>Book<br>(é€‰è¯¾)</a>
    <a href="/growth.html" class="nav-item"><span class="nav-icon">ğŸ“Š</span>Growth<br>(æˆé•¿)</a>
  </div>

<script>
  const TERM_START = new Date("2026-02-02"); 
  const WEEKS = 10; 
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  
  let allCourses = [];
  let currentDay = 'Monday';
  let currentCourse = null;
  let selectedMode = 'term';
  let selectedDates = [];
  let userMakeupCredits = 0;

  async function init() {
    const tabContainer = document.getElementById('dayTabs');
    days.forEach((d) => {
        const div = document.createElement('div');
        div.className = `day-tab ${d === 'Monday' ? 'active' : ''}`;
        div.textContent = d === 'Wednesday' ? 'Wed' : d.substring(0, 3);
        div.onclick = () => switchDay(d, div);
        tabContainer.appendChild(div);
    });

    fetch('/api/me').then(r=>r.json()).then(u => { if(u) userMakeupCredits = u.makeup_credits || 0; });

    try {
        const res = await fetch('/api/courses/recommended');
        const data = await res.json();
        document.getElementById('ageTip').textContent = `Age: ${data.age} (Recommended for you / æ™ºèƒ½æ¨è)`;
        allCourses = data.courses;
        renderList();
    } catch(e) {}
  }

  function switchDay(day, el) {
      currentDay = day;
      document.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      renderList();
  }

  function renderList() {
      const list = document.getElementById('courseList');
      list.innerHTML = '';
      const todayCourses = allCourses.filter(c => c.day_of_week === currentDay);
      
      if(todayCourses.length === 0) list.innerHTML = '<p style="text-align:center;color:#999">No courses available for your age today.<br>(ä»Šæ—¥æ— é€‚åˆè¯¾ç¨‹)</p>';

      todayCourses.forEach(c => {
          const div = document.createElement('div');
          div.className = 'course-card';
          div.innerHTML = `
            <div class="c-main">
                <h3>${c.name}</h3>
                <div class="c-detail">â° ${c.start_time} - ${c.end_time}</div>
                <div class="c-detail"><span class="tag">ğŸ‘©â€ğŸ« ${c.teacher}</span><span class="tag">$${c.price}</span></div>
            </div>
            <button class="btn-book" onclick='openModal(${JSON.stringify(c)})'>Book (æŠ¥å)</button>
          `;
          list.appendChild(div);
      });
  }

  function openModal(course) {
      currentCourse = course;
      selectedMode = 'term';
      selectedDates = [];
      
      document.getElementById('mTitle').textContent = course.name;
      document.getElementById('mTermPrice').textContent = `$${course.price}`;
      document.getElementById('mCasualPrice').textContent = `$${course.casual_price || 25} / lesson`;
      
      if(userMakeupCredits > 0) {
          document.getElementById('optMakeup').style.display = 'block';
          document.getElementById('userCredits').textContent = `Credit Available: ${userMakeupCredits} (å¯ç”¨é¢åº¦)`;
      } else {
          document.getElementById('optMakeup').style.display = 'none';
          document.getElementById('userCredits').textContent = '';
      }

      const gridCasual = document.getElementById('dateGrid');
      const gridMakeup = document.getElementById('makeupDateGrid');
      gridCasual.innerHTML = '';
      gridMakeup.innerHTML = '';
      
      const dayIndex = days.indexOf(course.day_of_week);
      let currentDate = new Date(TERM_START);
      currentDate.setDate(currentDate.getDate() + dayIndex); 

      for(let i=0; i<WEEKS; i++) {
          const dateStr = currentDate.toLocaleDateString('en-NZ'); 
          const isoDate = currentDate.toISOString().split('T')[0];
          
          const d1 = document.createElement('div');
          d1.className = 'date-item';
          d1.textContent = dateStr.substring(0, 5);
          d1.onclick = (e) => toggleDate(d1, isoDate, e, 'casual');
          gridCasual.appendChild(d1);

          const d2 = d1.cloneNode(true);
          d2.onclick = (e) => toggleDate(d2, isoDate, e, 'makeup'); 
          gridMakeup.appendChild(d2);
          
          currentDate.setDate(currentDate.getDate() + 7);
      }

      selectMode('term');
      document.getElementById('bookModal').style.display = 'flex';
  }

  function selectMode(mode) {
      selectedMode = mode;
      selectedDates = []; 
      document.querySelectorAll('.date-item').forEach(d => d.classList.remove('active'));
      
      document.getElementById('optTerm').className = mode==='term'?'option-box selected':'option-box';
      document.getElementById('optCasual').className = mode==='casual'?'option-box selected':'option-box';
      document.getElementById('optMakeup').className = mode==='makeup'?'option-box makeup-box selected':'option-box makeup-box';
      
      document.getElementById('dateGrid').style.display = mode==='casual'?'grid':'none';
      document.getElementById('makeupDateGrid').style.display = mode==='makeup'?'grid':'none';
  }

  function toggleDate(div, date, e, mode) {
      e.stopPropagation();
      if (mode === 'makeup') {
          selectedDates = [date];
          div.parentNode.querySelectorAll('.date-item').forEach(d => d.classList.remove('active'));
          div.classList.add('active');
      } else {
          if(selectedDates.includes(date)) {
              selectedDates = selectedDates.filter(d => d !== date);
              div.classList.remove('active');
          } else {
              selectedDates.push(date);
              div.classList.add('active');
          }
      }
  }

  function closeModal() { document.getElementById('bookModal').style.display = 'none'; }

  async function confirmBooking() {
      if (selectedMode === 'casual' && selectedDates.length === 0) return alert('Please select dates (è¯·é€‰æ‹©æ—¥æœŸ)');
      if (selectedMode === 'makeup' && selectedDates.length === 0) return alert('Please select date (è¯·é€‰æ‹©æ—¥æœŸ)');
      
      let price = currentCourse.price;
      if (selectedMode === 'casual') {
          price = (currentCourse.casual_price || 25) * selectedDates.length;
      } else if (selectedMode === 'makeup') {
          price = 0;
      }

      if(!confirm(`Confirm booking? Total: $${price}`)) return;

      try {
          const res = await fetch('/api/book-course', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                  courseId: currentCourse.id,
                  type: selectedMode,
                  selectedDates: selectedDates,
                  totalPrice: price
              })
          });
          const result = await res.json();
          if(result.success) {
              alert(result.message);
              closeModal();
              location.href = '/my_schedule.html';
          } else {
              alert(result.message);
          }
      } catch(e) { alert('Failed'); }
  }
  init();
</script>
</body>
</html>