<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>2026 Timetable (é€‰è¯¾)</title>
  <style>
    /* ... æ ·å¼ä¿æŒä¸å˜ ... */
    body{font-family:'Segoe UI', sans-serif;margin:0;background:#f9f9f9;padding-bottom:5rem}
    .header{background:#ff6b35;color:white;padding:1rem;text-align:center;position:sticky;top:0;z-index:90}
    .day-tabs {display:flex;overflow-x:auto;background:white;padding:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05);position:sticky;top:60px;z-index:80}
    .day-tab {flex:0 0 auto;padding:8px 16px;margin-right:10px;border-radius:20px;background:#f0f0f0;color:#666;font-weight:bold;cursor:pointer;font-size:0.9rem}
    .day-tab.active {background:#ff6b35;color:white}
    .container{max-width:800px;margin:1rem auto;padding:0 1rem}
    
    .course-card{background:white;border-radius:12px;padding:1.2rem;margin-bottom:1rem;box-shadow:0 2px 8px rgba(0,0,0,0.05);display:flex;justify-content:space-between;align-items:center; transition:0.2s}
    .course-card.disabled {opacity: 0.6; background: #eee; cursor: not-allowed;}
    
    .c-main h3{margin:0 0 5px 0;color:#333}
    .c-detail{font-size:0.9rem;color:#666;margin:2px 0}
    .tag{font-size:0.8rem;background:#fff0e6;color:#ff6b35;padding:2px 5px;border-radius:4px;margin-right:5px}
    
    .btn-book{background:#ff6b35;color:white;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:bold}
    .btn-book:disabled {background:#ccc; cursor: not-allowed;}

    .modal-overlay {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999;justify-content:center;align-items:end}
    .modal {background:white;width:100%;max-width:600px;border-radius:20px 20px 0 0;padding:20px;box-sizing:border-box;animation:slideUp 0.3s}
    @keyframes slideUp {from{transform:translateY(100%)} to{transform:translateY(0)}}
    
    .option-box {border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:10px;cursor:pointer}
    .option-box.selected {border-color:#ff6b35;background:#fff0e6}
    .option-box.disabled {opacity:0.5; cursor:not-allowed; background:#eee; border-color:#ccc}
    
    .date-grid {display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px;display:none}
    .date-item {background:#f0f0f0;padding:8px;text-align:center;border-radius:4px;font-size:0.8rem;cursor:pointer}
    .date-item.active {background:#ff6b35;color:white}
    .date-item.booked {background:#ccc;color:#666;cursor:not-allowed;text-decoration:line-through}

    .nav-bar{position:fixed;bottom:0;left:0;width:100%;background:white;border-top:1px solid #eee;display:flex;justify-content:space-around;padding:8px 0;z-index:99; padding-bottom: max(8px, env(safe-area-inset-bottom));}
    .nav-item{text-decoration:none;color:#888;font-size:0.75rem;text-align:center;display:flex;flex-direction:column;align-items:center;flex:1}
    .nav-icon{font-size:1.4rem;margin-bottom:2px}
    .nav-item.active{color:#ff6b35}
  </style>
</head>
<body>

<div class="header"><h3>2026 TERM 1 Timetable</h3></div>
<div class="day-tabs" id="dayTabs"></div>
<div class="container">
  <div id="ageTip" style="text-align:center;color:#666;margin:10px">Loading...</div>
  <div id="courseList"></div>
</div>

<div id="bookModal" class="modal-overlay">
  </div>

<div class="nav-bar">
    <a href="/games.html" class="nav-item"><span class="nav-icon">ğŸ®</span>Home<br>(å¤§å…)</a>
    <a href="/my_schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>Schedule<br>(è¯¾è¡¨)</a>
    <a href="#" class="nav-item active"><span class="nav-icon">ğŸ›’</span>Book<br>(é€‰è¯¾)</a>
    <a href="/growth.html" class="nav-item"><span class="nav-icon">ğŸ“Š</span>Growth<br>(æˆé•¿)</a> 
    <a href="/rooms.html" class="nav-item"><span class="nav-icon">ğŸ”‘</span>Rooms<br>(æ•™å®¤)</a>
</div>

<script>
  const TERM_START = new Date("2026-02-02"); 
  const WEEKS = 10; 
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  
  let allCourses = [];
  let myBookings = []; // å­˜å‚¨ç”¨æˆ·å·²æŠ¥åçš„ä¿¡æ¯
  let currentDay = 'Monday';
  let currentCourse = null;
  let selectedMode = 'term';
  let selectedDates = [];
  let userMakeupCredits = 0;

  async function init() {
    // 1. åˆå§‹åŒ– Tab
    const tabContainer = document.getElementById('dayTabs');
    days.forEach((d) => {
        const div = document.createElement('div');
        div.className = `day-tab ${d === 'Monday' ? 'active' : ''}`;
        div.textContent = d === 'Wednesday' ? 'Wed' : d.substring(0, 3);
        div.onclick = () => switchDay(d, div);
        tabContainer.appendChild(div);
    });

    // 2. è·å–ç”¨æˆ·ä¿¡æ¯ & å·²æŠ¥åè¯¾ç¨‹ (MOCK DATA for now)
    // çœŸå®ç¯å¢ƒ: fetch('/api/my-bookings')
    // è¿™é‡Œæ¨¡æ‹Ÿï¼šå‡è®¾ç”¨æˆ·å·²ç»æŠ¥äº† 'Ballet Grade 1' çš„æ•´å­¦æœŸï¼Œä»¥åŠ 'Jazz' çš„ç¬¬ä¸€å‘¨
    try {
        const resMe = await fetch('/api/me');
        const user = await resMe.json();
        userMakeupCredits = user.makeup_credits || 0;
        
        // è·å–å·²æŠ¥åæ•°æ® (APIéœ€è¿”å› array: [{courseId: 1, type: 'term'}, {courseId: 2, type: 'casual', dates:['2026-02-02']}] )
        const resBooks = await fetch('/api/my-bookings'); 
        myBookings = await resBooks.json();
    } catch(e) { console.log('Mocking bookings'); myBookings = []; }

    // 3. è·å–è¯¾ç¨‹åˆ—è¡¨
    try {
        const res = await fetch('/api/courses/recommended');
        const data = await res.json();
        document.getElementById('ageTip').textContent = `Age: ${data.age} (Recommended)`;
        allCourses = data.courses;
        renderList();
    } catch(e) {}
  }

  function switchDay(day, el) {
      currentDay = day;
      document.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      renderList();
  }

  function renderList() {
      const list = document.getElementById('courseList');
      list.innerHTML = '';
      const todayCourses = allCourses.filter(c => c.day_of_week === currentDay);
      
      if(todayCourses.length === 0) list.innerHTML = '<p style="text-align:center;color:#999;margin-top:20px">No classes today.</p>';

      todayCourses.forEach(c => {
          // æ£€æŸ¥æ˜¯å¦å·²æŠ¥å
          const existing = myBookings.find(b => b.course_id === c.id);
          const isFullTermBooked = existing && existing.type === 'term';
          
          const div = document.createElement('div');
          // å¦‚æœæ•´å­¦æœŸå·²æŠ¥ï¼Œå¡ç‰‡ç¨å¾®å˜ç°
          div.className = `course-card ${isFullTermBooked ? 'disabled' : ''}`;
          
          let btnHtml = '';
          if (isFullTermBooked) {
              btnHtml = `<button class="btn-book" disabled>âœ… Joined</button>`;
          } else {
              // ä¼ å…¥ existing æ•°æ®ä»¥ä¾¿åœ¨ modal é‡Œå¤„ç†å•æ¬¡è¯¾é‡å¤
              btnHtml = `<button class="btn-book" onclick='openModal(${JSON.stringify(c)})'>Book</button>`;
          }

          div.innerHTML = `
            <div class="c-main">
                <h3>${c.name}</h3>
                <div class="c-detail">â° ${c.start_time} - ${c.end_time}</div>
                <div class="c-detail">
                    <span class="tag">ğŸ“ ${c.classroom || 'Studio 1'}</span>
                    <span class="tag">ğŸ‘©â€ğŸ« ${c.teacher}</span>
                    <span class="tag">$${c.price}</span>
                </div>
            </div>
            ${btnHtml}
          `;
          list.appendChild(div);
      });
  }

  function openModal(course) { /* ... */ }
  function selectMode(mode) { /* ... */ }
  function toggleDate(div, date, e, mode) { /* ... */ }
  function closeModal() { document.getElementById('bookModal').style.display = 'none'; }
  async function confirmBooking() { /* ... */ }
  
  init();
</script>
</body>
</html>