<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>2026 Timetable (é€‰è¯¾)</title>
  <style>
    /* ... ä¿æŒæ ·å¼ä¸å˜ ... */
    body{font-family:'Segoe UI', sans-serif;margin:0;background:#f9f9f9;padding-bottom:5rem}
    .header{background:#ff6b35;color:white;padding:1rem;text-align:center;position:sticky;top:0;z-index:90}
    .day-tabs {display:flex;overflow-x:auto;background:white;padding:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05);position:sticky;top:60px;z-index:80}
    .day-tab {flex:0 0 auto;padding:8px 16px;margin-right:10px;border-radius:20px;background:#f0f0f0;color:#666;font-weight:bold;cursor:pointer;font-size:0.9rem}
    .day-tab.active {background:#ff6b35;color:white}
    .container{max-width:800px;margin:1rem auto;padding:0 1rem}
    
    .course-card{background:white;border-radius:12px;padding:1.2rem;margin-bottom:1rem;box-shadow:0 2px 8px rgba(0,0,0,0.05);display:flex;justify-content:space-between;align-items:center; transition:0.2s}
    /* å˜ç°æ ·å¼ */
    .course-card.disabled {opacity: 0.6; background: #eee; cursor: not-allowed; border: 1px solid #ccc;}
    
    .c-main h3{margin:0 0 5px 0;color:#333}
    .c-detail{font-size:0.9rem;color:#666;margin:2px 0}
    .tag{font-size:0.8rem;background:#fff0e6;color:#ff6b35;padding:2px 5px;border-radius:4px;margin-right:5px}
    
    .btn-book{background:#ff6b35;color:white;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:bold}
    .btn-book:disabled {background:#999; cursor: not-allowed;}

    .modal-overlay {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999;justify-content:center;align-items:end}
    .modal {background:white;width:100%;max-width:600px;border-radius:20px 20px 0 0;padding:20px;box-sizing:border-box;animation:slideUp 0.3s}
    @keyframes slideUp {from{transform:translateY(100%)} to{transform:translateY(0)}}
    
    .option-box {border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:10px;cursor:pointer}
    .option-box.selected {border-color:#ff6b35;background:#fff0e6}
    .option-box.disabled {opacity:0.5; cursor:not-allowed; background:#eee; border-color:#ccc}
    
    .date-grid {display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px;display:none}
    .date-item {background:#f0f0f0;padding:8px;text-align:center;border-radius:4px;font-size:0.8rem;cursor:pointer}
    .date-item.active {background:#ff6b35;color:white}
    .date-item.booked {background:#ccc;color:#666;cursor:not-allowed;text-decoration:line-through}

    .nav-bar{position:fixed;bottom:0;left:0;width:100%;background:white;border-top:1px solid #eee;display:flex;justify-content:space-around;padding:8px 0;z-index:99; padding-bottom: max(8px, env(safe-area-inset-bottom));}
    .nav-item{text-decoration:none;color:#888;font-size:0.75rem;text-align:center;display:flex;flex-direction:column;align-items:center;flex:1}
    .nav-icon{font-size:1.4rem;margin-bottom:2px}
    .nav-item.active{color:#ff6b35}
  </style>
</head>
<body>

<div class="header"><h3>2026 TERM 1 Timetable</h3></div>
<div class="day-tabs" id="dayTabs"></div>
<div class="container">
  <div id="ageTip" style="text-align:center;color:#666;margin:10px">Loading...</div>
  <div id="courseList"></div>
</div>

<div id="bookModal" class="modal-overlay">
  <div class="modal">
    <h3 id="mTitle">Course Name</h3>
    <div id="userCredits" style="font-size:0.8rem;color:#2196f3;margin-bottom:10px"></div>
    
    <div class="option-box selected" onclick="selectMode('term')" id="optTerm">
      <div style="font-weight:bold">ğŸ“… Full Term (æ•´å­¦æœŸ)</div>
      <div style="color:#ff6b35;margin-top:5px" id="mTermPrice">$230</div>
      <div id="termStatusMsg" style="font-size:0.8rem;color:red;display:none">âš ï¸ Already Joined (å·²æŠ¥å)</div>
    </div>

    <div class="option-box" onclick="selectMode('casual')" id="optCasual">
      <div style="font-weight:bold">ğŸ—“ Casual Dates (è‡ªé€‰æ—¥æœŸ)</div>
      <div style="color:#ff6b35;margin-top:5px" id="mCasualPrice">$25 / lesson</div>
      <div class="date-grid" id="dateGrid"></div>
    </div>

    <div class="option-box" onclick="selectMode('makeup')" id="optMakeup" style="display:none; border-color:#2196f3; background:#e3f2fd">
      <div style="font-weight:bold">ğŸ”µ Use Makeup Credit (ä½¿ç”¨è¡¥è¯¾å¡)</div>
      <div style="color:#2196f3;margin-top:5px">Free (å…è´¹)</div>
      <div class="date-grid" id="makeupDateGrid"></div>
    </div>

    <div style="margin-top:20px;display:flex;gap:10px">
      <button onclick="closeModal()" style="flex:1;padding:12px;border:1px solid #ddd;background:white;border-radius:8px">Cancel</button>
      <button id="btnConfirm" onclick="confirmBooking()" style="flex:2;padding:12px;background:#ff6b35;color:white;border:none;border-radius:8px;font-weight:bold">Confirm</button>
    </div>
  </div>
</div>

<div class="nav-bar">
    <a href="/games.html" class="nav-item"><span class="nav-icon">ğŸ®</span>Home<br>(å¤§å…)</a>
    <a href="/my_schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>Schedule<br>(è¯¾è¡¨)</a>
    <a href="#" class="nav-item active"><span class="nav-icon">ğŸ›’</span>Book<br>(é€‰è¯¾)</a>
    <a href="/rooms.html" class="nav-item"><span class="nav-icon">ğŸ”‘</span>Rooms<br>(æ•™å®¤)</a>
</div>

<script>
  const TERM_START = new Date("2026-02-02"); 
  const WEEKS = 10; 
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  
  let allCourses = [];
  let myBookings = []; 
  let currentDay = 'Monday';
  let currentCourse = null;
  let selectedMode = 'term';
  let selectedDates = [];
  let userMakeupCredits = 0;

  async function init() {
    const tabContainer = document.getElementById('dayTabs');
    // é˜²æ­¢é‡å¤åˆå§‹åŒ–
    if(tabContainer.innerHTML === '') {
        days.forEach((d) => {
            const div = document.createElement('div');
            div.className = `day-tab ${d === 'Monday' ? 'active' : ''}`;
            div.textContent = d === 'Wednesday' ? 'Wed' : d.substring(0, 3);
            div.onclick = () => switchDay(d, div);
            tabContainer.appendChild(div);
        });
    }

    try {
        const resMe = await fetch('/api/me');
        const user = await resMe.json();
        userMakeupCredits = user.makeup_credits || 0;
        
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šè°ƒç”¨åç«¯æ–°æ¥å£è·å–çœŸå®æŠ¥åæ•°æ® â˜…â˜…â˜…
        const resBooks = await fetch('/api/my-bookings'); 
        myBookings = await resBooks.json(); // ç°åœ¨è¿™é‡Œä¸ä¼šæ˜¯ç©ºæ•°ç»„äº†
        console.log("My Bookings:", myBookings);
    } catch(e) { console.error('Fetch bookings failed', e); myBookings = []; }

    try {
        const res = await fetch('/api/courses/recommended');
        const data = await res.json();
        document.getElementById('ageTip').textContent = `Age: ${data.age} (Recommended)`;
        allCourses = data.courses;
        renderList();
    } catch(e) {}
  }

  function switchDay(day, el) {
      currentDay = day;
      document.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      renderList();
  }

  function renderList() {
      const list = document.getElementById('courseList');
      list.innerHTML = '';
      const todayCourses = allCourses.filter(c => c.day_of_week === currentDay);
      
      if(todayCourses.length === 0) list.innerHTML = '<p style="text-align:center;color:#999;margin-top:20px">No classes today.</p>';

      todayCourses.forEach(c => {
          // æ£€æŸ¥æŠ¥åçŠ¶æ€
          const existing = myBookings.find(b => b.course_id === c.id);
          const isFullTermBooked = existing && existing.type === 'term';
          
          const div = document.createElement('div');
          // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šæ•´å­¦æœŸå·²æŠ¥åˆ™å˜ç° â˜…â˜…â˜…
          div.className = `course-card ${isFullTermBooked ? 'disabled' : ''}`;
          
          let btnHtml = '';
          if (isFullTermBooked) {
              btnHtml = `<button class="btn-book" disabled>âœ… Joined</button>`;
          } else {
              btnHtml = `<button class="btn-book" onclick='openModal(${JSON.stringify(c)})'>Book</button>`;
          }

          div.innerHTML = `
            <div class="c-main">
                <h3>${c.name}</h3>
                <div class="c-detail">â° ${c.start_time} - ${c.end_time}</div>
                <div class="c-detail">
                    <span class="tag">ğŸ“ ${c.classroom || 'Studio 1'}</span>
                    <span class="tag">ğŸ‘©â€ğŸ« ${c.teacher}</span>
                    <span class="tag">$${c.price}</span>
                </div>
            </div>
            ${btnHtml}
          `;
          list.appendChild(div);
      });
  }

  function openModal(course) {
      currentCourse = course;
      selectedMode = 'term';
      selectedDates = [];
      
      document.getElementById('mTitle').textContent = course.name;
      document.getElementById('mTermPrice').textContent = `$${course.price}`;
      document.getElementById('mCasualPrice').textContent = `$${course.casual_price || 25} / lesson`;
      
      const existing = myBookings.find(b => b.course_id === course.id);
      const bookedDates = (existing && existing.dates) ? existing.dates : [];

      // å¦‚æœæ•´å­¦æœŸå·²æŠ¥
      if (existing && existing.type === 'term') {
          document.getElementById('optTerm').classList.add('disabled');
          document.getElementById('termStatusMsg').style.display = 'block';
          selectMode('casual'); 
      } else {
          document.getElementById('optTerm').classList.remove('disabled');
          document.getElementById('termStatusMsg').style.display = 'none';
          selectMode('term');
      }
      
      // ç”Ÿæˆæ—¥æœŸç½‘æ ¼
      const gridCasual = document.getElementById('dateGrid');
      gridCasual.innerHTML = '';
      
      const dayIndex = days.indexOf(course.day_of_week);
      let currentDate = new Date(TERM_START);
      currentDate.setDate(currentDate.getDate() + dayIndex); 

      for(let i=0; i<WEEKS; i++) {
          const isoDate = currentDate.toISOString().split('T')[0];
          const displayDate = currentDate.toLocaleDateString('en-NZ', {month:'short', day:'numeric'});
          
          const isBooked = bookedDates.includes(isoDate);

          const d = document.createElement('div');
          // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šå•æ¬¡å·²æŠ¥æ—¥æœŸå˜ç°/åˆ’æ‰ â˜…â˜…â˜…
          d.className = `date-item ${isBooked ? 'booked' : ''}`;
          d.textContent = displayDate;
          
          if (!isBooked) {
              d.onclick = (e) => toggleDate(d, isoDate, e, 'casual');
          } else {
              d.title = "Already booked";
          }
          
          gridCasual.appendChild(d);
          currentDate.setDate(currentDate.getDate() + 7);
      }

      if(userMakeupCredits > 0) {
          document.getElementById('optMakeup').style.display = 'block';
          document.getElementById('userCredits').textContent = `Credits: ${userMakeupCredits}`;
      } else {
          document.getElementById('optMakeup').style.display = 'none';
      }

      document.getElementById('bookModal').style.display = 'flex';
  }

  function selectMode(mode) {
      if (mode === 'term' && document.getElementById('optTerm').classList.contains('disabled')) return;

      selectedMode = mode;
      selectedDates = []; 
      
      document.querySelectorAll('.date-item').forEach(d => {
          if(!d.classList.contains('booked')) d.classList.remove('active');
      });
      
      document.getElementById('optTerm').className = `option-box ${mode==='term'?'selected':''}`;
      document.getElementById('optCasual').className = `option-box ${mode==='casual'?'selected':''}`;
      document.getElementById('dateGrid').style.display = mode==='casual'?'grid':'none';
      document.getElementById('btnConfirm').disabled = false;
  }

  function toggleDate(div, date, e, mode) {
      e.stopPropagation();
      if(selectedDates.includes(date)) {
          selectedDates = selectedDates.filter(d => d !== date);
          div.classList.remove('active');
      } else {
          selectedDates.push(date);
          div.classList.add('active');
      }
  }

  function closeModal() { document.getElementById('bookModal').style.display = 'none'; }

  async function confirmBooking() {
      if (selectedMode === 'casual' && selectedDates.length === 0) return alert('âš ï¸ Please select at least one date (è¯·é€‰æ‹©æ—¥æœŸ).');
      
      let price = currentCourse.price;
      if (selectedMode === 'casual') price = (currentCourse.casual_price || 25) * selectedDates.length;

      if(!confirm(`Confirm booking? Total: $${price}`)) return;
      
      const btn = document.getElementById('btnConfirm');
      btn.disabled = true;
      btn.textContent = 'Processing...';

      try {
          const res = await fetch('/api/book-course', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                  courseId: currentCourse.id,
                  type: selectedMode,
                  selectedDates: selectedDates,
                  totalPrice: price
              })
          });
          const result = await res.json();
          
          // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šå¤„ç† undefined å¼¹çª— â˜…â˜…â˜…
          if(result.success) {
              alert('âœ… ' + (result.message || 'Booked Successfully!'));
              closeModal();
              init(); // åˆ·æ–°é¡µé¢çŠ¶æ€ï¼Œè®©æ–°æŠ¥çš„è¯¾å˜ç°
          } else {
              // è¿™é‡Œçš„ result.message æ¥è‡ªåç«¯æˆ‘ä»¬æ–°åŠ çš„é€»è¾‘ï¼Œä¼šæ˜¾ç¤ºâ€œå·²æŠ¥åâ€ç­‰ä¸­æ–‡
              alert('âŒ ' + (result.message || result.error || 'Booking Failed (æœªçŸ¥é”™è¯¯)'));
          }
      } catch(e) { 
          alert('Network Error (ç½‘ç»œé”™è¯¯)'); 
      } finally {
          btn.disabled = false;
          btn.textContent = 'Confirm';
      }
  }
  
  init();
</script>
</body>
</html>