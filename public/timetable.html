<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>2026 æ™ºèƒ½é€‰è¯¾</title>
  <style>
    body{font-family:Arial;margin:0;background:#f9f9f9;padding-bottom:5rem}
    .header{background:#ff6b35;color:white;padding:1rem;text-align:center}
    
    /* æ˜ŸæœŸå¯¼èˆªæ  */
    .day-tabs {display:flex;overflow-x:auto;background:white;padding:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05);position:sticky;top:0;z-index:100}
    .day-tab {flex:0 0 auto;padding:8px 16px;margin-right:10px;border-radius:20px;background:#f0f0f0;color:#666;font-weight:bold;cursor:pointer;font-size:0.9rem}
    .day-tab.active {background:#ff6b35;color:white}
    
    .container{max-width:800px;margin:1rem auto;padding:0 1rem}
    .age-tip {text-align:center;color:#666;font-size:0.9rem;margin:10px 0}

    .course-card{background:white;border-radius:12px;padding:1.2rem;margin-bottom:1rem;box-shadow:0 2px 8px rgba(0,0,0,0.05);display:flex;justify-content:space-between;align-items:center}
    .c-main h3{margin:0 0 5px 0;color:#333}
    .c-detail{font-size:0.9rem;color:#666;margin:2px 0}
    .tag{font-size:0.8rem;background:#fff0e6;color:#ff6b35;padding:2px 5px;border-radius:4px;margin-right:5px}
    
    .btn-book{background:#ff6b35;color:white;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:bold}
    
    /* å¼¹çª—æ ·å¼ */
    .modal-overlay {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999;justify-content:center;align-items:end}
    .modal {background:white;width:100%;max-width:600px;border-radius:20px 20px 0 0;padding:20px;box-sizing:border-box;animation:slideUp 0.3s}
    @keyframes slideUp {from{transform:translateY(100%)} to{transform:translateY(0)}}
    
    .option-box {border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:10px;cursor:pointer}
    .option-box.selected {border-color:#ff6b35;background:#fff0e6}
    .date-grid {display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px;display:none}
    .date-item {background:#f0f0f0;padding:8px;text-align:center;border-radius:4px;font-size:0.8rem;cursor:pointer}
    .date-item.active {background:#ff6b35;color:white}
    
    .nav-bar{position:fixed;bottom:0;left:0;width:100%;background:white;border-top:1px solid #eee;display:flex;justify-content:space-around;padding:10px 0;z-index:99}
    .nav-item{text-decoration:none;color:#666;font-size:0.9rem;text-align:center}
  </style>
</head>
<body>

<div class="header">
  <h3>2026 TERM 1 è¯¾è¡¨</h3>
</div>

<div class="day-tabs" id="dayTabs">
  </div>

<div class="container">
  <div id="ageTip" class="age-tip">åŠ è½½ä¸­...</div>
  <div id="courseList"></div>
</div>

<div id="bookModal" class="modal-overlay">
  <div class="modal">
    <h3 id="mTitle">è¯¾ç¨‹å</h3>
    <p style="color:#666;font-size:0.9rem">è¯·é€‰æ‹©æŠ¥åæ–¹å¼ï¼š</p>
    
    <div class="option-box selected" onclick="selectMode('term')" id="optTerm">
      <div style="font-weight:bold">ğŸ“… æ•´å­¦æœŸæŠ¥å (Full Term)</div>
      <div style="color:#ff6b35;margin-top:5px" id="mTermPrice">$200</div>
      <div style="font-size:0.8rem;color:#999">åŒ…å«æ‰€æœ‰ 10 å‘¨è¯¾ç¨‹ï¼Œæœ€ä¼˜æƒ </div>
    </div>

    <div class="option-box" onclick="selectMode('casual')" id="optCasual">
      <div style="font-weight:bold">ğŸ—“ è‡ªé€‰æ—¥æœŸ (Casual)</div>
      <div style="color:#ff6b35;margin-top:5px" id="mCasualPrice">$25 / è¯¾</div>
      
      <div class="date-grid" id="dateGrid">
        </div>
    </div>

    <div style="margin-top:20px;display:flex;gap:10px">
      <button onclick="closeModal()" style="flex:1;padding:12px;border:1px solid #ddd;background:white;border-radius:8px">å–æ¶ˆ</button>
      <button onclick="confirmBooking()" style="flex:2;padding:12px;background:#ff6b35;color:white;border:none;border-radius:8px;font-weight:bold">ç¡®è®¤æŠ¥å</button>
    </div>
  </div>
</div>

<div class="nav-bar">
    <a href="/games.html" class="nav-item">ğŸ® é¦–é¡µ</a>
    <a href="#" class="nav-item" style="color:#ff6b35">ğŸ“… é€‰è¯¾</a>
    <a href="/invoices.html" class="nav-item">ğŸ’° è´¦å•</a>
</div>

<script>
  // é…ç½®ï¼š2026 Term 1 æ—¥æœŸèŒƒå›´ (å‡è®¾ 2æœˆ2æ—¥ å‘¨ä¸€å¼€å­¦)
  const TERM_START = new Date("2026-02-02"); 
  const WEEKS = 10; // 10å‘¨

  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  let allCourses = [];
  let currentDay = 'Monday';
  let currentCourse = null;
  let selectedMode = 'term'; // 'term' or 'casual'
  let selectedDates = [];

  // 1. åˆå§‹åŒ–é¡µé¢
  async function init() {
    // ç”Ÿæˆæ˜ŸæœŸTab
    const tabContainer = document.getElementById('dayTabs');
    days.forEach((d, i) => {
        const div = document.createElement('div');
        div.className = `day-tab ${d === 'Monday' ? 'active' : ''}`;
        div.textContent = d === 'Wednesday' ? 'Wed' : d.substring(0, 3); // ç®€å†™
        div.onclick = () => switchDay(d, div);
        tabContainer.appendChild(div);
    });

    // è·å–æ•°æ®
    try {
        const res = await fetch('/api/courses/recommended');
        const data = await res.json();
        if(data.error) { alert(data.error); return; }
        
        document.getElementById('ageTip').textContent = `å­¦å‘˜å¹´é¾„: ${data.age}å² (ç³»ç»Ÿå·²è‡ªåŠ¨ç­›é€‰è¯¾ç¨‹)`;
        allCourses = data.courses;
        renderList();
    } catch(e) { console.error(e); }
  }

  // 2. åˆ‡æ¢æ˜ŸæœŸ
  function switchDay(day, tabElement) {
      currentDay = day;
      document.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
      tabElement.classList.add('active');
      renderList();
  }

  // 3. æ¸²æŸ“åˆ—è¡¨
  function renderList() {
      const list = document.getElementById('courseList');
      list.innerHTML = '';
      
      const todayCourses = allCourses.filter(c => c.day_of_week === currentDay);
      
      if(todayCourses.length === 0) {
          list.innerHTML = '<p style="text-align:center;color:#999;margin-top:2rem">è¯¥æ—¥æš‚æ— é€‚åˆæ‚¨å¹´é¾„çš„è¯¾ç¨‹</p>';
          return;
      }

      todayCourses.forEach(c => {
          const div = document.createElement('div');
          div.className = 'course-card';
          div.innerHTML = `
            <div class="c-main">
                <h3>${c.name}</h3>
                <div class="c-detail">â° ${c.start_time} - ${c.end_time}</div>
                <div class="c-detail">
                    <span class="tag">ğŸ‘©â€ğŸ« ${c.teacher}</span>
                    <span class="tag">$${c.price} / Term</span>
                </div>
            </div>
            <button class="btn-book" onclick='openModal(${JSON.stringify(c)})'>æŠ¥å</button>
          `;
          list.appendChild(div);
      });
  }

  // 4. æ‰“å¼€æŠ¥åå¼¹çª—
  function openModal(course) {
      currentCourse = course;
      selectedMode = 'term';
      selectedDates = [];
      
      document.getElementById('mTitle').textContent = course.name;
      document.getElementById('mTermPrice').textContent = `$${course.price}`;
      document.getElementById('mCasualPrice').textContent = `$${course.casual_price || Math.ceil(course.price/8)} / è¯¾`;
      
      // ç”Ÿæˆè¯¥è¯¾ç¨‹æœ¬å­¦æœŸçš„æ‰€æœ‰æ—¥æœŸ
      const grid = document.getElementById('dateGrid');
      grid.innerHTML = '';
      const dayIndex = days.indexOf(course.day_of_week); // 0=Mon, 1=Tue...
      
      // è®¡ç®—ç¬¬ä¸€ä¸ªä¸Šè¯¾æ—¥ (TermStart æ˜¯å‘¨ä¸€)
      let currentDate = new Date(TERM_START);
      currentDate.setDate(currentDate.getDate() + dayIndex); 

      for(let i=0; i<WEEKS; i++) {
          const dateStr = currentDate.toLocaleDateString('en-NZ'); // DD/MM/YYYY
          const isoDate = currentDate.toISOString().split('T')[0]; // YYYY-MM-DD
          
          const div = document.createElement('div');
          div.className = 'date-item';
          div.textContent = dateStr.substring(0, 5); // åªæ˜¾ç¤º DD/MM
          div.onclick = (e) => toggleDate(div, isoDate, e);
          grid.appendChild(div);
          
          // ä¸‹ä¸€å‘¨
          currentDate.setDate(currentDate.getDate() + 7);
      }

      selectMode('term'); // é‡ç½®ä¸ºæ•´å­¦æœŸ
      document.getElementById('bookModal').style.display = 'flex';
  }

  function selectMode(mode) {
      selectedMode = mode;
      document.getElementById('optTerm').className = mode==='term' ? 'option-box selected' : 'option-box';
      document.getElementById('optCasual').className = mode==='casual' ? 'option-box selected' : 'option-box';
      document.getElementById('dateGrid').style.display = mode==='casual' ? 'grid' : 'none';
  }

  function toggleDate(div, date, e) {
      e.stopPropagation(); // é˜²æ­¢è§¦å‘çˆ¶çº§ç‚¹å‡»
      if(selectedDates.includes(date)) {
          selectedDates = selectedDates.filter(d => d !== date);
          div.classList.remove('active');
      } else {
          selectedDates.push(date);
          div.classList.add('active');
      }
  }

  function closeModal() {
      document.getElementById('bookModal').style.display = 'none';
  }

  async function confirmBooking() {
      let finalPrice = currentCourse.price;
      
      if (selectedMode === 'casual') {
          if (selectedDates.length === 0) {
              alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ—¥æœŸ');
              return;
          }
          const casualPrice = currentCourse.casual_price || Math.ceil(currentCourse.price/8);
          finalPrice = casualPrice * selectedDates.length;
      }

      const msg = selectedMode === 'term' 
          ? `ç¡®è®¤æŠ¥åæ•´å­¦æœŸï¼Ÿæ€»ä»· $${finalPrice}` 
          : `ç¡®è®¤æŠ¥å ${selectedDates.length} èŠ‚è¯¾ï¼Ÿæ€»ä»· $${finalPrice}`;
          
      if(!confirm(msg)) return;

      // æäº¤åç«¯
      try {
          const res = await fetch('/api/book-course', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                  courseId: currentCourse.id,
                  type: selectedMode,
                  selectedDates: selectedMode === 'casual' ? selectedDates : null,
                  totalPrice: finalPrice
              })
          });
          const result = await res.json();
          if(result.success) {
              alert('âœ… æŠ¥åæˆåŠŸï¼');
              closeModal();
              location.href = '/invoices.html';
          } else {
              alert('âš ï¸ ' + result.message);
          }
      } catch(e) { alert('æäº¤å¤±è´¥'); }
  }

  init();
</script>

</body>
</html>