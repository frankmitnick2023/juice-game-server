<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>2026 Timetable (é€‰è¯¾)</title>
  <style>
    body{font-family:'Segoe UI', sans-serif;margin:0;background:#f9f9f9;padding-bottom:5rem}
    .header{background:#ff6b35;color:white;padding:1rem;text-align:center;position:sticky;top:0;z-index:90}
    .day-tabs {display:flex;overflow-x:auto;background:white;padding:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05);position:sticky;top:60px;z-index:80}
    .day-tab {flex:0 0 auto;padding:8px 16px;margin-right:10px;border-radius:20px;background:#f0f0f0;color:#666;font-weight:bold;cursor:pointer;font-size:0.9rem}
    .day-tab.active {background:#ff6b35;color:white}
    .container{max-width:800px;margin:1rem auto;padding:0 1rem}
    
    .course-card{background:white;border-radius:12px;padding:1.2rem;margin-bottom:1rem;box-shadow:0 2px 8px rgba(0,0,0,0.05);display:flex;justify-content:space-between;align-items:center; transition:0.2s}
    .course-card.disabled {opacity: 0.6; background: #eee; cursor: not-allowed;}
    
    .c-main h3{margin:0 0 5px 0;color:#333}
    .c-detail{font-size:0.9rem;color:#666;margin:2px 0}
    .tag{font-size:0.8rem;background:#fff0e6;color:#ff6b35;padding:2px 5px;border-radius:4px;margin-right:5px}
    
    .btn-book{background:#ff6b35;color:white;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-weight:bold}
    .btn-book:disabled {background:#ccc; cursor: not-allowed;}

    .modal-overlay {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:999;justify-content:center;align-items:end}
    .modal {background:white;width:100%;max-width:600px;border-radius:20px 20px 0 0;padding:20px;box-sizing:border-box;animation:slideUp 0.3s}
    @keyframes slideUp {from{transform:translateY(100%)} to{transform:translateY(0)}}
    
    .option-box {border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:10px;cursor:pointer; display:flex; justify-content:space-between; align-items:center}
    .option-box.selected {border-color:#ff6b35;background:#fff0e6}
    .option-box.disabled {opacity:0.5; cursor:not-allowed; background:#eee; border-color:#ccc}
    
    .date-grid {display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px;display:none; padding:10px; background:#f9f9f9; border-radius:8px;}
    .date-item {background:white; border:1px solid #ddd; padding:8px; text-align:center;border-radius:4px;font-size:0.8rem;cursor:pointer}
    .date-item.active {background:#ff6b35;color:white; border-color:#ff6b35}
    .date-item.booked {background:#e0e0e0;color:#999;cursor:not-allowed;text-decoration:line-through; border-color:#ccc}

    .btn-confirm {width:100%; padding:15px; background:#ff6b35; color:white; border:none; border-radius:8px; font-weight:bold; font-size:1.1rem; margin-top:15px; cursor:pointer}
    
    .nav-bar{position:fixed;bottom:0;left:0;width:100%;background:white;border-top:1px solid #eee;display:flex;justify-content:space-around;padding:8px 0;z-index:99; padding-bottom: max(8px, env(safe-area-inset-bottom));}
    .nav-item{text-decoration:none;color:#888;font-size:0.75rem;text-align:center;display:flex;flex-direction:column;align-items:center;flex:1}
    .nav-icon{font-size:1.4rem;margin-bottom:2px}
    .nav-item.active{color:#ff6b35}
  </style>
</head>
<body>

<div class="header"><h3>2026 TERM 1 Timetable</h3></div>
<div class="day-tabs" id="dayTabs"></div>
<div class="container">
  <div id="ageTip" style="text-align:center;color:#666;margin:10px">Loading...</div>
  <div id="courseList"></div>
</div>

<div id="bookModal" class="modal-overlay">
    <div class="modal">
        <h2 id="mTitle" style="margin-top:0">Course Name</h2>
        <div style="margin-bottom:15px; color:#666" id="mInfo"></div>
        
        <div class="option-box selected" id="optTerm" onclick="selectMode('term')">
            <div>
                <div style="font-weight:bold">Full Term (10 Weeks)</div>
                <div style="font-size:0.85rem;color:#666">Best Value â€¢ Guaranteed Spot</div>
            </div>
            <div style="font-weight:bold;color:#ff6b35" id="priceTerm">$230</div>
        </div>

        <div class="option-box" id="optCasual" onclick="selectMode('casual')">
             <div>
                <div style="font-weight:bold">Casual / Make-up</div>
                <div style="font-size:0.85rem;color:#666">Select specific dates</div>
            </div>
            <div style="font-weight:bold;color:#ff6b35">$25/class</div>
        </div>

        <div class="date-grid" id="dateGrid"></div>

        <div style="display:flex; justify-content:space-between; margin-top:15px; font-weight:bold">
            <span>Total:</span>
            <span id="totalDisplay" style="color:#ff6b35">$230</span>
        </div>

        <button class="btn-confirm" id="btnConfirm" onclick="confirmBooking()">Confirm Booking</button>
        <button onclick="closeModal()" style="width:100%;padding:12px;background:none;border:none;color:#999;margin-top:5px">Cancel</button>
    </div>
</div>

<div class="nav-bar">
    <a href="/games.html" class="nav-item"><span class="nav-icon">ğŸ®</span>Home<br>(å¤§å…)</a>
    <a href="/my_schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>Schedule<br>(è¯¾è¡¨)</a>
    <a href="#" class="nav-item active"><span class="nav-icon">ğŸ›’</span>Book<br>(é€‰è¯¾)</a>
    <a href="/growth.html" class="nav-item"><span class="nav-icon">ğŸ“Š</span>Growth<br>(æˆé•¿)</a> 
    <a href="/rooms.html" class="nav-item"><span class="nav-icon">ğŸ”‘</span>Rooms<br>(æ•™å®¤)</a>
</div>

<script>
  // å‡å®š 2026 Term 1 ä» 2æœˆ2æ—¥å¼€å§‹
  const TERM_START = new Date("2026-02-02"); 
  const WEEKS = 10; 
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  
  let allCourses = [];
  let myBookings = []; 
  let currentDay = 'Monday';
  let currentCourse = null;
  let selectedMode = 'term';
  let selectedDates = []; // å­˜ç±»ä¼¼ "2026-02-02" çš„å­—ç¬¦ä¸²
  let userMakeupCredits = 0;
  
  // ç®—å…·ä½“æ—¥æœŸçš„è¾…åŠ©å‡½æ•°
  function getCourseDates(dayStr) {
      const dayIndex = days.indexOf(dayStr); // 0=Monday
      // è¿™é‡Œçš„ 1 æ˜¯å› ä¸º 2026-02-02 æ˜¯å‘¨ä¸€ã€‚å¦‚æœTerm Startä¸æ˜¯å‘¨ä¸€éœ€è°ƒæ•´
      // ç®€å•èµ·è§ï¼Œå‡è®¾ TERM_START å°±æ˜¯ç¬¬ä¸€å‘¨çš„å‘¨ä¸€
      const result = [];
      for(let i=0; i<WEEKS; i++) {
          const d = new Date(TERM_START);
          d.setDate(d.getDate() + (i*7) + dayIndex);
          result.push(d.toISOString().split('T')[0]);
      }
      return result;
  }

  async function init() {
    const tabContainer = document.getElementById('dayTabs');
    days.forEach((d) => {
        const div = document.createElement('div');
        div.className = `day-tab ${d === 'Monday' ? 'active' : ''}`;
        div.textContent = d === 'Wednesday' ? 'Wed' : d.substring(0, 3);
        div.onclick = () => switchDay(d, div);
        tabContainer.appendChild(div);
    });

    try {
        const resMe = await fetch('/api/me');
        const user = await resMe.json();
        userMakeupCredits = user.makeup_credits || 0;
        
        const resBooks = await fetch('/api/my-bookings'); 
        myBookings = await resBooks.json();
    } catch(e) { myBookings = []; }

    try {
        const res = await fetch('/api/courses/recommended');
        const data = await res.json();
        document.getElementById('ageTip').textContent = `Age: ${data.age} (Recommended)`;
        allCourses = data.courses;
        renderList();
    } catch(e) {}
  }

  function switchDay(day, el) {
      currentDay = day;
      document.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      renderList();
  }

  function renderList() {
      const list = document.getElementById('courseList');
      list.innerHTML = '';
      const todayCourses = allCourses.filter(c => c.day_of_week === currentDay);
      
      if(todayCourses.length === 0) list.innerHTML = '<p style="text-align:center;color:#999;margin-top:20px">No classes today.</p>';

      todayCourses.forEach(c => {
          // æ£€æŸ¥æŠ¥åçŠ¶æ€
          // 1. æ˜¯å¦æŠ¥äº†æ•´å­¦æœŸ
          const termBooking = myBookings.find(b => b.course_id === c.id && b.type === 'term');
          // 2. æ˜¯å¦æŠ¥äº†è¿™é—¨è¯¾çš„æŸäº›å•æ¬¡ (Casual)
          const casualBookings = myBookings.filter(b => b.course_id === c.id && b.type === 'casual');
          
          const div = document.createElement('div');
          div.className = `course-card ${termBooking ? 'disabled' : ''}`;
          
          let btnHtml = '';
          if (termBooking) {
              btnHtml = `<button class="btn-book" disabled>âœ… Joined</button>`;
          } else {
              // è¿™é‡Œçš„ onclick ç»ˆäºæœ‰å†…å®¹äº†
              // æŠŠ c å¯¹è±¡è½¬æˆå­—ç¬¦ä¸²ä¼ è¿›å»ï¼Œæˆ–è€…å­˜å…¨å±€å˜é‡
              div.onclick = (e) => {
                  if(e.target.tagName !== 'BUTTON') return; // ç‚¹å‡»å¡ç‰‡ç©ºç™½å¤„ä¸è§¦å‘
              };
              btnHtml = `<button class="btn-book" onclick='prepareModal(${JSON.stringify(c)})'>Book</button>`;
          }

          div.innerHTML = `
            <div class="c-main">
                <h3>${c.name}</h3>
                <div class="c-detail">â° ${c.start_time} - ${c.end_time}</div>
                <div class="c-detail">
                    <span class="tag">ğŸ“ ${c.classroom || 'Studio 1'}</span>
                    <span class="tag">ğŸ‘©â€ğŸ« ${c.teacher}</span>
                    <span class="tag">$${c.price} / Term</span>
                </div>
            </div>
            ${btnHtml}
          `;
          list.appendChild(div);
      });
  }

  // æ‰“å¼€å¼¹çª—å‰çš„å‡†å¤‡
  window.prepareModal = function(course) {
      currentCourse = course;
      const allDates = getCourseDates(course.day_of_week);
      
      // æ‰¾å‡ºè¿™é—¨è¯¾ç”¨æˆ·å·²ç»æŠ¥è¿‡çš„æ—¥æœŸï¼ˆé˜²æ­¢å•æ¬¡è¯¾é‡å¤é€‰ï¼‰
      const existingDates = new Set();
      const existing = myBookings.filter(b => b.course_id === course.id);
      existing.forEach(b => {
          if(b.type === 'term') allDates.forEach(d => existingDates.add(d));
          else if(b.dates) b.dates.forEach(d => existingDates.add(d));
      });

      // å¡«å…… Modal ä¿¡æ¯
      document.getElementById('mTitle').textContent = course.name;
      document.getElementById('mInfo').textContent = `${course.day_of_week} ${course.start_time} @ ${course.classroom}`;
      document.getElementById('priceTerm').textContent = `$${course.price}`;

      // æ¸²æŸ“æ—¥æœŸæ ¼å­
      const grid = document.getElementById('dateGrid');
      grid.innerHTML = '';
      allDates.forEach(dateStr => {
          const dObj = new Date(dateStr);
          const display = `${dObj.getDate()}/${dObj.getMonth()+1}`;
          const isBooked = existingDates.has(dateStr);
          
          const item = document.createElement('div');
          item.className = `date-item ${isBooked ? 'booked' : ''}`;
          item.textContent = display;
          if(!isBooked) {
              item.onclick = () => toggleDate(item, dateStr);
          }
          grid.appendChild(item);
      });

      // é»˜è®¤é€‰ä¸­ Term
      selectMode('term');
      document.getElementById('bookModal').style.display = 'flex';
  }

  window.selectMode = function(mode) {
      selectedMode = mode;
      document.getElementById('optTerm').className = `option-box ${mode==='term'?'selected':''}`;
      document.getElementById('optCasual').className = `option-box ${mode==='casual'?'selected':''}`;
      
      const grid = document.getElementById('dateGrid');
      if(mode === 'term') {
          grid.style.display = 'none';
          updateTotal();
      } else {
          grid.style.display = 'grid';
          selectedDates = []; // åˆ‡æ¢åˆ° casual æ—¶å…ˆæ¸…ç©º
          // æ¸…é™¤é€‰ä¸­æ ·å¼
          document.querySelectorAll('.date-item').forEach(el => {
              if(!el.classList.contains('booked')) el.classList.remove('active');
          });
          updateTotal();
      }
  }

  window.toggleDate = function(el, dateStr) {
      if(selectedMode !== 'casual') return;
      if(selectedDates.includes(dateStr)) {
          selectedDates = selectedDates.filter(d => d !== dateStr);
          el.classList.remove('active');
      } else {
          selectedDates.push(dateStr);
          el.classList.add('active');
      }
      updateTotal();
  }

  function updateTotal() {
      const display = document.getElementById('totalDisplay');
      const btn = document.getElementById('btnConfirm');
      
      if(selectedMode === 'term') {
          display.textContent = `$${currentCourse.price}`;
          btn.textContent = `Confirm ($${currentCourse.price})`;
          btn.disabled = false;
          btn.style.opacity = 1;
      } else {
          const cost = selectedDates.length * 25; // å•æ¬¡è¯¾ä»·æ ¼
          display.textContent = `$${cost}`;
          if(selectedDates.length === 0) {
              btn.textContent = 'Select Dates';
              btn.disabled = true;
              btn.style.opacity = 0.5;
          } else {
              btn.textContent = `Confirm ($${cost})`;
              btn.disabled = false;
              btn.style.opacity = 1;
          }
      }
  }

  window.closeModal = function() {
      document.getElementById('bookModal').style.display = 'none';
  }

  window.confirmBooking = async function() {
      const btn = document.getElementById('btnConfirm');
      btn.textContent = 'Processing...';
      btn.disabled = true;

      const payload = {
          courseId: currentCourse.id,
          type: selectedMode,
          totalPrice: selectedMode === 'term' ? currentCourse.price : (selectedDates.length * 25),
          selectedDates: selectedMode === 'term' ? [] : selectedDates
      };

      try {
          const res = await fetch('/api/book-course', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(payload)
          });
          const data = await res.json();
          if(data.success) {
              alert('âœ… Booking Successful!');
              closeModal();
              init(); // åˆ·æ–°åˆ—è¡¨
          } else {
              alert('Failed: ' + (data.message || 'Error'));
          }
      } catch(e) {
          alert('Network Error');
      }
      btn.disabled = false;
  }
  
  init();
</script>
</body>
</html>