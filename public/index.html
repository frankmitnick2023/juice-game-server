<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FunX ‚Ä¢ Juice Game Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0f14;
      --card: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --primary: #22d3ee;
      --primary-2: #38bdf8;
      --danger: #ef4444;
      --ok: #10b981;
      --btn: #1f2937;
      --btn2: #374151;
      --radius: 16px;
    }
    html, body { height: 100%; }
    body {
      margin: 0; background: radial-gradient(1200px 600px at 10% -10%, #112, transparent), var(--bg);
      color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      display: grid; place-items: center;
    }
    .shell { width: 100%; max-width: 900px; padding: 24px; }
    .nav {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;
    }
    .brand { font-weight: 800; letter-spacing: .5px; }
    .nav .right { display:flex; gap: 10px; align-items:center; }
    .badge {
      background: #0f172a; padding: 8px 12px; border-radius: 999px; font-size: 13px; color: var(--muted);
      border: 1px solid #1f2937;
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.15));
      border: 1px solid #1f2937; border-radius: var(--radius);
      padding: 22px; box-shadow: 0 10px 40px rgba(0,0,0,.3);
    }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); }
    h1 { margin: 10px 0 4px; font-size: 28px; }
    p { margin: 8px 0; color: var(--muted); }

    .btn {
      background: linear-gradient(180deg, var(--primary), var(--primary-2));
      border: none; color: #021017; font-weight: 700; padding: 12px 18px; border-radius: 12px; cursor: pointer;
    }
    .btn.secondary { background: var(--btn2); color: #e2e8f0; }
    .btn.ghost { background: transparent; border: 1px solid #334155; color: #e2e8f0; }

    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .hidden { display: none !important; }

    .input {
      width: 100%; background: #0b1220; border: 1px solid #1f2937; color: var(--text);
      border-radius: 12px; padding: 12px 14px;
    }

    .game {
      background: #0b1220; border: 1px solid #1f2937; border-radius: 14px; padding: 14px;
      transition: transform .15s ease;
      display:flex; flex-direction:column; gap:8px;
    }
    .game:hover { transform: translateY(-2px); }
    .game .title { font-weight: 700; }
    .game .desc { color: var(--muted); font-size: 14px; }
    .game .play { margin-top: auto; }
    .error { color: var(--danger); font-size: 14px; min-height:1.5em; }
    .ok { color: var(--ok); font-size: 14px; min-height:1.5em; }
  </style>
</head>
<body>
  <div class="shell">
    <div class="nav">
      <div class="brand">üçπ FunX Game Hub</div>
      <div class="right">
        <span id="userBadge" class="badge hidden"></span>
        <button id="loginBtnTop" class="btn ghost" onclick="goto('/login')">Login</button>
        <button id="logoutBtnTop" class="btn secondary hidden" onclick="doLogout()">Logout</button>
      </div>
    </div>

    <!-- LandingÔºàÊú™ÁôªÂΩïÔºâ -->
    <section id="view-landing" class="card">
      <h1>Train like a gamer. Move like a dancer.</h1>
      <p>Login to track your progress and play all games.</p>
      <div class="row" style="margin-top:10px;">
        <button class="btn" onclick="goto('/register')">Get Started</button>
        <button class="btn secondary" onclick="goto('/login')">Login</button>
      </div>
    </section>

    <!-- Register -->
    <section id="view-register" class="card hidden">
      <h1>Create account</h1>
      <p>Unlock all games and save your progress.</p>
      <div class="row">
        <input id="r_name" class="input" placeholder="Your name" />
        <input id="r_email" class="input" placeholder="Email" />
        <input id="r_pwd" class="input" placeholder="Password" type="password" />
        <div class="error" id="r_err"></div>
        <div class="row">
          <button class="btn" onclick="doRegister()">Create account</button>
          <button class="btn ghost" onclick="goto('/')">Back</button>
        </div>
      </div>
    </section>

    <!-- Login -->
    <section id="view-login" class="card hidden">
      <h1>Welcome back</h1>
      <p>Sign in to continue.</p>
      <div class="row">
        <input id="l_email" class="input" placeholder="Email" />
        <input id="l_pwd" class="input" placeholder="Password" type="password" />
        <div class="error" id="l_err"></div>
        <div class="row">
          <button class="btn" onclick="doLogin()">Login</button>
          <button class="btn ghost" onclick="goto('/')">Back</button>
        </div>
      </div>
    </section>

    <!-- DashboardÔºàÂ∑≤ÁôªÂΩïÔºâ -->
    <section id="view-dashboard" class="card hidden">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div>
          <h1 id="helloTitle">Hi!</h1>
          <p id="helloSub" class="ok"></p>
        </div>
        <button class="btn secondary" onclick="doLogout()">Logout</button>
      </div>

      <h2 style="margin-top:10px;">Available Games</h2>
      <div id="gamesGrid" class="grid" style="margin-top:10px;"></div>
      <div id="gamesErr" class="error"></div>
    </section>
  </div>

  <script>
    // --- SPA ËßÜÂõæÂàáÊç¢ ---
    const views = ['landing','register','login','dashboard'];
    function show(id) {
      for (const v of views) {
        const el = document.getElementById('view-' + v);
        if (!el) continue;
        if (v === id) el.classList.remove('hidden'); else el.classList.add('hidden');
      }
    }

    function goto(pathname) {
      history.pushState({ path: pathname }, '', pathname);
      route();
    }

    window.addEventListener('popstate', route);

    // --- Áä∂ÊÄÅ ---
    let currentUser = null;

    async function fetchMe() {
      try {
        const r = await fetch('/api/me', { credentials: 'same-origin' });
        if (!r.ok) throw 0;
        const data = await r.json();
        if (data.ok) {
          currentUser = data.user;
        } else {
          currentUser = null;
        }
      } catch {
        currentUser = null;
      }
      renderUserBadge();
    }

    function renderUserBadge() {
      const badge = document.getElementById('userBadge');
      const loginTop = document.getElementById('loginBtnTop');
      const logoutTop = document.getElementById('logoutBtnTop');

      if (currentUser) {
        badge.textContent = `${currentUser.name} ‚Ä¢ Lv.${currentUser.level} ‚Ä¢ ${currentUser.coins}üí∞`;
        badge.classList.remove('hidden');
        logoutTop.classList.remove('hidden');
        loginTop.classList.add('hidden');
      } else {
        badge.classList.add('hidden');
        logoutTop.classList.add('hidden');
        loginTop.classList.remove('hidden');
      }
    }

    // --- Ê≥®ÂÜå / ÁôªÂΩï / ÁôªÂá∫ ---
    async function doRegister() {
      const name = document.getElementById('r_name').value.trim();
      const email = document.getElementById('r_email').value.trim();
      const pwd = document.getElementById('r_pwd').value;
      const err = document.getElementById('r_err'); err.textContent = '';

      try {
        const r = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ name, email, password: pwd })
        });
        const data = await r.json();
        if (!r.ok || !data.ok) throw new Error(data.error || 'Register failed');
        // Ê≥®ÂÜåÊàêÂäü ‚Üí Âõû‰∏ªÈ°µ
        await fetchMe();
        goto('/');
      } catch (e) {
        err.textContent = e.message || 'Server error';
      }
    }

    async function doLogin() {
      const email = document.getElementById('l_email').value.trim();
      const pwd = document.getElementById('l_pwd').value;
      const err = document.getElementById('l_err'); err.textContent = '';

      try {
        const r = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ email, password: pwd })
        });
        const data = await r.json();
        if (!r.ok || !data.ok) throw new Error(data.error || 'Login failed');
        // ÁôªÂΩïÊàêÂäü ‚Üí Âõû‰∏ªÈ°µ
        await fetchMe();
        goto('/');
      } catch (e) {
        err.textContent = e.message || 'Server error';
      }
    }

    async function doLogout() {
      try {
        await fetch('/api/logout', { method: 'POST', credentials: 'same-origin' });
      } catch {}
      currentUser = null;
      renderUserBadge();
      goto('/');
    }

    // --- Âä†ËΩΩÊ∏∏Êàè ---
    async function loadGames() {
      const grid = document.getElementById('gamesGrid');
      const err = document.getElementById('gamesErr');
      grid.innerHTML = ''; err.textContent = '';

      try {
        const r = await fetch('/api/games', { credentials: 'same-origin' });
        const data = await r.json();
        if (!r.ok || !data.ok) throw new Error(data.error || 'Failed to load games');

        if (!data.items.length) {
          grid.innerHTML = '<div class="card">No games found. Put your games under <code>/games/*/index.html</code>.</div>';
          return;
        }

        for (const g of data.items) {
          const div = document.createElement('div');
          div.className = 'game';
          div.innerHTML = `
            <div class="title">${g.icon || 'üéÆ'} ${g.name}</div>
            <div class="desc">${g.description || ''}</div>
            <div class="play">
              <button class="btn" onclick="location.href='/play/${g.id}'">Play</button>
            </div>
          `;
          grid.appendChild(div);
        }
      } catch (e) {
        err.textContent = e.message || 'Server error';
      }
    }

    // --- Ë∑ØÁî±ÈÄªËæë ---
    async function route() {
      await fetchMe();
      const path = location.pathname;

      if (!currentUser) {
        if (path === '/register') {
          show('register');
          return;
        }
        if (path === '/login') {
          show('login');
          return;
        }
        // Êú™ÁôªÂΩïÈªòËÆ§ Landing
        show('landing');
        return;
      }

      // Â∑≤ÁôªÂΩïÔºöÊÄªÊòØÂ±ïÁ§∫ Dashboard
      document.getElementById('helloTitle').textContent = `Welcome, ${currentUser.name}!`;
      document.getElementById('helloSub').textContent = `Level ${currentUser.level} ‚Ä¢ ${currentUser.coins} coins`;
      await loadGames();
      show('dashboard');
    }

    // È¶ñÊ¨°ËøõÂÖ•
    route();
  </script>
</body>
</html>

