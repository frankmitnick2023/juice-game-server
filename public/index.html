<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FunX â€¢ Dance Hero Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg-0:#090a0f;
      --bg-1:#111827;
      --neon-1:#00e5ff;
      --neon-2:#7b61ff;
      --txt:#e6f6ff;
      --muted:#9fb3c8;
      --error:#ff5470;
      --ok:#22d3ee;
      --card:#0c1120;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--txt);
      background: radial-gradient(1200px 700px at 50% 100%, #162033 0%, transparent 70%), radial-gradient(900px 500px at 10% -10%, #10162a 0%, transparent 60%), var(--bg-0);
      overflow-x:hidden;
    }

    /* ----- å…¨å±€æŒ‰é’®/è¾“å…¥ ----- */
    .btn{
      appearance:none;border:0;cursor:pointer;
      padding:12px 16px;border-radius:14px;
      background:#0d1528;color:#dff7ff;font-weight:700;
      border:1px solid #193055;
      transition:transform .08s ease, box-shadow .2s ease, background .2s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.neon{
      background:linear-gradient(90deg, var(--neon-1), var(--neon-2));
      color:#021019;border:none;
      box-shadow:0 0 10px var(--neon-1), 0 0 30px #000 inset;
    }
    .btn.ghost{
      background:transparent;color:#cbe8ff;border:1px solid #2a3f66;
    }
    .input{
      width:100%;padding:12px 14px;border-radius:12px;
      background:#0a1224;color:#e5f2ff;border:1px solid #182b55;
      outline:0;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}

    /* ----- ç™»å½•èˆ±ï¼ˆé¦–å±ï¼‰ ----- */
    .login-stage{
      position:relative;min-height:100dvh;
      display:grid;place-items:center;padding:24px;
      overflow:hidden;
    }
    .rings{
      position:absolute;inset:-10%;
      background:
        radial-gradient(200px 200px at 20% 30%, rgba(123,97,255,.25), transparent 60%),
        radial-gradient(240px 240px at 80% 70%, rgba(0,229,255,.25), transparent 60%);
      filter:blur(10px);
      pointer-events:none;
      animation:slow-pan 18s linear infinite alternate;
    }
    @keyframes slow-pan{
      from{transform:translate3d(0,0,0) scale(1)}
      to{transform:translate3d(0,-2%,0) scale(1.02)}
    }
    .login-card{
      width:min(560px, 92vw);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.2));
      border:1px solid #1e2a4a;
      padding:22px 20px;
      backdrop-filter: blur(8px);
      box-shadow:
        0 0 12px rgba(0,229,255,.25),
        0 0 48px rgba(123,97,255,.12) inset;
      position:relative;
      z-index:1;
      overflow:hidden;
    }
    .login-card::before{
      content:"";
      position:absolute; inset:0; pointer-events:none;
      border-radius:inherit;
      background: radial-gradient(600px 120px at 50% -40px, rgba(0,229,255,.3), transparent 60%);
      mix-blend-mode:screen;
    }
    .brand{
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px;
    }
    .brand .logo{
      font-weight:900;letter-spacing:.5px;font-size:20px;
      display:flex;align-items:center;gap:10px;
    }
    .tiny{
      color:var(--muted);font-size:13px;
    }
    .title{
      font-size:28px;font-weight:800;margin:6px 0 2px;
      text-shadow:0 0 10px rgba(0,229,255,.35);
    }
    .subtitle{color:var(--muted);margin:0 0 14px}
    .panel{
      display:grid;gap:10px
    }
    .error{color:var(--error);min-height:1.4em;font-size:14px}
    .ok{color:#10b981;min-height:1.4em;font-size:14px}

    /* ç™»å½•æŒ‰é’®çš„å‘å…‰è¾¹æ¡†åŠ¨ç”» */
    .glow-wrap{position:relative}
    .glow{
      position:absolute;inset:-2px;border-radius:16px;
      background: conic-gradient(from 0deg, var(--neon-1), var(--neon-2), var(--neon-1));
      filter: blur(12px);opacity:.5;z-index:-1;
      animation: spin 4.5s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ----- ä»ªè¡¨ç›˜ï¼ˆæ¸¸æˆåˆ—è¡¨è§†å›¾ï¼‰ ----- */
    .dashboard{
      display:none;min-height:100dvh;padding:18px 18px 72px;
      max-width:1200px;margin:0 auto;
    }
    .nav{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      margin:10px 0 18px;
    }
    .badge{
      background:#0b1328;border:1px solid #20345e;color:#cfe9ff;
      border-radius:999px;padding:8px 12px;font-size:13px;
    }
    .grid{
      display:grid;gap:16px;grid-template-columns:repeat(auto-fill, minmax(230px,1fr));
    }
    .game{
      background:var(--card);border:1px solid #1e2a4a;border-radius:16px;padding:14px;
      box-shadow:0 6px 28px rgba(0,0,0,.35);
      transition:transform .12s ease, box-shadow .2s ease, border-color .2s ease;
      display:flex;flex-direction:column;gap:8px;
    }
    .game:hover{ transform:translateY(-2px); border-color:#2a4c8a; box-shadow:0 10px 34px rgba(0,0,0,.45)}
    .game .title{font-weight:800}
    .game .desc{color:var(--muted);font-size:14px}
    .footer-note{color:var(--muted);font-size:12px;margin-top:14px}

    /* å…¥åœº/å‡ºåœºåŠ¨ç”» */
    .fade-in{animation:fadeIn .35s ease both}
    .fade-out{animation:fadeOut .25s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    @keyframes fadeOut{from{opacity:1}to{opacity:0;transform:translateY(-6px)}}

    /* å°å±ä¼˜åŒ– */
    @media (max-width:520px){
      .title{font-size:24px}
      .login-card{padding:18px 16px}
    }
  </style>
</head>
<body>

  <!-- ---------- ç™»å½•é¦–å± ---------- -->
  <section id="loginStage" class="login-stage">
    <div class="rings" aria-hidden="true"></div>

    <div class="login-card fade-in" id="loginCard">
      <div class="brand">
        <div class="logo">âš¡ Dance Hero <span class="tiny">by FunX</span></div>
        <button class="btn ghost" onclick="openSignup()">Create account</button>
      </div>
      <h1 class="title">Ready, Dancer?</h1>
      <p class="subtitle">Step into your power. Enter the arena to play.</p>

      <div class="panel">
        <input id="l_email" class="input" placeholder="Email" autocomplete="username" />
        <input id="l_pwd" class="input" placeholder="Password" type="password" autocomplete="current-password" />
        <div id="loginErr" class="error"></div>

        <div class="glow-wrap">
          <div class="glow" aria-hidden="true"></div>
          <button class="btn neon" style="width:100%" onclick="doLogin()">Enter Arena</button>
        </div>

        <button class="btn ghost" onclick="openForgot()">Forgot password?</button>
        <p class="tiny">Tip: You can create a test account with any email. Verification can be enabled later.</p>
      </div>
    </div>
  </section>

  <!-- ---------- ä»ªè¡¨ç›˜ / æ¸¸æˆåˆ—è¡¨ ---------- -->
  <main id="dashboard" class="dashboard">
    <div class="nav">
      <div style="display:flex;align-items:center;gap:10px">
        <div style="font-weight:900;letter-spacing:.5px">ğŸ¹ FunX Game Hub</div>
        <span id="userBadge" class="badge" title="Player status"></span>
      </div>
      <div class="row">
        <button class="btn ghost" onclick="reloadGames()">Refresh</button>
        <button class="btn" onclick="doLogout()">Logout</button>
      </div>
    </div>

    <h2 style="margin:8px 0 6px">Available Games</h2>
    <div id="gamesGrid" class="grid"></div>
    <div id="gamesErr" class="error"></div>
    <div class="footer-note">Put new games into <code>/games/your-game/</code> and refresh.</div>
  </main>

  <!-- ---------- æ³¨å†Œå¼¹çª— ---------- -->
  <dialog id="signupDlg">
    <form method="dialog" style="min-width:min(520px,92vw);background:#0c1120;color:#e6f6ff;border:1px solid #1e2a4a;border-radius:16px;padding:16px">
      <h3 style="margin:0 0 8px">Create account</h3>
      <p class="tiny" style="margin-top:0;color:var(--muted)">Unlock all games and save your progress.</p>
      <div class="row" style="flex-direction:column">
        <input id="r_name" class="input" placeholder="Your name" autocomplete="name" />
        <input id="r_email" class="input" placeholder="Email" autocomplete="email" />
        <input id="r_pwd" class="input" placeholder="Password" type="password" autocomplete="new-password" />
        <div id="r_err" class="error"></div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn ghost" value="cancel">Cancel</button>
          <button class="btn neon" onclick="submitSignup(event)">Create</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- ---------- å¿˜è®°å¯†ç ï¼ˆå ä½ï¼Œåç«¯æ¥å…¥åå¯ç”¨ï¼‰ ---------- -->
  <dialog id="forgotDlg">
    <form method="dialog" style="min-width:min(520px,92vw);background:#0c1120;color:#e6f6ff;border:1px solid #1e2a4a;border-radius:16px;padding:16px">
      <h3 style="margin:0 0 8px">Forgot password</h3>
      <p class="tiny" style="margin-top:0;color:var(--muted)">We can email you a reset link. (To be enabled)</p>
      <div class="row" style="flex-direction:column">
        <input id="f_email" class="input" placeholder="Your email" />
        <div class="row" style="justify-content:flex-end">
          <button class="btn ghost" value="cancel">Close</button>
          <button class="btn" onclick="event.preventDefault(); alert('Password reset flow can be enabled later.');">Send link</button>
        </div>
      </div>
    </form>
  </dialog>

  <script>
    // --------- åŸºç¡€çŠ¶æ€ ---------
    let currentUser = null;

    function showLogin() {
      document.getElementById('loginStage').style.display = 'grid';
      document.getElementById('dashboard').style.display = 'none';
      // é‡ç½®è¡¨å•
      const e = document.getElementById('l_email');
      const p = document.getElementById('l_pwd');
      const err = document.getElementById('loginErr');
      if (e && p) { e.value=''; p.value=''; }
      if (err) err.textContent='';
    }
    function showDashboard() {
      document.getElementById('loginStage').style.display = 'none';
      const dash = document.getElementById('dashboard');
      dash.style.display = 'block';
      dash.classList.remove('fade-out');
      dash.classList.add('fade-in');
    }

    // --------- API ---------
    async function apiMe(){
      try{
        const r = await fetch('/api/me', {credentials:'same-origin'});
        if(!r.ok) return null;
        const d = await r.json();
        if(d && d.ok) return d.user;
      }catch{}
      return null;
    }
    async function apiLogin(email,password){
      const r = await fetch('/api/login',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body:JSON.stringify({email,password})
      });
      return r.json();
    }
    async function apiRegister(name,email,password){
      const r = await fetch('/api/register',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'same-origin',
        body:JSON.stringify({name,email,password})
      });
      return r.json();
    }
    async function apiLogout(){
      try{ await fetch('/api/logout',{method:'POST', credentials:'same-origin'});}catch{}
    }
    async function apiGames(){
      const r = await fetch('/api/games',{credentials:'same-origin'});
      return r.json();
    }

    // --------- UI äº¤äº’ ---------
    async function bootstrap(){
      // å¦‚æœå·²ç™»å½•ï¼Œç›´æ¥è¿›ä»ªè¡¨ç›˜
      currentUser = await apiMe();
      if(currentUser){
        await enterArenaAnimation(true);
        await renderDashboard();
        return;
      }
      showLogin();
    }

    async function doLogin(){
      const email = document.getElementById('l_email').value.trim();
      const pwd = document.getElementById('l_pwd').value;
      const err = document.getElementById('loginErr'); err.textContent='';
      try{
        const data = await apiLogin(email,pwd);
        if(!data.ok) throw new Error(data.error || 'Login failed');
        currentUser = await apiMe();
        await enterArenaAnimation();
        await renderDashboard();
      }catch(e){
        err.textContent = e.message || 'Server error';
      }
    }

    async function doLogout(){
      await apiLogout();
      currentUser = null;
      // é€€åœºåŠ¨ç”»
      const dash = document.getElementById('dashboard');
      dash.classList.remove('fade-in'); dash.classList.add('fade-out');
      setTimeout(()=>{ showLogin(); }, 220);
    }

    function openSignup(){ document.getElementById('signupDlg').showModal(); }
    function openForgot(){ document.getElementById('forgotDlg').showModal(); }

    async function submitSignup(ev){
      ev.preventDefault();
      const name = document.getElementById('r_name').value.trim();
      const email = document.getElementById('r_email').value.trim();
      const pwd = document.getElementById('r_pwd').value;
      const err = document.getElementById('r_err'); err.textContent='';
      try{
        const data = await apiRegister(name,email,pwd);
        if(!data.ok) throw new Error(data.error || 'Register failed');
        document.getElementById('signupDlg').close();
        // æ³¨å†Œåç›´æ¥ç™»å½•æ€å·²å»ºç«‹ï¼ˆåç«¯è®¾ç½®äº† sessionï¼‰
        currentUser = await apiMe();
        await enterArenaAnimation();
        await renderDashboard();
      }catch(e){
        err.textContent = e.message || 'Server error';
      }
    }

    // è¿›å…¥ç«æŠ€åœºåŠ¨ç”»ï¼šæŒ‰é’®ç‚¹å‡»â†’èˆ±é—¨äº®èµ·â†’è¿‡æ¸¡åˆ°ä»ªè¡¨ç›˜
    async function enterArenaAnimation(skipBtnBounce){
      const card = document.getElementById('loginCard');
      if(!card) return;
      if(!skipBtnBounce){
        card.animate(
          [
            {transform:'translateY(0)', filter:'none'},
            {transform:'translateY(-4px)', filter:'brightness(1.1)'},
            {transform:'translateY(0)', filter:'none'}
          ],
          {duration:260, easing:'ease-out'}
        );
      }
      await wait(140);
      // æ·¡å‡ºç™»å½•å¡ç‰‡
      card.classList.remove('fade-in');
      card.classList.add('fade-out');
      await wait(220);
      showDashboard();
    }

    function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }

    async function renderDashboard(){
      if(!currentUser){ showLogin(); return; }
      // é¡¶éƒ¨å¾½ç« 
      const badge = document.getElementById('userBadge');
      badge.textContent = `${currentUser.name} â€¢ Lv.${currentUser.level ?? 1} â€¢ ${currentUser.coins ?? 0}ğŸ’°`;

      // åŠ è½½æ¸¸æˆ
      await reloadGames();
    }

    async function reloadGames(){
      const grid = document.getElementById('gamesGrid');
      const err = document.getElementById('gamesErr');
      grid.innerHTML=''; err.textContent='';

      try{
        const data = await apiGames();
        if(!data.ok) throw new Error(data.error || 'Failed to load games');

        if(!data.items || !data.items.length){
          grid.innerHTML = `<div class="game"><div class="title">No games found</div>
            <div class="desc">Put html games under <code>/games/&lt;folder&gt;/</code> then refresh.</div></div>`;
          return;
        }

        for(const g of data.items){
          const el = document.createElement('div');
          el.className = 'game';
          el.innerHTML = `
            <div class="title">${g.icon || 'ğŸ®'} ${escapeHtml(g.name)}</div>
            <div class="desc">${escapeHtml(g.description || '')}</div>
            <div style="margin-top:auto">
              <button class="btn neon" style="width:100%" onclick="location.href='/play/${g.id}'">Play</button>
            </div>
          `;
          grid.appendChild(el);
        }
      }catch(e){
        err.textContent = e.message || 'Server error';
      }
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // å¯åŠ¨
    bootstrap();
  </script>
</body>
</html>

