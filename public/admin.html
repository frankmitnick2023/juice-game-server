<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard</title>
  <style>
    body{font-family:'Segoe UI', sans-serif;margin:0;background:#f2f4f8;padding-bottom:4rem}
    
    /* Header & Nav */
    .header{background:#2c3e50;color:white;padding:1rem;position:sticky;top:0;z-index:1000;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
    .nav-tabs{display:flex;gap:20px}
    .nav-tab{cursor:pointer;opacity:0.6;font-weight:bold;padding-bottom:5px;transition:0.3s;color:white;text-decoration:none}
    .nav-tab.active{opacity:1;border-bottom:3px solid #e94560}
    
    .container{padding:15px;max-width:1400px;margin:0 auto} /* Wider container for calendar */
    
    .tab-content-card {background:white; padding:20px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); margin-bottom:20px; min-height:600px;}

    /* === Calendar Toolbar === */
    .cal-toolbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:10px; }
    .cal-date-display { font-size:1.5rem; font-weight:bold; color:#333; }
    .cal-toggles button { padding:8px 16px; border:1px solid #ddd; background:white; cursor:pointer; font-weight:bold; }
    .cal-toggles button.active { background:#2c3e50; color:white; border-color:#2c3e50; }

    /* === Calendar Grid System === */
    .calendar-wrapper { display: flex; position: relative; height: 800px; overflow-y: auto; border: 1px solid #eee; background:white; }
    
    /* Time Axis (Left) */
    .time-axis { width: 60px; flex-shrink: 0; border-right: 1px solid #eee; background: #fafafa; }
    .time-slot { height: 60px; border-bottom: 1px solid #eee; font-size: 0.75rem; color: #999; text-align: center; padding-top: 5px; box-sizing: border-box; }

    /* Event Grid (Main) */
    .event-grid { flex-grow: 1; position: relative; background: white; }
    
    /* Grid Lines */
    .grid-lines { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; }
    .grid-line-h { height: 60px; border-bottom: 1px dashed #f0f0f0; box-sizing: border-box; }
    
    /* Column Headers for Week View */
    .day-headers { display: flex; margin-left: 60px; border-bottom: 1px solid #ddd; background: white; position: sticky; top: 0; z-index: 10; }
    .day-header-cell { flex: 1; text-align: center; padding: 10px; font-weight: bold; border-right: 1px solid #eee; background:#f8f9fa; }

    /* Class Events Blocks (Overlay) */
    .class-event {
        position: absolute;
        width: 13%; /* Approx 1/7th with gap */
        border-radius: 4px;
        padding: 4px 6px;
        font-size: 0.7rem;
        color: #fff;
        overflow: hidden;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        border-left: 4px solid rgba(0,0,0,0.2);
        z-index: 2;
        transition: 0.1s;
        line-height: 1.2;
    }
    .class-event:hover { z-index: 10; transform: scale(1.02); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    
    /* Color Coding */
    .evt-rad { background: #64b5f6; border-color: #1976d2; color: #0d47a1; }
    .evt-jazz { background: #ffb74d; border-color: #f57c00; color: #e65100; }
    .evt-hiphop { background: #ba68c8; border-color: #7b1fa2; color: #4a148c; }
    .evt-kpop { background: #f06292; border-color: #c2185b; color: #880e4f; }
    .evt-other { background: #90a4ae; border-color: #455a64; color: #263238; }

    /* Red Line (Current Time) */
    .red-line {
        position: absolute; left: 0; width: 100%; height: 2px; background: red;
        z-index: 20; pointer-events: none; display:none;
    }
    .red-line::before {
        content: ''; position: absolute; left: -6px; top: -4px; width: 10px; height: 10px; background: red; border-radius: 50%;
    }

    /* Other Tab Styles (Simple) */
    .form-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:15px; }
    input, select { width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; }
    .btn-add { background:#27ae60; color:white; border:none; padding:10px; width:100%; cursor:pointer; }
    
    /* Modal */
    .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
    .modal-box { background: white; width: 500px; padding: 20px; border-radius: 10px; max-height:80vh; overflow-y:auto; }
    .student-row { padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; }
    .paid { color:green; font-weight:bold; } .unpaid { color:red; font-weight:bold; }
  </style>
</head>
<body>

<div class="header">
  <div>ADMIN</div>
  <div class="nav-tabs">
    <div class="nav-tab" onclick="switchTab('courses')" id="tabBtnCourses">Courses</div>
    <div class="nav-tab" onclick="switchTab('reviews')" id="tabBtnReviews">üèÜ Reviews</div>
    <div class="nav-tab" onclick="switchTab('invoices')" id="tabBtnInvoices">üìö Bookings</div>
    <div class="nav-tab active" onclick="switchTab('checkin')" id="tabBtnCheckin">‚úÖ Check In</div>
  </div>
</div>

<div id="tabCheckin" class="container">
    <div class="tab-content-card" style="padding: 0; overflow: hidden;">
        <div class="cal-toolbar" style="padding: 15px 20px;">
            <div class="cal-date-display" id="calTitle">Weekly Schedule</div>
            <div class="cal-toggles">
                <button onclick="location.reload()">Refresh</button>
            </div>
        </div>

        <div class="day-headers" id="weekHeaders">
            </div>

        <div class="calendar-wrapper" id="calWrapper">
            <div class="time-axis" id="timeAxis"></div>
            
            <div class="event-grid" id="eventGrid">
                <div class="grid-lines" id="gridLines"></div>
                <div id="redLine" class="red-line"></div>
                </div>
        </div>
    </div>
</div>

<div id="tabCourses" class="container" style="display:none">
    <div class="tab-content-card" style="padding:20px"><h3>Course Manager</h3><p>Use filters above to manage list.</p></div>
</div>
<div id="tabReviews" class="container" style="display:none"><h3>Reviews</h3></div>
<div id="tabInvoices" class="container" style="display:none"><h3>Bookings</h3></div>

<div id="checkInModal" class="modal-overlay">
    <div class="modal-box">
        <h3 id="modalTitle">Class Check-In</h3>
        <div id="modalContent">Loading...</div>
        <button onclick="document.getElementById('checkInModal').style.display='none'" style="width:100%;padding:10px;margin-top:10px">Close</button>
    </div>
</div>

<script>
    const START_HOUR = 9; // 9:00 AM
    const END_HOUR = 21;  // 9:00 PM
    const PIXELS_PER_HOUR = 60; 
    const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    let scheduleData = {};

    // Init
    setupGridBackground();
    setupRedLine();
    fetchSchedule();
    switchTab('checkin'); // Default to CheckIn

    function switchTab(t) {
        document.querySelectorAll('.container').forEach(el => el.style.display = 'none');
        document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).style.display = 'block';
        document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
        document.getElementById('tabBtn'+t.charAt(0).toUpperCase()+t.slice(1)).classList.add('active');
        
        // Lazy load logic for other tabs (omitted for brevity, focus on CheckIn UI)
    }

    function setupGridBackground() {
        const axis = document.getElementById('timeAxis');
        const lines = document.getElementById('gridLines');
        const headers = document.getElementById('weekHeaders');
        
        axis.innerHTML = ''; lines.innerHTML = ''; headers.innerHTML = '';
        
        for (let h = START_HOUR; h <= END_HOUR; h++) {
            axis.innerHTML += `<div class="time-slot">${h}:00</div>`;
            lines.innerHTML += `<div class="grid-line-h"></div>`;
        }

        DAYS.forEach(d => {
            headers.innerHTML += `<div class="day-header-cell">${d.substring(0,3)}</div>`;
        });
    }

    function setupRedLine() {
        const updateLine = () => {
            const now = new Date();
            // Adjust for NZ timezone if server is elsewhere, but for UI simplicity using local
            const currentHour = now.getHours() + now.getMinutes() / 60;
            
            if (currentHour >= START_HOUR && currentHour <= END_HOUR) {
                const offset = (currentHour - START_HOUR) * PIXELS_PER_HOUR;
                document.getElementById('redLine').style.top = `${offset}px`;
                document.getElementById('redLine').style.display = 'block';
            }
        };
        updateLine();
        setInterval(updateLine, 60000);
    }

    async function fetchSchedule() {
        try {
            const res = await fetch('/api/admin/check-in/weekly-schedule');
            scheduleData = await res.json();
            renderEvents();
        } catch(e) { console.error(e); }
    }

    function renderEvents() {
        const grid = document.getElementById('eventGrid');
        // Clear old events only (keep grid lines)
        Array.from(document.querySelectorAll('.class-event')).forEach(e => e.remove());

        DAYS.forEach((day, index) => {
            if (!scheduleData[day]) return;
            
            // Calculate column position (approx 14.28% per day)
            const colWidth = 100 / 7;
            const leftOffset = index * colWidth;

            scheduleData[day].forEach(c => {
                // Parse time (16:00 -> 16.0)
                const [sH, sM] = c.start_time.split(':').map(Number);
                const [eH, eM] = c.end_time.split(':').map(Number);
                
                const startVal = sH + sM/60;
                const endVal = eH + eM/60;

                const top = (startVal - START_HOUR) * PIXELS_PER_HOUR;
                const height = (endVal - startVal) * PIXELS_PER_HOUR;

                // Color logic
                let colorClass = 'evt-other';
                const name = c.name.toLowerCase();
                if (name.includes('ballet') || name.includes('rad')) colorClass = 'evt-rad';
                else if (name.includes('jazz')) colorClass = 'evt-jazz';
                else if (name.includes('hiphop')) colorClass = 'evt-hiphop';
                else if (name.includes('k-pop')) colorClass = 'evt-kpop';

                const el = document.createElement('div');
                el.className = `class-event ${colorClass}`;
                el.style.top = `${top}px`;
                el.style.height = `${height - 2}px`;
                el.style.left = `${leftOffset}%`;
                el.style.width = `${colWidth - 1}%`; // -1% for gap
                
                // Content
                el.innerHTML = `
                    <div style="font-weight:bold; white-space:nowrap; overflow:hidden">${c.name}</div>
                    <div>${c.start_time}</div>
                    <div style="font-size:0.65rem; display:flex; justify-content:space-between">
                        <span>${c.classroom.replace('Classroom','C').replace('Studio','S')}</span>
                        <span>üë• ${c.enrolled_count || 0}/16</span>
                    </div>
                `;
                
                el.onclick = () => loadClassList(c.id, c.name);
                grid.appendChild(el);
            });
        });
    }

    async function loadClassList(id, name) {
        document.getElementById('modalTitle').textContent = name;
        document.getElementById('checkInModal').style.display = 'flex';
        const content = document.getElementById('modalContent');
        content.innerHTML = 'Loading...';
        
        const res = await fetch(`/api/admin/check-in/class-list/${id}`);
        const students = await res.json();
        
        if(students.length === 0) {
            content.innerHTML = 'No students enrolled.';
            return;
        }
        
        let html = '';
        students.forEach(s => {
            const isPaid = s.payment_status === 'PAID';
            html += `
                <div class="student-row">
                    <div>
                        <div>${s.student_name}</div>
                        <div style="font-size:0.8rem; color:${isPaid?'green':'red'}">${s.payment_status}</div>
                    </div>
                    <div>
                        <button onclick="markPresent(${s.user_id}, ${id})">‚úÖ</button>
                    </div>
                </div>
            `;
        });
        content.innerHTML = html;
    }
    
    function markPresent(uid, cid) {
        alert('Marked Present (Mock)');
    }
</script>
</body>
</html>