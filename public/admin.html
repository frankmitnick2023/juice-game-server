<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WE DANCE æ•™åŠ¡åå°</title>
  <style>
    body{font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin:0; background:#f2f4f8; padding-bottom:4rem}
    .header{background:#333;color:white;padding:1rem;position:sticky;top:0;z-index:100}
    
    /* æ˜ŸæœŸæ  */
    .day-tabs {display:flex;overflow-x:auto;background:white;padding:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05)}
    .day-tab {flex:0 0 auto;padding:6px 14px;margin-right:8px;border-radius:15px;background:#f0f0f0;color:#666;font-weight:bold;font-size:0.9rem;cursor:pointer}
    .day-tab.active {background:#333;color:white}

    .container{padding:15px}
    .class-card{background:white;border-radius:10px;padding:15px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,0.05);border-left:5px solid #333;cursor:pointer;position:relative}
    .c-time{font-weight:bold;color:#333;font-size:1.1rem}
    .c-name{font-size:1rem;color:#555;margin:5px 0}
    .c-badge{position:absolute;right:15px;top:20px;background:#e8f5e9;color:#2e7d32;padding:4px 10px;border-radius:10px;font-weight:bold;font-size:0.9rem}

    /* å¼¹çª— */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:200;flex-direction:column}
    .m-header{padding:15px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;background:#fff}
    .m-body{flex:1;overflow-y:auto;padding:15px}
    .m-close{font-size:2rem;cursor:pointer;padding:0 10px}

    .student-row{display:flex;justify-content:space-between;align-items:center;padding:15px 0;border-bottom:1px solid #f5f5f5}
    .s-info{flex:1}
    .s-tag{background:#e3f2fd;color:#1976d2;padding:1px 5px;border-radius:4px;font-size:0.7rem;margin-left:5px}
    .s-makeup{background:#fff3e0;color:#ef6c00}

    .btn-group{display:flex;gap:5px}
    .btn{border:none;padding:8px 12px;border-radius:6px;font-weight:bold;cursor:pointer;font-size:0.9rem}
    .btn-check{background:#4CAF50;color:white}
    .btn-absent{background:#ff9800;color:white}
    .btn-disabled{background:#ddd;color:#999;cursor:not-allowed}
    
    .time-warning{background:#ffebee;color:#c62828;padding:10px;text-align:center;font-size:0.9rem;display:none}
  </style>
</head>
<body>

<div class="header">
  <div>ğŸ“ æ•™åŠ¡ç®¡ç†ç³»ç»Ÿ</div>
</div>

<div class="day-tabs" id="dayTabs"></div>
<div class="container" id="classList"></div>

<div id="rollCallModal" class="modal">
    <div class="m-header">
        <div>
            <h3 id="mTitle" style="margin:0">è¯¾ç¨‹å</h3>
            <div id="mTime" style="font-size:0.8rem;color:#666">16:00 - 17:00</div>
        </div>
        <div class="m-close" onclick="closeModal()">Ã—</div>
    </div>
    <div id="timeWarning" class="time-warning">âš ï¸ æœªåˆ°ä¸Šè¯¾æ—¶é—´ï¼Œç­¾åˆ°åŠŸèƒ½å·²é”å®š (è¯·äºè¯¾å‰30åˆ†é’Ÿæ“ä½œ)</div>
    <div class="m-body" id="mList"></div>
</div>

<script>
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  let allCourses = [];
  // è·å–ä»Šå¤©æ˜¯å‘¨å‡  (ä¾‹å¦‚ "Friday")
  const todayIndex = new Date().getDay(); 
  const todayName = days[todayIndex === 0 ? 6 : todayIndex - 1]; // ä¿®æ­£ JS getDay 0=å‘¨æ—¥
  let currentDay = todayName;

  async function init() {
      const tabs = document.getElementById('dayTabs');
      days.forEach(d => {
          const div = document.createElement('div');
          div.className = `day-tab ${d===currentDay?'active':''}`;
          div.textContent = d.substring(0,3);
          div.onclick = () => switchDay(d, div);
          tabs.appendChild(div);
      });

      const res = await fetch('/api/teacher/schedule');
      allCourses = await res.json();
      renderClasses();
  }

  function switchDay(day, el) {
      currentDay = day;
      document.querySelectorAll('.day-tab').forEach(t=>t.classList.remove('active'));
      el.classList.add('active');
      renderClasses();
  }

  function renderClasses() {
      const list = document.getElementById('classList');
      list.innerHTML = '';
      const todayClasses = allCourses.filter(c => c.day_of_week === currentDay);
      
      if(todayClasses.length === 0) {
          list.innerHTML = '<p style="text-align:center;color:#999;margin-top:50px">ä»Šæ—¥æ— è¯¾ç¨‹</p>';
          return;
      }

      // æŒ‰æ—¶é—´æ’åº
      todayClasses.sort((a,b) => a.start_time.localeCompare(b.start_time));

      todayClasses.forEach(c => {
          const div = document.createElement('div');
          div.className = 'class-card';
          div.innerHTML = `
            <div class="c-time">${c.start_time} - ${c.end_time}</div>
            <div class="c-name">${c.name}</div>
            <div class="c-meta">ğŸ‘¨â€ğŸ« ${c.teacher}</div>
            <div class="c-badge">${c.student_count || 0}äººæŠ¥å</div>
          `;
          div.onclick = () => openRollCall(c);
          list.appendChild(div);
      });
  }

  async function openRollCall(course) {
      document.getElementById('rollCallModal').style.display = 'flex';
      document.getElementById('mTitle').textContent = course.name;
      document.getElementById('mTime').textContent = `${course.start_time} - ${course.end_time}`;
      
      // === æ ¸å¿ƒé€»è¾‘ï¼šæ£€æŸ¥æ—¶é—´é” ===
      // è§„åˆ™ï¼šå¿…é¡»æ˜¯ å½“å¤©ï¼Œä¸” å½“å‰æ—¶é—´ > å¼€å§‹æ—¶é—´ - 30åˆ†é’Ÿ
      const now = new Date();
      const currentDayName = days[now.getDay() === 0 ? 6 : now.getDay() - 1];
      const [sH, sM] = course.start_time.split(':').map(Number);
      
      const classTime = new Date();
      classTime.setHours(sH, sM, 0);
      // å…è®¸æå‰ 30 åˆ†é’Ÿ
      const unlockTime = new Date(classTime.getTime() - 30 * 60000);
      
      let isLocked = false;
      // å¦‚æœä¸æ˜¯ä»Šå¤©ï¼Œæˆ–è€…è¿˜æ²¡åˆ°æ—¶é—´
      if (currentDayName !== course.day_of_week) {
          isLocked = true;
      } else if (now < unlockTime) {
          isLocked = true;
      }
      
      // ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œæ‚¨å¯ä»¥æš‚æ—¶æ³¨é‡Šæ‰ä¸‹é¢è¿™è¡Œï¼Œå¦åˆ™éå‘¨äº”æ— æ³•æµ‹è¯•
      // isLocked = false; // <--- è°ƒè¯•å¼€å…³

      const warning = document.getElementById('timeWarning');
      warning.style.display = isLocked ? 'block' : 'none';
      if (currentDayName !== course.day_of_week) warning.textContent = `âš ï¸ è¿™ä¸æ˜¯ä»Šå¤©çš„è¯¾ç¨‹ï¼Œæ— æ³•ç­¾åˆ°`;

      // åŠ è½½åå•
      const list = document.getElementById('mList');
      list.innerHTML = 'åŠ è½½ä¸­...';
      const res = await fetch(`/api/teacher/bookings/${course.id}`);
      const students = await res.json();

      list.innerHTML = '';
      if(students.length === 0) {
          list.innerHTML = '<p style="text-align:center;color:#999">æš‚æ— æŠ¥å</p>'; return;
      }

      students.forEach(s => {
          const isDone = s.status === 'attended' || s.status === 'absent'; // å·²å¤„ç†
          const isMakeup = s.is_makeup; // æ˜¯å¦è¡¥è¯¾ç”Ÿ
          
          const div = document.createElement('div');
          div.className = 'student-row';
          div.innerHTML = `
            <div class="s-info">
                <div style="font-weight:bold">${s.student_name} 
                    ${isMakeup ? '<span class="s-tag s-makeup">ğŸ”µ è¡¥è¯¾</span>' : '<span class="s-tag">âšªï¸ æ­£è¯¾</span>'}
                </div>
                <div style="font-size:0.8rem;color:#888">${s.selected_dates || 'æ•´å­¦æœŸ'}</div>
            </div>
            <div class="btn-group">
                <button class="btn ${isDone||isLocked ? 'btn-disabled' : 'btn-check'}" 
                    onclick="takeAction(${s.id}, ${course.id}, 'present', this)" 
                    ${isDone||isLocked ? 'disabled' : ''}>
                    åˆ°
                </button>
                <button class="btn ${isDone||isLocked ? 'btn-disabled' : 'btn-absent'}" 
                    onclick="takeAction(${s.id}, ${course.id}, 'absent', this)" 
                    ${isDone||isLocked ? 'disabled' : ''}>
                    ç¼º
                </button>
            </div>
          `;
          list.appendChild(div);
      });
  }

  function closeModal() { document.getElementById('rollCallModal').style.display = 'none'; }

  async function takeAction(bid, cid, action, btn) {
      if(!confirm(action==='present' ? 'ç¡®è®¤åˆ°è¯¾ï¼Ÿ' : 'ç¡®è®¤ç¼ºå‹¤ï¼Ÿ\nç³»ç»Ÿå°†è‡ªåŠ¨å‘æ”¾è¡¥è¯¾é¢åº¦ã€‚')) return;
      
      const res = await fetch('/api/teacher/action', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({bookingId:bid, courseId:cid, action})
      });
      
      if(res.ok) {
          alert(action==='present' ? 'âœ… å·²ç­¾åˆ°' : 'âš ï¸ å·²æ ‡è®°ç¼ºå‹¤ï¼Œè¡¥è¯¾é¢åº¦+1');
          // åˆ·æ–°é¡µé¢æˆ–ç¦ç”¨æŒ‰é’®
          openRollCall({id:cid, name:document.getElementById('mTitle').textContent, start_time:document.getElementById('mTime').textContent.split(' - ')[0]}); // ç®€å•ç²—æš´é‡è½½
      } else {
          alert('æ“ä½œå¤±è´¥');
      }
  }

  init();
</script>
</body>
</html>