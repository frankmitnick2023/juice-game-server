<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard</title>
  <style>
    body{font-family:'Segoe UI', sans-serif;margin:0;background:#f2f4f8;padding-bottom:4rem}
    
    /* Header & Nav */
    .header{background:#2c3e50;color:white;padding:1rem;position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
    .nav-tabs{display:flex;gap:20px}
    .nav-tab{cursor:pointer;opacity:0.6;font-weight:bold;padding-bottom:5px;transition:0.3s;color:white;text-decoration:none}
    .nav-tab.active{opacity:1;border-bottom:3px solid #e94560}
    
    .container{padding:15px;max-width:1000px;margin:0 auto}

    /* === 1. Course Manager Styles === */
    .form-card {background:white; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.05); margin-bottom:20px}
    .form-grid {display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px; margin-bottom:15px}
    input, select {width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box}
    label {font-size:0.8rem; color:#666; font-weight:bold; display:block; margin-bottom:5px}
    .btn-add {background:#27ae60; color:white; border:none; padding:12px 25px; border-radius:6px; font-weight:bold; cursor:pointer; width:100%}
    
    .list-card {background:white; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.05)}
    table {width:100%; border-collapse:collapse}
    th {text-align:left; padding:10px; border-bottom:2px solid #eee; color:#888; font-size:0.85rem}
    td {padding:12px 10px; border-bottom:1px solid #eee; font-size:0.9rem}
    .btn-del {background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer}

    /* === 2. Trophy Review Styles (New) === */
    .review-card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 5px solid #e94560; }
    .r-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; color:#2c3e50; font-size:1.1rem; }
    
    .r-gallery { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; }
    .r-main-img { height: 200px; width: auto; border-radius: 8px; border: 2px solid #e94560; cursor: zoom-in; }
    .r-extra-img { height: 80px; width: auto; border-radius: 6px; opacity: 0.7; cursor: zoom-in; transition: 0.2s; border: 1px solid #ddd; }
    .r-extra-img:hover { opacity: 1; }

    .action-area { background:#f8f9fa; padding:15px; border-radius:8px; }
    .btn-row { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .btn-audit { flex: 1; min-width: 80px; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: #333; transition: 0.2s; display:flex; align-items:center; justify-content:center; gap:5px; }
    .btn-audit:hover { transform:translateY(-2px); box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    
    .btn-gold { background: #ffd700; } 
    .btn-silver { background: #e0e0e0; } 
    .btn-bronze { background: #cd7f32; color: white; } 
    .btn-medal { background: #fff; border: 2px solid #ffd700; color:#d4af37; }
    .btn-cert { background: #fff; border: 1px solid #999; color: #666; }
    .btn-reject { background: #ff4757; color: white; flex: 0 0 auto; }

  </style>
</head>
<body>

<div class="header">
  <div>ADMIN</div>
  <div class="nav-tabs">
    <div class="nav-tab active" onclick="switchTab('courses')" id="tabBtnCourses">Courses</div>
    <div class="nav-tab" onclick="switchTab('reviews')" id="tabBtnReviews">üèÜ Reviews</div>
  </div>
</div>

<div id="tabCourses" class="container">
    <div class="form-card">
        <h3 style="margin-top:0">Add New Course</h3>
        <div class="form-grid">
            <div><label>Name</label><input type="text" id="cName" placeholder="e.g. RAD Grade 5"></div>
            <div>
                <label>Day</label>
                <select id="cDay">
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                </select>
            </div>
            <div><label>Start</label><input type="time" id="cStart" value="16:00"></div>
            <div><label>End</label><input type="time" id="cEnd" value="17:00"></div>
            <div><label>Teacher</label><input type="text" id="cTeacher" placeholder="e.g. Demi"></div>
            <div>
                <label>Room</label>
                <select id="cRoom">
                    <option value="Classroom 1">Studio 1</option>
                    <option value="Classroom 2">Studio 2</option>
                    <option value="Classroom 3">Studio 3</option>
                    <option value="Classroom 4">Studio 4</option>
                    <option value="Classroom 5">Studio 5</option>
                    <option value="Classroom 6">Studio 6</option>
                    <option value="Classroom 7">Studio 7</option>
                    <option value="Yoga Room">Yoga Room</option>
                </select>
            </div>
            <div><label>Age</label><input type="text" id="cAge" placeholder="9-11"></div>
        </div>
        <button class="btn-add" onclick="addCourse()">‚ûï Add Course</button>
    </div>

    <div class="list-card">
        <h3>Course List</h3>
        <table>
            <thead><tr><th>Day</th><th>Time</th><th>Room</th><th>Name</th><th>Teacher</th><th>Age</th><th>Action</th></tr></thead>
            <tbody id="courseTable"><tr><td colspan="7">Loading...</td></tr></tbody>
        </table>
    </div>
</div>

<div id="tabReviews" class="container" style="display:none">
    <div id="pendingList">Loading...</div>
</div>

<script>
  function switchTab(t) {
      document.getElementById('tabCourses').style.display = t==='courses'?'block':'none';
      document.getElementById('tabReviews').style.display = t==='reviews'?'block':'none';
      document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
      document.getElementById(t==='courses'?'tabBtnCourses':'tabBtnReviews').classList.add('active');
      
      if(t==='courses') loadCourses();
      else loadReviews();
  }

  // --- Course Logic ---
  async function loadCourses() {
      try {
          const res = await fetch('/api/admin/all-courses');
          const data = await res.json();
          const tbody = document.getElementById('courseTable');
          tbody.innerHTML = '';
          data.forEach(c => {
              tbody.innerHTML += `
                <tr>
                    <td><b>${c.day_of_week}</b></td>
                    <td>${c.start_time}</td>
                    <td>${c.classroom}</td>
                    <td>${c.name}</td>
                    <td>${c.teacher}</td>
                    <td>${c.age_group}</td>
                    <td><button class="btn-del" onclick="deleteCourse(${c.id})">Del</button></td>
                </tr>`;
          });
      } catch(e) { console.error(e); }
  }

  async function addCourse() {
      const payload = {
          name: document.getElementById('cName').value,
          day: document.getElementById('cDay').value,
          start: document.getElementById('cStart').value,
          end: document.getElementById('cEnd').value,
          teacher: document.getElementById('cTeacher').value,
          price: 230,
          classroom: document.getElementById('cRoom').value,
          age: document.getElementById('cAge').value
      };
      if(!payload.name) return alert('Name required');
      await fetch('/api/admin/courses', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      loadCourses();
      alert('Added!');
  }

  async function deleteCourse(id) {
      if(!confirm('Delete?')) return;
      await fetch(`/api/admin/courses/${id}`, {method:'DELETE'});
      loadCourses();
  }

  // --- Trophy Review Logic ---
  async function loadReviews() {
      const list = document.getElementById('pendingList');
      list.innerHTML = '<div style="text-align:center;margin-top:20px">Loading...</div>';

      try {
          const res = await fetch('/api/admin/trophies/pending');
          const data = await res.json();
          
          if(data.length === 0) {
              list.innerHTML = '<div style="text-align:center;color:#999;margin-top:30px;font-size:1.2rem">‚úÖ All caught up! No pending reviews.</div>';
              return;
          }

          list.innerHTML = '';
          data.forEach(item => {
              let extrasHtml = '';
              if(item.extra_images && item.extra_images.length > 0) {
                  extrasHtml = item.extra_images.map(url => `<img src="${url}" class="r-extra-img" onclick="window.open(this.src)">`).join('');
              }

              const div = document.createElement('div');
              div.className = 'review-card';
              div.innerHTML = `
                <div class="r-header">
                    <span>üë§ Student: ${item.student_name || 'Unknown'}</span>
                    <span style="color:#999;font-weight:normal;font-size:0.9rem">${new Date(item.created_at).toLocaleDateString()}</span>
                </div>
                
                <div class="r-gallery">
                    <div style="text-align:center;margin-right:10px">
                        <img src="${item.image_path}" class="r-main-img" onclick="window.open(this.src)">
                        <div style="font-size:0.8rem;color:#e94560;font-weight:bold">Main Certificate</div>
                    </div>
                    ${extrasHtml}
                </div>

                <div class="action-area">
                    <label style="margin-bottom:5px">Award Title (ÊØîËµõ/Â•ñÈ°πÂêçÁß∞):</label>
                    <input type="text" id="awardName-${item.id}" value="${item.source_name || 'Competition Award'}" style="margin-bottom:10px">
                    
                    <div style="font-size:0.8rem;color:#666;margin-bottom:5px">Select Trophy Level to Approve:</div>
                    <div class="btn-row">
                        <button class="btn-audit btn-gold" onclick="audit(${item.id}, 'gold')">üèÜ Gold Trophy</button>
                        <button class="btn-audit btn-silver" onclick="audit(${item.id}, 'silver')">ü•à Silver Trophy</button>
                        <button class="btn-audit btn-bronze" onclick="audit(${item.id}, 'bronze')">ü•â Bronze Trophy</button>
                    </div>
                    <div class="btn-row">
                        <button class="btn-audit btn-medal" onclick="audit(${item.id}, 'medal_gold')">ü•á Gold Medal</button>
                        <button class="btn-audit btn-medal" onclick="audit(${item.id}, 'medal_silver')">ü•à Silver Medal</button>
                        <button class="btn-audit btn-cert" onclick="audit(${item.id}, 'certificate')">üìú Certificate</button>
                        <button class="btn-audit btn-reject" onclick="audit(${item.id}, 'reject')">‚ùå Reject</button>
                    </div>
                </div>
              `;
              list.appendChild(div);
          });
      } catch(e) { list.innerHTML = 'Error loading reviews'; }
  }

  async function audit(id, type) {
      if(!confirm(`Confirm ${type === 'reject' ? 'REJECT' : 'APPROVE'}?`)) return;
      
      const nameInput = document.getElementById(`awardName-${id}`);
      const sourceName = nameInput ? nameInput.value : 'Award';

      try {
          await fetch('/api/admin/trophies/approve', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({ trophyId: id, action: type==='reject'?'reject':'approve', type, sourceName })
          });
          alert('Processed!');
          loadReviews(); // Refresh list
      } catch(e) { alert('Error processing'); }
  }

  // Init
  loadCourses();
</script>
</body>
</html>