<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard</title>
  <style>
    body{font-family:'Segoe UI', sans-serif;margin:0;background:#f2f4f8;padding-bottom:4rem}
    
    /* Header & Nav */
    .header{background:#2c3e50;color:white;padding:1rem;position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
    .nav-tabs{display:flex;gap:20px}
    .nav-tab{cursor:pointer;opacity:0.6;font-weight:bold;padding-bottom:5px;transition:0.3s;color:white;text-decoration:none}
    .nav-tab.active{opacity:1;border-bottom:3px solid #e94560}
    
    .container{padding:15px;max-width:1000px;margin:0 auto}
    
    /* Tabs Content */
    .tab-content-card {background:white; padding:20px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.05); margin-bottom:20px}
    table {width:100%; border-collapse:collapse}
    th {text-align:left; padding:10px; border-bottom:2px solid #eee; color:#888; font-size:0.85rem}
    td {padding:12px 10px; border-bottom:1px solid #eee; font-size:0.9rem}

    /* === Course Manager Styles === */
    .form-grid {display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px; margin-bottom:15px}
    input, select {width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box}
    label {font-size:0.8rem; color:#666; font-weight:bold; display:block; margin-bottom:5px}
    .btn-add {background:#27ae60; color:white; border:none; padding:12px 25px; border-radius:6px; font-weight:bold; cursor:pointer; width:100%}
    .btn-del {background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer}

    /* === Filters Styles === */
    .filter-bar {display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px; padding:10px 0; border-bottom:1px solid #eee;}
    .filter-control {flex:1; min-width:120px;}
    .filter-control select {padding:8px 10px; font-size:0.9rem; border:1px solid #ccc;}

    /* === Invoice Styles === */
    .status-paid {background:#2ed573; color:white; padding:4px 8px; border-radius:4px; font-weight:bold}
    .status-unpaid {background:#ff4757; color:white; padding:4px 8px; border-radius:4px; font-weight:bold}
    .btn-pay, .btn-unpay {background:#4a90e2; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer}
    .btn-unpay {background:#ff4757}

    /* === Check In Grid Styles === */
    .check-in-grid { display: grid; grid-template-columns: 100px repeat(7, 1fr); gap: 10px; margin-top:10px; }
    .grid-day-header { text-align:center; font-weight:bold; color:#2c3e50; padding-bottom:5px; border-bottom:2px solid #eee; }
    .grid-time { font-size:0.8rem; color:#666; padding:5px 0; border-right:1px solid #eee; text-align:center; }
    
    .class-block { background:#f0f0f0; border-radius:8px; padding:10px 5px; font-size:0.8rem; font-weight:bold; text-align:center; margin-bottom:5px; cursor:pointer; overflow:hidden; transition:0.2s; color:white; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .block-rad { background:#1976d2; }
    .block-jazz { background:#f57c00; }
    .block-hiphop { background:#7b1fa2; }
    .block-other { background:#555; }
    .block-name { display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    
    .student-row { padding:12px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom: 5px; }
    .student-row.paid {background:#e6ffe6; border-left: 5px solid #2ed573;}
    .student-row.unpaid {background:#ffe6e6; border-left: 5px solid #ff4757;}
    .status-btn-group button { padding:6px 10px; margin-left:5px; border:none; border-radius:4px; font-weight:bold; cursor:pointer; transition:0.1s; font-size:0.8rem;}
    .btn-present { background:#2ed573; color:white; }
    .btn-absent { background:#ffc107; color:#333; }
    .btn-excused { background:#2196f3; color:white; }

    /* Trophy Review Styles */
    .review-card { border-left: 5px solid #e94560; }
    .r-header { color:#2c3e50; font-size:1.1rem; }
    .r-gallery { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; }
    .r-main-img { height: 200px; width: auto; border-radius: 8px; border: 2px solid #e94560; cursor: zoom-in; }
    .r-extra-img { height: 80px; width: auto; border-radius: 6px; opacity: 0.7; cursor: zoom-in; transition: 0.2s; border: 1px solid #ddd; }
    .btn-audit { flex: 1; min-width: 80px; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: #333; transition: 0.2s; display:flex; align-items:center; justify-content:center; gap:5px; }
    .btn-gold { background: #ffd700; } 
    .btn-reject { background: #ff4757; color: white; flex: 0 0 auto; }
    
    .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
    .modal-box { background: white; width: 100%; max-width: 600px; border-radius: 16px; padding: 20px; position: relative; max-height: 80vh; overflow-y: auto; }
    
  </style>
</head>
<body>

<div class="header">
  <div>ADMIN</div>
  <div class="nav-tabs">
    <div class="nav-tab active" onclick="switchTab('courses')" id="tabBtnCourses">Courses</div>
    <div class="nav-tab" onclick="switchTab('reviews')" id="tabBtnReviews">üèÜ Reviews</div>
    <div class="nav-tab" onclick="switchTab('invoices')" id="tabBtnInvoices">üí∞ Invoices</div>
    <div class="nav-tab" onclick="switchTab('checkin')" id="tabBtnCheckin">‚úÖ Check In</div>
  </div>
</div>

<div id="tabCourses" class="container">
    <div class="tab-content-card">
        <h3>Add New Course</h3>
        <div class="form-grid">
            <div><label>Name</label><input type="text" id="cName" placeholder="e.g. RAD Grade 5"></div>
            <div>
                <label>Day</label>
                <select id="cDay">
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                </select>
            </div>
            <div><label>Start</label><input type="time" id="cStart" value="16:00"></div>
            <div><label>End</label><input type="time" id="cEnd" value="17:00"></div>
            <div><label>Teacher</label><input type="text" id="cTeacher" placeholder="e.g. Demi"></div>
            <div>
                <label>Room</label>
                <select id="cRoom">
                    <option value="Classroom 1">Studio 1</option>
                    <option value="Classroom 2">Studio 2</option>
                    <option value="Classroom 3">Studio 3</option>
                    <option value="Classroom 4">Studio 4</option>
                    <option value="Classroom 5">Studio 5</option>
                    <option value="Classroom 6">Studio 6</option>
                    <option value="Classroom 7">Studio 7</option>
                    <option value="Yoga Room">Yoga Room</option>
                </select>
            </div>
            <div><label>Age</label><input type="text" id="cAge" placeholder="9-11"></div>
        </div>
        <button class="btn-add" onclick="addCourse()">‚ûï Add Course</button>
    </div>

    <div class="tab-content-card">
        <h3>Course List</h3>
        
        <div class="filter-bar">
            <div class="filter-control"><select id="filterDay" onchange="filterAndRender()"><option value="">Day</option></select></div>
            <div class="filter-control"><select id="filterTeacher" onchange="filterAndRender()"><option value="">Teacher</option></select></div>
            <div class="filter-control"><select id="filterAge" onchange="filterAndRender()"><option value="">Age</option></select></div>
            <div class="filter-control"><select id="filterRoom" onchange="filterAndRender()"><option value="">Room</option></select></div>
            <div class="filter-control"><select id="filterTime" onchange="filterAndRender()"><option value="">Start Time</option></select></div>
        </div>

        <table>
            <thead><tr><th>Day</th><th>Time</th><th>Room</th><th>Name</th><th>Teacher</th><th>Age</th><th>Action</th></tr></thead>
            <tbody id="courseTable"><tr><td colspan="7">Loading...</td></tr></tbody>
        </table>
    </div>
</div>

<div id="tabReviews" class="container" style="display:none">
    <div class="tab-content-card">
        <h3>Trophy Reviews</h3>
        <div id="pendingList">Loading...</div>
    </div>
</div>

<div id="tabInvoices" class="container" style="display:none">
    <div class="tab-content-card">
        <h3>All Bookings & Invoices</h3>
        <table>
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Course</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="invoiceTable">
                <tr><td colspan="5">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="tabCheckin" class="container" style="display:none">
    <div class="tab-content-card">
        <h3>‚úÖ Class Check In (Êú¨Âë®Á≠æÂà∞)</h3>
        <div style="font-size:0.9rem; color:#888; margin-bottom:15px">Click a class block to start attendance.</div>
        <div id="weeklyScheduleGrid">
            </div>
    </div>
</div>

<div id="checkInModal" class="modal-overlay">
    <div class="modal-box">
        <h3 id="modalCourseTitle" style="margin-top:0"></h3>
        <div style="font-size:0.9rem; color:#666; margin-bottom:15px">Date: <span id="modalLessonDate"></span></div>
        <div id="studentListContainer" style="background:#f9f9f9; padding:10px; border-radius:8px">
            </div>
        <button onclick="closeModal('checkInModal')" style="width:100%; padding:10px; margin-top:15px; border:1px solid #ddd; border-radius:8px; background:#f0f0f0">Close</button>
    </div>
</div>


<script>
  let globalCourses = [];
  const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  const ROOM_NAMES = ['Studio 1', 'Studio 2', 'Studio 3', 'Studio 4', 'Studio 5', 'Studio 6', 'Studio 7', 'Yoga Room'];
  const MOCK_LESSON_DATE = '2026-02-09'; 

  function switchTab(t) {
      document.getElementById('tabCourses').style.display = t==='courses'?'block':'none';
      document.getElementById('tabReviews').style.display = t==='reviews'?'block':'none';
      document.getElementById('tabInvoices').style.display = t==='invoices'?'block':'none';
      document.getElementById('tabCheckin').style.display = t==='checkin'?'block':'none';
      
      document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
      document.getElementById('tabBtn'+t.charAt(0).toUpperCase() + t.slice(1)).classList.add('active');
      
      if(t==='courses') loadCourses();
      else if(t==='reviews') loadReviews();
      else if(t==='invoices') loadInvoices();
      else if(t==='checkin') setupCheckInGrid();
  }
  
  // --- Tab: Courses (CRUD & Filtering) ---
  function getUniqueValues(data, key) {
      const values = [...new Set(data.map(item => item[key]).filter(v => v))];
      if (key === 'start_time') return values.sort();
      if (key === 'teacher' || key === 'age_group') return values.sort();
      return values.sort();
  }
  
  function populateFilters(courses) {
      const daySelect = document.getElementById('filterDay');
      const teacherSelect = document.getElementById('filterTeacher');
      const ageSelect = document.getElementById('filterAge');
      const roomSelect = document.getElementById('filterRoom');
      const timeSelect = document.getElementById('filterTime');

      const fillSelect = (select, values) => {
          select.innerHTML = '<option value="">All</option>';
          values.forEach(v => {
              if (v) select.innerHTML += `<option value="${v}">${v}</option>`;
          });
      };

      // 1. Day: Static list
      daySelect.innerHTML = '<option value="">All Days</option>';
      DAYS.forEach(day => { daySelect.innerHTML += `<option value="${day}">${day}</option>`; });

      // 2. Room: Static list
      roomSelect.innerHTML = '<option value="">All Rooms</option>';
      ROOM_NAMES.forEach(room => { roomSelect.innerHTML += `<option value="${room.replace('Studio ', 'Classroom ')}">${room}</option>`; });

      // 3. Dynamic lists
      const uniqueTeachers = getUniqueValues(courses, 'teacher');
      const uniqueAges = getUniqueValues(courses, 'age_group');
      const uniqueTimes = getUniqueValues(courses, 'start_time');
      
      fillSelect(teacherSelect, uniqueTeachers);
      fillSelect(ageSelect, uniqueAges);
      fillSelect(timeSelect, uniqueTimes);

      filterAndRender(courses);
  }

  window.filterAndRender = function(sourceData) {
      const coursesToRender = sourceData || globalCourses;
      const day = document.getElementById('filterDay').value;
      const teacher = document.getElementById('filterTeacher').value;
      const age = document.getElementById('filterAge').value;
      const room = document.getElementById('filterRoom').value;
      const time = document.getElementById('filterTime').value;

      let filteredCourses = coursesToRender;

      if (day) filteredCourses = filteredCourses.filter(c => c.day_of_week === day);
      if (teacher) filteredCourses = filteredCourses.filter(c => c.teacher === teacher);
      if (age) filteredCourses = filteredCourses.filter(c => c.age_group === age);
      if (room) filteredCourses = filteredCourses.filter(c => c.classroom === room);
      if (time) filteredCourses = filteredCourses.filter(c => c.start_time.substring(0,5) === time.substring(0,5));


      const tbody = document.getElementById('courseTable');
      tbody.innerHTML = '';
      if (filteredCourses.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#999">No courses matching filters.</td></tr>'; return; }

      filteredCourses.forEach(c => {
          tbody.innerHTML += `
            <tr>
                <td><b>${c.day_of_week.substring(0,3)}</b></td>
                <td>${c.start_time.substring(0,5)}</td>
                <td>${c.classroom.replace('Classroom ', 'S')}</td>
                <td>${c.name}</td>
                <td>${c.teacher}</td>
                <td>${c.age_group}</td>
                <td><button class="btn-del" onclick="deleteCourse(${c.id})">Del</button></td>
            </tr>`;
      });
  }

  async function loadCourses() {
      try {
          const res = await fetch('/api/admin/all-courses');
          globalCourses = await res.json();
          populateFilters(globalCourses);
      } catch(e) { 
          document.getElementById('courseTable').innerHTML = '<tr><td colspan="7" style="color:red; text-align:center">Error loading courses.</td></tr>';
          console.error(e); 
      }
  }

  async function addCourse() {
      const payload = {
          name: document.getElementById('cName').value,
          day: document.getElementById('cDay').value,
          start: document.getElementById('cStart').value,
          end: document.getElementById('cEnd').value,
          teacher: document.getElementById('cTeacher').value,
          price: 230,
          classroom: document.getElementById('cRoom').value,
          age: document.getElementById('cAge').value
      };
      if(!payload.name) return alert('Name required');
      await fetch('/api/admin/courses', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      loadCourses();
      alert('Added!');
  }
  async function deleteCourse(id) {
      if(!confirm('Delete?')) return;
      await fetch(`/api/admin/courses/${id}`, {method:'DELETE'});
      loadCourses();
  }


  // --- Tab: Invoices ---
  async function loadInvoices() {
      const tbody = document.getElementById('invoiceTable');
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Loading...</td></tr>';
      
      try {
          const res = await fetch('/api/admin/invoices');
          const data = await res.json();

          tbody.innerHTML = '';
          data.forEach(inv => {
              const isPaid = inv.status === 'PAID';
              const statusTag = `<span class="${isPaid ? 'status-paid' : 'status-unpaid'}">${inv.status}</span>`;
              const actionBtn = isPaid 
                  ? `<button class="btn-unpay" onclick="updateStatus(${inv.id}, 'UNPAID')">Mark Unpaid</button>`
                  : `<button class="btn-pay" onclick="updateStatus(${inv.id}, 'PAID')">Mark Paid</button>`;
              
              tbody.innerHTML += `
                  <tr>
                      <td>${inv.student_name}</td>
                      <td>${inv.course_name}</td>
                      <td>$${inv.total_price.toFixed(2)}</td>
                      <td>${statusTag}</td>
                      <td>${actionBtn}</td>
                  </tr>
              `;
          });
      } catch(e) { tbody.innerHTML = '<tr><td colspan="5" style="color:red;text-align:center">Error loading invoices.</td></tr>'; }
  }

  async function updateStatus(bookingId, newStatus) {
      if(!confirm(`Confirm change status to ${newStatus}?`)) return;
      await fetch('/api/admin/invoices/update-status', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ bookingId, newStatus })
      });
      loadInvoices(); 
  }

  // --- Tab: Check In Grid (Weekly UI) ---
  
  function getBlockClass(courseName) {
      const name = courseName.toLowerCase();
      if (name.includes('ballet') || name.includes('rad')) return 'block-rad';
      if (name.includes('jazz') || name.includes('nzamd')) return 'block-jazz';
      if (name.includes('hiphop')) return 'block-hiphop';
      return 'block-other';
  }

  async function setupCheckInGrid() {
      const gridContainer = document.getElementById('weeklyScheduleGrid');
      gridContainer.style.display = 'grid';
      gridContainer.style.gridTemplateColumns = '100px repeat(7, 1fr)'; 

      const res = await fetch('/api/admin/check-in/weekly-schedule');
      const data = await res.json();
      
      gridContainer.innerHTML = '';
      
      // 1. Render Headers
      let headerHTML = '<div></div>'; 
      DAYS.forEach(day => { headerHTML += `<div class="grid-day-header">${day.substring(0,3)}</div>`; });
      gridContainer.innerHTML += headerHTML;

      // 2. Determine all unique time slots
      const allTimes = new Set();
      DAYS.forEach(day => { if (data[day]) data[day].forEach(c => { allTimes.add(c.start_time.substring(0,5)); }); });
      const sortedTimes = Array.from(allTimes).sort();

      // 3. Render Grid Body
      sortedTimes.forEach(time => {
          let rowHTML = `<div class="grid-time">${time}</div>`;
          DAYS.forEach(day => {
              const classesAtThisSlot = data[day] ? data[day].filter(c => c.start_time.substring(0,5) === time) : [];
              
              let cellHTML = '<div></div>';
              
              if (classesAtThisSlot.length > 0) {
                  cellHTML = classesAtThisSlot.map(c => `
                      <div 
                          class="class-block ${getBlockClass(c.name)}" 
                          onclick="openCheckInModal(${c.id}, '${c.name}', '${time}')"
                          title="${c.name} with ${c.teacher} (${c.classroom})"
                      >
                          <span class="block-name">${c.name}</span>
                          <span style="font-size:0.7rem; opacity:0.8">${c.classroom.replace('Classroom ', 'C')}</span>
                      </div>
                  `).join('');
              }
              rowHTML += `<div>${cellHTML}</div>`;
          });
          gridContainer.innerHTML += rowHTML;
      });
  }

  // --- Check In Modal Logic ---
  window.openCheckInModal = async function(courseId, courseName, startTime) {
      document.getElementById('modalCourseTitle').textContent = `Check In: ${courseName} (${startTime})`;
      document.getElementById('modalLessonDate').textContent = MOCK_LESSON_DATE;

      const container = document.getElementById('studentListContainer');
      container.innerHTML = '<div style="text-align:center; padding:20px;">Loading students...</div>';
      
      document.getElementById('checkInModal').style.display = 'flex';

      try {
          const res = await fetch(`/api/admin/check-in/class-list/${courseId}`);
          const students = await res.json();

          container.innerHTML = '';

          students.forEach(s => {
              const isPaid = s.payment_status === 'PAID';
              const statusClass = isPaid ? 'paid' : 'unpaid';
              
              container.innerHTML += `
                  <div class="student-row ${statusClass}" data-user-id="${s.user_id}" data-course-id="${courseId}" data-course-name="${courseName}">
                      <div>
                          üë§ <b>${s.student_name}</b> 
                          <span style="font-size:0.8rem; color:#1976d2">(${s.booking_type || 'Enrolled'})</span>
                          <span style="font-size:0.8rem; color:${isPaid?'green':'red'}"> | ${s.payment_status}</span>
                      </div>
                      <div class="status-btn-group">
                          <button class="btn-present" onclick="submitAttendance(this, 'PRESENT')">Present</button>
                          <button class="btn-absent" onclick="submitAttendance(this, 'ABSENT_UNEXCUSED')">Absent (No Credit)</button>
                          <button class="btn-excused" onclick="submitAttendance(this, 'ABSENT_EXCUSED')">Excused (Grant Credit)</button>
                      </div>
                  </div>
              `;
          });
      } catch(e) { container.innerHTML = '<div style="color:red;text-align:center;padding:20px;">Error loading class list.</div>'; }
  }

  window.submitAttendance = async function(btn, status) {
      const row = btn.closest('.student-row');
      const userId = row.dataset.userId;
      const courseId = row.dataset.courseId;
      const courseName = row.dataset.courseName;

      btn.disabled = true;
      btn.textContent = '...';

      const res = await fetch('/api/admin/check-in/submit-attendance', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ userId, courseId, lessonDate: MOCK_LESSON_DATE, status, courseName })
      });

      if (res.ok) {
          alert('Attendance recorded! Status: ' + status);
          row.style.background = status === 'PRESENT' ? '#d4edda' : '#ffe6e6';
          row.querySelector('.status-btn-group').innerHTML = `<span style="font-weight:bold; color:green">Recorded: ${status}</span>`;
      } else {
          alert('Failed to record attendance.');
          btn.disabled = false;
          btn.textContent = status;
      }
  }
  function closeModal(id) { document.getElementById(id).style.display = 'none'; }
  
  // --- Tab: Reviews ---
  async function loadReviews() {
      const list = document.getElementById('pendingList');
      list.innerHTML = '<div style="text-align:center;color:#999;margin-top:30px;font-size:1.2rem">Loading reviews...</div>';
      
      try {
          const res = await fetch('/api/admin/trophies/pending');
          const data = await res.json();
          
          if(data.length === 0) { list.innerHTML = '<div class="tab-content-card" style="text-align:center;color:#666;font-size:1.2rem">‚úÖ All caught up! No pending reviews.</div>'; return; }

          list.innerHTML = '';
          data.forEach(item => {
              let extrasHtml = item.extra_images.map(url => `<img src="${url}" class="r-extra-img" onclick="window.open(this.src)">`).join('');

              const div = document.createElement('div');
              div.className = 'review-card tab-content-card';
              div.innerHTML = `
                <div class="r-header">
                    <span>üë§ Student: ${item.student_name || 'Unknown'}</span>
                    <span style="color:#999;font-weight:normal;font-size:0.9rem">${new Date(item.created_at).toLocaleDateString()}</span>
                </div>
                
                <div class="r-gallery">
                    <div style="text-align:center;margin-right:10px">
                        <img src="${item.image_path}" class="r-main-img" onclick="window.open(this.src)">
                        <div style="font-size:0.8rem;color:#e94560;font-weight:bold">Main Certificate</div>
                    </div>
                    ${extrasHtml}
                </div>

                <div class="action-area">
                    <label style="margin-bottom:5px">Award Title:</label>
                    <input type="text" id="awardName-${item.id}" value="${item.source_name || 'Competition Award'}" style="margin-bottom:10px; width:100%">
                    
                    <div style="font-size:0.8rem;color:#666;margin-bottom:5px">Select Trophy Level to Approve:</div>
                    <div class="btn-row">
                        <button class="btn-audit btn-gold" onclick="audit(${item.id}, 'gold')">üèÜ Gold Trophy</button>
                        <button class="btn-audit btn-silver" onclick="audit(${item.id}, 'silver')">ü•à Silver Trophy</button>
                        <button class="btn-audit btn-bronze" onclick="audit(${item.id}, 'bronze')">ü•â Bronze Trophy</button>
                    </div>
                    <div class="btn-row">
                        <button class="btn-audit btn-cert" onclick="audit(${item.id}, 'certificate')">üìú Certificate</button>
                        <button class="btn-audit btn-reject" onclick="audit(${item.id}, 'reject')">‚ùå Reject</button>
                    </div>
                </div>
              `;
              list.appendChild(div);
          });
      } catch(e) { list.innerHTML = 'Error loading reviews'; }
  }

  async function audit(id, type) {
      if(!confirm(`Confirm ${type === 'reject' ? 'REJECT' : 'APPROVE'}?`)) return;
      
      const nameInput = document.getElementById(`awardName-${id}`);
      const sourceName = nameInput ? nameInput.value : 'Award';

      try {
          await fetch('/api/admin/trophies/approve', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({ trophyId: id, action: type==='reject'?'reject':'approve', type, sourceName })
          });
          alert('Processed!');
          loadReviews(); 
      } catch(e) { alert('Error processing'); }
  }


  // Init
  switchTab('courses');
</script>
</body>
</html>