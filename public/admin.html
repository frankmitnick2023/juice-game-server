<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WE DANCE æ•™åŠ¡åå°</title>
  <style>
    body{font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin:0; background:#f2f4f8; padding-bottom:4rem}
    .header{background:#333;color:white;padding:1rem;position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center}
    
    .day-tabs {display:flex;overflow-x:auto;background:white;padding:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05)}
    .day-tab {flex:0 0 auto;padding:6px 14px;margin-right:8px;border-radius:15px;background:#f0f0f0;color:#666;font-weight:bold;font-size:0.9rem;cursor:pointer}
    .day-tab.active {background:#333;color:white}

    .container{padding:15px;min-height: 300px;}
    .class-card{background:white;border-radius:10px;padding:15px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,0.05);border-left:5px solid #333;cursor:pointer;position:relative}
    
    .c-time{font-weight:bold;color:#333;font-size:1.1rem}
    .c-name{font-size:1rem;color:#555;margin:5px 0}
    .c-meta{font-size:0.8rem;color:#888}
    .c-badge{position:absolute;right:15px;top:20px;background:#ffebee;color:#d32f2f;padding:4px 10px;border-radius:10px;font-weight:bold;font-size:0.9rem}
    .c-badge.has-student{background:#e8f5e9;color:#2e7d32}

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:200;flex-direction:column}
    .m-header{padding:15px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;background:#fff}
    .m-body{flex:1;overflow-y:auto;padding:15px}
    .m-close{font-size:1.5rem;cursor:pointer;padding:0 10px}

    .student-row{display:flex;justify-content:space-between;align-items:center;padding:15px 0;border-bottom:1px solid #f5f5f5}
    .btn-check{background:#4CAF50;color:white;border:none;padding:8px 20px;border-radius:20px;font-weight:bold}
    .btn-done{background:#ddd;color:#999}
    
    .error-msg {color: red; text-align: center; padding: 20px; background: #ffebee; border-radius: 8px;}
  </style>
</head>
<body>

<div class="header">
  <div>ğŸ“ æ•™åŠ¡ç®¡ç†ç³»ç»Ÿ</div>
  <div style="font-size:0.8rem">Admin</div>
</div>

<div class="day-tabs" id="dayTabs"></div>
<div class="container" id="classList">
    <p style="text-align:center;color:#666">æ­£åœ¨åŠ è½½æ•°æ®...</p>
</div>

<div id="rollCallModal" class="modal">
    <div class="m-header">
        <h3 id="mTitle" style="margin:0">è¯¾ç¨‹å</h3>
        <div class="m-close" onclick="closeModal()">Ã—</div>
    </div>
    <div class="m-body" id="mList"></div>
</div>

<script>
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  let allCourses = [];
  let currentDay = 'Friday'; // é»˜è®¤å‘¨äº”

  async function init() {
      // 1. æ¸²æŸ“é¡¶éƒ¨æ˜ŸæœŸæ 
      const tabs = document.getElementById('dayTabs');
      days.forEach(d => {
          const div = document.createElement('div');
          div.className = `day-tab ${d===currentDay?'active':''}`;
          div.textContent = d.substring(0,3);
          div.onclick = () => switchDay(d, div);
          tabs.appendChild(div);
      });

      try {
          // 2. è¯·æ±‚æ•°æ®
          const res = await fetch('/api/teacher/schedule');
          
          // å¦‚æœçŠ¶æ€ç ä¸å¯¹ (æ¯”å¦‚ 500 Error)ï¼ŒæŠ›å‡ºé”™è¯¯
          if (!res.ok) {
              const errData = await res.json();
              throw new Error(errData.error || 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯');
          }

          allCourses = await res.json();
          
          // æ£€æŸ¥æ•°æ®æ ¼å¼
          if (!Array.isArray(allCourses)) {
              throw new Error('è¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
          }

          renderClasses();

      } catch (e) {
          // 3. é”™è¯¯å¤„ç†ï¼šæ˜¾ç¤ºåœ¨é¡µé¢ä¸Šï¼Œä¸å†ç™½å±
          document.getElementById('classList').innerHTML = `
            <div class="error-msg">
                <h3>åŠ è½½å¤±è´¥</h3>
                <p>${e.message}</p>
                <button onclick="location.reload()" style="margin-top:10px">é‡è¯•</button>
            </div>
          `;
          console.error(e);
      }
  }

  function switchDay(day, el) {
      currentDay = day;
      document.querySelectorAll('.day-tab').forEach(t=>t.classList.remove('active'));
      el.classList.add('active');
      renderClasses();
  }

  function renderClasses() {
      const list = document.getElementById('classList');
      list.innerHTML = '';
      
      if (!allCourses || allCourses.length === 0) {
          list.innerHTML = '<p style="text-align:center;color:#999">æ•°æ®åº“ä¸­æš‚æ— è¯¾ç¨‹æ•°æ®</p>';
          return;
      }

      const todayClasses = allCourses.filter(c => c.day_of_week === currentDay);
      
      if(todayClasses.length === 0) {
          list.innerHTML = `<p style="text-align:center;color:#999;margin-top:50px">${currentDay} æ²¡æœ‰æ’è¯¾</p>`;
          return;
      }

      todayClasses.forEach(c => {
          const count = parseInt(c.student_count || 0);
          const div = document.createElement('div');
          div.className = 'class-card';
          div.innerHTML = `
            <div class="c-time">${c.start_time} - ${c.end_time}</div>
            <div class="c-name">${c.name}</div>
            <div class="c-meta">ğŸ‘¨â€ğŸ« ${c.teacher} | ${c.category}</div>
            <div class="c-badge ${count>0?'has-student':''}">${count}äººæŠ¥å</div>
          `;
          div.onclick = () => openRollCall(c);
          list.appendChild(div);
      });
  }

  async function openRollCall(course) {
      document.getElementById('rollCallModal').style.display = 'flex';
      document.getElementById('mTitle').textContent = course.name;
      const list = document.getElementById('mList');
      list.innerHTML = '<p style="text-align:center">åŠ è½½åå•...</p>';

      try {
          const res = await fetch(`/api/teacher/bookings/${course.id}`);
          const students = await res.json();

          list.innerHTML = '';
          if(students.length === 0) {
              list.innerHTML = '<p style="text-align:center;color:#999;margin-top:20px">æš‚æ— å­¦ç”ŸæŠ¥å</p>';
              return;
          }

          students.forEach(s => {
              // å…¼å®¹æ—§çŠ¶æ€ 'attended' å’Œæ–°çŠ¶æ€ 'active'
              const isAttended = s.status === 'attended' || s.status === 'active'; 
              
              const div = document.createElement('div');
              div.className = 'student-row';
              div.innerHTML = `
                <div>
                    <div style="font-weight:bold;font-size:1.1rem">${s.student_name || 'æœªå‘½å'}</div>
                    <div style="font-size:0.8rem;color:#888">ç´¯è®¡ä¿®ç»ƒ: ${(s.total_minutes/60).toFixed(1)}å°æ—¶</div>
                </div>
                <button class="${isAttended ? 'btn-check btn-done' : 'btn-check'}" 
                        onclick="checkIn(${s.id}, ${course.id}, this)" 
                        ${isAttended ? 'disabled' : ''}>
                    ${isAttended ? 'å·²åˆ°' : 'ç­¾åˆ°'}
                </button>
              `;
              list.appendChild(div);
          });
      } catch(e) {
          list.innerHTML = '<p style="color:red;text-align:center">åŠ è½½åå•å¤±è´¥</p>';
      }
  }

  function closeModal() {
      document.getElementById('rollCallModal').style.display = 'none';
  }

  async function checkIn(bid, cid, btn) {
      if(!confirm('ç¡®è®¤è¯¥å­¦ç”Ÿå·²åˆ°è¯¾ï¼Ÿ')) return;
      
      const originalText = btn.textContent;
      btn.textContent = '...';
      
      try {
          const res = await fetch('/api/teacher/check-in', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({bookingId:bid, courseId:cid})
          });
          if(res.ok) {
              const d = await res.json();
              alert(`âœ… ç­¾åˆ°æˆåŠŸ (+${d.added_minutes}åˆ†é’Ÿ)`);
              btn.className = 'btn-check btn-done';
              btn.textContent = 'å·²åˆ°';
              btn.disabled = true;
          } else {
              alert('æ“ä½œå¤±è´¥');
              btn.textContent = originalText;
          }
      } catch(e) {
          alert('ç½‘ç»œé”™è¯¯');
          btn.textContent = originalText;
      }
  }

  init();
</script>
</body>
</html>