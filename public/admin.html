<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WE DANCE æ•™åŠ¡åå°</title>
  <style>
    body{font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin:0; background:#f2f4f8; padding-bottom:4rem}
    .header{background:#333;color:white;padding:1rem;position:sticky;top:0;z-index:100}
    
    .day-tabs {display:flex;overflow-x:auto;background:white;padding:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05)}
    .day-tab {flex:0 0 auto;padding:6px 14px;margin-right:8px;border-radius:15px;background:#f0f0f0;color:#666;font-weight:bold;font-size:0.9rem;cursor:pointer}
    .day-tab.active {background:#333;color:white}

    .container{padding:15px}
    .class-card{background:white;border-radius:10px;padding:15px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,0.05);border-left:5px solid #333;cursor:pointer;position:relative}
    .c-time{font-weight:bold;color:#333;font-size:1.1rem}
    .c-name{font-size:1rem;color:#555;margin:5px 0}
    .c-badge{position:absolute;right:15px;top:20px;background:#ffebee;color:#d32f2f;padding:4px 10px;border-radius:10px;font-weight:bold;font-size:0.9rem}

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:200;flex-direction:column}
    .m-header{padding:15px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;background:#fff}
    .m-body{flex:1;overflow-y:auto;padding:15px}
    .m-close{font-size:2rem;cursor:pointer;padding:0 10px}

    .student-row{display:flex;justify-content:space-between;align-items:center;padding:15px 0;border-bottom:1px solid #f5f5f5}
    .s-tag{background:#e3f2fd;color:#1976d2;padding:1px 5px;border-radius:4px;font-size:0.7rem;margin-left:5px}
    
    .btn-group{display:flex;gap:5px}
    .btn{border:none;padding:6px 12px;border-radius:6px;font-weight:bold;cursor:pointer;font-size:0.8rem}
    .btn-check{background:#4CAF50;color:white}
    .btn-remove{background:transparent;color:#999;border:1px solid #ddd} /* ç§»é™¤æŒ‰é’®æ ·å¼ */
    .btn-remove:hover{color:red;border-color:red}
    .btn-done{background:#ddd;color:#888;cursor:default}
  </style>
</head>
<body>

<div class="header"><div>ğŸ“ æ•™åŠ¡åå°</div></div>
<div class="day-tabs" id="dayTabs"></div>
<div class="container" id="classList"></div>

<div id="rollCallModal" class="modal">
    <div class="m-header">
        <h3 id="mTitle" style="margin:0"></h3>
        <div class="m-close" onclick="closeModal()">Ã—</div>
    </div>
    <div class="m-body" id="mList"></div>
</div>

<script>
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  let allCourses = [];
  let currentDay = days[new Date().getDay() === 0 ? 6 : new Date().getDay() - 1];

  async function init() {
      const tabs = document.getElementById('dayTabs');
      days.forEach(d => {
          const div = document.createElement('div');
          div.className = `day-tab ${d===currentDay?'active':''}`;
          div.textContent = d.substring(0,3);
          div.onclick = () => switchDay(d, div);
          tabs.appendChild(div);
      });
      const res = await fetch('/api/teacher/schedule');
      allCourses = await res.json();
      renderClasses();
  }

  function switchDay(day, el) {
      currentDay = day;
      document.querySelectorAll('.day-tab').forEach(t=>t.classList.remove('active'));
      el.classList.add('active');
      renderClasses();
  }

  function renderClasses() {
      const list = document.getElementById('classList');
      list.innerHTML = '';
      const todayClasses = allCourses.filter(c => c.day_of_week === currentDay);
      if(todayClasses.length === 0) list.innerHTML = '<p style="text-align:center;color:#999;margin-top:50px">æ— è¯¾ç¨‹</p>';
      
      todayClasses.forEach(c => {
          const div = document.createElement('div');
          div.className = 'class-card';
          div.innerHTML = `
            <div class="c-time">${c.start_time}</div>
            <div class="c-name">${c.name}</div>
            <div class="c-badge">${c.student_count||0}äºº</div>
          `;
          div.onclick = () => openRollCall(c);
          list.appendChild(div);
      });
  }

  async function openRollCall(course) {
      document.getElementById('rollCallModal').style.display = 'flex';
      document.getElementById('mTitle').textContent = course.name;
      const list = document.getElementById('mList');
      list.innerHTML = 'åŠ è½½ä¸­...';
      
      const res = await fetch(`/api/teacher/bookings/${course.id}`);
      const students = await res.json();
      list.innerHTML = '';
      
      if(students.length === 0) list.innerHTML = '<p style="text-align:center;color:#999">æš‚æ— æŠ¥å</p>';

      students.forEach(s => {
          const isDone = s.status === 'attended';
          const div = document.createElement('div');
          div.className = 'student-row';
          div.innerHTML = `
            <div>
                <div style="font-weight:bold">${s.student_name}</div>
                <div style="font-size:0.8rem;color:#888">${s.is_makeup?'ğŸ”µ è¡¥è¯¾':'âšªï¸ æ­£è¯¾'}</div>
            </div>
            <div class="btn-group">
                <button class="btn btn-remove" onclick="removeStudent(${s.id}, ${course.id})">ğŸ—‘</button>
                <button class="btn ${isDone?'btn-done':'btn-check'}" onclick="checkIn(${s.id}, ${course.id}, this)" ${isDone?'disabled':''}>
                    ${isDone?'å·²åˆ°':'ç­¾åˆ°'}
                </button>
            </div>
          `;
          list.appendChild(div);
      });
  }

  function closeModal() { document.getElementById('rollCallModal').style.display = 'none'; }

  async function checkIn(bid, cid, btn) {
      if(!confirm('ç¡®è®¤ç­¾åˆ°ï¼Ÿ')) return;
      const res = await fetch('/api/teacher/action', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({bookingId:bid, courseId:cid, action:'present'})
      });
      if(res.ok) { 
          btn.className = 'btn btn-done'; btn.textContent = 'å·²åˆ°'; btn.disabled = true;
      }
  }

  // === è€å¸ˆç«¯ç§»é™¤å­¦ç”Ÿ ===
  async function removeStudent(bid, cid) {
      if(!confirm('âš ï¸ å±é™©æ“ä½œï¼šç¡®è®¤å°†è¯¥å­¦ç”Ÿä»åå•ä¸­ç§»é™¤ï¼Ÿ\nå¦‚æœæ˜¯è¡¥è¯¾ç”Ÿï¼Œä¼šè‡ªåŠ¨é€€è¿˜è¡¥è¯¾é¢åº¦ã€‚')) return;
      
      const res = await fetch('/api/teacher/remove-booking', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({bookingId:bid})
      });
      
      if(res.ok) {
          alert('âœ… å·²ç§»é™¤');
          // é‡æ–°åŠ è½½åå•
          openRollCall({id:cid, name:document.getElementById('mTitle').textContent}); 
      } else {
          alert('ç§»é™¤å¤±è´¥');
      }
  }

  init();
</script>
</body>
</html>